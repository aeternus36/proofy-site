<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proofy – Verifiera underlag</title>
  <meta name="description" content="Verifiera om ett underlag är oförändrat jämfört med ett registrerat Verifierings-ID." />
  <meta name="theme-color" content="#0b1220" />
  <meta name="robots" content="noindex" />

  <link rel="stylesheet" href="/assets/proofy.css?v=2025-12-24a" />
  <link rel="stylesheet" href="/assets/header.css?v=2025-12-24a" />
</head>

<body>
<a class="skip" href="#main">Hoppa till innehåll</a>

<header>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="/" aria-label="Proofy">
        <span class="logo" aria-hidden="true"></span>
        <span>Proofy</span>
      </a>

      <div class="navActions" id="navActionsDesktop">
        <a class="btn" href="/register.html">Skapa Verifierings-ID</a>
        <a class="btn soft" href="/pilot.html">Starta pilot</a>
        <a class="btn primary" href="/#kontakt">Boka kort demo</a>
      </div>

      <details class="mnav" id="mnav">
        <summary class="mnavSummary" aria-label="Öppna meny">
          <span class="mnavIcon" aria-hidden="true"></span>
        </summary>

        <nav class="mnavMenu" aria-label="Meny">
          <a class="mnavLink" href="/verify.html" aria-current="page">Verifiera underlag</a>
          <a class="mnavLink" href="/register.html">Skapa Verifierings-ID</a>
          <a class="mnavLink" href="/pilot.html">Starta pilot</a>
          <a class="mnavLink mnavLinkPrimary" href="/#kontakt">Boka kort demo</a>

          <!-- policy-länkar även i mobilmenyn -->
          <div class="mnavMeta">
            <a class="mnavLink" href="/security.html">Säkerhet</a>
            <a class="mnavLink" href="/privacy.html">Integritet</a>
            <a class="mnavLink" href="/terms.html">Villkor</a>
            <a class="mnavLink" href="/cookies.html">Cookies</a>

            <!-- Viktigt: “note” ska signalera produkt/nytta, inte policies -->
            <div class="mnavNote">Verifiering · revision · granskning</div>
            <a class="mnavMail" href="mailto:kontakt@proofy.se">kontakt@proofy.se</a>
          </div>
        </nav>
      </details>
    </div>
  </div>
</header>

<main id="main">
  <div class="wrap">
    <div class="badge">Verifiering · revision · granskning</div>

    <h1 class="pageTitle">Verifiera underlag</h1>

    <p class="lead">
      Kontrollera om ett underlag är samma filversion som den som tidigare fastställdes.
      <strong>Underlaget lämnar aldrig din dator.</strong>
    </p>

    <div class="card content" style="margin-top:14px;">
      <div class="grid2">

        <section aria-label="Verifieringsuppgifter">
          <div style="font-weight:950; font-size:16px;">1. Ange Verifierings-ID</div>

          <label class="meta" for="hashInput" style="margin-top:8px;">Verifierings-ID (sparat i ärendet)</label>
          <input id="hashInput" type="text" placeholder="0x…" autocomplete="off" spellcheck="false" style="margin-top:6px" />

          <div class="small" style="margin-top:8px">
            ID:t fylls i automatiskt om du öppnat sidan via verifieringslänk.
          </div>

          <div class="actions" style="margin-top:10px; flex-wrap:wrap; gap:10px;">
            <a class="btn soft" id="openLinkBtn" href="/verify.html" style="pointer-events:none;opacity:.55;">Öppna länk</a>
            <button class="btn" id="shareLinkBtn" type="button" disabled>Dela</button>
            <button class="btn" id="copyLinkBtn" type="button" disabled>Kopiera länk</button>
            <span id="linkPill" class="pill" style="display:none;"></span>
          </div>

          <div class="hr"></div>

          <div style="font-weight:950; font-size:16px;">2. Välj underlag att verifiera</div>

          <label for="fileInput" class="btn primary" style="display:inline-flex; margin-top:8px; cursor:pointer;">
            Välj underlag (fil)
          </label>
          <input id="fileInput" type="file" style="display:none;" />

          <!-- ✅ STEG 2: Drag & drop-zon (samma UX som register.html) -->
          <div id="dropZone" class="drop" style="margin-top:10px;">
            Dra &amp; släpp underlag här
          </div>

          <div id="fileInfo"
               class="meta"
               style="margin-top:10px; padding:10px 12px; border-radius:12px; border:1px dashed rgba(255,255,255,.25); background:rgba(255,255,255,.04);">
            Inget underlag valt.
          </div>

          <div class="actions" style="margin-top:14px">
            <button class="btn soft" id="verifyBtn" disabled>Verifiera underlag</button>
            <span id="statusPill" class="pill">Förbered verifiering</span>
          </div>

          <div id="inputAlert"
               role="status"
               aria-live="polite"
               style="display:none; margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06);">
            <div id="inputAlertText" style="font-weight:800;"></div>
            <div id="inputAlertHelp" class="small" style="margin-top:6px; opacity:.95;"></div>
          </div>

          <p class="small" style="margin-top:12px; margin-bottom:0;">
            <b>Tips:</b> Ny export/omskanning/konvertering kan ge annan filversion även om dokumentet “ser likadant ut”.
          </p>
        </section>

        <section aria-label="Verifieringsresultat">
          <div style="display:flex; align-items:baseline; justify-content:space-between; gap:12px;">
            <div style="font-weight:950; font-size:16px;">Verifieringsresultat</div>
            <div class="meta" id="reportMeta" style="opacity:.85; display:none;">Rapport</div>
          </div>
          <div class="hr"></div>

          <div id="resultBox" style="display:none;">
            <div id="resultHeadline"
                 style="font-size:18px; font-weight:950; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.05);">
            </div>

            <div style="margin-top:12px;">
              <div class="meta">Verifierings-ID</div>
              <div class="copyFieldWrap" style="position:relative; margin-top:6px;">
                <button type="button" id="copyIdIconBtn" aria-label="Kopiera Verifierings-ID" title="Kopiera"
                        style="display:none; position:absolute; top:6px; right:6px; width:34px; height:30px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); cursor:pointer;">
                  <span aria-hidden="true" style="display:block; font-size:15px; line-height:28px;">⧉</span>
                </button>

                <div id="outHash"
                     class="mono"
                     tabindex="0"
                     role="button"
                     title="Klicka för att kopiera"
                     aria-label="Verifierings-ID (klicka för att kopiera)"
                     style="
                       padding:8px 10px;
                       border-radius:12px;
                       border:1px solid rgba(255,255,255,.14);
                       background:rgba(255,255,255,.03);
                       cursor:pointer;
                       padding-right:52px;
                       user-select:text;
                       overflow-wrap:anywhere;
                       word-break:break-word;
                       font-size:13px;
                       line-height:1.3;
                     ">—</div>

                <span id="copyIdPill" class="pill" style="display:none; margin-top:8px;"> </span>
              </div>

              <div class="meta" style="margin-top:12px;">Underlagets tekniska fingeravtryck</div>
              <div class="copyFieldWrap" style="position:relative; margin-top:6px;">
                <button type="button" id="copyFileHashIconBtn" aria-label="Kopiera fingeravtryck" title="Kopiera"
                        style="display:none; position:absolute; top:6px; right:6px; width:34px; height:30px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); cursor:pointer;">
                  <span aria-hidden="true" style="display:block; font-size:15px; line-height:28px;">⧉</span>
                </button>

                <div id="outFileHash"
                     class="mono"
                     tabindex="0"
                     role="button"
                     title="Klicka för att kopiera"
                     aria-label="Underlagets fingeravtryck (klicka för att kopiera)"
                     style="
                       padding:8px 10px;
                       border-radius:12px;
                       border:1px solid rgba(255,255,255,.14);
                       background:rgba(255,255,255,.03);
                       cursor:pointer;
                       padding-right:52px;
                       user-select:text;
                       overflow-wrap:anywhere;
                       word-break:break-word;
                       font-size:13px;
                       line-height:1.3;
                     ">—</div>

                <span id="copyFileHashPill" class="pill" style="display:none; margin-top:8px;"> </span>
              </div>

              <div class="hr" style="margin-top:14px;"></div>

              <div style="display:grid; grid-template-columns: 1fr; gap:10px;">
                <div>
                  <div class="meta">Registreringsstatus</div>
                  <div id="outRegStatus" class="mono" style="margin-top:6px;">—</div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr; gap:10px;">
                  <div>
                    <div class="meta">Registreringstid (Sverige)</div>
                    <div id="outRegSe" class="mono" style="margin-top:6px;">—</div>
                  </div>

                  <div>
                    <div class="meta">Registreringstid (UTC)</div>
                    <div id="outRegUtc" class="mono" style="margin-top:6px;">—</div>
                  </div>
                </div>
              </div>

              <div id="outExplain"
                   style="margin-top:12px; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06);">
                <div id="outExplainTitle" style="font-weight:900;"></div>
                <div id="outExplainBody" class="small" style="margin-top:6px; opacity:.95;"></div>
              </div>

              <div class="actions" style="margin-top:12px; flex-wrap:wrap; gap:10px;">
                <a class="btn soft" id="openCertBtn" href="/certificate.html" style="display:none;">Öppna registreringskvitto</a>
                <button class="btn" id="copySummaryBtn" type="button" style="display:none;">Kopiera verifieringsnotering</button>

                <button class="btn soft" id="sendNoteToChatBtn" type="button" style="display:none;">
                  Skapa verifieringsnotering i chatten
                </button>

                <span id="copySummaryPill" class="pill" style="display:none;"> </span>
              </div>

              <details style="margin-top:12px;">
                <summary>Notering för dokumentation (valfritt)</summary>
                <p class="small" style="margin:10px 0 8px; opacity:.95;">
                  Praktiskt om du vill klistra in en kort notering i arbetsdokument/revisionsfil.
                </p>
                <pre class="mono" id="summaryOut" style="white-space:pre-wrap;">—</pre>
              </details>

              <div class="meta" style="margin-top:12px; opacity:.85;">
                Not: Proofy verifierar filversion (identisk/avvikande), inte dokumentets sakliga riktighet.
              </div>
            </div>
          </div>

          <div id="errorBox" style="display:none;">
            <div class="err">Verifiering kunde inte genomföras</div>
            <div id="errorMsg" class="mono" style="margin-top:8px"></div>
          </div>
        </section>

      </div>
    </div>

    <p class="meta" style="margin-top:14px">
      Proofy avgör inte om innehållet är korrekt – endast om underlaget är oförändrat jämfört med referensen.
    </p>
  </div>
</main>

<footer>
  <div class="wrap">
    <div class="foot">
      <div>
        <div style="color: rgba(234,240,255,.86); font-weight:800;">Proofy</div>
        <div class="small">© 2026 Proofy. Alla rättigheter förbehållna.</div>
        <div class="small" style="margin-top:8px; max-width:92ch;">
          Proofy tillhandahåller teknisk tidsstämpling och verifiering av filer. Tjänsten utgör inte juridisk rådgivning och avgör inte filens rättsliga giltighet.
        </div>
      </div>
      <div class="links">
        <a href="/security.html">Säkerhet</a>
        <a href="/privacy.html">Integritet</a>
        <a href="/terms.html">Villkor</a>
        <a href="/cookies.html">Cookies</a>
        <a href="/#kontakt">Kontakt</a>
      </div>
    </div>
  </div>
</footer>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const hashInput = $("hashInput");
  const fileInput = $("fileInput");
  const dropZone = $("dropZone"); // ✅ STEG 2
  const fileInfo = $("fileInfo");
  const verifyBtn = $("verifyBtn");
  const statusPill = $("statusPill");

  const inputAlert = $("inputAlert");
  const inputAlertText = $("inputAlertText");
  const inputAlertHelp = $("inputAlertHelp");

  const reportMeta = $("reportMeta");

  const resultBox = $("resultBox");
  const resultHeadline = $("resultHeadline");
  const outHash = $("outHash");
  const outFileHash = $("outFileHash");
  const outRegStatus = $("outRegStatus");
  const outRegSe = $("outRegSe");
  const outRegUtc = $("outRegUtc");
  const openCertBtn = $("openCertBtn");

  const outExplain = $("outExplain");
  const outExplainTitle = $("outExplainTitle");
  const outExplainBody = $("outExplainBody");

  const copyIdIconBtn = $("copyIdIconBtn");
  const copyIdPill = $("copyIdPill");

  const copyFileHashIconBtn = $("copyFileHashIconBtn");
  const copyFileHashPill = $("copyFileHashPill");

  const copySummaryBtn = $("copySummaryBtn");
  const copySummaryPill = $("copySummaryPill");
  const summaryOut = $("summaryOut");

  const sendNoteToChatBtn = $("sendNoteToChatBtn");

  const errorBox = $("errorBox");
  const errorMsg = $("errorMsg");

  // länkkontroller
  const openLinkBtn = $("openLinkBtn");
  const shareLinkBtn = $("shareLinkBtn");
  const copyLinkBtn = $("copyLinkBtn");
  const linkPill = $("linkPill");

  let currentFile = null;
  let busy = false;
  let opId = 0;

  let lastRun = null;

  function isValidId(h){
    return /^0x[0-9a-fA-F]{64}$/.test((h || "").trim());
  }

  function buildSelfLink(id){
    return `${location.origin}/verify.html?hash=${encodeURIComponent(id)}`;
  }

  function showLinkPill(text){
    if (!linkPill) return;
    linkPill.style.display = "inline-block";
    linkPill.textContent = text || "";
    setTimeout(() => {
      linkPill.style.display = "none";
      linkPill.textContent = "";
    }, 1400);
  }

  // ✅ STEG 2: robust kopiering (clipboard + fallback)
  async function copyTextToClipboard(text){
    const t = String(text || "").trim();
    if (!t || t === "—") return false;

    try{
      await navigator.clipboard.writeText(t);
      return true;
    } catch {
      try{
        const ta = document.createElement("textarea");
        ta.value = t;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        ta.style.top = "0";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        const ok = document.execCommand("copy");
        document.body.removeChild(ta);
        return !!ok;
      } catch {
        return false;
      }
    }
  }

  async function tryCopy(text){
    // ✅ STEG 2: använd robust kopiering
    return await copyTextToClipboard(text);
  }

  async function shareOrFallback(link){
    try{
      if (navigator.share) {
        await navigator.share({ title: "Proofy – verifieringslänk", url: link });
        showLinkPill("Delad ✓");
        return;
      }
    } catch {}
    const ok = await tryCopy(link);
    showLinkPill(ok ? "Kopierad ✓" : "Kunde inte dela");
  }

  function updateLinkActions(){
    const id = (hashInput.value || "").trim();
    const ok = isValidId(id);
    const link = ok ? buildSelfLink(id) : "/verify.html";

    if (openLinkBtn){
      openLinkBtn.href = link;
      openLinkBtn.style.pointerEvents = ok ? "auto" : "none";
      openLinkBtn.style.opacity = ok ? "1" : ".55";
    }
    if (shareLinkBtn) shareLinkBtn.disabled = !ok;
    if (copyLinkBtn) copyLinkBtn.disabled = !ok;
  }

  function setStatus(text){
    statusPill.textContent = text;
  }

  function setVerifyBtnTone(isReady){
    if (!verifyBtn) return;
    verifyBtn.classList.remove("primary");
    verifyBtn.classList.remove("soft");
    verifyBtn.classList.add(isReady ? "primary" : "soft");
  }

  function showAlert(title, help, tone){
    inputAlert.style.display = "block";
    inputAlertText.textContent = title || "";
    inputAlertHelp.textContent = help || "";

    if (tone === "err") {
      inputAlert.style.borderColor = "rgba(255,80,80,.35)";
      inputAlert.style.background = "rgba(255,80,80,.10)";
      inputAlertText.style.color = "rgba(255,220,220,.95)";
    } else if (tone === "ok") {
      inputAlert.style.borderColor = "rgba(80,255,180,.28)";
      inputAlert.style.background = "rgba(80,255,180,.08)";
      inputAlertText.style.color = "rgba(220,255,245,.95)";
    } else {
      inputAlert.style.borderColor = "rgba(255,255,255,.14)";
      inputAlert.style.background = "rgba(255,255,255,.06)";
      inputAlertText.style.color = "";
    }
  }

  function hideAlert(){
    inputAlert.style.display = "none";
    inputAlertText.textContent = "";
    inputAlertHelp.textContent = "";
  }

  function setBusy(v){
    busy = v;
    verifyBtn.disabled = v || !(currentFile && isValidId(hashInput.value));
    setVerifyBtnTone(!verifyBtn.disabled);
  }

  function bytesToHex(bytes){
    return [...bytes].map(b => b.toString(16).padStart(2,"0")).join("");
  }

  async function sha256Hex(file){
    const buf = await file.arrayBuffer();
    const dig = await crypto.subtle.digest("SHA-256", buf);
    return "0x" + bytesToHex(new Uint8Array(dig));
  }

  function resetCopyPill(pill){
    if (!pill) return;
    pill.style.display = "none";
    pill.textContent = "";
  }

  function resetUI(){
    resultBox.style.display = "none";
    errorBox.style.display = "none";
    errorMsg.textContent = "";
    if (openCertBtn) openCertBtn.style.display = "none";

    if (reportMeta) reportMeta.style.display = "none";

    if (copyIdIconBtn) copyIdIconBtn.style.display = "none";
    resetCopyPill(copyIdPill);

    if (copyFileHashIconBtn) copyFileHashIconBtn.style.display = "none";
    resetCopyPill(copyFileHashPill);

    if (copySummaryBtn) copySummaryBtn.style.display = "none";
    resetCopyPill(copySummaryPill);

    if (sendNoteToChatBtn) sendNoteToChatBtn.style.display = "none";

    if (summaryOut) summaryOut.textContent = "—";
    lastRun = null;

    outHash.textContent = "—";
    outFileHash.textContent = "—";
    outRegStatus.textContent = "—";
    outRegSe.textContent = "—";
    outRegUtc.textContent = "—";

    resultHeadline.textContent = "";
    outExplainTitle.textContent = "";
    outExplainBody.textContent = "";

    if (outExplain){
      outExplain.style.borderColor = "rgba(255,255,255,.14)";
      outExplain.style.background = "rgba(255,255,255,.06)";
    }

    if (outHash){
      outHash.style.outline = "";
      outHash.style.outlineOffset = "";
      outHash.style.background = "rgba(255,255,255,.03)";
    }
    if (outFileHash){
      outFileHash.style.outline = "";
      outFileHash.style.outlineOffset = "";
      outFileHash.style.background = "rgba(255,255,255,.03)";
    }
  }

  function getIdFromUrl(){
    const url = new URL(location.href);
    return (url.searchParams.get("hash") || url.searchParams.get("id") || "").trim();
  }

  function setIdInUrl(id){
    const url = new URL(location.href);
    if (id) {
      url.searchParams.set("hash", id);
      url.searchParams.delete("id");
    } else {
      url.searchParams.delete("hash");
      url.searchParams.delete("id");
    }
    history.replaceState({}, "", url.toString());
  }

  function isoUtcNoMs(d){
    return d.toISOString().replace("T"," ").replace(/\.\d{3}Z$/, " UTC");
  }

  function fmtSe(ts){
    try{
      return new Intl.DateTimeFormat("sv-SE", {
        timeZone:"Europe/Stockholm",
        year:"numeric", month:"2-digit", day:"2-digit",
        hour:"2-digit", minute:"2-digit", second:"2-digit"
      }).format(new Date(Number(ts) * 1000)) + " (Europe/Stockholm)";
    } catch {
      return "—";
    }
  }

  function fmtUtc(ts){
    try{
      return isoUtcNoMs(new Date(Number(ts) * 1000));
    } catch {
      return "—";
    }
  }

  async function fetchVerify(hash){
    try{
      const r = await fetch(`/api/verify?hash=${encodeURIComponent(hash)}`, { method:"GET" });
      const j = await r.json().catch(() => ({}));
      if (r.ok && typeof j?.exists === "boolean") return { ok:true, data:j };
    } catch {}

    const r2 = await fetch(`/api/verify`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ hash })
    });
    const j2 = await r2.json().catch(() => ({}));
    if (!r2.ok) return { ok:false, error: j2?.error || `HTTP ${r2.status}` };
    return { ok:true, data:j2 };
  }

  function buildSummaryText(run){
    if (!run) return "—";

    const lines = [];
    lines.push("PROOFY – Verifieringsnotering");
    lines.push("");
    lines.push(`Verifierings-ID: ${run.refHash || "—"}`);
    if (run.fileName) lines.push(`Underlag: ${run.fileName}`);
    if (run.fileSizeMb != null) lines.push(`Filstorlek: ${run.fileSizeMb} MB`);
    lines.push(`Resultat: ${run.match ? "OFÖRÄNDRAT UNDERLAG (överensstämmer med referensen)" : "AVVIKELSE (annan filversion än referensen)"}`);
    lines.push("");
    if (run.exists === true) {
      lines.push("Registreringsstatus: Registrerad");
      if (run.regSe) lines.push(`Registreringstid (SE): ${run.regSe}`);
      if (run.regUtc) lines.push(`Registreringstid (UTC): ${run.regUtc}`);
    } else if (run.exists === false) {
      lines.push("Registreringsstatus: Ej registrerad");
    } else {
      lines.push("Registreringsstatus: Kunde inte kontrolleras (tillfälligt tekniskt fel)");
    }
    lines.push("");
    lines.push(`Tidpunkt för verifiering: ${new Date().toLocaleString("sv-SE")}`);
    return lines.join("\n");
  }

  function setExplainTone(match){
    if (!outExplain) return;
    if (match === true) {
      outExplain.style.borderColor = "rgba(80,255,180,.22)";
      outExplain.style.background = "rgba(80,255,180,.07)";
      return;
    }
    if (match === false) {
      outExplain.style.borderColor = "rgba(255,80,80,.22)";
      outExplain.style.background = "rgba(255,80,80,.07)";
      return;
    }
    outExplain.style.borderColor = "rgba(255,255,255,.14)";
    outExplain.style.background = "rgba(255,255,255,.06)";
  }

  function applyCopyHover(fieldEl, iconBtnEl, enabled){
    if (!fieldEl) return;

    if (!enabled){
      fieldEl.onmouseenter = null;
      fieldEl.onmouseleave = null;
      fieldEl.onfocus = null;
      fieldEl.onblur = null;
      if (iconBtnEl) iconBtnEl.style.display = "none";
      return;
    }

    const onEnter = () => {
      if (iconBtnEl) iconBtnEl.style.display = "inline-flex";
      fieldEl.style.outline = "1px solid rgba(255,255,255,.14)";
      fieldEl.style.outlineOffset = "2px";
      fieldEl.style.background = "rgba(255,255,255,.05)";
    };

    const onLeave = () => {
      if (iconBtnEl) iconBtnEl.style.display = "none";
      fieldEl.style.outline = "";
      fieldEl.style.outlineOffset = "";
      fieldEl.style.background = "rgba(255,255,255,.03)";
    };

    fieldEl.onmouseenter = onEnter;
    fieldEl.onmouseleave = onLeave;

    fieldEl.onfocus = () => {
      if (iconBtnEl) iconBtnEl.style.display = "inline-flex";
      fieldEl.style.outline = "2px solid rgba(120, 180, 255, .25)";
      fieldEl.style.outlineOffset = "2px";
    };
    fieldEl.onblur = () => {
      if (iconBtnEl) iconBtnEl.style.display = "none";
      fieldEl.style.outline = "";
      fieldEl.style.outlineOffset = "";
    };
  }

  async function copyWithPill({ text, pillEl }){
    if (!pillEl) return false;

    const t = String(text || "").trim();
    if (!t || t === "—") return false;

    pillEl.style.display = "inline-block";
    pillEl.textContent = "Kopierar…";
    const ok = await copyTextToClipboard(t); // ✅ STEG 2: robust kopiering
    pillEl.textContent = ok ? "Kopierad ✓" : "Kunde inte kopiera";
    if (ok){
      setTimeout(() => {
        pillEl.style.display = "none";
        pillEl.textContent = "";
      }, 1400);
    }
    return ok;
  }

  // Skapa en kort “kommando-payload” som chatten kan tolka, och skicka direkt
  function buildChatCommandForNote(run){
    if (!run) return "";
    const payload = {
      t: "proofy_note_v1",
      refHash: run.refHash || "",
      fileName: run.fileName || "",
      fileSizeMb: run.fileSizeMb != null ? String(run.fileSizeMb) : "",
      match: Boolean(run.match),
      exists: run.exists, // true/false/null
      regSe: run.regSe || "",
      regUtc: run.regUtc || "",
      verifySe: new Date().toLocaleString("sv-SE")
    };
    return `__PROOFY_NOTE__ ${JSON.stringify(payload)}`;
  }

  function openChatWithNote(run){
    const cmd = buildChatCommandForNote(run);
    if (!cmd) return false;

    // öppna chatten (om widget finns)
    const chatBtn = document.querySelector(".proofy-chat-btn");
    if (chatBtn) chatBtn.click();

    // fyll och skicka direkt (utan att användaren behöver se “prompttext”)
    const input = document.querySelector(".proofy-panel .proofy-input");
    const sendBtn = document.querySelector(".proofy-panel .proofy-send");
    if (!input || !sendBtn) return false;

    input.value = cmd;
    sendBtn.click();
    return true;
  }

  function updateValidationUI(){
    const id = (hashInput.value || "").trim();

    updateLinkActions();

    if (!id && !currentFile){
      hideAlert();
      setStatus("Förbered verifiering");
      setBusy(false);
      return;
    }

    if (!id){
      showAlert(
        "⚠️ Ange Verifierings-ID för att kunna verifiera",
        "Klistra in ID (format: 0x + 64 hex-tecken) eller öppna verifieringslänken du fått.",
        "err"
      );
      setStatus("Ange Verifierings-ID");
      setBusy(false);
      return;
    }

    if (!isValidId(id)){
      showAlert(
        "⚠️ Ogiltigt Verifierings-ID",
        "Kontrollera att ID börjar med 0x och innehåller exakt 64 hex-tecken (0–9, a–f).",
        "err"
      );
      setStatus("Åtgärd krävs");
      setBusy(false);
      return;
    }

    hideAlert();

    if (!currentFile) {
      setStatus("Välj underlag");
      setBusy(false);
      return;
    }

    setStatus("Redo att verifiera");
    setBusy(false);
  }

  // ✅ STEG 2: gemensam fil-setter (för både välj-fil och drag-drop)
  function setFile(file){
    currentFile = file || null;
    fileInfo.textContent = currentFile
      ? `Valt underlag: ${currentFile.name} (${(currentFile.size/1024/1024).toFixed(2)} MB)`
      : "Inget underlag valt.";
    updateValidationUI();
  }

  // init URL
  const urlId = getIdFromUrl();
  if (isValidId(urlId)) {
    hashInput.value = urlId;
    setIdInUrl(urlId);
  }

  // bind share/copy actions
  if (shareLinkBtn){
    shareLinkBtn.addEventListener("click", async () => {
      const id = (hashInput.value || "").trim();
      if (!isValidId(id)) return;
      await shareOrFallback(buildSelfLink(id));
    });
  }
  if (copyLinkBtn){
    copyLinkBtn.addEventListener("click", async () => {
      const id = (hashInput.value || "").trim();
      if (!isValidId(id)) return;
      const link = buildSelfLink(id);
      const ok = await tryCopy(link);
      showLinkPill(ok ? "Kopierad ✓" : "Kunde inte kopiera");
    });
  }

  hashInput.addEventListener("input", () => {
    const v = hashInput.value.trim();
    if (isValidId(v)) setIdInUrl(v);
    updateValidationUI();
  });

  fileInput.addEventListener("change", () => {
    setFile(fileInput.files?.[0] || null); // ✅ STEG 2
  });

  // ✅ STEG 2: drag & drop (som register.html)
  if (dropZone){
    dropZone.addEventListener("dragover", (e) => { e.preventDefault(); dropZone.classList.add("drag"); });
    dropZone.addEventListener("dragleave", () => dropZone.classList.remove("drag"));
    dropZone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropZone.classList.remove("drag");
      const f = e.dataTransfer?.files?.[0];
      if (f) setFile(f);
    });
  }

  if (outHash) {
    outHash.addEventListener("click", async () => {
      await copyWithPill({ text: outHash.textContent, pillEl: copyIdPill });
    });
    outHash.addEventListener("keydown", async (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        await copyWithPill({ text: outHash.textContent, pillEl: copyIdPill });
      }
    });
  }

  if (copyIdIconBtn) {
    copyIdIconBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      e.stopPropagation();
      await copyWithPill({ text: outHash.textContent, pillEl: copyIdPill });
    });
  }

  if (outFileHash) {
    outFileHash.addEventListener("click", async () => {
      await copyWithPill({ text: outFileHash.textContent, pillEl: copyFileHashPill });
    });
    outFileHash.addEventListener("keydown", async (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        await copyWithPill({ text: outFileHash.textContent, pillEl: copyFileHashPill });
      }
    });
  }

  if (copyFileHashIconBtn) {
    copyFileHashIconBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      e.stopPropagation();
      await copyWithPill({ text: outFileHash.textContent, pillEl: copyFileHashPill });
    });
  }

  if (copySummaryBtn) {
    copySummaryBtn.addEventListener("click", async () => {
      if (!lastRun) return;
      const txt = buildSummaryText(lastRun);
      await copyWithPill({ text: txt, pillEl: copySummaryPill });
    });
  }

  if (sendNoteToChatBtn) {
    sendNoteToChatBtn.addEventListener("click", () => {
      if (!lastRun) return;
      const ok = openChatWithNote(lastRun);
      if (!ok) {
        const txt = buildSummaryText(lastRun);
        copyWithPill({ text: txt, pillEl: copySummaryPill });
      }
    });
  }

  verifyBtn.addEventListener("click", async () => {
    if (busy) return;

    resetUI();

    const refHash = hashInput.value.trim();
    if (!isValidId(refHash)) {
      showAlert(
        "⚠️ Verifiering kan inte starta – ogiltigt Verifierings-ID",
        "Kontrollera ID (0x + 64 hex-tecken).",
        "err"
      );
      setStatus("Åtgärd krävs");
      hashInput.focus();
      return;
    }
    if (!currentFile) {
      showAlert(
        "⚠️ Välj ett underlag att verifiera",
        "Välj filen du vill kontrollera. Underlaget lämnar aldrig din dator.",
        "err"
      );
      setStatus("Välj underlag");
      fileInput.focus();
      return;
    }

    setStatus("Verifierar…");
    setBusy(true);

    const myOp = ++opId;

    try{
      const fileHash = await sha256Hex(currentFile);
      if (myOp !== opId) return;

      const match = (fileHash.toLowerCase() === refHash.toLowerCase());

      const verifyRes = await fetchVerify(refHash);
      if (myOp !== opId) return;

      resultBox.style.display = "block";
      if (reportMeta) reportMeta.style.display = "block";

      outHash.textContent = refHash;
      outFileHash.textContent = fileHash;

      applyCopyHover(outHash, copyIdIconBtn, true);
      applyCopyHover(outFileHash, copyFileHashIconBtn, true);

      if (match) {
        resultHeadline.style.borderColor = "rgba(80,255,180,.20)";
        resultHeadline.style.background = "rgba(80,255,180,.06)";
        resultHeadline.innerHTML = `<span class="ok">✅ Oförändrat underlag</span> <span class="meta">(överensstämmer med referensen)</span>`;
      } else {
        resultHeadline.style.borderColor = "rgba(255,80,80,.20)";
        resultHeadline.style.background = "rgba(255,80,80,.06)";
        resultHeadline.innerHTML = `<span class="err">⚠️ Avvikelse</span> <span class="meta">(annan filversion än referensen)</span>`;
      }

      setExplainTone(match);

      if (match) {
        outExplainTitle.textContent = "Underlaget överensstämmer med referensen.";
        outExplainBody.textContent =
          "Detta innebär att filen är identisk med referensen (samma bytes). Det säger inget om innehållets riktighet – endast att filversionen inte har ändrats.";
      } else {
        outExplainTitle.textContent = "Underlaget avviker från referensen.";
        outExplainBody.textContent =
          "Detta innebär att filen inte är identisk med referensen. Vanliga orsaker: ny export, omskanning, konvertering eller att fel fil valts.";
      }

      let exists = null;
      let ts = null;

      if (!verifyRes.ok) {
        outRegStatus.textContent = "Kunde inte kontrollera registreringsstatus (tillfälligt tekniskt problem).";
        outRegSe.textContent = "—";
        outRegUtc.textContent = "—";
      } else {
        const data = verifyRes.data || {};
        exists = Boolean(data.exists);
        ts = data.timestamp ? Number(data.timestamp) : null;

        outRegStatus.textContent = exists ? "Registrerad" : "Ej registrerad";
        outRegSe.textContent = (exists && ts) ? fmtSe(ts) : "—";
        outRegUtc.textContent = (exists && ts) ? fmtUtc(ts) : "—";
      }

      if (openCertBtn) {
        openCertBtn.href = `/certificate.html?hash=${encodeURIComponent(refHash)}`;
        openCertBtn.style.display = "inline-flex";
      }

      lastRun = {
        refHash,
        match,
        exists,
        regSe: (exists && ts) ? fmtSe(ts) : null,
        regUtc: (exists && ts) ? fmtUtc(ts) : null,
        fileName: currentFile?.name || "",
        fileSizeMb: currentFile ? (currentFile.size/1024/1024).toFixed(2) : null
      };

      const summaryText = buildSummaryText(lastRun);
      if (summaryOut) summaryOut.textContent = summaryText;

      if (copySummaryBtn) copySummaryBtn.style.display = "inline-flex";
      if (sendNoteToChatBtn) sendNoteToChatBtn.style.display = "inline-flex";

      hideAlert();

      setStatus("Verifiering klar");
      setBusy(false);
    } catch (e){
      if (myOp !== opId) return;
      errorBox.style.display = "block";
      errorMsg.textContent = e?.message || "Tekniskt fel.";
      setStatus("Åtgärd krävs");
      setBusy(false);
    }
  });

  updateValidationUI();
})();
</script>

<script src="/assets/header-toggle.js?v=2025-12-24a" defer></script>
<script src="/chat-widget.js?v=2025-12-24a" defer></script>
</body>
</html>
