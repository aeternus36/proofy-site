<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proofy – Verifiera underlag</title>
  <meta name="description" content="Verifiera om en fil är oförändrad jämfört med ett registrerat Verifierings-ID." />
  <meta name="theme-color" content="#0b1220" />

  <link rel="stylesheet" href="/assets/proofy.css?v=2025-12-24a" />
  <link rel="stylesheet" href="/assets/header.css?v=2025-12-24a" />
</head>

<body>
<a class="skip" href="#main">Hoppa till innehåll</a>

<header>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="/" aria-label="Proofy">
        <span class="logo" aria-hidden="true"></span>
        <span>Proofy</span>
      </a>

      <!-- Desktop actions -->
      <div class="navActions" id="navActionsDesktop">
        <a class="btn" href="/register.html">Skapa Verifierings-ID</a>
        <a class="btn soft" href="/pilot.html">Starta pilot</a>
        <a class="btn primary" href="/#kontakt">Boka kort demo</a>
      </div>

      <!-- Mobile menu -->
      <details class="mnav" id="mnav">
        <summary class="mnavSummary" aria-label="Öppna meny">
          <span class="mnavIcon" aria-hidden="true"></span>
        </summary>

        <nav class="mnavMenu" aria-label="Meny">
          <!-- Visa aktuell sida överst (men inte som “knapp” på desktop) -->
          <a class="mnavLink" href="/verify.html" aria-current="page">Verifiera underlag</a>
          <a class="mnavLink" href="/register.html">Skapa Verifierings-ID</a>
          <a class="mnavLink" href="/pilot.html">Starta pilot</a>
          <a class="mnavLink mnavLinkPrimary" href="/#kontakt">Boka kort demo</a>

          <div class="mnavMeta">
            <div class="mnavNote">Verifiering · revision · granskning</div>
            <a class="mnavMail" href="mailto:kontakt@proofy.se">kontakt@proofy.se</a>
          </div>
        </nav>
      </details>
    </div>
  </div>
</header>

<main id="main">
  <div class="wrap">
    <div class="badge">Verifiering · revision · granskning</div>

    <h1 class="pageTitle">Verifiera underlag</h1>

    <p class="lead">
      Kontrollera om ett underlag är samma version som det som tidigare fastställdes.
      Underlaget lämnar aldrig din dator.
    </p>

    <div class="card content" style="margin-top:14px;">
      <div class="grid2">

        <section aria-label="Verifieringsuppgifter">
          <div style="font-weight:950; font-size:16px;">1. Ange Verifierings-ID</div>

          <label class="meta" for="hashInput" style="margin-top:8px;">Verifierings-ID</label>
          <input id="hashInput" type="text" placeholder="0x…" autocomplete="off" spellcheck="false" style="margin-top:6px" />

          <div class="small" style="margin-top:8px">
            ID:t fylls i automatiskt om du öppnat sidan via verifieringslänk.
          </div>

          <div class="hr"></div>

          <div style="font-weight:950; font-size:16px;">2. Välj underlag att kontrollera</div>

          <input id="fileInput" type="file" style="margin-top:8px" />
          <div id="fileInfo" class="meta" style="margin-top:8px">Inget underlag valt.</div>

          <div class="actions" style="margin-top:14px">
            <button class="btn primary" id="verifyBtn" disabled>Verifiera underlag</button>
            <span id="statusPill" class="pill">Väntar</span>
          </div>

          <!-- NY: tydligare påminnelse/varning (syns när det behövs) -->
          <div id="hintBox" class="small" style="display:none; margin-top:10px;">
            <span class="err" id="hintText"></span>
          </div>

          <p class="small" style="margin-top:12px; margin-bottom:0;">
            <b>Tips:</b> Ny export/omskanning kan ge annan filversion även om dokumentet “ser likadant ut”.
          </p>
        </section>

        <section aria-label="Resultat">
          <div style="font-weight:950; font-size:16px;">Resultat</div>
          <div class="hr"></div>

          <div id="resultBox" style="display:none;">
            <div id="resultHeadline" style="font-size:20px; font-weight:900;"></div>

            <!-- NY: tydligare förklaring vid ingen match -->
            <div id="resultNote" class="small" style="display:none; margin-top:10px;"></div>

            <div class="meta" style="margin-top:12px;">Verifierings-ID</div>
            <pre class="mono" id="outHash">—</pre>

            <div class="meta" style="margin-top:10px;">Underlagets fingeravtryck</div>
            <pre class="mono" id="outFileHash">—</pre>

            <div class="hr"></div>

            <div class="meta">Registreringsstatus</div>
            <div id="outRegStatus" class="mono">—</div>

            <div class="meta" style="margin-top:10px;">Registreringstid (Sverige)</div>
            <pre class="mono" id="outRegSe">—</pre>

            <div class="meta" style="margin-top:10px;">Registreringstid (UTC)</div>
            <pre class="mono" id="outRegUtc">—</pre>

            <div class="small" style="margin-top:10px">
              <b>Match</b> betyder att underlaget är <b>exakt samma version</b> (samma bytes) som den som ID:t avser.
              <br />
              Proofy avgör inte vem som skapat underlaget eller om innehållet är korrekt – endast om filversionen är identisk.
            </div>

            <div class="actions" style="margin-top:12px">
              <a class="btn soft" id="openCertBtn" href="/certificate.html" style="display:none;">Öppna intyg</a>
            </div>
          </div>

          <div id="errorBox" style="display:none;">
            <div class="err">Verifiering kunde inte genomföras</div>
            <div id="errorMsg" class="mono" style="margin-top:8px"></div>
          </div>
        </section>

      </div>
    </div>

    <p class="meta" style="margin-top:14px">
      Proofy avgör inte om innehållet är korrekt – endast om underlaget är oförändrat jämfört med referensen.
    </p>
  </div>
</main>

<footer>
  <div class="wrap">
    <div class="foot">
      <div>
        <div style="color: rgba(234,240,255,.86); font-weight:800;">Proofy</div>
        <div class="small">© 2025 Proofy. Alla rättigheter förbehållna.</div>
        <div class="small" style="margin-top:8px; max-width:92ch;">
          Proofy tillhandahåller teknisk tidsstämpling och verifiering av filer. Tjänsten utgör inte juridisk rådgivning och avgör inte filens rättsliga giltighet.
        </div>
      </div>
      <div class="links">
        <a href="/security.html">Säkerhet</a>
        <a href="/privacy.html">Integritet</a>
        <a href="/terms.html">Villkor</a>
        <a href="/#kontakt">Kontakt</a>
      </div>
    </div>
  </div>
</footer>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const hashInput = $("hashInput");
  const fileInput = $("fileInput");
  const fileInfo = $("fileInfo");
  const verifyBtn = $("verifyBtn");
  const statusPill = $("statusPill");

  const hintBox = $("hintBox");
  const hintText = $("hintText");

  const resultBox = $("resultBox");
  const resultHeadline = $("resultHeadline");
  const resultNote = $("resultNote");
  const outHash = $("outHash");
  const outFileHash = $("outFileHash");
  const outRegStatus = $("outRegStatus");
  const outRegSe = $("outRegSe");
  const outRegUtc = $("outRegUtc");
  const openCertBtn = $("openCertBtn");

  const errorBox = $("errorBox");
  const errorMsg = $("errorMsg");

  let currentFile = null;
  let busy = false;
  let opId = 0;

  function isValidId(h){
    return /^0x[0-9a-fA-F]{64}$/.test((h || "").trim());
  }

  function setStatus(text){
    statusPill.textContent = text;
  }

  function showHint(msg){
    hintText.textContent = msg || "";
    hintBox.style.display = msg ? "block" : "none";
  }

  function setBusy(v){
    busy = v;
    verifyBtn.disabled = v || !(currentFile && isValidId(hashInput.value));
  }

  function bytesToHex(bytes){
    return [...bytes].map(b => b.toString(16).padStart(2,"0")).join("");
  }

  async function sha256Hex(file){
    const buf = await file.arrayBuffer();
    const dig = await crypto.subtle.digest("SHA-256", buf);
    return "0x" + bytesToHex(new Uint8Array(dig));
  }

  function resetUI(){
    resultBox.style.display = "none";
    errorBox.style.display = "none";
    errorMsg.textContent = "";
    showHint("");

    if (openCertBtn) openCertBtn.style.display = "none";

    outHash.textContent = "—";
    outFileHash.textContent = "—";
    outRegStatus.textContent = "—";
    outRegSe.textContent = "—";
    outRegUtc.textContent = "—";
    resultHeadline.textContent = "";

    if (resultNote) {
      resultNote.style.display = "none";
      resultNote.textContent = "";
    }
  }

  function getIdFromUrl(){
    const url = new URL(location.href);
    return (url.searchParams.get("hash") || url.searchParams.get("id") || "").trim();
  }

  function setIdInUrl(id){
    const url = new URL(location.href);
    if (id) {
      url.searchParams.set("hash", id);
      url.searchParams.delete("id");
    } else {
      url.searchParams.delete("hash");
      url.searchParams.delete("id");
    }
    history.replaceState({}, "", url.toString());
  }

  function isoUtcNoMs(d){
    return d.toISOString().replace("T"," ").replace(/\.\d{3}Z$/, " UTC");
  }

  function fmtSe(ts){
    try{
      return new Intl.DateTimeFormat("sv-SE", {
        timeZone:"Europe/Stockholm",
        year:"numeric", month:"2-digit", day:"2-digit",
        hour:"2-digit", minute:"2-digit", second:"2-digit"
      }).format(new Date(Number(ts) * 1000)) + " (Europe/Stockholm)";
    } catch {
      return "—";
    }
  }

  function fmtUtc(ts){
    try{
      return isoUtcNoMs(new Date(Number(ts) * 1000));
    } catch {
      return "—";
    }
  }

  async function fetchVerify(hash){
    try{
      const r = await fetch(`/api/verify?hash=${encodeURIComponent(hash)}`, { method:"GET" });
      const j = await r.json().catch(() => ({}));
      if (r.ok && typeof j?.exists === "boolean") return { ok:true, data:j };
    } catch { /* ignore */ }

    const r2 = await fetch(`/api/verify`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ hash })
    });
    const j2 = await r2.json().catch(() => ({}));
    if (!r2.ok) return { ok:false, error: j2?.error || `HTTP ${r2.status}` };
    return { ok:true, data:j2 };
  }

  function updateGuidance(){
    if (busy) return;

    const idOk = isValidId(hashInput.value);
    const hasFile = Boolean(currentFile);

    // Om användaren valt fil men saknar/har ogiltigt ID: visa tydlig påminnelse.
    if (hasFile && !idOk){
      const v = (hashInput.value || "").trim();
      if (!v) {
        showHint("Verifierings-ID saknas. Klistra in ID (format: 0x + 64 hex-tecken) eller öppna verifieringslänken.");
        setStatus("Ange Verifierings-ID");
      } else {
        showHint("Ogiltigt Verifierings-ID. Kontrollera att det börjar med 0x och innehåller 64 hex-tecken.");
        setStatus("Ogiltigt ID");
      }
    } else {
      showHint("");
      if (!hasFile) setStatus("Väntar");
      else setStatus("Redo");
    }

    setBusy(false);
  }

  const urlId = getIdFromUrl();
  if (isValidId(urlId)) {
    hashInput.value = urlId;
    setIdInUrl(urlId);
  }

  hashInput.addEventListener("input", () => {
    const v = hashInput.value.trim();
    if (isValidId(v)) setIdInUrl(v);
    resetUI();
    updateGuidance();
  });

  fileInput.addEventListener("change", () => {
    currentFile = fileInput.files?.[0] || null;
    fileInfo.textContent = currentFile
      ? `Valt underlag: ${currentFile.name} (${(currentFile.size/1024/1024).toFixed(2)} MB)`
      : "Inget underlag valt.";
    resetUI();
    updateGuidance();
  });

  verifyBtn.addEventListener("click", async () => {
    if (busy) return;

    resetUI();
    setStatus("Verifierar…");
    setBusy(true);

    const myOp = ++opId;

    try{
      const refHash = hashInput.value.trim();
      if (!isValidId(refHash)) throw new Error("Ogiltigt Verifierings-ID (måste vara 0x + 64 hex-tecken).");
      if (!currentFile) throw new Error("Välj ett underlag att verifiera.");

      const fileHash = await sha256Hex(currentFile);
      if (myOp !== opId) return;

      const match = (fileHash.toLowerCase() === refHash.toLowerCase());

      const verifyRes = await fetchVerify(refHash);
      if (myOp !== opId) return;

      resultBox.style.display = "block";
      outHash.textContent = refHash;
      outFileHash.textContent = fileHash;

      if (match){
        resultHeadline.innerHTML = `<span class="ok">✅ Match</span>`;
        if (resultNote) {
          resultNote.style.display = "none";
          resultNote.textContent = "";
        }
      } else {
        resultHeadline.innerHTML = `<span class="err">❌ Ingen match – filversionen är inte identisk</span>`;
        if (resultNote) {
          resultNote.style.display = "block";
          resultNote.innerHTML =
            "Underlaget du valt är <b>inte samma filversion (bytes)</b> som den som Verifierings-ID:t avser.<br/>" +
            "Vanliga orsaker: ny export, omskanning, konvertering eller att fel fil valts.<br/>" +
            "<b>Åtgärd:</b> be om originalfilen som registrerades, eller skapa nytt Verifierings-ID för aktuell version och dokumentera tidpunkt.";
        }
      }

      if (!verifyRes.ok) {
        outRegStatus.textContent = "Kunde inte kontrollera registreringsstatus (tillfälligt tekniskt problem).";
        outRegSe.textContent = "—";
        outRegUtc.textContent = "—";
      } else {
        const data = verifyRes.data || {};
        const exists = Boolean(data.exists);
        const ts = data.timestamp ? Number(data.timestamp) : null;

        outRegStatus.textContent = exists ? "Registrerad" : "Ej registrerad";
        outRegSe.textContent = (exists && ts) ? fmtSe(ts) : "—";
        outRegUtc.textContent = (exists && ts) ? fmtUtc(ts) : "—";
      }

      if (openCertBtn) {
        openCertBtn.href = `/certificate.html?hash=${encodeURIComponent(refHash)}`;
        openCertBtn.style.display = "inline-flex";
      }

      setStatus("Klar");
      setBusy(false);
      showHint("");
    } catch (e){
      if (myOp !== opId) return;
      errorBox.style.display = "block";
      errorMsg.textContent = e?.message || "Tekniskt fel.";
      setStatus("Fel");
      setBusy(false);
      updateGuidance();
    }
  });

  setStatus("Väntar");
  setBusy(false);
  updateGuidance();
})();
</script>

<script src="/assets/header-toggle.js?v=2025-12-24a" defer></script>
<script src="/chat-widget.js?v=2025-12-24a" defer></script>
</body>
</html>
