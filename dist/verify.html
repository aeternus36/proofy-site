<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proofy – Verifiera underlag</title>
  <meta name="description" content="Verifiera om ett underlag matchar registrerad filversion – genom Verifierings-ID eller genom att välja fil lokalt." />
  <meta name="theme-color" content="#0b1220" />
  <link rel="stylesheet" href="/assets/proofy.css?v=2025-12-20" />
</head>

<body>
<a class="skip" href="#main">Hoppa till innehåll</a>

<header>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="/" aria-label="Proofy">
        <span class="logo" aria-hidden="true"></span>
        <span>Proofy</span>
      </a>

      <div class="navLinks" aria-label="Navigation">
        <a href="/">Start</a>
        <a href="/verify.html">Verifiera</a>
        <a href="/hash.html">Skapa ID</a>
        <a href="/terms.html">Villkor</a>
      </div>

      <div class="navActions">
        <a class="btn" href="/hash.html">Skapa Verifierings-ID</a>
        <a class="btn primary" href="/#kontakt">Boka demo</a>
      </div>
    </div>
  </div>
</header>

<main id="main">
  <div class="wrap">
    <h1 class="pageTitle">Verifiera underlag</h1>
    <p class="lead" style="font-size:16.8px;">
      Verifiera via fil (lokalt) eller genom att klistra in ett <b>Verifierings-ID</b>.
      Om du har en delbar länk kan den se ut så här:
      <span class="mono">/verify.html?id=…</span>
    </p>

    <section class="card content">
      <div class="grid2">

        <div>
          <div style="font-weight:950; font-size:16px;">Verifiera via fil</div>
          <p class="meta" style="margin-top:8px">
            Välj en fil så kontrollerar vi om den matchar en registrerad version.
            Filen hanteras lokalt i webbläsaren.
          </p>

          <input id="fileInput" type="file" />
          <div id="dropZone" class="drop" style="margin-top:10px">Dra & släpp fil här</div>

          <div id="fileInfo" class="meta" style="margin-top:10px">Ingen fil vald.</div>

          <div class="actions" style="margin-top:12px">
            <button class="btn primary" id="fileVerifyBtn" disabled>Verifiera via fil</button>
            <span id="statusPill" class="pill">Välj en fil eller ange ID</span>
          </div>

          <div id="localIdBox" style="display:none;margin-top:12px">
            <div class="meta">Beräknat Verifierings-ID</div>
            <div id="localIdOut" class="mono" style="margin-top:8px">—</div>
          </div>

          <div class="small" style="margin-top:10px">
            Tips: Om någon skickar en ny filversion i efterhand kan verifieringen visa “ingen match”.
          </div>
        </div>

        <div>
          <div style="font-weight:950; font-size:16px;">Verifiera via Verifierings-ID</div>
          <label class="meta" style="display:block;margin-top:10px" for="idInput">Verifierings-ID</label>
          <input id="idInput" type="text" placeholder="Klistra in Verifierings-ID" />

          <div class="actions" style="margin-top:12px">
            <button class="btn primary" id="verifyBtn" type="button">Verifiera</button>
            <button class="btn" id="copyLinkBtn" type="button">Kopiera verifieringslänk</button>
            <a class="btn soft" id="openCertBtn" href="/certificate.html" style="pointer-events:none;opacity:.55;">Öppna intyg</a>
          </div>

          <div class="hr"></div>

          <div id="status" class="meta"></div>

          <div id="resultBox" class="card" style="display:none;margin-top:10px; padding:14px; background:rgba(11,18,32,.25); border:1px solid rgba(255,255,255,.12); border-radius:16px;"></div>

          <p class="small" style="margin-top:12px;">
            <b>Juridik (kort):</b> Proofy visar om filen matchar registrerad version. Det är inte ett intyg om innehållets korrekthet eller upphov.
          </p>
        </div>

      </div>
    </section>
  </div>
</main>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const fileInput = $("fileInput");
  const dropZone = $("dropZone");
  const fileInfo = $("fileInfo");
  const fileVerifyBtn = $("fileVerifyBtn");
  const localIdBox = $("localIdBox");
  const localIdOut = $("localIdOut");

  const idInput = $("idInput");
  const verifyBtn = $("verifyBtn");
  const copyLinkBtn = $("copyLinkBtn");
  const openCertBtn = $("openCertBtn");
  const status = $("status");
  const statusPill = $("statusPill");
  const resultBox = $("resultBox");

  let currentFile = null;
  let busy = false;
  let opId = 0;

  function setBusy(v){
    busy = v;
    fileVerifyBtn.disabled = !currentFile || busy;
    verifyBtn.disabled = busy;
    copyLinkBtn.disabled = busy;
  }

  function setStatus(msg, cls="meta"){
    status.textContent = msg || "";
    status.className = cls;
  }

  function setPill(msg){
    statusPill.textContent = msg || "—";
  }

  function resetResults(){
    localIdBox.style.display = "none";
    localIdOut.textContent = "—";
    resultBox.style.display = "none";
    resultBox.innerHTML = "";
    setStatus("");
  }

  function bytesToHex(bytes){
    return [...bytes].map(b => b.toString(16).padStart(2,"0")).join("");
  }

  async function computeIdFromFile(file){
    const buf = await file.arrayBuffer();
    const dig = await crypto.subtle.digest("SHA-256", buf);
    return "0x" + bytesToHex(new Uint8Array(dig));
  }

  function isIdFormat(h){
    return typeof h === "string" && /^0x[0-9a-fA-F]{64}$/.test(h);
  }

  function shareUrlForId(id){
    return `${location.origin}/verify.html?id=${encodeURIComponent(id)}`;
  }

  function fmtDateSv(timestampSeconds){
    try{
      return new Date(timestampSeconds * 1000).toLocaleString("sv-SE");
    } catch {
      return "—";
    }
  }

  async function verifyId(id, showWorking=true){
    if(!isIdFormat(id)){
      setStatus("Ange ett giltigt Verifierings-ID.", "err");
      setPill("Ogiltigt ID");
      openCertBtn.href = "/certificate.html";
      openCertBtn.style.pointerEvents = "none";
      openCertBtn.style.opacity = ".55";
      return;
    }

    const myOp = ++opId;
    setBusy(true);

    if(showWorking){
      setStatus("Verifierar…");
      setPill("Verifierar…");
    }

    resultBox.style.display = "none";
    resultBox.innerHTML = "";

    // cert link
    openCertBtn.href = `/certificate.html?id=${encodeURIComponent(id)}`;
    openCertBtn.style.pointerEvents = "auto";
    openCertBtn.style.opacity = "1";

    try{
      const r = await fetch("/api/verify",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ hash: id })
      });

      const j = await r.json().catch(() => ({}));
      if(myOp !== opId) return;

      if(!r.ok || !j.ok){
        setStatus("Tekniskt fel vid verifiering.", "err");
        setPill("Tekniskt fel");
        return;
      }

      const link = shareUrlForId(id);

      if(!j.exists){
        resultBox.innerHTML = `
          <div class="err">❌ Ingen registrering hittades</div>
          <div class="meta" style="margin-top:10px;">Verifierings-ID</div>
          <div class="mono" style="margin-top:8px;">${id}</div>
          <div class="meta" style="margin-top:10px;">Delbar verifieringslänk</div>
          <div class="mono" style="margin-top:8px;">${link}</div>
        `;
        setPill("Ingen match");
      } else {
        resultBox.innerHTML = `
          <div class="ok">✅ Match: registrerad version finns</div>
          <div class="meta" style="margin-top:10px;">Registrerad</div>
          <div class="mono" style="margin-top:8px;">${j.timestamp ? fmtDateSv(j.timestamp) : "—"}</div>
          <div class="meta" style="margin-top:10px;">Verifierings-ID</div>
          <div class="mono" style="margin-top:8px;">${id}</div>
          <div class="meta" style="margin-top:10px;">Delbar verifieringslänk</div>
          <div class="mono" style="margin-top:8px;">${link}</div>

          <details style="margin-top:12px;">
            <summary>Detaljer (valfritt)</summary>
            <p class="meta" style="margin:10px 0 0;">
              Detta kan hjälpa vid felsökning men behövs normalt inte i byråflödet.
            </p>
            <div class="meta" style="margin-top:10px;">Registrerad av</div>
            <div class="mono" style="margin-top:8px;">${j.submitter || "—"}</div>
          </details>
        `;
        setPill("Match ✅");
      }

      resultBox.style.display = "block";
      setStatus("");
    } finally {
      if(myOp === opId) setBusy(false);
    }
  }

  function setFile(file){
    currentFile = file || null;
    resetResults();

    if(!currentFile){
      fileInfo.textContent = "Ingen fil vald.";
      setPill("Välj en fil eller ange ID");
      fileVerifyBtn.disabled = true;
      return;
    }

    fileInfo.textContent = `Vald fil: ${currentFile.name} (${(currentFile.size/1024/1024).toFixed(2)} MB)`;
    setPill("Redo att verifiera");
    setBusy(false);
  }

  fileInput.addEventListener("change", () => setFile(fileInput.files?.[0] || null));

  dropZone.addEventListener("dragover", (e) => { e.preventDefault(); dropZone.classList.add("drag"); });
  dropZone.addEventListener("dragleave", () => dropZone.classList.remove("drag"));
  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("drag");
    const f = e.dataTransfer?.files?.[0];
    if(f) setFile(f);
  });

  fileVerifyBtn.addEventListener("click", async () => {
    if(!currentFile || busy) return;

    const myOp = ++opId;
    setBusy(true);
    setStatus("Skapar Verifierings-ID lokalt…");
    setPill("Arbetar…");

    resultBox.style.display = "none";
    resultBox.innerHTML = "";

    try{
      const id = await computeIdFromFile(currentFile);
      if(myOp !== opId) return;

      localIdBox.style.display = "block";
      localIdOut.textContent = id;
      idInput.value = id;

      setStatus("");
      setPill("Verifierar…");
      await verifyId(id, false);
    } catch (e){
      console.error(e);
      if(myOp !== opId) return;
      setStatus("Fel: kunde inte behandla filen.", "err");
      setPill("Fel");
    } finally {
      if(myOp === opId) setBusy(false);
    }
  });

  verifyBtn.addEventListener("click", () => verifyId((idInput.value || "").trim(), true));

  copyLinkBtn.addEventListener("click", async () => {
    const id = (idInput.value || "").trim();
    if(!isIdFormat(id)){
      setStatus("Ange ett giltigt Verifierings-ID innan du kopierar länk.", "err");
      setPill("Ogiltigt ID");
      return;
    }
    try{
      await navigator.clipboard.writeText(shareUrlForId(id));
      setStatus("Verifieringslänk kopierad ✅", "ok");
      setPill("Länk kopierad");
    } catch {
      setStatus("Kunde inte kopiera. Tillåt clipboard i webbläsaren.", "err");
      setPill("Kunde inte kopiera");
    }
  });

  // Auto from URL: prefer id= but support old hash= for bakåtkompatibilitet
  const p = new URLSearchParams(location.search);
  const urlId = (p.get("id") || p.get("hash") || "").trim();
  if(urlId){
    idInput.value = urlId;
    if(isIdFormat(urlId)){
      verifyId(urlId, true);
    } else {
      setStatus("Ogiltigt Verifierings-ID i länken.", "err");
      setPill("Ogiltigt ID");
    }
  } else {
    setPill("Välj en fil eller ange ID");
  }

  setBusy(false);
})();
</script>

<script src="/chat-widget.js?v=2025-01" defer></script>
</body>
</html>
