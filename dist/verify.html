<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proofy – Verifiera underlag</title>
  <meta name="description" content="Verifiera om en fil är oförändrad jämfört med ett registrerat Verifierings-ID." />
  <meta name="theme-color" content="#0b1220" />
  <link rel="stylesheet" href="/assets/proofy.css?v=2025-12-20" />
</head>

<body>
<a class="skip" href="#main">Hoppa till innehåll</a>

<header>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="/" aria-label="Proofy">
        <span class="logo" aria-hidden="true"></span>
        <span>Proofy</span>
      </a>

      <!-- Beslut A: inga ankarlänkar i headern (navLinks borttaget) -->

      <div class="navActions">
        <a class="btn soft" href="/pilot.html">Starta pilot</a>
        <a class="btn" href="/verify.html">Verifiera underlag</a>
        <a class="btn" href="/register.html">Skapa Verifierings-ID</a>
        <a class="btn primary" href="/#kontakt">Boka demo</a>
      </div>
    </div>
  </div>
</header>

<main id="main">
  <div class="wrap">
    <div class="badge">Verifiering · revision · granskning</div>

    <h1 class="pageTitle">Verifiera underlag</h1>

    <p class="lead">
      Kontrollera om en fil är <b>identisk</b> med den version som tidigare registrerats.
      Filen lämnar aldrig din dator.
    </p>

    <div class="card content" style="margin-top:14px;">
      <div class="grid2">

        <!-- LEFT -->
        <section aria-label="Verifieringsuppgifter">
          <div style="font-weight:950; font-size:16px;">1. Ange Verifierings-ID</div>

          <label class="meta" for="hashInput" style="margin-top:8px;">
            Verifierings-ID
          </label>
          <input
            id="hashInput"
            type="text"
            placeholder="0x…"
            autocomplete="off"
            spellcheck="false"
            style="margin-top:6px"
          />

          <div class="small" style="margin-top:8px">
            ID:t hämtas automatiskt om du öppnat sidan via verifieringslänk.
          </div>

          <div class="hr"></div>

          <div style="font-weight:950; font-size:16px;">2. Välj fil att kontrollera</div>

          <input id="fileInput" type="file" style="margin-top:8px" />
          <div id="fileInfo" class="meta" style="margin-top:8px">Ingen fil vald.</div>

          <div class="actions" style="margin-top:14px">
            <button class="btn primary" id="verifyBtn" disabled>Verifiera fil</button>
            <span id="statusPill" class="pill">Väntar</span>
          </div>
        </section>

        <!-- RIGHT -->
        <section aria-label="Resultat">
          <div style="font-weight:950; font-size:16px;">Resultat</div>
          <div class="hr"></div>

          <div id="resultBox" style="display:none;">
            <div id="resultHeadline" style="font-size:20px; font-weight:900;"></div>

            <div class="meta" style="margin-top:12px;">Verifierings-ID</div>
            <pre class="mono" id="outHash">—</pre>

            <div class="meta" style="margin-top:10px;">Filens fingeravtryck</div>
            <pre class="mono" id="outFileHash">—</pre>

            <div class="small" style="margin-top:10px">
              Match betyder att filen är <b>exakt samma version</b> (samma bytes) som den som registrerades.
            </div>
          </div>

          <div id="errorBox" style="display:none;">
            <div class="err">Verifiering kunde inte genomföras</div>
            <div id="errorMsg" class="mono" style="margin-top:8px"></div>
          </div>
        </section>

      </div>
    </div>

    <p class="meta" style="margin-top:14px">
      Proofy avgör inte om innehållet är korrekt – endast om filen är oförändrad jämfört med referensen.
    </p>
  </div>
</main>

<footer>
  <div class="wrap">
    <div class="foot">
      <div>
        <div style="color: rgba(234,240,255,.86); font-weight:800;">Proofy</div>
        <div class="small">© 2025 Proofy. Alla rättigheter förbehållna.</div>
        <div class="small" style="margin-top:8px; max-width:92ch;">
          Proofy tillhandahåller teknisk tidsstämpling och verifiering av filer. Tjänsten utgör inte juridisk rådgivning och avgör inte filens rättsliga giltighet.
        </div>
      </div>
      <div class="links">
        <a href="/security.html">Säkerhet</a>
        <a href="/privacy.html">Integritet</a>
        <a href="/terms.html">Villkor</a>
        <a href="/#kontakt">Kontakt</a>
      </div>
    </div>
  </div>
</footer>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const hashInput = $("hashInput");
  const fileInput = $("fileInput");
  const fileInfo = $("fileInfo");
  const verifyBtn = $("verifyBtn");
  const statusPill = $("statusPill");

  const resultBox = $("resultBox");
  const resultHeadline = $("resultHeadline");
  const outHash = $("outHash");
  const outFileHash = $("outFileHash");

  const errorBox = $("errorBox");
  const errorMsg = $("errorMsg");

  let currentFile = null;

  function isValidHash(h){
    return /^0x[0-9a-fA-F]{64}$/.test((h || "").trim());
  }

  function setStatus(text){
    statusPill.textContent = text;
  }

  function bytesToHex(bytes){
    return [...bytes].map(b => b.toString(16).padStart(2,"0")).join("");
  }

  async function sha256Hex(file){
    const buf = await file.arrayBuffer();
    const dig = await crypto.subtle.digest("SHA-256", buf);
    return "0x" + bytesToHex(new Uint8Array(dig));
  }

  function resetUI(){
    resultBox.style.display = "none";
    errorBox.style.display = "none";
    errorMsg.textContent = "";
  }

  function updateState(){
    verifyBtn.disabled = !(currentFile && isValidHash(hashInput.value));
  }

  // ✅ Prefill from URL:
  // support both ?id= (new) and legacy ?hash=
  const params = new URLSearchParams(location.search);
  const urlId = params.get("id");
  const urlHash = params.get("hash");
  const prefill = (urlId && isValidHash(urlId)) ? urlId : urlHash;

  if (isValidHash(prefill)) {
    hashInput.value = prefill.trim();
  }

  hashInput.addEventListener("input", updateState);

  fileInput.addEventListener("change", () => {
    currentFile = fileInput.files?.[0] || null;
    fileInfo.textContent = currentFile
      ? `Vald fil: ${currentFile.name} (${(currentFile.size/1024/1024).toFixed(2)} MB)`
      : "Ingen fil vald.";
    updateState();
  });

  verifyBtn.addEventListener("click", async () => {
    resetUI();
    setStatus("Verifierar…");

    try{
      const refHash = hashInput.value.trim();
      if (!isValidHash(refHash)) throw new Error("Ogiltigt Verifierings-ID.");
      if (!currentFile) throw new Error("Välj en fil att verifiera.");

      const fileHash = await sha256Hex(currentFile);

      const res = await fetch("/api/verify", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ hash: refHash, fileHash })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data?.error || "Verifiering misslyckades.");

      resultBox.style.display = "block";
      outHash.textContent = refHash;
      outFileHash.textContent = fileHash;

      if (data.match === true) {
        resultHeadline.innerHTML = `<span class="ok">✅ Match</span>`;
      } else {
        resultHeadline.innerHTML = `<span class="err">❌ Ingen match</span>`;
      }

      setStatus("Klar");
    } catch (e){
      errorBox.style.display = "block";
      errorMsg.textContent = e?.message || "Tekniskt fel.";
      setStatus("Fel");
    }
  });

  setStatus("Väntar");
  updateState();
})();
</script>

<script src="/chat-widget.js?v=2025-01" defer></script>
</body>
</html>
