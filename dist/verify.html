<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proofy – Verifiera underlag</title>
  <meta name="description" content="Verifiera om ett underlag är samma filversion som den som registrerats tidigare. Filen lämnar aldrig din dator. Proofy lagrar inte filinnehåll." />
  <meta name="theme-color" content="#0b1220" />
  <link rel="stylesheet" href="/assets/proofy.css?v=2025-12-20" />
</head>

<body>
<a class="skip" href="#main">Hoppa till innehåll</a>

<header>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="/" aria-label="Proofy">
        <span class="logo" aria-hidden="true"></span>
        <span>Proofy</span>
      </a>

      <div class="navActions" aria-label="Snabblänkar">
        <a class="btn soft" href="/hash.html">Skapa ID</a>
        <a class="btn primary" href="/#kontakt">Boka demo</a>
      </div>
    </div>
  </div>
</header>

<main id="main">
  <div class="wrap">
    <div class="badge">För redovisningsbyråer · revision · granskning</div>

    <h1 class="pageTitle">Verifiera underlag</h1>

    <p class="lead">
      Här kontrollerar du om ett underlag är <b>samma filversion</b> som den som tidigare registrerats.
      Du kan verifiera antingen genom att <b>välja filen</b> eller genom att <b>klistra in Verifierings-ID</b>.
      <b>Filen lämnar aldrig din dator</b> och Proofy <b>lagrar inte filinnehåll</b>.
    </p>

    <section class="card content" aria-label="Verifiera">
      <div class="grid2">

        <!-- LEFT: Verify via file -->
        <section aria-label="Verifiera via fil">
          <div style="font-weight:950; font-size:16px;">Verifiera via fil</div>
          <p class="meta" style="margin-top:8px">
            Välj filversionen du vill kontrollera. Vi jämför den mot den registrerade referensen.
          </p>

          <input id="fileInput" type="file" aria-label="Välj fil att verifiera" />
          <div id="dropZone" class="drop" style="margin-top:10px">Dra & släpp fil här</div>

          <div id="fileInfo" class="meta" style="margin-top:10px">Ingen fil vald.</div>

          <div class="actions" style="margin-top:12px">
            <button class="btn primary" id="fileVerifyBtn" disabled>Verifiera fil</button>
            <span id="statusPill" class="pill">Välj fil eller klistra in ID</span>
          </div>

          <details style="margin-top:12px;">
            <summary>Detaljer (valfritt)</summary>
            <p class="meta" style="margin:10px 0 0;">
              Här visas den interna referensen som används för att kontrollera om en fil är exakt samma version.
            </p>
            <div id="localRefBox" style="display:none;margin-top:10px">
              <div class="meta">Intern referens:</div>
              <div id="localRefOut" class="mono">—</div>
            </div>
          </details>

          <div class="small" style="margin-top:10px">
            Obs: Ny export/omskanning kan skapa en ny filversion även om den “ser likadan ut”.
          </div>
        </section>

        <!-- RIGHT: Verify via ID -->
        <section aria-label="Verifiera via Verifierings-ID">
          <div style="font-weight:950; font-size:16px;">Verifiera via Verifierings-ID</div>
          <p class="meta" style="margin-top:8px">
            Har du ett Verifierings-ID i ärendet? Klistra in det här så kontrollerar vi status.
          </p>

          <label class="meta" for="idInput" style="display:block;margin-top:10px;">Verifierings-ID</label>
          <input id="idInput" type="text" placeholder="Klistra in Verifierings-ID…" autocomplete="off" />

          <div class="actions" style="margin-top:12px">
            <button class="btn primary" id="verifyBtn" type="button">Verifiera</button>
            <button class="btn" id="copyLinkBtn" type="button" disabled>Kopiera verifieringslänk</button>
          </div>

          <div class="hr"></div>

          <div id="statusLine" class="meta" aria-live="polite"></div>

          <div id="resultBox" style="display:none;margin-top:10px">
            <div class="card content" style="background:rgba(11,18,32,.25); box-shadow:none;">
              <div id="resultHeadline" style="font-size:18px; font-weight:950;"></div>

              <div class="hr"></div>

              <div class="meta">Tidpunkt</div>
              <div id="timeOut" class="mono" style="margin-top:8px">—</div>

              <div class="meta" style="margin-top:12px;">Skapad av</div>
              <div id="submitterOut" class="mono" style="margin-top:8px">—</div>

              <div class="meta" style="margin-top:12px;">Verifierings-ID</div>
              <div id="idOut" class="mono" style="margin-top:8px">—</div>

              <div class="meta" style="margin-top:12px;">Verifieringslänk</div>
              <div id="linkOut" class="mono" style="margin-top:8px">—</div>

              <div class="small" style="margin-top:12px">
                Tolkning: “Matchar” betyder att filversionen/ID:t finns registrerad som referens.
                “Matchar inte” betyder att ingen referens hittades för den filversionen/ID:t.
              </div>
            </div>
          </div>

          <div class="small" style="margin-top:12px">
            Tips: Dela verifieringslänken om någon annan behöver kontrollera senare.
          </div>
        </section>

      </div>
    </section>

    <p class="small" style="margin-top:14px">
      Proofy lagrar inte dokument och visar inte vem som skapat ett dokument eller om innehållet är korrekt – endast om en filversion matchar en registrerad referens.
    </p>
  </div>
</main>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // File side
  const fileInput = $("fileInput");
  const dropZone = $("dropZone");
  const fileInfo = $("fileInfo");
  const fileVerifyBtn = $("fileVerifyBtn");
  const statusPill = $("statusPill");
  const localRefBox = $("localRefBox");
  const localRefOut = $("localRefOut");

  // ID side
  const idInput = $("idInput");
  const verifyBtn = $("verifyBtn");
  const copyLinkBtn = $("copyLinkBtn");
  const statusLine = $("statusLine");

  const resultBox = $("resultBox");
  const resultHeadline = $("resultHeadline");
  const timeOut = $("timeOut");
  const submitterOut = $("submitterOut");
  const idOut = $("idOut");
  const linkOut = $("linkOut");

  // state
  let currentFile = null;
  let currentId = null;
  let busy = false;
  let opId = 0;

  function setBusy(v){
    busy = v;
    fileVerifyBtn.disabled = !currentFile || busy;
    verifyBtn.disabled = busy;
    // copyLinkBtn enabled only if we have a valid currentId
    copyLinkBtn.disabled = !currentId || busy;
  }

  function setPill(text){
    statusPill.textContent = text || "—";
  }

  function setStatus(text, cls){
    statusLine.textContent = text || "";
    statusLine.className = cls ? cls : "meta";
  }

  function resetResult(){
    resultBox.style.display = "none";
    resultHeadline.textContent = "";
    timeOut.textContent = "—";
    submitterOut.textContent = "—";
    idOut.textContent = "—";
    linkOut.textContent = "—";
    setStatus("");
  }

  function bytesToHex(bytes){
    return [...bytes].map(b => b.toString(16).padStart(2,"0")).join("");
  }

  async function fileToInternalId(file){
    // Keep internal format compatible with your API: 0x + 64 hex
    const buf = await file.arrayBuffer();
    const dig = await crypto.subtle.digest("SHA-256", buf);
    return "0x" + bytesToHex(new Uint8Array(dig));
  }

  function isInternalIdFormat(v){
    return typeof v === "string" && /^0x[0-9a-fA-F]{64}$/.test(v);
  }

  function buildShareLink(id){
    // Keep query param name for compatibility: ?hash=
    return `${location.origin}/verify.html?hash=${encodeURIComponent(id)}`;
  }

  function fmtSv(tsSeconds){
    try{ return new Date(Number(tsSeconds) * 1000).toLocaleString("sv-SE"); }
    catch { return "—"; }
  }

  function renderResult(found, payload){
    const id = payload?.id || currentId;
    const link = buildShareLink(id);

    idOut.textContent = id || "—";
    linkOut.textContent = link;

    if (!found){
      resultHeadline.innerHTML = `<span class="err">❌ Matchar inte</span> <span class="meta">(ingen referens hittades)</span>`;
      timeOut.textContent = "—";
      submitterOut.textContent = "—";
      setPill("Matchar inte");
    } else {
      resultHeadline.innerHTML = `<span class="ok">✅ Matchar</span> <span class="meta">(referens hittades)</span>`;
      timeOut.textContent = payload?.timestamp ? fmtSv(payload.timestamp) : "—";
      submitterOut.textContent = payload?.submitter || "—";
      setPill("Matchar ✅");
    }

    currentId = id;
    copyLinkBtn.disabled = !currentId || busy;

    resultBox.style.display = "block";
  }

  async function verifyById(id, showWorking=true){
    const clean = (id || "").trim();

    if (!isInternalIdFormat(clean)){
      currentId = null;
      copyLinkBtn.disabled = true;
      resetResult();
      setStatus("Ange ett giltigt Verifierings-ID.", "err");
      setPill(clean ? "Ogiltigt ID" : "Välj fil eller klistra in ID");
      return;
    }

    const myOp = ++opId;
    setBusy(true);

    currentId = clean;
    copyLinkBtn.disabled = false;

    if (showWorking){
      resetResult();
      setStatus("Kontrollerar…");
      setPill("Kontrollerar…");
    }

    try{
      const r = await fetch("/api/verify",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ hash: clean }) // API expects {hash}
      });

      const j = await r.json().catch(() => ({}));
      if(myOp !== opId) return;

      if(!r.ok || !j.ok){
        setStatus("Tekniskt fel vid kontroll. Försök igen.", "err");
        setPill("Tekniskt fel");
        return;
      }

      renderResult(!!j.exists, { id: clean, timestamp: j.timestamp, submitter: j.submitter });
      setStatus("");
    } catch (e){
      console.error(e);
      if(myOp !== opId) return;
      setStatus("Tekniskt fel vid kontroll. Försök igen.", "err");
      setPill("Tekniskt fel");
    } finally {
      if(myOp === opId) setBusy(false);
    }
  }

  // File input handling
  function setFile(file){
    currentFile = file || null;
    localRefBox.style.display = "none";
    localRefOut.textContent = "—";
    resetResult();

    if(!currentFile){
      fileInfo.textContent = "Ingen fil vald.";
      setPill("Välj fil eller klistra in ID");
      setBusy(false);
      return;
    }

    fileInfo.textContent = `Vald fil: ${currentFile.name} (${(currentFile.size/1024/1024).toFixed(2)} MB)`;
    setPill("Redo att verifiera");
    setBusy(false);
  }

  fileInput.addEventListener("change", () => setFile(fileInput.files?.[0] || null));

  dropZone.addEventListener("dragover", (e) => { e.preventDefault(); dropZone.classList.add("drag"); });
  dropZone.addEventListener("dragleave", () => dropZone.classList.remove("drag"));
  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("drag");
    const f = e.dataTransfer?.files?.[0];
    if(f) setFile(f);
  });

  fileVerifyBtn.addEventListener("click", async () => {
    if(!currentFile || busy) return;

    const myOp = ++opId;
    setBusy(true);
    setStatus("Förbereder kontroll…");
    setPill("Förbereder…");
    resetResult();

    try{
      const id = await fileToInternalId(currentFile);
      if(myOp !== opId) return;

      // show optional details
      localRefBox.style.display = "block";
      localRefOut.textContent = id;

      // Also fill the ID input (nice for copy/share)
      idInput.value = id;

      await verifyById(id, false);
    } catch (e){
      console.error(e);
      if(myOp !== opId) return;
      setStatus("Kunde inte läsa filen. Försök igen.", "err");
      setPill("Fel");
    } finally {
      if(myOp === opId) setBusy(false);
    }
  });

  // ID input handling
  verifyBtn.addEventListener("click", () => verifyById(idInput.value, true));

  idInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") verifyById(idInput.value, true);
  });

  copyLinkBtn.addEventListener("click", async () => {
    const id = (idInput.value || "").trim();
    if(!isInternalIdFormat(id)){
      setStatus("Ange ett giltigt Verifierings-ID innan du kopierar länk.", "err");
      setPill("Ogiltigt ID");
      return;
    }
    try{
      await navigator.clipboard.writeText(buildShareLink(id));
      setStatus("Verifieringslänk kopierad ✅", "ok");
      setPill("Länk kopierad");
    } catch {
      setStatus("Kunde inte kopiera. Tillåt urklipp i webbläsaren.", "err");
      setPill("Kunde inte kopiera");
    }
  });

  // Auto from URL: /verify.html?hash=0x...
  const p = new URLSearchParams(location.search);
  const urlId = p.get("hash");
  if(urlId){
    idInput.value = urlId;
    verifyById(urlId, true);
  } else {
    setPill("Välj fil eller klistra in ID");
    setBusy(false);
  }

  setBusy(false);
})();
</script>

<script src="/chat-widget.js?v=2025-01" defer></script>
</body>
</html>
