<!doctype html>
<!-- CERT-HARDTEST v2026-01-15 / audit+juridik 5/5 (SE) / no-tech-terms + case-note -->
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="robots" content="noindex" />
    <meta name="theme-color" content="#0b1220" />
    <title>Proofy – Verifieringsintyg</title>

    <link rel="stylesheet" href="/assets/proofy.css?v=2026-01-03a" />
    <link rel="stylesheet" href="/assets/header.css?v=2026-01-03a" />

    <style>
      :root{
        --bg:#070b14;
        --border:rgba(255,255,255,.08);
        --text:#eaf0ff;
        --muted:rgba(234,240,255,.72);
        --muted2:rgba(234,240,255,.55);
        --good:#36d399;
        --bad:#ff6b6b;
        --warn:#fbbf24;
        --shadow:0 20px 60px rgba(0,0,0,.35);
        --radius:18px;
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";

        --qr-dark:#0b1220;
        --qr-light:#ffffff;
        --qr-frame: rgba(255,255,255,.10);
        --qr-shadow: 0 14px 42px rgba(0,0,0,.35);

        /* Fallback-space så chat/FAB aldrig täcker innehåll på mobil */
        --proofy-fab-space: 120px;
      }

      *{box-sizing:border-box}
      html{ background: var(--bg) !important; }
      body{
        margin:0;
        background-color: var(--bg) !important;
        background-image:
          radial-gradient(1200px 600px at 30% 20%, rgba(67,108,255,.20), transparent 60%),
          radial-gradient(900px 500px at 70% 35%, rgba(54,211,153,.12), transparent 55%) !important;
        background-repeat: no-repeat !important;
        background-attachment: scroll !important;
        background-size: auto !important;
        color:var(--text);
        font-family:var(--sans);
      }
      html::before, html::after, body::before, body::after{
        content:none !important;
        display:none !important;
      }

      a{color:inherit}
      .skip{
        position:absolute; left:-9999px; top:auto;
        width:1px; height:1px; overflow:hidden;
      }
      .skip:focus{
        left:18px; top:18px; width:auto; height:auto;
        padding:10px 12px; border-radius:12px;
        border:1px solid var(--border);
        background:rgba(255,255,255,.08);
        z-index:999;
      }
      a:focus-visible, button:focus-visible, [role="button"]:focus-visible{
        outline: 2px solid rgba(110,168,255,.55);
        outline-offset: 3px;
        border-radius: 14px;
      }

      main{
        max-width:1100px;
        margin:0 auto;
        padding:
          10px
          18px
          calc(48px + env(safe-area-inset-bottom) + var(--proofy-fab-space, 120px));
      }

      .pill{
        display:inline-flex; align-items:center; gap:10px;
        padding:8px 12px;
        border:1px solid var(--border);
        border-radius:999px;
        background:rgba(255,255,255,.04);
        color:var(--muted);
        font-weight:700;
        font-size:13px;
      }

      .hero{
        margin-top:10px;
        border:1px solid var(--border);
        background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
        border-radius:var(--radius);
        box-shadow:var(--shadow);
        padding:26px;
      }
      .heroTop{
        display:flex;
        gap:16px;
        align-items:flex-start;
        justify-content:space-between;
        flex-wrap:wrap;
      }
      h1{
        margin:12px 0 8px;
        font-size:44px;
        letter-spacing:-.02em;
        line-height:1.02;
      }

      .statusArea{
        display:flex;
        flex-direction:column;
        align-items:flex-end;
        gap:10px;
        min-width:220px;
      }

      .statusBadge{
        display:inline-flex; align-items:center; gap:8px;
        padding:10px 14px;
        border-radius:999px;
        font-weight:900;
        border:1px solid var(--border);
        background:rgba(255,255,255,.05);
        min-width:220px;
        justify-content:center;
        text-align:center;
      }
      .dot{width:9px;height:9px;border-radius:99px;background:var(--warn)}
      .statusBadge.good .dot{background:var(--good)}
      .statusBadge.bad .dot{background:var(--bad)}
      .statusBadge.warn .dot{background:var(--warn)}

      .statusMeta{
        width:100%;
        border:1px solid var(--border);
        border-radius:16px;
        background:rgba(255,255,255,.03);
        padding:12px;
      }
      .statusMeta .label{ margin:0 0 6px; }

      .actions{
        display:flex; gap:10px; flex-wrap:wrap;
        margin-top:16px;
      }
      .actions .btn{
        display:inline-flex;
        align-items:center;
        justify-content:center;
        text-decoration:none;
      }

      .auditTop{
        margin-top:16px;
        display:grid;
        grid-template-columns: 1.05fr .95fr;
        gap:14px;
        align-items:start;
      }
      @media (max-width: 900px){
        .auditTop{ grid-template-columns:1fr; }
        h1{font-size:36px}
        .statusArea{ align-items:stretch; }
      }

      .card{
        border:1px solid var(--border);
        background:rgba(255,255,255,.03);
        border-radius:var(--radius);
        padding:18px;
      }
      .card h3{
        margin:2px 0 10px;
        font-size:13px;
        color:var(--muted2);
        letter-spacing:.08em;
        text-transform:uppercase;
      }

      .kv{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap:12px;
      }
      @media (max-width: 700px){
        .kv{grid-template-columns:1fr}
      }

      .val{
        background:rgba(0,0,0,.18);
        border:1px solid var(--border);
        border-radius:14px;
        padding:12px;
        min-height:54px;
      }
      .label{
        font-size:12px;
        color:var(--muted2);
        margin-bottom:6px;
        font-weight:800;
      }
      .mono{
        font-family:var(--mono);
        font-size:13px;
        word-break:break-word;
        overflow-wrap:anywhere;
        color:rgba(234,240,255,.92);
      }

      .row{
        display:flex; align-items:center; justify-content:space-between; gap:10px;
      }

      .copyBtn{
        padding:8px 10px;
        font-weight:900;
        border-radius:12px;
        white-space:nowrap;
        border:1px solid rgba(255,255,255,.14);
        background:rgba(255,255,255,.04);
        color:var(--text);
        cursor:pointer;
      }
      .copyBtn:hover{ background:rgba(255,255,255,.06); }

      .note{
        margin-top:12px;
        color:var(--muted);
        font-size:14px;
        line-height:1.55;
      }

      .fine{
        margin-top:14px;
        border-top:1px solid var(--border);
        padding-top:14px;
        color:var(--muted2);
        font-size:13px;
        line-height:1.6;
      }

      .qrWrap{
        display:flex; align-items:flex-start; gap:14px; flex-wrap:wrap;
      }

      #qrcodeTap{
        width:184px; height:184px;
        border-radius:18px;
        border:1px solid var(--qr-frame);
        background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
        box-shadow: var(--qr-shadow);
        display:grid; place-items:center;
        overflow:hidden;
        cursor:pointer;
        -webkit-tap-highlight-color: transparent;
        user-select:none;
      }
      #qrcodeSurface{
        width:176px; height:176px;
        border-radius:16px;
        background:var(--qr-light);
        border:1px solid rgba(0,0,0,.10);
        display:grid; place-items:center;
      }

      #qrcode{
        width:168px; height:168px;
        display:grid; place-items:center;
      }
      #qrcode canvas, #qrcode img, #qrcode svg{
        width:168px !important;
        height:168px !important;
        display:block;
        image-rendering: pixelated;
      }

      .small{
        font-size:12px; color:var(--muted2); line-height:1.45;
        max-width:520px;
      }

      .warnBox{
        margin-top:12px;
        border:1px solid rgba(251,191,36,.35);
        background:rgba(251,191,36,.10);
        border-radius:16px;
        padding:12px;
        color:rgba(255,255,255,.92);
        display:none;
      }
      .warnBox.show{display:block}
      .mutedLink{color:rgba(234,240,255,.88)}
      .footer{
        margin-top:14px;
        color:var(--muted2);
        font-size:12.5px;
        line-height:1.55;
      }

      details.more{
        margin-top:12px;
        border:1px solid var(--border);
        border-radius:16px;
        background:rgba(255,255,255,.02);
        padding:10px 12px;
      }
      details.more > summary{
        cursor:pointer;
        font-weight:900;
        color:rgba(234,240,255,.90);
        list-style:none;
      }
      details.more > summary::-webkit-details-marker{display:none}
      .moreGrid{
        margin-top:10px;
        display:grid;
        grid-template-columns: 1fr;
        gap:10px;
      }

      .tz{
        white-space:nowrap;
        word-break:normal;
        overflow-wrap:normal;
      }

      /* Noteringsruta */
      .noteBox{
        margin-top:12px;
        border:1px solid rgba(255,255,255,.12);
        background:rgba(255,255,255,.03);
        border-radius:16px;
        padding:12px;
      }
      .noteText{
        margin-top:8px;
        border:1px solid rgba(255,255,255,.10);
        background:rgba(0,0,0,.18);
        border-radius:14px;
        padding:12px;
        font-family:var(--mono);
        font-size:12.5px;
        line-height:1.5;
        color:rgba(234,240,255,.92);
        white-space:pre-wrap;
        overflow-wrap:anywhere;
        user-select:text;
      }
      .noteActions{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        align-items:center;
        margin-top:10px;
      }
      .noteHint{
        margin-top:10px;
        font-size:12px;
        color:var(--muted2);
        line-height:1.45;
      }

      /* Extra hård mobil-säkring mot FAB/keyboard */
      @media (max-width: 700px){
        :root{ --proofy-fab-space: 140px; }
      }

      @media print{
        header, .actions, details.more { display:none !important; }
        body{ background:#fff !important; color:#000 !important; }
        .hero, .card { box-shadow:none !important; border-color:#ddd !important; background:#fff !important; }
        .pill, .statusBadge, .val, .statusMeta, .noteBox, .noteText { border-color:#ddd !important; background:#fff !important; }
        .small, .footer, .noteHint { color:#111 !important; }
        a{ color:#000 !important; text-decoration:none !important; }

        .auditTop{ display:flex !important; flex-direction:column !important; gap:14px !important; }
        .card{ break-inside:avoid; page-break-inside:avoid; }

        #qrcodeTap{
          box-shadow:none !important;
          border-color:#ddd !important;
          background:#fff !important;
        }
        #qrcodeSurface{
          border-color:#ddd !important;
          background:#fff !important;
        }
        #qrcodeTap, #qrcodeSurface, #qrcode{
          -webkit-print-color-adjust:exact;
          print-color-adjust:exact;
        }
      }
    </style>

    <script src="/assets/qr.min.js?v=2026-01-03a"></script>

    <script>
      (function(){
        try{
          var p = location.pathname || "";
          if (p === "/certificate" || p === "/certificate/") {
            if (sessionStorage.getItem("__proofy_cert_redirected") === "1") return;
            sessionStorage.setItem("__proofy_cert_redirected","1");
            location.replace("/certificate.html" + (location.search || "") + (location.hash || ""));
          }
        }catch(e){}
      })();
    </script>
  </head>

  <body>
    <a class="skip" href="#main">Hoppa till innehåll</a>

    <header>
      <div class="wrap">
        <div class="nav">
          <a class="brand" href="/" aria-label="Proofy">
            <span class="logo" aria-hidden="true"></span>
            <span>Proofy</span>
          </a>

          <div class="navActions" id="navActionsDesktop">
            <a class="btn soft" href="/register.html">Skapa kontrollvärde</a>
            <a class="btn soft" href="/verify.html">Verifiera underlag</a>
            <a class="btn soft" href="/pilot.html">Starta pilot</a>
            <a class="btn primary" href="/#kontakt">Boka kort demo</a>
          </div>

          <details class="mnav" id="mnav">
            <summary class="mnavSummary" aria-label="Öppna meny">
              <span class="mnavIcon" aria-hidden="true"></span>
            </summary>

            <nav class="mnavMenu" aria-label="Meny">
              <a class="mnavLink" href="/register.html">Skapa kontrollvärde</a>
              <a class="mnavLink" href="/verify.html">Verifiera underlag</a>
              <a class="mnavLink" href="/pilot.html">Starta pilot</a>
              <a class="mnavLink mnavLinkPrimary" href="/#kontakt">Boka kort demo</a>

              <div class="mnavMeta">
                <a class="mnavLink" href="/security.html">Säkerhet</a>
                <a class="mnavLink" href="/privacy.html">Integritet</a>
                <a class="mnavLink" href="/terms.html">Villkor</a>
                <a class="mnavLink" href="/cookies.html">Cookies</a>

                <div class="mnavNote">Verifiering · revision · granskning</div>
                <a class="mnavMail" href="mailto:kontakt@proofy.se">kontakt@proofy.se</a>
              </div>
            </nav>
          </details>
        </div>
      </div>
    </header>

    <main id="main">
      <div class="pill">Intyg · revision · granskning</div>

      <section class="hero" aria-label="Verifieringsintyg">
        <div class="heroTop">
          <div>
            <h1>Verifieringsintyg</h1>

            <div class="small" style="margin-top:10px; max-width:92ch;">
              <b>Syfte:</b> Detta intyg redovisar vilken <b>status</b> Proofy kunde visa för ett angivet
              <b>kontrollvärde (Verifierings-ID)</b> vid ett visst <b>kontrolltillfälle</b>.
              <br/><br/>
              <b>Avgränsning:</b> Intyget uttalar sig inte om dokumentets innehåll, riktighet, giltighet eller äkthet.
              Intyget är inte juridisk rådgivning och ersätter inte processkontroller, behörighetsloggar,
              signering eller arkivering.
              <br/>
              <span style="opacity:.92">
                Kontrolltiden i denna visning utgår från enhetens tid och är inte extern tidsstämpling.
              </span>
            </div>
          </div>

          <div class="statusArea" aria-label="Status och kontrolltid">
            <div id="statusBadge" class="statusBadge warn" title="Status hos Proofy vid kontrolltillfället">
              <span class="dot" aria-hidden="true"></span>
              <span id="statusText">Kontrollerar…</span>
            </div>

            <div class="statusMeta">
              <div class="label">Kontrolltid (detta kontrolltillfälle)</div>
              <div class="mono" id="checkedTopLocal" style="word-break:normal; overflow-wrap:normal; white-space:normal;">—</div>
              <div class="mono" id="checkedTopUtc" style="margin-top:6px;color:rgba(234,240,255,.72); word-break:normal; overflow-wrap:normal; white-space:normal;">—</div>
              <div class="small" style="margin-top:8px">
                Kontrolltiden genereras i denna webbläsare och kan vara fel om enhetens klocka är fel. Den utgör inte extern tidsstämpling.
              </div>

              <div class="label" style="margin-top:10px">Status vid kontrolltillfället</div>
              <div class="mono" id="resultText">—</div>
              <div class="small" id="legalLine" style="margin-top:8px">—</div>

              <div class="label" style="margin-top:10px">Intygsversion</div>
              <div class="mono" id="auditVersion">—</div>
            </div>
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="btnPrint" type="button">Skriv ut / Spara som PDF</button>
          <button class="btn" id="btnRefresh" type="button">Uppdatera</button>
          <a class="btn soft" id="btnOpenVerify" href="/verify.html">Öppna verifiering</a>
        </div>

        <div id="warnBox" class="warnBox" role="status" aria-live="polite" aria-atomic="true"></div>

        <div class="auditTop" aria-label="Snabböversikt (revision/juridik)">
          <div class="card" id="cardEssentials">
            <h3>Nyckeluppgifter (för ärendeakt)</h3>

            <div class="kv">
              <div class="val">
                <div class="label">Kontrollvärde (Verifierings-ID)</div>
                <div class="row">
                  <div class="mono" id="idText">—</div>
                  <button class="copyBtn" id="copyId" type="button">Kopiera</button>
                </div>
                <div class="small" style="margin-top:8px">
                  Kontrollvärdet avser en specifik filversion. Ny export/omskanning/omkomprimering kan ge nytt kontrollvärde även om underlaget ser likadant ut.
                </div>
              </div>

              <div class="val">
                <div class="label">Tidpunkt (endast om status är Bekräftad)</div>
                <div class="mono" id="confirmedLocal" style="word-break:normal; overflow-wrap:normal; white-space:normal;">—</div>
                <div class="mono" id="confirmedUtc" style="margin-top:6px;color:rgba(234,240,255,.72); word-break:normal; overflow-wrap:normal; white-space:normal;">—</div>
                <div class="small" style="margin-top:8px">
                  Tidpunkten avser när Proofy kan redovisa bekräftelse för kontrollvärdet i sitt register – inte när dokumentet upprättades, signerades, godkändes eller kommunicerades.
                </div>
              </div>
            </div>

            <div class="kv" style="margin-top:12px">
              <div class="val">
                <div class="label">Intygslänk (denna visning)</div>
                <div class="row">
                  <div class="mono" id="certLinkInline">—</div>
                  <button class="copyBtn" id="copyCertInline" type="button">Kopiera</button>
                </div>
                <div class="small" style="margin-top:8px">
                  Rekommenderas att sparas i ärendeakten. Länken visar resultatet av kontrollen vid kontrolltillfället.
                </div>
              </div>

              <div class="val">
                <div class="label">Intygs-ID (valfritt)</div>
                <div class="row">
                  <div class="mono" id="certIdOut">—</div>
                  <button class="copyBtn" id="copyCertId" type="button">Kopiera</button>
                </div>
                <div class="small" style="margin-top:8px">
                  Om en organisation använder ett internt intygs-ID kan det anges i länken och visas här.
                </div>
              </div>
            </div>

            <div class="note">
              <b>Rekommenderad notering i ärendeakt:</b> Spara kontrollvärde (Verifierings-ID) och intygslänk.
              Vid efterhandsgranskning används verifieringslänk/QR för snabb kontroll.
            </div>

            <!-- ✅ NYTT: Notering för ärendeakt (kopiera + ladda ner) -->
            <div class="noteBox" aria-label="Notering för ärendeakt">
              <div class="label">Notering för ärendeakt (kopiera / spara)</div>
              <div class="noteText" id="caseNoteText" role="textbox" aria-label="Noteringstext" tabindex="0">—</div>

              <div class="noteActions">
                <button class="copyBtn" id="copyCaseNote" type="button">Kopiera notering</button>
                <button class="copyBtn" id="downloadCaseNote" type="button">Ladda ner .txt</button>
              </div>

              <div class="noteHint">
                Tips: Klistra in noteringen i ärendeakten tillsammans med eventuellt underlag om process/åtkomst.
              </div>
            </div>

            <div class="small" style="margin-top:10px; opacity:.95;">
              <b>För revision/juridik:</b> Intyget är en dokumentation av en kontroll <b>vid kontrolltillfället</b>.
              Bevisvärde bedöms i sitt sammanhang (process, åtkomst, versionshantering och övrig dokumentation).
            </div>
          </div>

          <div class="card" id="cardLinks">
            <h3>Verifieringslänk &amp; QR</h3>
            <div class="qrWrap">
              <div>
                <div class="label" style="margin-bottom:8px">QR-kod (snabb kontroll)</div>
                <div id="qrcodeTap" role="button" tabindex="0" aria-label="QR-kod (klicka för att kopiera verifieringslänk)" title="Klicka för att kopiera verifieringslänk">
                  <div id="qrcodeSurface">
                    <div id="qrcode" aria-label="QR-kod"></div>
                  </div>
                </div>
                <div class="small" style="margin-top:10px">
                  Skanna med <b>annan enhet</b> för snabb kontroll. Klick på QR kopierar verifieringslänken.
                </div>
              </div>

              <div style="flex:1; min-width:260px;">
                <div class="val" style="margin-bottom:12px">
                  <div class="label">Verifieringslänk</div>
                  <div class="row">
                    <div class="mono" id="verifyLink">—</div>
                    <button class="copyBtn" id="copyVerify" type="button">Kopiera</button>
                  </div>
                </div>

                <div class="val">
                  <div class="label">Länk till intyg</div>
                  <div class="row">
                    <div class="mono" id="certLink">—</div>
                    <button class="copyBtn" id="copyCert" type="button">Kopiera</button>
                  </div>
                </div>

                <div class="small" id="contextHint" style="margin-top:10px"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="small" style="margin-top:14px; max-width:96ch;">
          <b>Detta intyg visar:</b> att Proofy vid kontrolltillfället kunde redovisa angiven status för kontrollvärdet.<br/>
          <b>Detta intyg visar inte:</b> dokumentets innehåll, riktighet, giltighet eller äkthet – och ersätter inte juridisk bedömning.
        </div>

        <div class="card" id="cardSummary" style="margin-top:14px;">
          <h3>Tydlighet för granskning</h3>

          <div class="fine" style="border-top:0; padding-top:0; margin-top:0;">
            <b>Sammanfattning (självbärande)</b><br/>
            • Intyget redovisar status för kontrollvärdet i Proofys register vid kontrolltillfället.<br/>
            • Tidpunkt redovisas endast om status är <b>Bekräftad</b>.<br/>
            • Tidpunkten avser bekräftelse av kontrollvärdet i Proofys register – inte när dokumentet upprättades eller användes.<br/>
            • Intyget ersätter inte signering, arkivering, behörighetsloggar eller processkontroller.<br/>
            • Bevisvärde bedöms i sitt sammanhang (process, åtkomst, versionshantering och dokumentationskedja).<br/>
            • Utfallet avser kontrolltillfället. Utfallet kan ändras om registerstatus uppdateras senare.
          </div>

          <div class="fine" style="margin-top:12px;">
            <b>Begrepp (kort, utan teknikspråk)</b><br/>
            • <b>Kontrollvärde (Verifierings-ID):</b> en unik identifierare för en bestämd filversion.<br/>
            • <b>Kontrolltillfälle:</b> när denna sida hämtar status från Proofy.<br/>
            • <b>Bekräftad:</b> Proofy kan redovisa bekräftelse och tidpunkt för kontrollvärdet.<br/>
            • <b>Kontrolltid:</b> tidpunkt när kontrollen utfördes i denna visning (utgår från enhetens tid).
          </div>

          <details class="more" id="moreDetails">
            <summary>Mer information (valfritt)</summary>
            <div class="moreGrid">
              <div class="val">
                <div class="label">Intern referens (valfri)</div>
                <div class="mono" id="internalRefA">—</div>
                <div class="small" style="margin-top:6px">
                  Kan underlätta intern uppföljning/support. Behövs normalt inte i ärendet.
                </div>
              </div>
              <div class="val">
                <div class="label">Spårningsreferens (valfri)</div>
                <div class="mono" id="internalRefB">—</div>
                <div class="small" style="margin-top:6px">
                  Kan användas vid felsökning. Påverkar inte intygets innebörd.
                </div>
              </div>
            </div>
          </details>

          <div class="footer">
            <div><b>Integritet:</b> Vid kontroll lämnas inte filen ut. Kontroll sker med kontrollvärdet.</div>
            <div style="margin-top:6px"><b>Utfärdare:</b> Proofy</div>
            <div style="margin-top:6px">Kontakt: <a href="mailto:kontakt@proofy.se">kontakt@proofy.se</a></div>
          </div>
        </div>
      </section>
    </main>

    <script>
      const CERT_HARDTEST_VERSION = "CERT-HARDTEST v2026-01-15 (SE audit/juridik, no-tech-terms + case-note)";
      const $ = (id) => document.getElementById(id);

      // URL måste bära ett kontrollvärde (Verifierings-ID).
      // Interna namn i koden påverkar inte UI. UI använder inga tekniska begrepp.
      function isValidVerifieringsId(s){
        return typeof s === "string" && /^0x[0-9a-fA-F]{64}$/.test(s.trim());
      }

      function nowSeconds(){ return Math.floor(Date.now()/1000); }
      function pad2(n){ return String(n).padStart(2,"0"); }

      function fmtUtc(sec){
        const n = Number(sec);
        if(!Number.isFinite(n) || n <= 0) return "—";
        const d = new Date(n * 1000);
        return `${d.getUTCFullYear()}-${pad2(d.getUTCMonth()+1)}-${pad2(d.getUTCDate())} ${pad2(d.getUTCHours())}:${pad2(d.getUTCMinutes())}:${pad2(d.getUTCSeconds())} UTC`;
      }

      function fmtSeHtml(sec){
        const n = Number(sec);
        if(!Number.isFinite(n) || n <= 0) return "—";
        try{
          const dt = new Date(n*1000);
          const tz = "Europe/Stockholm";
          const se = new Intl.DateTimeFormat("sv-SE", {
            timeZone: tz,
            year:"numeric", month:"2-digit", day:"2-digit",
            hour:"2-digit", minute:"2-digit", second:"2-digit"
          }).format(dt);
          return `${se} (<span class="tz">${tz}</span>)`;
        }catch{
          return new Date(n*1000).toLocaleString("sv-SE") + " (lokal)";
        }
      }

      function setStatus(tone, text){
        const badge = $("statusBadge");
        badge.classList.remove("good","bad","warn");
        badge.classList.add(tone);
        $("statusText").textContent = text;
      }

      function showWarn(html){
        const box = $("warnBox");
        box.innerHTML = html;
        box.classList.add("show");
      }
      function hideWarn(){
        const box = $("warnBox");
        box.innerHTML = "";
        box.classList.remove("show");
      }

      async function copyText(text){
        const t = String(text || "").trim();
        if(!t || t === "—") return false;
        try{
          await navigator.clipboard.writeText(t);
          return true;
        }catch{
          try{
            const ta = document.createElement("textarea");
            ta.value = t;
            ta.style.position="fixed";
            ta.style.left="-9999px";
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            document.body.removeChild(ta);
            return true;
          }catch{
            return false;
          }
        }
      }

      function toastCopied(label){
        showWarn(`<b>Kopierat:</b> ${label}`);
        setTimeout(() => hideWarn(), 1200);
      }

      function downloadTextFile(filename, text){
        const blob = new Blob([String(text || "")], { type:"text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(url), 1200);
      }

      function renderQR(text){
        const el = $("qrcode");
        el.innerHTML = "";

        const payload = String(text || "").trim();
        const setFallback = (msg) => {
          el.innerHTML =
            '<div class="small" style="padding:10px;color:#0b1220;text-align:center;line-height:1.35">' +
            msg +
            "</div>";
        };

        if (!payload){
          setFallback("Ingen länk att koda.");
          return;
        }

        const correctLevel =
          (window.QRCodeCorrectLevel && window.QRCodeCorrectLevel.H != null) ? window.QRCodeCorrectLevel.H :
          (window.QRCode && window.QRCode.CorrectLevel && window.QRCode.CorrectLevel.H != null) ? window.QRCode.CorrectLevel.H :
          undefined;

        const runRender = () => {
          if (typeof window.QRCode !== "function"){
            setFallback("QR kunde inte laddas.");
            return;
          }
          try{
            let qr = null;

            try{
              qr = new window.QRCode(el);
              if (qr && qr._htOption){
                qr._htOption.width = 168;
                qr._htOption.height = 168;
                qr._htOption.colorDark = getComputedStyle(document.documentElement).getPropertyValue("--qr-dark").trim() || "#0b1220";
                qr._htOption.colorLight = "#ffffff";
                if (correctLevel != null) qr._htOption.correctLevel = correctLevel;
              }
            }catch{
              qr = null;
            }

            if (!qr || typeof qr.makeCode !== "function"){
              el.innerHTML = "";
              qr = new window.QRCode(el, {
                width:168,
                height:168,
                colorDark:(getComputedStyle(document.documentElement).getPropertyValue("--qr-dark").trim() || "#0b1220"),
                colorLight:"#ffffff",
                correctLevel: correctLevel
              });
            }

            if (!qr || typeof qr.makeCode !== "function"){
              setFallback("QR-koden kunde inte visas.");
              return;
            }

            qr.makeCode(payload);

            const node = el.querySelector("canvas, img, svg, table");
            if (!node){
              setFallback("QR-koden kunde inte visas.");
              return;
            }
            node.style.width = "168px";
            node.style.height = "168px";
            node.style.display = "block";
            node.style.imageRendering = "pixelated";
          }catch(e){
            setFallback("QR-koden kunde inte visas.");
          }
        };

        if (typeof window.QRCode === "function") runRender();
        else setTimeout(runRender, 0);
      }

      async function fetchJson(url){
        const sep = url.includes("?") ? "&" : "?";
        const bustUrl = url + sep + "t=" + Date.now();
        const r = await fetch(bustUrl, { cache:"no-store", credentials:"same-origin" });

        let data = {};
        try { data = await r.json(); } catch { data = {}; }

        if(!r.ok) throw new Error(data?.error || data?.detail || `HTTP ${r.status}`);
        return data;
      }

      function safeText(v, fallback="—"){
        const s = String(v ?? "").trim();
        return s ? s : fallback;
      }

      function canonicalStatus(code){
        if (code === "CONFIRMED") return "Bekräftad";
        if (code === "SUBMITTED_UNCONFIRMED") return "Inskickad – ej bekräftad";
        if (code === "NOT_CONFIRMED") return "Ej bekräftad";
        return "Kunde inte kontrolleras";
      }

      function pickStatusPresentation(code){
        if (code === "CONFIRMED") return { tone:"good", badge:"Bekräftad" };
        if (code === "SUBMITTED_UNCONFIRMED") return { tone:"warn", badge:"Inskickad – ej bekräftad" };
        if (code === "NOT_CONFIRMED") return { tone:"bad", badge:"Ej bekräftad" };
        return { tone:"bad", badge:"Kunde inte kontrolleras" };
      }

      function isMeaningful(v){
        const s = String(v ?? "").trim();
        if (!s || s === "—") return false;
        if (/^0+$/.test(s)) return false;
        return true;
      }

      function updateMoreVisibility({ a, b }){
        const more = $("moreDetails");
        if (!more) return;

        const hasA = isMeaningful(a);
        const hasB = isMeaningful(b);

        if (!hasA && !hasB){
          more.open = false;
          more.style.display = "none";
          return;
        }

        more.style.display = "block";
        more.open = false;

        const aWrap = $("internalRefA")?.closest(".val");
        const bWrap = $("internalRefB")?.closest(".val");
        if (aWrap) aWrap.style.display = hasA ? "block" : "none";
        if (bWrap) bWrap.style.display = hasB ? "block" : "none";
      }

      function buildCaseNote({
        verifieringsId,
        statusText,
        checkedLocalText,
        checkedUtcText,
        confirmedLocalText,
        confirmedUtcText,
        certLink,
        verifyLink,
        legalLine,
        certId,
        internalA,
        internalB
      }){
        const lines = [];
        lines.push("PROOFY – Notering (ärendeakt/granskningsunderlag)");
        lines.push("");
        lines.push("Syfte: Dokumentera att status för kontrollvärdet kontrollerades hos Proofy vid angivet kontrolltillfälle.");
        lines.push("Avgränsning: Intyget avser inte dokumentets innehåll, riktighet, giltighet eller äkthet.");
        lines.push("");

        lines.push(`Kontrollvärde (Verifierings-ID): ${verifieringsId || "—"}`);
        lines.push(`Status vid kontrolltillfället: ${statusText || "—"}`);
        if (legalLine) lines.push(`Kommentar: ${legalLine}`);

        lines.push("");
        lines.push(`Kontrolltid (detta kontrolltillfälle): ${checkedLocalText || "—"}`);
        lines.push(`Kontrolltid (UTC): ${checkedUtcText || "—"}`);
        lines.push("Obs: Kontrolltiden utgår från enhetens tid och är inte extern tidsstämpling.");

        lines.push("");
        lines.push(`Intygslänk: ${certLink || "—"}`);
        lines.push(`Verifieringslänk: ${verifyLink || "—"}`);

        if (certId) {
          lines.push("");
          lines.push(`Intygs-ID (valfritt): ${certId}`);
        }

        // Tidpunkt endast när bekräftad
        if (statusText === "Bekräftad" && confirmedLocalText && confirmedLocalText !== "—"){
          lines.push("");
          lines.push(`Tidpunkt (endast om bekräftad): ${confirmedLocalText}`);
          if (confirmedUtcText && confirmedUtcText !== "—") lines.push(`Tidpunkt (UTC): ${confirmedUtcText}`);
          lines.push("Obs: Tidpunkten avser när Proofy kan redovisa bekräftelse för kontrollvärdet – inte när dokumentet upprättades eller användes.");
        }

        // Valfria interna referenser (utan teknikspråk)
        const hasA = internalA && internalA !== "—" && !/^0+$/.test(String(internalA));
        const hasB = internalB && internalB !== "—" && !/^0+$/.test(String(internalB));
        if (hasA || hasB){
          lines.push("");
          lines.push("Interna referenser (valfritt, för support/spårning):");
          if (hasA) lines.push(`- Intern referens: ${internalA}`);
          if (hasB) lines.push(`- Spårningsreferens: ${internalB}`);
        }

        lines.push("");
        lines.push("Slutsats: Noteringen visar endast utfallet av kontrollen vid kontrolltillfället.");
        return lines.join("\n");
      }

      /* Mobil-säkring: försök läsa av ev. flytande widget och ge extra bottenutrymme */
      function trySetFabSpace(){
        try{
          const candidates = [
            document.querySelector('[data-proofy-fab]'),
            document.querySelector('.proofy-chat-fab'),
            document.querySelector('.chat-widget-fab'),
            document.querySelector('#chatFab'),
            document.querySelector('button[aria-label*="Fråga"]'),
          ].filter(Boolean);

          if(!candidates.length) return;

          let maxH = 0;
          for(const el of candidates){
            const r = el.getBoundingClientRect();
            if (r && r.height) maxH = Math.max(maxH, r.height);
          }
          if(maxH > 0){
            document.documentElement.style.setProperty('--proofy-fab-space', String(Math.ceil(maxH + 56)) + 'px');
          }
        }catch{}
      }

      async function run(){
        hideWarn();
        $("auditVersion").textContent = CERT_HARDTEST_VERSION;

        const url = new URL(location.href);

        // Interna parameternamn (UI nämner inte tekniska ord)
        const verifieringsId = (url.searchParams.get("hash") || "").trim();
        const optionalContext = (url.searchParams.get("tx") || "").trim();
        const certId = (url.searchParams.get("cert") || "").trim();

        const checkedParam = (url.searchParams.get("checked") || "").trim();
        const checked = (() => {
          const n = Number(checkedParam);
          return Number.isFinite(n) && n > 0 ? Math.floor(n) : nowSeconds();
        })();

        const certLink =
          `${location.origin}/certificate.html?hash=${encodeURIComponent(verifieringsId)}&checked=${checked}` +
          (optionalContext ? `&tx=${encodeURIComponent(optionalContext)}` : "") +
          (certId ? `&cert=${encodeURIComponent(certId)}` : "");

        const verifyLink =
          `${location.origin}/verify.html?hash=${encodeURIComponent(verifieringsId)}` +
          (optionalContext ? `&tx=${encodeURIComponent(optionalContext)}` : "");

        $("certLink").textContent = certLink;
        $("verifyLink").textContent = verifyLink;
        $("certLinkInline").textContent = certLink;

        $("certIdOut").textContent = certId ? certId : "—";
        $("btnOpenVerify").href = verifyLink;

        $("btnPrint").onclick = () => window.print();
        $("btnRefresh").onclick = () => run();

        $("copyId").onclick = async () => { if (await copyText(verifieringsId)) toastCopied("Kontrollvärde (Verifierings-ID)"); };
        $("copyCert").onclick = async () => { if (await copyText(certLink)) toastCopied("Länk till intyg"); };
        $("copyVerify").onclick = async () => { if (await copyText(verifyLink)) toastCopied("Verifieringslänk"); };
        $("copyCertInline").onclick = async () => { if (await copyText(certLink)) toastCopied("Intygslänk"); };
        $("copyCertId").onclick = async () => { if (await copyText(certId)) toastCopied("Intygs-ID"); };

        renderQR(verifyLink);

        const qrTap = $("qrcodeTap");
        const doQrCopy = async () => { if (await copyText(verifyLink)) toastCopied("Verifieringslänk"); };
        qrTap.onclick = (e) => { e.preventDefault(); doQrCopy(); };
        qrTap.onkeydown = (e) => {
          if (e.key === "Enter" || e.key === " ") { e.preventDefault(); doQrCopy(); }
        };

        // Kontrolltid (topp)
        const checkedLocalHtml = fmtSeHtml(checked);
        const checkedUtcText = fmtUtc(checked);
        $("checkedTopLocal").innerHTML = checkedLocalHtml;
        $("checkedTopUtc").textContent = checkedUtcText;

        // Reset innan kontroll
        $("resultText").textContent = "Kontrollerar…";
        $("legalLine").textContent = "—";
        $("confirmedLocal").textContent = "—";
        $("confirmedUtc").textContent = "—";

        $("internalRefA").textContent = "—";
        $("internalRefB").textContent = "—";
        updateMoreVisibility({ a:"—", b:"—" });

        const contextHintEl = $("contextHint");
        if (contextHintEl){
          if (certId){
            contextHintEl.innerHTML = `Intygs-ID: <span class="mono">${certId}</span>`;
          } else if (optionalContext){
            contextHintEl.innerHTML = `Intern referens finns angiven (valfri).`;
          } else {
            contextHintEl.textContent = `Version: ${CERT_HARDTEST_VERSION}`;
          }
        }

        // Förhandsbygg notering (innan vi vet status)
        const noteEl = $("caseNoteText");
        const updateCaseNote = (payload) => {
          const note = buildCaseNote(payload);
          if (noteEl) noteEl.textContent = note;
          return note;
        };

        // Kopiera/ladda ner notering
        const copyNoteBtn = $("copyCaseNote");
        const dlNoteBtn = $("downloadCaseNote");

        const wireNoteButtons = () => {
          if (copyNoteBtn){
            copyNoteBtn.onclick = async () => {
              const t = noteEl?.textContent || "";
              if (await copyText(t)) toastCopied("Notering för ärendeakt");
            };
          }
          if (dlNoteBtn){
            dlNoteBtn.onclick = () => {
              const t = noteEl?.textContent || "";
              downloadTextFile("proofy-notering.txt", t);
              showWarn("<b>Nerladdad:</b> proofy-notering.txt");
              setTimeout(() => hideWarn(), 1200);
            };
          }
        };
        wireNoteButtons();

        if (!isValidVerifieringsId(verifieringsId)){
          setStatus("bad", "Kunde inte kontrolleras");
          $("idText").textContent = "Ogiltigt eller saknas (Verifierings-ID)";
          $("resultText").textContent = "Kunde inte kontrolleras: giltigt kontrollvärde (Verifierings-ID) saknas i länken.";
          $("legalLine").textContent = "Ingen slutsats kan dras utan giltigt kontrollvärde (Verifierings-ID).";

          updateCaseNote({
            verifieringsId: "—",
            statusText: "Kunde inte kontrolleras",
            checkedLocalText: $("checkedTopLocal")?.textContent || "—",
            checkedUtcText,
            confirmedLocalText: "—",
            confirmedUtcText: "—",
            certLink,
            verifyLink,
            legalLine: "Ingen slutsats kan dras utan giltigt kontrollvärde (Verifierings-ID).",
            certId: certId || "",
            internalA: "—",
            internalB: "—"
          });

          showWarn(`
            <b>Fel:</b> Intyget saknar giltigt kontrollvärde (Verifierings-ID) i länken.<br/>
            Exempel: <span class="mono">/certificate.html?hash=0x…</span>
          `);
          return;
        }

        $("idText").textContent = verifieringsId;

        // Notering (preliminär)
        updateCaseNote({
          verifieringsId,
          statusText: "Kontrollerar…",
          checkedLocalText: $("checkedTopLocal")?.textContent || "—",
          checkedUtcText,
          confirmedLocalText: "—",
          confirmedUtcText: "—",
          certLink,
          verifyLink,
          legalLine: "Kontroll pågår.",
          certId: certId || "",
          internalA: "—",
          internalB: "—"
        });

        setStatus("warn", "Kontrollerar…");
        $("resultText").textContent = "Kontrollerar status vid kontrolltillfället…";

        let v;
        try{
          v = await fetchJson(`/api/verify?hash=${encodeURIComponent(verifieringsId)}` + (optionalContext ? `&tx=${encodeURIComponent(optionalContext)}` : ""));
        }catch(e){
          setStatus("bad", "Kunde inte kontrolleras");
          $("resultText").textContent = "Kunde inte kontrolleras vid kontrolltillfället.";
          $("legalLine").textContent = "Detta kan vara ett tillfälligt fel. Försök igen.";

          updateCaseNote({
            verifieringsId,
            statusText: "Kunde inte kontrolleras",
            checkedLocalText: $("checkedTopLocal")?.textContent || "—",
            checkedUtcText,
            confirmedLocalText: "—",
            confirmedUtcText: "—",
            certLink,
            verifyLink,
            legalLine: "Tillfälligt fel. Försök igen.",
            certId: certId || "",
            internalA: "—",
            internalB: "—"
          });

          updateMoreVisibility({ a:"—", b:"—" });
          showWarn(`
            <b>Tillfälligt fel:</b> kontrollen kunde inte genomföras.<br/>
            Försök igen eller öppna verifieringssidan: <a class="mutedLink" href="${verifyLink}">${verifyLink}</a>
          `);
          return;
        }

        const statusCode = safeText(v?.statusCode, "UNKNOWN");
        const statusText = canonicalStatus(statusCode);
        const legalText = safeText(v?.legalText, "");
        const confirmedAtUnix = (v?.confirmedAtUnix != null) ? Number(v.confirmedAtUnix) : null;

        // Valfria interna referenser – presenteras som intern/spårning
        const internalA = safeText(v?.evidence?.observedBlockNumber, "—");
        const internalB = safeText(v?.submission?.txHash, "—");
        $("internalRefA").textContent = internalA;
        $("internalRefB").textContent = internalB;
        updateMoreVisibility({ a: internalA, b: internalB });

        const pres = pickStatusPresentation(statusCode);
        setStatus(pres.tone, pres.badge);
        $("resultText").textContent = statusText;

        const finalLegalLine = (() => {
          if (legalText) return legalText;
          if (statusCode === "CONFIRMED") return "Status är bekräftad vid kontrolltillfället.";
          if (statusCode === "SUBMITTED_UNCONFIRMED") return "Status är inskickad men ännu inte bekräftad vid kontrolltillfället.";
          if (statusCode === "NOT_CONFIRMED") return "Status är inte bekräftad vid kontrolltillfället.";
          return "Status kunde inte kontrolleras vid kontrolltillfället.";
        })();
        $("legalLine").textContent = finalLegalLine;

        let confirmedLocalPlain = "—";
        let confirmedUtcPlain = "—";

        if (statusCode === "CONFIRMED" && Number.isFinite(confirmedAtUnix) && confirmedAtUnix > 0){
          $("confirmedLocal").innerHTML = fmtSeHtml(confirmedAtUnix);
          $("confirmedUtc").textContent = fmtUtc(confirmedAtUnix);

          // För noteringen vill vi ha plain-text (utan HTML)
          try{
            confirmedLocalPlain = new Intl.DateTimeFormat("sv-SE", {
              timeZone:"Europe/Stockholm",
              year:"numeric", month:"2-digit", day:"2-digit",
              hour:"2-digit", minute:"2-digit", second:"2-digit"
            }).format(new Date(confirmedAtUnix*1000)) + " (Europe/Stockholm)";
          }catch{
            confirmedLocalPlain = (new Date(confirmedAtUnix*1000)).toLocaleString("sv-SE");
          }
          confirmedUtcPlain = fmtUtc(confirmedAtUnix);

          updateCaseNote({
            verifieringsId,
            statusText,
            checkedLocalText: $("checkedTopLocal")?.textContent || "—",
            checkedUtcText,
            confirmedLocalText: confirmedLocalPlain,
            confirmedUtcText: confirmedUtcPlain,
            certLink,
            verifyLink,
            legalLine: finalLegalLine,
            certId: certId || "",
            internalA,
            internalB
          });

          hideWarn();
          return;
        }

        $("confirmedLocal").textContent = "—";
        $("confirmedUtc").textContent = "—";

        updateCaseNote({
          verifieringsId,
          statusText,
          checkedLocalText: $("checkedTopLocal")?.textContent || "—",
          checkedUtcText,
          confirmedLocalText: "—",
          confirmedUtcText: "—",
          certLink,
          verifyLink,
          legalLine: finalLegalLine,
          certId: certId || "",
          internalA,
          internalB
        });

        if (statusCode === "SUBMITTED_UNCONFIRMED"){
          showWarn(`<b>Inskickad – ej bekräftad.</b><br/>Intyget kan inte redovisa tidpunkt innan status är Bekräftad.`);
          return;
        }

        if (statusCode === "NOT_CONFIRMED"){
          showWarn(`<b>Ej bekräftad.</b><br/>Ingen bekräftelse kunde redovisas vid kontrolltillfället. Kontrollera att rätt filversion/kontrollvärde används.`);
          return;
        }

        showWarn(`<b>Kunde inte kontrolleras.</b><br/>Kontrollen kunde inte genomföras vid kontrolltillfället. Försök igen eller öppna verifieringssidan.`);
      }

      trySetFabSpace();
      window.addEventListener("resize", trySetFabSpace, { passive:true });
      setTimeout(trySetFabSpace, 400);

      run();
    </script>

    <script src="/assets/header-toggle.js?v=2026-01-03a" defer></script>
    <script src="/chat-widget.js?v=2026-01-03a" defer></script>
  </body>
</html>
