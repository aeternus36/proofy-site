<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proofy – Verifieringsintyg</title>
  <meta name="description" content="Verifieringsintyg som sammanfattar resultatet av en kontroll av ett Verifierings-ID." />
  <meta name="theme-color" content="#0b1220" />
  <link rel="stylesheet" href="/assets/proofy.css?v=2025-12-20" />
</head>

<body>
<a class="skip" href="#main">Hoppa till innehåll</a>

<header>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="/" aria-label="Proofy">
        <span class="logo" aria-hidden="true"></span>
        <span>Proofy</span>
      </a>

      <div class="navLinks" aria-label="Navigering">
        <a href="/verify.html">Verifiera</a>
        <a href="/hash.html">Skapa ID</a>
        <a href="/#kontakt">Kontakt</a>
      </div>

      <div class="navActions">
        <a class="btn soft" href="/verify.html">Öppna verifiering</a>
        <a class="btn primary" href="/#kontakt">Boka demo</a>
      </div>
    </div>
  </div>
</header>

<main id="main">
  <div class="wrap">
    <div class="badge">Intyg · dokumentkontroll · byrå & granskning</div>

    <h1 class="pageTitle">Verifieringsintyg</h1>
    <p class="lead" style="max-width: 85ch;">
      Detta intyg sammanfattar resultatet av en kontroll av ett <b>Verifierings-ID</b>.
      Det visar om ID:t är <b>registrerat</b> och i så fall <b>när registreringen skedde</b>.
      Inget dokumentinnehåll lagras.
    </p>

    <div class="card content" style="margin-top:14px;">
      <div class="actions" style="justify-content:space-between;">
        <div class="actions">
          <button class="btn" id="printBtn" type="button">Skriv ut / Spara som PDF</button>
          <button class="btn soft" id="refreshBtn" type="button">Uppdatera</button>
        </div>

        <div class="actions">
          <a class="btn primary" id="openVerifyBtn" href="/verify.html">Öppna verifiering</a>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <section aria-label="Sammanfattning">
          <div class="label">Kontrollresultat</div>
          <div id="statusLine" class="mono" style="margin-top:8px;">—</div>

          <div class="label" style="margin-top:12px;">Verifierings-ID</div>
          <div id="idOut" class="mono" style="margin-top:8px;">—</div>

          <div class="small" style="margin-top:10px;">
            Verifierings-ID är en unik teknisk referens för en specifik filversion. Minsta ändring ger ett nytt ID.
          </div>
        </section>

        <section aria-label="Tidpunkter">
          <div class="label">Kontroll genomförd</div>
          <div id="checkedOut" class="mono" style="margin-top:8px;">—</div>

          <div class="label" style="margin-top:12px;">Registreringstid (Sverige)</div>
          <div id="regSeOut" class="mono" style="margin-top:8px;">—</div>

          <div class="label" style="margin-top:12px;">Registreringstid (UTC)</div>
          <div id="regUtcOut" class="mono" style="margin-top:8px;">—</div>
        </section>
      </div>

      <div class="hr"></div>

      <section aria-label="Verifieringslänk och QR">
        <div class="label">Verifieringslänk</div>
        <div id="linkOut" class="mono" style="margin-top:8px;">—</div>

        <div class="qrRow" style="margin-top:12px;">
          <div>
            <div class="label" style="margin-bottom:8px;">QR-kod</div>
            <div id="qrBox" class="qrBox" aria-label="QR-kod"></div>
            <div id="qrHint" class="small" style="margin-top:8px;">—</div>
          </div>

          <div style="min-width:240px; flex:1;">
            <div class="label">Tolkning</div>
            <p id="interpretOut" class="para" style="margin-top:8px;">—</p>

            <p class="para muted" style="margin-top:10px;">
              <b>Viktigt:</b> Detta intyg visar endast om Verifierings-ID:t är registrerat och vid vilken tidpunkt.
              Det säger inget om dokumentets innehåll, riktighet, vem som skapat dokumentet eller vem som haft tillgång till det.
            </p>
          </div>
        </div>
      </section>

      <div id="errorBox" style="display:none; margin-top:14px;">
        <div class="err">Tillfälligt tekniskt problem</div>
        <div id="errorMsg" class="mono" style="margin-top:8px;"></div>
        <div class="small" style="margin-top:10px;">
          Prova att klicka <b>Uppdatera</b>. Om det kvarstår: kontrollera att API är publicerat och att /api/verify svarar korrekt.
        </div>
      </div>

      <div class="hr"></div>

      <p class="small" style="margin:0;">
        Juridiskt: Proofy är ett tekniskt verifieringsunderlag. Tjänsten är inte juridisk rådgivning och ersätter inte
        revision eller krav på dokumentation enligt tillämpliga regelverk.
      </p>
    </div>

    <p class="meta" style="margin-top:14px;">
      Behöver ni ett upplägg för rutin/arbetsflöde i byrån? <a href="/#kontakt">Boka demo</a>.
    </p>
  </div>
</main>

<!-- QR lib MUST be reachable at /qr.min.js -->
<script
  src="/qr.min.js?v=2025-12-20"
  onload="window.__proofyQrLibLoaded = true"
  onerror="window.__proofyQrLibError = true"
></script>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const printBtn = $("printBtn");
  const refreshBtn = $("refreshBtn");
  const openVerifyBtn = $("openVerifyBtn");

  const statusLine = $("statusLine");
  const idOut = $("idOut");
  const checkedOut = $("checkedOut");
  const regSeOut = $("regSeOut");
  const regUtcOut = $("regUtcOut");
  const linkOut = $("linkOut");
  const interpretOut = $("interpretOut");

  const qrBox = $("qrBox");
  const qrHint = $("qrHint");

  const errorBox = $("errorBox");
  const errorMsg = $("errorMsg");

  function getIdFromQuery() {
    const p = new URLSearchParams(location.search);
    return (p.get("hash") || "").trim(); // behåll param-namnet för kompatibilitet
  }

  function isIdFormatOk(v) {
    return /^0x[0-9a-fA-F]{64}$/.test(v);
  }

  function buildVerifyLink(id) {
    return `${location.origin}/verify.html?hash=${encodeURIComponent(id)}`;
  }

  function nowSe() {
    return new Intl.DateTimeFormat("sv-SE", {
      timeZone: "Europe/Stockholm",
      year: "numeric", month: "2-digit", day: "2-digit",
      hour: "2-digit", minute: "2-digit", second: "2-digit"
    }).format(new Date()) + " (Europe/Stockholm)";
  }

  function nowUtc() {
    return new Date().toISOString().replace("T"," ").replace("Z"," UTC");
  }

  function fmtSe(tsSeconds) {
    const d = new Date(Number(tsSeconds) * 1000);
    return new Intl.DateTimeFormat("sv-SE", {
      timeZone: "Europe/Stockholm",
      year: "numeric", month: "2-digit", day: "2-digit",
      hour: "2-digit", minute: "2-digit", second: "2-digit"
    }).format(d) + " (Europe/Stockholm)";
  }

  function fmtUtc(tsSeconds) {
    const d = new Date(Number(tsSeconds) * 1000);
    return d.toISOString().replace("T"," ").replace(".000Z"," UTC");
  }

  function setError(msg) {
    errorBox.style.display = "block";
    errorMsg.textContent = msg || "Okänt fel.";
  }

  function clearError() {
    errorBox.style.display = "none";
    errorMsg.textContent = "";
  }

  function canRenderQr() {
    return typeof window.QRCode === "function";
  }

  function renderQr(text) {
    qrBox.innerHTML = "";
    qrHint.textContent = "—";

    if (!text) {
      qrBox.innerHTML = "—";
      qrHint.textContent = "Ingen länk att visa.";
      return;
    }

    if (!canRenderQr()) {
      if (window.__proofyQrLibError) {
        qrBox.innerHTML = '<div class="small" style="padding:10px; text-align:center;">QR kunde inte laddas.</div>';
        qrHint.textContent = "QR-bibliotek saknas i deploy.";
        return;
      }

      qrBox.innerHTML = '<div class="small" style="padding:10px; text-align:center;">Laddar QR…</div>';
      qrHint.textContent = "Laddar…";

      let tries = 0;
      const t = setInterval(() => {
        tries++;
        if (canRenderQr()) {
          clearInterval(t);
          doRender(text);
          qrHint.textContent = "Scanna för att öppna verifiering.";
          return;
        }
        if (window.__proofyQrLibError || tries >= 20) {
          clearInterval(t);
          qrBox.innerHTML = '<div class="small" style="padding:10px; text-align:center;">QR kunde inte laddas.</div>';
          qrHint.textContent = "QR-bibliotek saknas i deploy.";
        }
      }, 50);

      return;
    }

    doRender(text);
    qrHint.textContent = "Scanna för att öppna verifiering.";
  }

  function doRender(text) {
    qrBox.innerHTML = "";
    const correctLevel =
      window.QRCodeCorrectLevel && window.QRCodeCorrectLevel.M
        ? window.QRCodeCorrectLevel.M
        : undefined;

    new QRCode(qrBox, {
      text,
      width: 150,
      height: 150,
      colorDark: "#0b1220",
      colorLight: "#eaf0ff",
      correctLevel
    });
  }

  async function verifyId(id) {
    // Viktigt: samma metod som verify.html (POST)
    const res = await fetch("/api/verify", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ hash: id })
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok || data.ok === false) {
      throw new Error(data?.error || `Verifiering misslyckades (HTTP ${res.status}).`);
    }
    return data;
  }

  async function load() {
    clearError();

    const id = getIdFromQuery();
    idOut.textContent = id || "—";

    checkedOut.textContent = `${nowSe()}\n${nowUtc()}`;

    // default
    statusLine.textContent = "—";
    regSeOut.textContent = "—";
    regUtcOut.textContent = "—";
    linkOut.textContent = "—";
    interpretOut.textContent = "—";
    openVerifyBtn.href = "/verify.html";

    if (!id) {
      statusLine.textContent = "Saknar Verifierings-ID (öppna intyget via en verifieringslänk).";
      interpretOut.textContent =
        "Ingen kontroll kunde göras eftersom Verifierings-ID saknas. Öppna verifieringssidan och skapa en länk till intyget.";
      renderQr("");
      return;
    }

    if (!isIdFormatOk(id)) {
      statusLine.textContent = "Ogiltigt Verifierings-ID (formatfel).";
      interpretOut.textContent =
        "Verifierings-ID måste vara i korrekt format. Öppna verifieringssidan och kopiera ID därifrån.";
      renderQr("");
      return;
    }

    const vlink = buildVerifyLink(id);
    openVerifyBtn.href = vlink;
    linkOut.textContent = vlink;
    renderQr(vlink);

    statusLine.textContent = "Kontrollerar…";

    try {
      const data = await verifyId(id);

      if (data.exists) {
        statusLine.textContent = "Registrerad ✅";
        if (data.timestamp) {
          regSeOut.textContent = fmtSe(data.timestamp);
          regUtcOut.textContent = fmtUtc(data.timestamp);
        }
        interpretOut.textContent =
          "Kontrollen visar att Verifierings-ID:t är registrerat. Registreringstiden är den tidpunkt som visas ovan.";
      } else {
        statusLine.textContent = "Inte registrerad ❌";
        interpretOut.textContent =
          "Kontrollen hittar ingen registrering för Verifierings-ID:t vid kontrolltillfället.";
      }
    } catch (e) {
      statusLine.textContent = "Kan inte kontrollera just nu";
      interpretOut.textContent =
        "Kontrollen kunde inte genomföras på grund av ett tillfälligt problem. Försök igen senare.";
      setError(e?.message || String(e));
    }
  }

  printBtn.addEventListener("click", () => window.print());
  refreshBtn.addEventListener("click", () => load());

  load();
})();
</script>

<script src="/chat-widget.js?v=2025-01" defer></script>
</body>
</html>
