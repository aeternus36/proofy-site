<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proofy – Verifieringsintyg</title>
  <meta name="description" content="Verifieringsintyg (snapshot) för ett Verifierings-ID. Kontroll mot Proofys register vid angiven kontrolltid." />
  <meta name="theme-color" content="#0b1220" />
  <meta name="robots" content="noindex" />

  <!-- ✅ Matcha Proofy UI -->
  <link rel="stylesheet" href="/assets/proofy.css?v=2026-01-03a" />
  <link rel="stylesheet" href="/assets/header.css?v=2026-01-03a" />

  <style>
    .sr-only{
      position:absolute !important;
      width:1px !important;
      height:1px !important;
      padding:0 !important;
      margin:-1px !important;
      overflow:hidden !important;
      clip:rect(0,0,0,0) !important;
      white-space:nowrap !important;
      border:0 !important;
    }

    /* Stabil tidszon-radbrytning */
    .tz{ white-space:nowrap; }

    /* ✅ QR (matchar register/verify/certificate-stil) */
    .proofyQrTap{
      width:184px;
      height:184px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:#ffffff;
      display:grid;
      place-items:center;
      overflow:hidden;
      cursor:pointer;
      padding:0 !important;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .proofyQrBox{
      width:168px;
      height:168px;
      display:grid;
      place-items:center;
    }
    .proofyQrBox canvas,
    .proofyQrBox img,
    .proofyQrBox svg{
      width:168px !important;
      height:168px !important;
      display:block;
      image-rendering: pixelated;
    }

    /* Layout */
    .heroTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .actionsRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:12px;
    }
    .statusBadge{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      font-weight:900;
      min-width:200px;
      justify-content:center;
    }
    .dot{ width:10px; height:10px; border-radius:999px; background: rgba(251,191,36, .95); }
    .dot.good{ background: rgba(80,255,180,.95); }
    .dot.bad{ background: rgba(255,80,80,.95); }

    .hintline{ margin-top:6px; opacity:.9; }
    .monoBlock{
      display:block;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.03);
      text-decoration:none;
      cursor:pointer;
      user-select:text;
      word-break:break-all;
    }

    .warnBox{
      margin-top:12px;
      border:1px solid rgba(251,191,36,.35);
      background:rgba(251,191,36,.08);
      border-radius:16px;
      padding:12px 14px;
      display:none;
    }
    .warnBox.show{ display:block; }

    @media print{
      header, .actionsRow, #warnBox, #techDetails { display:none !important; }
      a{ text-decoration:none !important; }
      .proofyQrTap{ box-shadow:none !important; }
      .monoBlock{ border-color:#ddd !important; background:#fff !important; }
      .card{ box-shadow:none !important; }
    }
  </style>

  <!-- ✅ Om någon öppnar /certificate?…: redirecta hårt till /certificate.html?… -->
  <script>
    (function(){
      try{
        var p = location.pathname || "";
        // Vanliga fel: /certificate eller /certificate/ eller /certificate.html.html osv.
        if (p === "/certificate" || p === "/certificate/" || p.endsWith("/certificate")) {
          var target = "/certificate.html" + (location.search || "") + (location.hash || "");
          location.replace(target);
        }
      }catch(e){}
    })();
  </script>

  <script src="/assets/qr.min.js?v=2026-01-03a"></script>
</head>

<body>
<a class="skip" href="#main">Hoppa till innehåll</a>

<header>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="/" aria-label="Proofy">
        <span class="logo" aria-hidden="true"></span>
        <span>Proofy</span>
      </a>

      <div class="navActions" id="navActionsDesktop">
        <a class="btn soft" href="/register.html">Skapa Verifierings-ID</a>
        <a class="btn soft" href="/verify.html">Verifiera underlag</a>
        <a class="btn soft" href="/pilot.html">Starta pilot</a>
        <a class="btn primary" href="/#kontakt">Boka kort demo</a>
      </div>

      <details class="mnav" id="mnav">
        <summary class="mnavSummary" aria-label="Öppna meny">
          <span class="mnavIcon" aria-hidden="true"></span>
        </summary>

        <nav class="mnavMenu" aria-label="Meny">
          <a class="mnavLink" href="/register.html">Skapa Verifierings-ID</a>
          <a class="mnavLink" href="/verify.html">Verifiera underlag</a>
          <a class="mnavLink" href="/pilot.html">Starta pilot</a>
          <a class="mnavLink mnavLinkPrimary" href="/#kontakt">Boka kort demo</a>

          <div class="mnavMeta">
            <a class="mnavLink" href="/security.html">Säkerhet</a>
            <a class="mnavLink" href="/privacy.html">Integritet</a>
            <a class="mnavLink" href="/terms.html">Villkor</a>
            <a class="mnavLink" href="/cookies.html">Cookies</a>

            <div class="mnavNote">Verifiering · revision · granskning</div>
            <a class="mnavMail" href="mailto:kontakt@proofy.se">kontakt@proofy.se</a>
          </div>
        </nav>
      </details>
    </div>
  </div>
</header>

<main id="main">
  <div class="wrap">
    <div class="badge">Intyg · spårbarhet · byrå &amp; granskning</div>

    <div class="heroTop" style="margin-top:10px;">
      <div>
        <h1 class="pageTitle" style="margin-bottom:6px;">Verifieringsintyg</h1>
        <p class="lead" style="margin-top:0;">
          Detta intyg är ett <b>tekniskt underlag</b> (snapshot) som sammanfattar utfallet av en kontroll av ett
          <b>Verifierings-ID</b> mot Proofys register vid angiven kontrolltid. Proofy lagrar <b>inte</b> dokumentinnehåll i registret.
        </p>
      </div>

      <div class="statusBadge" id="statusBadge" title="Status hos Proofy vid kontrolltillfället">
        <span class="dot" id="statusDot" aria-hidden="true"></span>
        <span id="statusText">Kontrollerar…</span>
      </div>
    </div>

    <div class="actionsRow" aria-label="Åtgärder">
      <button class="btn primary" id="btnPrint" type="button">Skriv ut / Spara som PDF</button>
      <button class="btn" id="btnRefresh" type="button">Uppdatera</button>
      <a class="btn soft" id="btnOpenVerify" href="/verify.html">Öppna verifiering</a>
    </div>

    <div id="warnBox" class="warnBox" role="status" aria-live="polite" aria-atomic="true"></div>

    <div class="card content" style="margin-top:14px;">
      <div class="grid2">

        <!-- LEFT: Nyckeluppgifter -->
        <section aria-label="Nyckeluppgifter">
          <div style="font-weight:950; font-size:16px;">Nyckeluppgifter</div>
          <div class="hr"></div>

          <div class="meta">Verifierings-ID</div>
          <div class="actionsRow" style="margin-top:6px;">
            <div id="hashText" class="mono monoBlock" role="button" tabindex="0" title="Klicka för att kopiera">—</div>
            <button class="btn" id="copyHash" type="button">Kopiera</button>
          </div>
          <div class="small hintline">
            ID:t avser en specifik filversion. Ny export/omskanning/omkomprimering kan ge nytt ID även om underlaget ser likadant ut.
          </div>

          <div style="margin-top:14px;"></div>

          <div class="meta">Kontroll genomförd</div>
          <div id="checkedLocal" class="mono monoBlock" style="margin-top:6px; cursor:default;" aria-live="polite">—</div>
          <div id="checkedUtc" class="mono monoBlock" style="margin-top:8px; cursor:default; opacity:.78;" aria-live="polite">—</div>
          <div class="small hintline">
            Kontrolltiden avser <b>när detta intyg uppdaterades</b> (snapshot). Uppdatera vid behov.
          </div>

          <div style="margin-top:14px;"></div>

          <div class="meta">Tidpunkt (om bekräftad)</div>
          <div id="regLocal" class="mono monoBlock" style="margin-top:6px; cursor:default;">—</div>
          <div id="regUtc" class="mono monoBlock" style="margin-top:8px; cursor:default; opacity:.78;">—</div>

          <div style="margin-top:14px;"></div>

          <div class="meta">Status hos Proofy vid kontrolltillfället</div>
          <div id="resultText" class="mono monoBlock" style="margin-top:6px; cursor:default;">—</div>
          <div id="legalLine" class="small" style="margin-top:8px; opacity:.95;">—</div>

          <div class="hr" style="margin-top:14px;"></div>

          <div class="small" style="margin-top:10px; opacity:.92;">
            <b>Praktiskt tips:</b> Spara Verifierings-ID + intygslänk i ärendet vid fastställande.
            Dela verifieringslänk/QR vid intern kvalitetskontroll eller efterhandsgranskning.
          </div>
        </section>

        <!-- RIGHT: Länkar & QR -->
        <section aria-label="Länkar och QR">
          <div style="font-weight:950; font-size:16px;">Länkar &amp; QR</div>
          <div class="hr"></div>

          <div class="meta" style="margin-bottom:8px;">QR-kod (snabb kontroll)</div>
          <div id="qrTap" class="proofyQrTap" role="button" tabindex="0"
               aria-label="QR-kod (klicka för att kopiera verifieringslänk)"
               title="Klicka för att kopiera verifieringslänk">
            <div id="qrBox" class="proofyQrBox" aria-label="QR-kod"></div>
          </div>
          <div class="small" style="margin-top:10px; opacity:.9;">
            Skanna med <b>annan enhet</b> för snabb kontroll. Klick på QR kopierar verifieringslänken.
          </div>

          <div style="margin-top:14px;"></div>

          <div class="meta">Verifieringslänk</div>
          <div class="actionsRow" style="margin-top:6px;">
            <a id="verifyLink" class="mono monoBlock" href="#" target="_blank" rel="noopener"
               title="Tryck för att öppna · Långtryck för att kopiera">—</a>
            <button class="btn" id="copyVerify" type="button">Kopiera</button>
          </div>

          <div style="margin-top:14px;"></div>

          <div class="meta">Länk till intyg</div>
          <div class="actionsRow" style="margin-top:6px;">
            <a id="certLink" class="mono monoBlock" href="#" target="_blank" rel="noopener"
               title="Tryck för att öppna · Långtryck för att kopiera">—</a>
            <button class="btn" id="copyCert" type="button">Kopiera</button>
          </div>

          <div id="techHint" class="small" style="margin-top:10px; opacity:.9;"></div>
        </section>

      </div>
    </div>

    <div class="card content" style="margin-top:14px;">
      <div style="font-weight:950; font-size:16px;">Revisions-/juridisk tydlighet</div>
      <div class="hr"></div>

      <div class="small" style="opacity:.92; line-height:1.6;">
        • Intyget redovisar status för kontrollvärdet i Proofys register vid kontrolltillfället.<br/>
        • Tidpunkt anges endast när status är <b>bekräftad</b>.<br/>
        • Tidpunkten avser när kontrollvärdet först blev bekräftat i registret – inte när dokumentet skapades, signerades, godkändes eller kommunicerades.<br/>
        • Intyget ersätter inte e-signering, arkivering, behörighetsloggar, processkontroller eller juridisk rådgivning.<br/>
        • Bevisvärde och relevans bedöms i sitt sammanhang (process, åtkomst, versionshantering, dokumentationskedja).<br/>
        • Intyget avser en <b>teknisk kontroll vid kontrolltillfället</b>. Utfallet kan ändras om registret uppdateras senare.
      </div>

      <details id="techDetails" style="margin-top:12px;">
        <summary style="cursor:pointer; font-weight:900;">Teknisk information (valfritt)</summary>

        <div style="margin-top:10px;">
          <div class="meta">Kontrollpunkt (valfritt)</div>
          <div id="observedPoint" class="mono monoBlock" style="margin-top:6px; cursor:default;">—</div>
          <div class="small hintline">Visar vilken kontrollpunkt som användes vid kontrolltillfället. Kan underlätta felsökning.</div>

          <div style="margin-top:12px;"></div>

          <div class="meta">Registreringsreferens (valfri)</div>
          <div id="registrationRef" class="mono monoBlock" style="margin-top:6px; cursor:default;">—</div>
          <div class="small hintline">Intern referens kopplad till inskickad registrering. Behövs normalt inte i ärendet.</div>
        </div>
      </details>

      <div class="hr" style="margin-top:14px;"></div>

      <div class="small" style="opacity:.9;">
        <div><b>Integritet:</b> Verifierings-ID skapas lokalt från filen. Vid kontroll skickas endast kontrollvärdet – inte filen.</div>
        <div style="margin-top:6px;">Kontakt: <a href="mailto:kontakt@proofy.se">kontakt@proofy.se</a></div>
      </div>
    </div>

  </div>
</main>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  function isValidBytes32Hex(s){
    return typeof s === "string" && /^0x[0-9a-fA-F]{64}$/.test(s.trim());
  }

  function pad2(n){ return String(n).padStart(2,"0"); }
  function fmtUtc(sec){
    const n = Number(sec);
    if (!Number.isFinite(n) || n <= 0) return "—";
    const d = new Date(n * 1000);
    return `${d.getUTCFullYear()}-${pad2(d.getUTCMonth()+1)}-${pad2(d.getUTCDate())} ${pad2(d.getUTCHours())}:${pad2(d.getUTCMinutes())}:${pad2(d.getUTCSeconds())} UTC`;
  }

  function fmtSeHtml(sec){
    const n = Number(sec);
    if (!Number.isFinite(n) || n <= 0) return "—";
    try{
      const dt = new Date(n * 1000);
      const tz = "Europe/Stockholm";
      const se = new Intl.DateTimeFormat("sv-SE", {
        timeZone:"Europe/Stockholm",
        year:"numeric", month:"2-digit", day:"2-digit",
        hour:"2-digit", minute:"2-digit", second:"2-digit"
      }).format(dt);
      return `${se} (<span class="tz">${tz}</span>)`;
    } catch {
      return new Date(n * 1000).toLocaleString("sv-SE") + " (lokal)";
    }
  }

  function setStatus(code, label){
    const dot = $("statusDot");
    const badge = $("statusBadge");
    if (!dot || !badge) return;

    dot.classList.remove("good","bad");
    badge.style.borderColor = "rgba(255,255,255,.14)";
    badge.style.background = "rgba(255,255,255,.05)";

    if (code === "CONFIRMED"){
      dot.classList.add("good");
      badge.style.borderColor = "rgba(80,255,180,.20)";
      badge.style.background = "rgba(80,255,180,.06)";
    } else if (code === "SUBMITTED_UNCONFIRMED"){
      // warn default
      badge.style.borderColor = "rgba(251,191,36,.22)";
      badge.style.background = "rgba(251,191,36,.08)";
    } else if (code === "NOT_CONFIRMED"){
      dot.classList.add("bad");
      badge.style.borderColor = "rgba(251,191,36,.22)";
      badge.style.background = "rgba(251,191,36,.08)";
    } else {
      dot.classList.add("bad");
      badge.style.borderColor = "rgba(255,80,80,.20)";
      badge.style.background = "rgba(255,80,80,.06)";
    }

    $("statusText").textContent = label;
  }

  function showWarn(html){
    const box = $("warnBox");
    box.innerHTML = html;
    box.classList.add("show");
  }
  function hideWarn(){
    const box = $("warnBox");
    box.innerHTML = "";
    box.classList.remove("show");
  }

  async function copyTextToClipboard(text){
    const t = String(text || "").trim();
    if (!t || t === "—") return false;
    try{
      await navigator.clipboard.writeText(t);
      return true;
    }catch{
      try{
        const ta = document.createElement("textarea");
        ta.value = t;
        ta.style.position="fixed";
        ta.style.left="-9999px";
        ta.style.top="0";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        const ok = document.execCommand("copy");
        document.body.removeChild(ta);
        return !!ok;
      }catch{
        return false;
      }
    }
  }

  function getCorrectLevelH(){
    if (window.QRCodeCorrectLevel && window.QRCodeCorrectLevel.H != null) return window.QRCodeCorrectLevel.H;
    if (window.QRCode && window.QRCode.CorrectLevel && window.QRCode.CorrectLevel.H != null) return window.QRCode.CorrectLevel.H;
    return undefined;
  }

  function waitForQRCode(timeoutMs = 2000){
    return new Promise((resolve) => {
      const start = Date.now();
      const tick = () => {
        if (typeof window.QRCode === "function") return resolve(true);
        if (Date.now() - start > timeoutMs) return resolve(false);
        requestAnimationFrame(tick);
      };
      tick();
    });
  }

  function waitForQrNode(targetEl, timeoutMs = 2500){
    return new Promise((resolve) => {
      const start = Date.now();
      const tick = () => {
        const node = targetEl.querySelector("canvas, img, svg, table");
        if (node) return resolve(node);
        if (Date.now() - start > timeoutMs) return resolve(null);
        requestAnimationFrame(tick);
      };
      tick();
    });
  }

  async function renderQr(targetEl, text){
    if (!targetEl) return;
    const payload = String(text || "").trim();
    targetEl.innerHTML = "";

    if (!payload || payload === "—") return;

    const ok = await waitForQRCode(2000);
    if (!ok) {
      targetEl.innerHTML = `<div class="meta" style="color:#0b1220;">QR kunde inte laddas.</div>`;
      return;
    }

    const size = 168;
    try{
      const levelH = getCorrectLevelH();
      let qr = null;

      try{
        qr = new window.QRCode(targetEl);
        if (qr && qr._htOption){
          qr._htOption.width = size;
          qr._htOption.height = size;
          qr._htOption.colorDark = "#0b1220";
          qr._htOption.colorLight = "#ffffff";
          if (levelH != null) qr._htOption.correctLevel = levelH;
        }
        if (qr && typeof qr.makeCode === "function") qr.makeCode(payload);
      }catch{
        qr = null;
      }

      if (!qr) {
        new window.QRCode(targetEl, {
          text: payload,
          width: size,
          height: size,
          colorDark: "#0b1220",
          colorLight: "#ffffff",
          correctLevel: levelH
        });
      }
    }catch(e){
      targetEl.innerHTML = `<div class="meta" style="color:#0b1220;">QR-koden kunde inte visas.</div>`;
      return;
    }

    const node = await waitForQrNode(targetEl, 2500);
    if (node){
      node.style.display = "block";
      node.style.width = size + "px";
      node.style.height = size + "px";
      node.style.imageRendering = "pixelated";
    }
  }

  async function fetchJson(url){
    const sep = url.includes("?") ? "&" : "?";
    const bustUrl = url + sep + "t=" + Date.now();
    const r = await fetch(bustUrl, { cache:"no-store", credentials:"same-origin" });
    const data = await r.json().catch(() => ({}));
    if (!r.ok) throw new Error(data?.error || data?.detail || `HTTP ${r.status}`);
    return data;
  }

  function safeText(v, fallback="—"){
    const s = String(v ?? "").trim();
    return s ? s : fallback;
  }

  function isMeaningful(v){
    const s = String(v ?? "").trim();
    if (!s || s === "—") return false;
    if (/^0+$/.test(s)) return false;
    return true;
  }

  function updateTechVisibility(observedPoint, registrationRef){
    const details = $("techDetails");
    if (!details) return;
    const hasObs = isMeaningful(observedPoint);
    const hasRef = isMeaningful(registrationRef);
    if (!hasObs && !hasRef){
      details.open = false;
      details.style.display = "none";
      return;
    }
    details.style.display = "block";
    details.open = true;
  }

  async function run(){
    hideWarn();

    const url = new URL(location.href);
    const hash = (url.searchParams.get("hash") || "").trim();
    const tx = (url.searchParams.get("tx") || "").trim();

    const checkedParam = (url.searchParams.get("checked") || "").trim();
    const checked = (() => {
      const n = Number(checkedParam);
      if (Number.isFinite(n) && n > 0) return Math.floor(n);
      return Math.floor(Date.now() / 1000);
    })();

    // ✅ HARDTEST: bygg alltid intygslänk mot /certificate.html (inte pathname)
    const certPath = "/certificate.html";
    const certLink = `${location.origin}${certPath}?hash=${encodeURIComponent(hash)}&checked=${checked}${tx ? `&tx=${encodeURIComponent(tx)}` : ""}`;

    // ✅ Verifieringslänk: inkluderar tx om det finns (för enkel spårning)
    const verifyLink = `${location.origin}/verify.html?hash=${encodeURIComponent(hash)}${tx ? `&tx=${encodeURIComponent(tx)}` : ""}`;

    $("btnOpenVerify").href = verifyLink;
    $("btnPrint").onclick = () => window.print();
    $("btnRefresh").onclick = () => run();

    $("certLink").textContent = certLink;
    $("certLink").href = certLink;

    $("verifyLink").textContent = verifyLink;
    $("verifyLink").href = verifyLink;

    // Klicka på hash för copy
    const hashEl = $("hashText");
    const copyHashBtn = $("copyHash");
    const copyVerifyBtn = $("copyVerify");
    const copyCertBtn = $("copyCert");

    const doCopy = async (text, label) => {
      const ok = await copyTextToClipboard(text);
      showWarn(ok
        ? `<b>Kopierat:</b> ${label}`
        : `<b>Kunde inte kopiera.</b> Markera och kopiera manuellt.`);
      setTimeout(() => hideWarn(), 1200);
    };

    if (hashEl){
      hashEl.onclick = () => isValidBytes32Hex(hashEl.textContent) && doCopy(hashEl.textContent, "Verifierings-ID");
      hashEl.onkeydown = (e) => {
        if (e.key === "Enter" || e.key === " ") { e.preventDefault(); hashEl.click(); }
      };
    }

    copyHashBtn.onclick = () => doCopy(hash, "Verifierings-ID");
    copyVerifyBtn.onclick = () => doCopy(verifyLink, "Verifieringslänk");
    copyCertBtn.onclick = () => doCopy(certLink, "Länk till intyg");

    // tider (snapshot)
    $("checkedLocal").innerHTML = fmtSeHtml(checked);
    $("checkedUtc").textContent = fmtUtc(checked);

    // default
    $("hashText").textContent = hash || "—";
    $("resultText").textContent = "Kontrollerar…";
    $("legalLine").textContent = "—";
    $("regLocal").textContent = "—";
    $("regUtc").textContent = "—";
    $("observedPoint").textContent = "—";
    $("registrationRef").textContent = "—";
    updateTechVisibility("—", "—");

    // QR bygger på verifyLink
    await renderQr($("qrBox"), verifyLink);

    const qrTap = $("qrTap");
    const doQrCopy = async () => doCopy(verifyLink, "Verifieringslänk");
    qrTap.onclick = (e) => { e.preventDefault(); doQrCopy(); };
    qrTap.onkeydown = (e) => {
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); doQrCopy(); }
    };

    if (tx){
      $("techHint").innerHTML = `Registreringsreferens i länk: <span class="mono">${tx}</span>`;
    } else {
      $("techHint").textContent = "";
    }

    // validera hash
    if (!isValidBytes32Hex(hash)){
      setStatus("UNKNOWN", "Ogiltigt ID");
      $("hashText").textContent = "Ogiltigt eller saknas (hash=...)";
      $("resultText").textContent = "Kunde inte kontrollera: saknat/ogiltigt Verifierings-ID i URL.";
      $("legalLine").textContent = "Ingen slutsats kan dras utan giltigt Verifierings-ID.";
      showWarn(`<b>Fel:</b> Intyget saknar giltigt Verifierings-ID i URL.<br/>Exempel: <span class="mono">/certificate.html?hash=0x...</span>`);
      return;
    }

    // Hämta status
    setStatus("SUBMITTED_UNCONFIRMED", "Kontrollerar…");
    $("resultText").textContent = "Kontrollerar status hos Proofy…";

    let v;
    try{
      // tx är valfritt; API kan ignorera
      const u = `/api/verify?hash=${encodeURIComponent(hash)}${tx ? `&tx=${encodeURIComponent(tx)}` : ""}`;
      v = await fetchJson(u);
    }catch(e){
      setStatus("UNKNOWN", "Kunde inte kontrolleras");
      $("resultText").textContent = "Kunde inte kontrolleras vid kontrolltillfället.";
      $("legalLine").textContent = "Detta är ett tekniskt fel. Ingen slutsats kan dras om bekräftelse.";
      showWarn(`<b>Tillfälligt fel:</b> kontrollen kunde inte genomföras.<br/>Försök igen eller öppna verifiering: <a href="${verifyLink}">${verifyLink}</a>`);
      return;
    }

    const statusCode = safeText(v?.statusCode, "UNKNOWN");
    const statusText = safeText(v?.statusText, "Kunde inte kontrolleras");
    const legalText  = safeText(v?.legalText, "");
    const confirmedAtUnix = (v?.confirmedAtUnix != null) ? Number(v.confirmedAtUnix) : null;

    // tech
    const observedPoint = safeText(v?.evidence?.observedBlockNumber, "—");
    const registrationRef = safeText(v?.submission?.txHash, "—");
    $("observedPoint").textContent = observedPoint;
    $("registrationRef").textContent = registrationRef;
    updateTechVisibility(observedPoint, registrationRef);

    // badge
    if (statusCode === "CONFIRMED") setStatus("CONFIRMED", "Bekräftad");
    else if (statusCode === "SUBMITTED_UNCONFIRMED") setStatus("SUBMITTED_UNCONFIRMED", "Inskickad – ej bekräftad");
    else if (statusCode === "NOT_CONFIRMED") setStatus("NOT_CONFIRMED", "Ej bekräftad");
    else setStatus("UNKNOWN", "Kunde inte kontrolleras");

    $("resultText").textContent = statusText;

    // legal line
    if (legalText){
      $("legalLine").textContent = legalText;
    } else {
      if (statusCode === "CONFIRMED"){
        $("legalLine").textContent = "Status är bekräftad vid kontrolltillfället.";
      } else if (statusCode === "SUBMITTED_UNCONFIRMED"){
        $("legalLine").textContent = "En registrering är inskickad men ännu ej bekräftad. Intyget visar inte 'bekräftad' innan bekräftelse finns.";
      } else if (statusCode === "NOT_CONFIRMED"){
        $("legalLine").textContent = "Ingen bekräftad notering kunde konstateras vid kontrolltillfället.";
      } else {
        $("legalLine").textContent = "Status kunde inte kontrolleras vid kontrolltillfället. Ingen slutsats kan dras om bekräftelse.";
      }
    }

    // confirmed time
    if (statusCode === "CONFIRMED" && Number.isFinite(confirmedAtUnix) && confirmedAtUnix > 0){
      $("regLocal").innerHTML = fmtSeHtml(confirmedAtUnix);
      $("regUtc").textContent = fmtUtc(confirmedAtUnix);
      return;
    }

    $("regLocal").textContent = "—";
    $("regUtc").textContent = "—";

    if (statusCode === "SUBMITTED_UNCONFIRMED"){
      showWarn(`<b>Inskickad – ej bekräftad.</b><br/>Intyget kan inte redovisa bekräftelse innan status är bekräftad.`);
      return;
    }
    if (statusCode === "NOT_CONFIRMED"){
      showWarn(`<b>Ej bekräftad.</b><br/>Ingen bekräftad notering kunde konstateras vid kontrolltillfället. Kontrollera att rätt filversion/Verifierings-ID används och uppdatera vid behov.`);
      return;
    }

    showWarn(`<b>Kunde inte kontrolleras.</b><br/>Kontroll kunde inte genomföras vid kontrolltillfället. Försök igen eller öppna verifieringssidan.`);
  }

  run();
})();
</script>

<script src="/assets/header-toggle.js?v=2026-01-03a" defer></script>
<script src="/chat-widget.js?v=2026-01-03a" defer></script>
</body>
</html>
