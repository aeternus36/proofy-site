<!doctype html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Proofy – Verifieringsintyg</title>

    <style>
      :root{
        --bg:#070b14;
        --card:#0e1526;
        --card2:#0b1220;
        --border:rgba(255,255,255,.08);
        --text:#eaf0ff;
        --muted:rgba(234,240,255,.72);
        --muted2:rgba(234,240,255,.55);
        --good:#36d399;
        --bad:#ff6b6b;
        --warn:#fbbf24;
        --btn:#1b2a4a;
        --btn2:#1a3b74;
        --shadow:0 20px 60px rgba(0,0,0,.35);
        --radius:18px;
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      }
      *{box-sizing:border-box}
      body{
        margin:0;
        background: radial-gradient(1200px 600px at 30% 20%, rgba(67,108,255,.20), transparent 60%),
                    radial-gradient(900px 500px at 70% 35%, rgba(54,211,153,.12), transparent 55%),
                    var(--bg);
        color:var(--text);
        font-family:var(--sans);
      }
      a{color:inherit}
      header{
        max-width:1100px;
        margin:0 auto;
        padding:22px 18px;
        display:flex;
        align-items:center;
        justify-content:space-between;
      }
      .brand{
        display:flex; gap:10px; align-items:center;
        font-weight:700;
      }
      .logo{
        width:34px;height:34px;border-radius:10px;
        background:linear-gradient(135deg, rgba(67,108,255,.9), rgba(54,211,153,.85));
        box-shadow:0 10px 25px rgba(0,0,0,.25);
      }
      nav{display:flex; gap:10px; flex-wrap:wrap}
      .navbtn{
        padding:10px 14px;
        border:1px solid var(--border);
        border-radius:999px;
        background:rgba(255,255,255,.04);
        text-decoration:none;
        font-weight:600;
        color:var(--text);
        transition:.15s ease;
      }
      .navbtn:hover{transform:translateY(-1px); background:rgba(255,255,255,.06)}
      .navbtn.primary{background:linear-gradient(135deg, rgba(67,108,255,.95), rgba(54,211,153,.85)); border:0}

      main{
        max-width:1100px;
        margin:0 auto;
        padding:10px 18px 48px;
      }

      .pill{
        display:inline-flex; align-items:center; gap:10px;
        padding:8px 12px;
        border:1px solid var(--border);
        border-radius:999px;
        background:rgba(255,255,255,.04);
        color:var(--muted);
        font-weight:600;
        font-size:13px;
      }

      .hero{
        margin-top:10px;
        border:1px solid var(--border);
        background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
        border-radius:var(--radius);
        box-shadow:var(--shadow);
        padding:26px;
      }
      .heroTop{
        display:flex;
        gap:16px;
        align-items:flex-start;
        justify-content:space-between;
        flex-wrap:wrap;
      }
      h1{
        margin:12px 0 8px;
        font-size:44px;
        letter-spacing:-.02em;
        line-height:1.02;
      }
      .lead{
        max-width:820px;
        color:var(--muted);
        line-height:1.55;
        font-size:16px;
      }
      .statusBadge{
        display:inline-flex; align-items:center; gap:8px;
        padding:10px 14px;
        border-radius:999px;
        font-weight:800;
        border:1px solid var(--border);
        background:rgba(255,255,255,.05);
        min-width:160px;
        justify-content:center;
      }
      .dot{width:9px;height:9px;border-radius:99px;background:var(--warn)}
      .statusBadge.good .dot{background:var(--good)}
      .statusBadge.bad .dot{background:var(--bad)}
      .statusBadge.warn .dot{background:var(--warn)}

      .actions{
        display:flex; gap:10px; flex-wrap:wrap;
        margin-top:16px;
      }
      button{
        appearance:none;
        border:1px solid var(--border);
        background:rgba(255,255,255,.04);
        color:var(--text);
        padding:12px 16px;
        border-radius:999px;
        font-weight:800;
        cursor:pointer;
        transition:.15s ease;
      }
      button:hover{transform:translateY(-1px); background:rgba(255,255,255,.06)}
      button.primary{
        background:linear-gradient(135deg, rgba(67,108,255,.95), rgba(54,211,153,.85));
        border:0;
      }
      button.ghost{background:transparent}
      button:disabled{opacity:.55; cursor:not-allowed; transform:none}

      .grid{
        margin-top:18px;
        display:grid;
        grid-template-columns: 1.15fr .85fr;
        gap:14px;
      }
      @media (max-width: 900px){
        .grid{grid-template-columns:1fr}
        h1{font-size:36px}
      }

      .card{
        border:1px solid var(--border);
        background:rgba(255,255,255,.03);
        border-radius:var(--radius);
        padding:18px;
      }
      .card h3{
        margin:2px 0 10px;
        font-size:13px;
        color:var(--muted2);
        letter-spacing:.08em;
        text-transform:uppercase;
      }
      .kv{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap:12px;
      }
      @media (max-width: 700px){
        .kv{grid-template-columns:1fr}
      }

      .val{
        background:rgba(0,0,0,.18);
        border:1px solid var(--border);
        border-radius:14px;
        padding:12px;
        min-height:54px;
      }
      .label{
        font-size:12px;
        color:var(--muted2);
        margin-bottom:6px;
        font-weight:700;
      }
      .mono{
        font-family:var(--mono);
        font-size:13px;
        word-break:break-all;
        color:rgba(234,240,255,.92);
      }

      .row{
        display:flex; align-items:center; justify-content:space-between; gap:10px;
      }
      .copyBtn{
        padding:8px 10px;
        font-weight:800;
        border-radius:12px;
      }

      .note{
        margin-top:12px;
        color:var(--muted);
        font-size:14px;
        line-height:1.55;
      }

      .fine{
        margin-top:14px;
        border-top:1px solid var(--border);
        padding-top:14px;
        color:var(--muted2);
        font-size:13px;
        line-height:1.55;
      }

      .qrWrap{
        display:flex; align-items:flex-start; gap:14px; flex-wrap:wrap;
      }
      #qrcode{
        width:168px; height:168px;
        border-radius:16px;
        border:1px solid var(--border);
        background:rgba(0,0,0,.22);
        display:grid; place-items:center;
        overflow:hidden;
      }
      #qrcode canvas, #qrcode img{
        width:168px !important;
        height:168px !important;
        display:block;
      }
      .small{
        font-size:12px; color:var(--muted2); line-height:1.45;
        max-width:360px;
      }

      .warnBox{
        margin-top:12px;
        border:1px solid rgba(251,191,36,.35);
        background:rgba(251,191,36,.08);
        border-radius:16px;
        padding:12px;
        color:rgba(255,255,255,.92);
        display:none;
      }
      .warnBox.show{display:block}
      .mutedLink{color:rgba(234,240,255,.85)}
    </style>

    <!-- QRCode lib (liten, stabil). Om du har CSP som blockerar CDN, kan du istället bundla lokalt. -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  </head>

  <body>
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>Proofy</div>
      </div>
      <nav>
        <a class="navbtn" href="/#pilot">Starta pilot</a>
        <a class="navbtn" href="/verify">Verifiera underlag</a>
        <a class="navbtn" href="/register">Skapa Verifierings-ID</a>
        <a class="navbtn primary" href="/#demo">Boka kort demo</a>
      </nav>
    </header>

    <main>
      <div class="pill">Intyg · spårbarhet · byrå & granskning</div>

      <section class="hero">
        <div class="heroTop">
          <div>
            <h1>Verifieringsintyg</h1>
            <div class="lead">
              Detta är ett <b>tekniskt intyg</b> som sammanfattar resultatet av en kontroll av ett
              <b>Verifierings-ID</b> (ett kontrollvärde kopplat till en specifik underlagsversion) mot Proofys register.
              Proofy lagrar <b>inte</b> dokumentinnehåll i samband med kontrollen.
            </div>
          </div>

          <div id="statusBadge" class="statusBadge warn" title="Status för verifiering">
            <span class="dot"></span>
            <span id="statusText">Kontrollerar…</span>
          </div>
        </div>

        <div class="actions">
          <button class="primary" id="btnPrint">Skriv ut / Spara som PDF</button>
          <button id="btnRefresh">Uppdatera</button>
          <button class="ghost" id="btnOpenVerify">Öppna verifiering</button>
        </div>

        <div id="warnBox" class="warnBox"></div>

        <div class="grid">
          <div class="card">
            <h3>Sammanfattning</h3>
            <div class="kv">
              <div class="val">
                <div class="label">Verifierings-ID</div>
                <div class="row">
                  <div class="mono" id="hashText">—</div>
                  <button class="copyBtn" id="copyHash">Kopiera</button>
                </div>
                <div class="small" style="margin-top:8px">
                  ID:t avser en specifik filversion. Ny export/omskanning/omkomprimering kan ge nytt ID även om underlaget ser likadant ut.
                </div>
              </div>

              <div class="val">
                <div class="label">Kontroll genomförd</div>
                <div class="mono" id="checkedLocal">—</div>
                <div class="mono" id="checkedUtc" style="margin-top:6px;color:rgba(234,240,255,.72)">—</div>
                <div class="small" style="margin-top:8px">
                  Tidpunkten avser <b>när kontrollen kördes</b> (uppdatera intyget vid behov).
                </div>
              </div>

              <div class="val">
                <div class="label">Resultat</div>
                <div class="mono" id="resultText">—</div>
              </div>

              <div class="val">
                <div class="label">Registreringstid hos Proofy</div>
                <div class="mono" id="regLocal">—</div>
                <div class="mono" id="regUtc" style="margin-top:6px;color:rgba(234,240,255,.72)">—</div>
              </div>
            </div>

            <div class="fine">
              <b>Juridisk/ revisionsmässig tydlighet:</b> Detta intyg är ett tekniskt underlag för spårbarhet och efterhandskontroll.
              Det är <b>inte</b> e-signering, arkivering eller juridisk rådgivning. Bevisvärde och relevans bedöms alltid i sitt sammanhang
              (t.ex. process, åtkomstkontroller, versionshantering och dokumentationskedja).
            </div>
          </div>

          <div class="card">
            <h3>Länkar & QR</h3>
            <div class="qrWrap">
              <div>
                <div id="qrcode" aria-label="QR-kod"></div>
              </div>
              <div>
                <div class="val" style="margin-bottom:12px">
                  <div class="label">Länk till intyg</div>
                  <div class="row">
                    <div class="mono" id="certLink">—</div>
                    <button class="copyBtn" id="copyCert">Kopiera</button>
                  </div>
                </div>

                <div class="val">
                  <div class="label">Verifieringslänk</div>
                  <div class="row">
                    <div class="mono" id="verifyLink">—</div>
                    <button class="copyBtn" id="copyVerify">Kopiera</button>
                  </div>
                </div>

                <div class="note">
                  Tips: Spara Verifierings-ID i ärendet och dela verifieringslänken/QR för snabb kontroll vid intern kvalitetskontroll eller efterhandsgranskning.
                </div>

                <div class="fine">
                  <b>Integritet:</b> Filen lämnar inte din dator i samband med skapande av ID eller kontroll i webbläsaren.
                  Proofy hanterar endast ID:t och registreringstid i registret.
                </div>
              </div>
            </div>
          </div>
        </div>

      </section>
    </main>

    <script>
      // ---------- Helpers ----------
      const $ = (id) => document.getElementById(id);

      function isValidBytes32Hex(s){
        return typeof s === "string" && s.startsWith("0x") && s.length === 66;
      }

      function toUtcString(ms){
        const d = new Date(ms);
        return d.toISOString().replace("T"," ").replace(".000Z"," UTC");
      }

      function toLocalString(ms){
        const d = new Date(ms);
        // Europe/Stockholm-ish via browser locale
        return d.toLocaleString(undefined, { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit", second:"2-digit" });
      }

      function setStatus(type, text){
        const badge = $("statusBadge");
        badge.classList.remove("good","bad","warn");
        badge.classList.add(type);
        $("statusText").textContent = text;
      }

      function showWarn(html){
        const box = $("warnBox");
        box.innerHTML = html;
        box.classList.add("show");
      }
      function hideWarn(){
        const box = $("warnBox");
        box.innerHTML = "";
        box.classList.remove("show");
      }

      async function copyText(text){
        try{
          await navigator.clipboard.writeText(text);
        }catch{
          // fallback
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
        }
      }

      function renderQR(text){
        const el = $("qrcode");
        el.innerHTML = "";
        if (typeof QRCode === "undefined"){
          el.innerHTML = '<div class="small">QR-biblioteket kunde inte laddas (CSP/CDN). Länken fungerar ändå.</div>';
          return;
        }
        new QRCode(el, {
          text,
          width: 168,
          height: 168,
          correctLevel: QRCode.CorrectLevel.M
        });
      }

      async function verify(hash){
        const r = await fetch(`/api/verify?hash=${encodeURIComponent(hash)}`, { cache: "no-store" });
        const t = await r.text();
        let j = null;
        try { j = JSON.parse(t); } catch {}
        if (!r.ok) throw new Error(j?.error || j?.detail || t || `HTTP ${r.status}`);
        return j;
      }

      // Optional: trigger register from certificate if not registered.
      // You can disable by setting AUTO_REGISTER = false.
      const AUTO_REGISTER = false; // <- ändra till true om du vill att cert automatiskt ska försöka registrera
      async function register(hash){
        const r = await fetch(`/api/register`, {
          method: "POST",
          headers: { "content-type":"application/json" },
          body: JSON.stringify({ hash }),
        });
        const t = await r.text();
        let j = null;
        try { j = JSON.parse(t); } catch {}
        if (!r.ok) throw new Error(j?.error || j?.detail || t || `HTTP ${r.status}`);
        return j;
      }

      async function pollUntilRegistered(hash, { attempts=24, delayMs=5000 } = {}){
        for (let i=1; i<=attempts; i++){
          const v = await verify(hash).catch(() => null);
          if (v && v.exists) return v;
          await new Promise(r => setTimeout(r, delayMs));
        }
        return null;
      }

      // ---------- Main ----------
      async function run(){
        hideWarn();

        const url = new URL(location.href);
        const hash = (url.searchParams.get("hash") || "").trim();

        // "checked" may be unix seconds passed in query (optional)
        const checked = url.searchParams.get("checked");
        const checkedMs = checked && /^\d+$/.test(checked)
          ? Number(checked) * 1000
          : Date.now();

        $("checkedLocal").textContent = `${toLocalString(checkedMs)} (lokal tid)`;
        $("checkedUtc").textContent = toUtcString(checkedMs);

        // Build links
        const certLink = `${location.origin}${location.pathname}?hash=${encodeURIComponent(hash)}&checked=${Math.floor(checkedMs/1000)}&cert=${encodeURIComponent(url.searchParams.get("cert") || "")}`;
        const verifyLink = `${location.origin}/verify.html?hash=${encodeURIComponent(hash)}`;

        $("certLink").textContent = certLink;
        $("verifyLink").textContent = verifyLink;

        $("btnOpenVerify").onclick = () => location.href = verifyLink;
        $("btnPrint").onclick = () => window.print();
        $("btnRefresh").onclick = () => run();

        $("copyHash").onclick = () => copyText(hash || "");
        $("copyCert").onclick = () => copyText(certLink);
        $("copyVerify").onclick = () => copyText(verifyLink);

        // QR should always show
        renderQR(certLink);

        // Validate hash
        if (!isValidBytes32Hex(hash)){
          setStatus("bad", "Ogiltigt ID");
          $("hashText").textContent = "Ogiltigt eller saknas (hash=...)";
          $("resultText").textContent = "Kunde inte verifiera: saknat/ogiltigt Verifierings-ID i URL.";
          $("regLocal").textContent = "—";
          $("regUtc").textContent = "—";
          showWarn(`
            <b>Fel:</b> Intyget saknar giltigt <span class="mono">hash</span> i URL:en.<br/>
            Exempel: <span class="mono">/certificate.html?hash=0x...</span>
          `);
          return;
        }

        $("hashText").textContent = hash;

        setStatus("warn", "Kontrollerar…");
        $("resultText").textContent = "Kontrollerar mot Proofys register…";
        $("regLocal").textContent = "—";
        $("regUtc").textContent = "—";

        // 1) Verify
        let v;
        try{
          v = await verify(hash);
        }catch(e){
          setStatus("bad", "Tillfälligt fel");
          $("resultText").textContent = "Kunde inte kontrollera just nu (tillfälligt fel).";
          showWarn(`
            <b>Tillfälligt fel:</b> API-svaret kunde inte hämtas.<br/>
            Försök igen eller öppna verifieringssidan: <a class="mutedLink" href="${verifyLink}">${verifyLink}</a>
          `);
          return;
        }

        if (v.exists){
          // Registered
          const ts = Number(v.timestamp || 0);
          const regMs = ts * 1000;

          setStatus("good", "Registrerad");
          $("resultText").textContent = "Registrerad (registrering hittades).";
          $("regLocal").textContent = `${toLocalString(regMs)} (lokal tid)`;
          $("regUtc").textContent = toUtcString(regMs);
          return;
        }

        // Not registered
        setStatus("bad", "Ej registrerad");
        $("resultText").textContent = "Inte registrerad (ingen registrering hittades).";
        $("regLocal").textContent = "—";
        $("regUtc").textContent = "—";

        // Optional: attempt to register + poll
        if (AUTO_REGISTER){
          showWarn(`
            <b>Inte registrerad:</b> Intyget kan (valfritt) försöka registrera ID:t och uppdatera status automatiskt.
            <div style="margin-top:10px">
              <button id="btnTryRegister" class="primary">Försök registrera nu</button>
            </div>
            <div class="small" style="margin-top:10px">
              Om du inte vill att intyg ska kunna trigga registrering, stäng av AUTO_REGISTER i filen.
            </div>
          `);

          const btn = document.getElementById("btnTryRegister");
          if (btn){
            btn.onclick = async () => {
              btn.disabled = true;
              setStatus("warn", "Registrerar…");
              $("resultText").textContent = "Registrering skickas…";

              let reg;
              try{
                reg = await register(hash);
              }catch(e){
                setStatus("bad", "Misslyckades");
                $("resultText").textContent = "Registrering misslyckades.";
                showWarn(`<b>Registrering misslyckades:</b> ${String(e.message || e).slice(0,200)}`);
                btn.disabled = false;
                return;
              }

              // poll verify
              $("resultText").textContent = "Väntar på bekräftelse…";
              const polled = await pollUntilRegistered(hash, { attempts: 24, delayMs: 5000 });

              if (polled && polled.exists){
                const ts = Number(polled.timestamp || 0);
                const regMs = ts * 1000;
                setStatus("good", "Registrerad");
                $("resultText").textContent = "Registrerad (registrering hittades).";
                $("regLocal").textContent = `${toLocalString(regMs)} (lokal tid)`;
                $("regUtc").textContent = toUtcString(regMs);

                hideWarn();
                return;
              }

              setStatus("warn", "Väntar…");
              $("resultText").textContent = "Transaktionen är skickad men inte bekräftad ännu.";
              showWarn(`
                <b>Transaktion skickad men ännu inte synlig i registret.</b><br/>
                Detta är normalt på testnät vid kö/pending. Klicka <b>Uppdatera</b> om en stund.<br/>
                ${reg?.txHash ? `Tx: <span class="mono">${reg.txHash}</span>` : ``}
              `);
              btn.disabled = false;
            };
          }
        } else {
          // guidance only
          showWarn(`
            <b>Inte registrerad:</b> Kontroll visar att ID:t inte finns i registret vid kontrolltillfället.<br/>
            Kontrollera att du använder rätt filversion/ID och att registrering verkligen bekräftades on-chain.
          `);
        }
      }

      // Kickstart
      run();
    </script>
  </body>
</html>
