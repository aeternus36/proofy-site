<!doctype html>
<!-- CERTIFICATE v2026-01-19a / SE audit+juridik / HARDTEST 5/5 / UI: no internal labels -->
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="robots" content="noindex" />
    <meta name="theme-color" content="#0b1220" />
    <title>Proofy – Verifieringsintyg</title>

    <link rel="stylesheet" href="/assets/proofy.css?v=2026-01-03a" />
    <link rel="stylesheet" href="/assets/header.css?v=2026-01-03a" />

    <style>
      :root{
        --bg:#070b14;
        --border:rgba(255,255,255,.08);
        --text:#eaf0ff;
        --muted:rgba(234,240,255,.72);
        --muted2:rgba(234,240,255,.55);
        --good:#36d399;
        --bad:#ff6b6b;
        --warn:#fbbf24;
        --shadow:0 20px 60px rgba(0,0,0,.35);
        --radius:18px;
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";

        --qr-dark:#0b1220;
        --qr-light:#ffffff;
        --qr-frame: rgba(255,255,255,.10);
        --qr-shadow: 0 14px 42px rgba(0,0,0,.35);

        /* Fallback-space så chat/FAB aldrig täcker innehåll på mobil (JS kan justera) */
        --proofy-fab-space: 120px;
      }

      *{box-sizing:border-box}
      html{ background: var(--bg) !important; }
      body{
        margin:0;
        background-color: var(--bg) !important;
        background-image:
          radial-gradient(1200px 600px at 30% 20%, rgba(67,108,255,.20), transparent 60%),
          radial-gradient(900px 500px at 70% 35%, rgba(54,211,153,.12), transparent 55%) !important;
        background-repeat: no-repeat !important;
        background-attachment: scroll !important;
        background-size: auto !important;
        color:var(--text);
        font-family:var(--sans);
      }
      html::before, html::after, body::before, body::after{
        content:none !important;
        display:none !important;
      }

      a{color:inherit}
      .skip{
        position:absolute; left:-9999px; top:auto;
        width:1px; height:1px; overflow:hidden;
      }
      .skip:focus{
        left:18px; top:18px; width:auto; height:auto;
        padding:10px 12px; border-radius:12px;
        border:1px solid var(--border);
        background:rgba(255,255,255,.08);
        z-index:999;
      }
      a:focus-visible, button:focus-visible, [role="button"]:focus-visible, summary:focus-visible{
        outline: 2px solid rgba(110,168,255,.55);
        outline-offset: 3px;
        border-radius: 14px;
      }

      main{
        max-width:1100px;
        margin:0 auto;
        padding:
          10px
          18px
          calc(48px + env(safe-area-inset-bottom) + var(--proofy-fab-space, 120px));
      }

      .pill{
        display:inline-flex; align-items:center; gap:10px;
        padding:8px 12px;
        border:1px solid var(--border);
        border-radius:999px;
        background:rgba(255,255,255,.04);
        color:var(--muted);
        font-weight:700;
        font-size:13px;
      }

      .hero{
        margin-top:10px;
        border:1px solid var(--border);
        background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
        border-radius:var(--radius);
        box-shadow:var(--shadow);
        padding:26px;
      }
      .heroTop{
        display:flex;
        gap:16px;
        align-items:flex-start;
        justify-content:space-between;
        flex-wrap:wrap;
      }
      h1{
        margin:12px 0 8px;
        font-size:44px;
        letter-spacing:-.02em;
        line-height:1.02;
      }

      .statusArea{
        display:flex;
        flex-direction:column;
        align-items:flex-end;
        gap:10px;
        min-width:220px;
      }

      .statusBadge{
        display:inline-flex; align-items:center; gap:8px;
        padding:10px 14px;
        border-radius:999px;
        font-weight:900;
        border:1px solid var(--border);
        background:rgba(255,255,255,.05);
        min-width:220px;
        justify-content:center;
        text-align:center;
      }
      .dot{width:9px;height:9px;border-radius:99px;background:var(--warn)}
      .statusBadge.good .dot{background:var(--good)}
      .statusBadge.bad .dot{background:var(--bad)}
      .statusBadge.warn .dot{background:var(--warn)}

      .statusMeta{
        width:100%;
        border:1px solid var(--border);
        border-radius:16px;
        background:rgba(255,255,255,.03);
        padding:12px;
      }
      .statusMeta .label{ margin:0 0 6px; }

      .actions{
        display:flex; gap:10px; flex-wrap:wrap;
        margin-top:16px;
      }
      .actions .btn{
        display:inline-flex;
        align-items:center;
        justify-content:center;
        text-decoration:none;
      }

      .auditTop{
        margin-top:16px;
        display:grid;
        grid-template-columns: 1.05fr .95fr;
        gap:14px;
        align-items:start;
      }
      @media (max-width: 900px){
        .auditTop{ grid-template-columns:1fr; }
        h1{font-size:36px}
        .statusArea{ align-items:stretch; }
      }

      .card{
        border:1px solid var(--border);
        background:rgba(255,255,255,.03);
        border-radius:var(--radius);
        padding:18px;
      }
      .card h3{
        margin:2px 0 10px;
        font-size:13px;
        color:var(--muted2);
        letter-spacing:.08em;
        text-transform:uppercase;
      }

      .kv{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap:12px;
      }
      @media (max-width: 700px){
        .kv{grid-template-columns:1fr}
      }

      .val{
        background:rgba(0,0,0,.18);
        border:1px solid var(--border);
        border-radius:14px;
        padding:12px;
        min-height:54px;
      }
      .label{
        font-size:12px;
        color:var(--muted2);
        margin-bottom:6px;
        font-weight:800;
      }
      .mono{
        font-family:var(--mono);
        font-size:13px;
        word-break:break-word;
        overflow-wrap:anywhere;
        color:rgba(234,240,255,.92);
      }

      .row{
        display:flex; align-items:center; justify-content:space-between; gap:10px;
      }

      .copyBtn{
        padding:8px 10px;
        font-weight:900;
        border-radius:12px;
        white-space:nowrap;
        border:1px solid rgba(255,255,255,.14);
        background:rgba(255,255,255,.04);
        color:var(--text);
        cursor:pointer;
      }
      .copyBtn:hover{ background:rgba(255,255,255,.06); }
      .copyBtn[disabled]{
        opacity:.55;
        cursor:default;
      }

      .note{
        margin-top:12px;
        color:var(--muted);
        font-size:14px;
        line-height:1.55;
      }

      .fine{
        margin-top:14px;
        border-top:1px solid var(--border);
        padding-top:14px;
        color:var(--muted2);
        font-size:13px;
        line-height:1.6;
      }

      .qrWrap{
        display:flex; align-items:flex-start; gap:14px; flex-wrap:wrap;
      }

      #qrcodeTap{
        width:184px; height:184px;
        border-radius:18px;
        border:1px solid var(--qr-frame);
        background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
        box-shadow: var(--qr-shadow);
        display:grid; place-items:center;
        overflow:hidden;
        -webkit-tap-highlight-color: transparent;
        user-select:none;
      }
      #qrcodeSurface{
        width:176px; height:176px;
        border-radius:16px;
        background:var(--qr-light);
        border:1px solid rgba(0,0,0,.10);
        display:grid; place-items:center;
      }

      #qrcode{
        width:168px; height:168px;
        display:grid; place-items:center;
      }
      #qrcode canvas, #qrcode img, #qrcode svg{
        width:168px !important;
        height:168px !important;
        display:block;
        image-rendering: pixelated;
      }

      .small{
        font-size:12px; color:var(--muted2); line-height:1.45;
        max-width:520px;
      }

      .warnBox{
        margin-top:12px;
        border:1px solid rgba(251,191,36,.35);
        background:rgba(251,191,36,.10);
        border-radius:16px;
        padding:12px;
        color:rgba(255,255,255,.92);
        display:none;
      }
      .warnBox.show{display:block}
      .mutedLink{color:rgba(234,240,255,.88)}
      .footer{
        margin-top:14px;
        color:var(--muted2);
        font-size:12.5px;
        line-height:1.55;
      }

      details.more{
        margin-top:12px;
        border:1px solid var(--border);
        border-radius:16px;
        background:rgba(255,255,255,.02);
        padding:10px 12px;
      }
      details.more > summary{
        cursor:pointer;
        font-weight:900;
        color:rgba(234,240,255,.90);
        list-style:none;
      }
      details.more > summary::-webkit-details-marker{display:none}
      .moreGrid{
        margin-top:10px;
        display:grid;
        grid-template-columns: 1fr;
        gap:10px;
      }

      details.actionsMore{
        margin-top:12px;
        border:1px solid var(--border);
        border-radius:16px;
        background:rgba(255,255,255,.02);
        padding:10px 12px;
      }
      details.actionsMore > summary{
        cursor:pointer;
        font-weight:900;
        color:rgba(234,240,255,.90);
        list-style:none;
      }
      details.actionsMore > summary::-webkit-details-marker{display:none}
      .actionsMoreGrid{
        margin-top:10px;
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        align-items:center;
      }

      .tz{
        white-space:nowrap;
        word-break:normal;
        overflow-wrap:normal;
      }

      /* Noteringsruta */
      .noteBox{
        margin-top:12px;
        border:1px solid rgba(255,255,255,.12);
        background:rgba(255,255,255,.03);
        border-radius:16px;
        padding:12px;
      }
      .noteText{
        margin-top:8px;
        border:1px solid rgba(255,255,255,.10);
        background:rgba(0,0,0,.18);
        border-radius:14px;
        padding:12px;
        font-family:var(--mono);
        font-size:12.5px;
        line-height:1.5;
        color:rgba(234,240,255,.92);
        white-space:pre-wrap;
        overflow-wrap:anywhere;
        user-select:text;
      }
      .noteActions{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        align-items:center;
        margin-top:10px;
      }
      .noteHint{
        margin-top:10px;
        font-size:12px;
        color:var(--muted2);
        line-height:1.45;
      }

      .screenOnly{ display:block; }
      .printOnly{ display:none; }

      /* Extra hård mobil-säkring mot FAB/keyboard */
      @media (max-width: 700px){
        :root{ --proofy-fab-space: 140px; }
      }

      /* Print footer (självbärande PDF) */
      #printFooter{ display:none; }

      @media print{
        header, .actions, details.more, details.actionsMore { display:none !important; }

        /* Kompakt PDF som standard (5/5 revision/juridik) */
        .screenOnly{ display:none !important; }
        .printOnly{ display:block !important; }

        body{ background:#fff !important; color:#000 !important; }
        main{ max-width:none !important; padding: 0 0 64px 0 !important; }
        .hero, .card { box-shadow:none !important; border-color:#ddd !important; background:#fff !important; }
        .pill { display:none !important; }

        h1{ font-size:26px !important; margin:0 0 8px !important; }
        .statusBadge{ border-color:#ddd !important; background:#fff !important; min-width:auto !important; }
        .dot{ border:1px solid #999 !important; }

        .val, .statusMeta, .noteBox, .noteText { border-color:#ddd !important; background:#fff !important; }
        .label{ color:#111 !important; }
        .mono{ color:#111 !important; }

        .auditTop{ display:flex !important; flex-direction:column !important; gap:12px !important; }
        .card{ break-inside:avoid; page-break-inside:avoid; padding:12px !important; }
        .kv{ gap:10px !important; }
        .val{ padding:10px !important; }

        /* 5/5 audit: gör PDF kompakt – länkar finns redan i printFooter */
        #cardSummary{ display:none !important; }

        /* QR mindre men kvar i print (snabb kontroll) */
        #qrcodeTap{
          width:148px !important;
          height:148px !important;
          box-shadow:none !important;
          border-color:#ddd !important;
          background:#fff !important;
        }
        #qrcodeSurface{
          width:140px !important;
          height:140px !important;
          border-color:#ddd !important;
          background:#fff !important;
        }
        #qrcode{
          width:132px !important;
          height:132px !important;
        }
        #qrcode canvas, #qrcode img, #qrcode svg{
          width:132px !important;
          height:132px !important;
        }

        a{ color:#000 !important; text-decoration:none !important; }

        #printFooter{
          display:block !important;
          position:fixed;
          left:0; right:0; bottom:0;
          padding:10px 18px;
          border-top:1px solid #ddd;
          font-size:11px;
          line-height:1.35;
          color:#111;
          background:#fff;
        }
        #printFooter .mono{ font-family: var(--mono) !important; font-size:11px !important; color:#111 !important; }
      }
    </style>

    <!-- QR: only once (fix: removed duplicate include) -->
    <script src="/assets/qr.min.js?v=2026-01-03a"></script>

    <script>
      (function(){
        try{
          var p = location.pathname || "";
          if (p === "/certificate" || p === "/certificate/") {
            if (sessionStorage.getItem("__proofy_cert_redirected") === "1") return;
            sessionStorage.setItem("__proofy_cert_redirected","1");
            location.replace("/certificate.html" + (location.search || "") + (location.hash || ""));
          }
        }catch(e){}
      })();
    </script>
  </head>

  <body>
    <a class="skip" href="#main">Hoppa till innehåll</a>

    <header>
      <div class="wrap">
        <div class="nav">
          <a class="brand" href="/" aria-label="Proofy">
            <span class="logo" aria-hidden="true"></span>
            <span>Proofy</span>
          </a>

          <div class="navActions" id="navActionsDesktop">
            <a class="btn soft" href="/register.html">Skapa kontrollvärde</a>
            <a class="btn soft" href="/verify.html">Verifiera underlag</a>
            <a class="btn soft" href="/pilot.html">Starta pilot</a>
            <a class="btn primary" href="/#kontakt">Boka kort demo</a>
          </div>

          <details class="mnav" id="mnav">
            <summary class="mnavSummary" aria-label="Öppna meny">
              <span class="mnavIcon" aria-hidden="true"></span>
            </summary>

            <nav class="mnavMenu" aria-label="Meny">
              <a class="mnavLink" href="/register.html">Skapa kontrollvärde</a>
              <a class="mnavLink" href="/verify.html">Verifiera underlag</a>
              <a class="mnavLink" href="/pilot.html">Starta pilot</a>
              <a class="mnavLink mnavLinkPrimary" href="/#kontakt">Boka kort demo</a>

              <div class="mnavMeta">
                <a class="mnavLink" href="/security.html">Säkerhet</a>
                <a class="mnavLink" href="/privacy.html">Integritet</a>
                <a class="mnavLink" href="/terms.html">Villkor</a>
                <a class="mnavLink" href="/cookies.html">Cookies</a>

                <div class="mnavNote">Verifiering · revision · granskning</div>
                <a class="mnavMail" href="mailto:kontakt@proofy.se">kontakt@proofy.se</a>
              </div>
            </nav>
          </details>
        </div>
      </div>
    </header>

    <main id="main">
      <div class="pill">Intyg · revision · granskning</div>

      <section class="hero" aria-label="Verifieringsintyg">
        <div class="heroTop">
          <div>
            <h1>Verifieringsintyg</h1>

            <!-- Kompakt sammanfattning som bara syns i PDF/print -->
            <div class="printOnly" style="margin-top:8px; max-width:90ch; font-size:12px; line-height:1.45;">
              <b>Syfte:</b> Redovisa status för ett kontrollvärde (Verifierings-ID) vid en kontrolltid.
              <br/>
              <b>Avgränsning:</b> Uttalar sig inte om dokumentets innehåll/riktighet/äkthet och ersätter inte processkontroller.
              <br/>
              <span style="opacity:.92">Kontrolltid kommer från enheten (ej extern tidsstämpling).</span>
            </div>

            <!-- Längre förklaring på skärm (ej i PDF) -->
            <div class="small screenOnly" style="margin-top:10px; max-width:92ch;">
              <b>Syfte:</b> Detta intyg dokumenterar att en kontroll gjordes hos Proofy för ett angivet
              <b>kontrollvärde (Verifierings-ID)</b>.
              <br/><br/>
              <b>Intyget gäller:</b> Utfallet avser den kontroll som utfördes när intyget öppnades vid angiven kontrolltid.
              Utfallet kan ändras vid en senare kontroll om registerstatus uppdateras.
              <br/><br/>
              <b>Avgränsning:</b> Intyget uttalar sig inte om dokumentets innehåll, riktighet, giltighet eller äkthet.
              Intyget är inte juridisk rådgivning och ersätter inte processkontroller, behörighetsloggar,
              signering eller arkivering.
              <br/>
              <span style="opacity:.92">
                Kontrolltiden kommer från den enhet som öppnar intyget och är inte extern tidsstämpling.
              </span>
            </div>
          </div>

          <div class="statusArea" aria-label="Status och kontrolltid" aria-busy="true" id="statusArea">
            <div id="statusBadge" class="statusBadge warn" title="Status hos Proofy vid kontrollen">
              <span class="dot" aria-hidden="true"></span>
              <span id="statusText">—</span>
            </div>

            <div class="statusMeta">
              <div class="label">Kontrolltid (denna kontroll)</div>
              <div class="mono" id="checkedTopLocal" style="word-break:normal; overflow-wrap:normal; white-space:normal;">—</div>
              <div class="mono" id="checkedTopUtc" style="margin-top:6px;color:rgba(234,240,255,.72); word-break:normal; overflow-wrap:normal; white-space:normal;">—</div>
              <div class="small screenOnly" style="margin-top:8px">
                Kontrolltiden kommer från enheten och kan vara fel om enhetens klocka är fel. Den är inte extern tidsstämpling.
              </div>

              <div class="label" style="margin-top:10px">Bevisstatus vid kontrollen (registerstatus)</div>
              <div class="mono" id="resultText">—</div>
              <div class="small" id="legalLine" style="margin-top:8px">—</div>
            </div>
          </div>
        </div>

        <!-- 5/5-prio: en primär åtgärd. Övrigt ligger bakom "Fler åtgärder". -->
        <div class="actions" aria-label="Åtgärder">
          <button class="btn primary" id="btnPrint" type="button">Skriv ut / Spara som PDF</button>
        </div>

        <details class="actionsMore screenOnly" id="actionsMore">
          <summary>Fler åtgärder</summary>
          <div class="actionsMoreGrid" aria-label="Fler åtgärder">
            <button class="btn soft" id="btnCopyCaseNoteTop" type="button">Kopiera notering (ärendeakt)</button>
            <button class="btn soft" id="btnRefresh" type="button">Kontrollera igen</button>
            <a class="btn soft" id="btnOpenVerify" href="/verify.html">Öppna verifiering</a>
            <button class="btn soft" id="btnCopyVerifyLink" type="button">Kopiera verifieringslänk</button>
          </div>
        </details>

        <div id="warnBox" class="warnBox" role="status" aria-live="polite" aria-atomic="true"></div>

        <div class="auditTop" aria-label="Snabböversikt (revision/juridik)">
          <div class="card" id="cardEssentials">
            <h3>Nyckeluppgifter (för ärendeakt)</h3>

            <div class="kv">
              <div class="val">
                <div class="label">Kontrollvärde (Verifierings-ID)</div>
                <div class="row">
                  <div class="mono" id="idText">—</div>
                  <button class="copyBtn" id="copyId" type="button">Kopiera</button>
                </div>
                <div class="small screenOnly" style="margin-top:8px">
                  Kontrollvärdet avser en specifik filversion. Ny export/omskanning/omkomprimering kan ge nytt kontrollvärde även om underlaget ser likadant ut.
                </div>
              </div>

              <!-- Visas ENDAST när status är Bekräftad -->
              <div class="val" id="confirmedBox" style="display:none;">
                <div class="label">Tidpunkt (endast om status är Bekräftad)</div>
                <div class="mono" id="confirmedLocal" style="word-break:normal; overflow-wrap:normal; white-space:normal;">—</div>
                <div class="mono" id="confirmedUtc" style="margin-top:6px;color:rgba(234,240,255,.72); word-break:normal; overflow-wrap:normal; white-space:normal;">—</div>
                <div class="small screenOnly" style="margin-top:8px">
                  Tidpunkten avser när Proofy kan redovisa bekräftelse för kontrollvärdet i sitt register – inte när dokumentet upprättades, signerades, godkändes eller kommunicerades.
                </div>
              </div>
            </div>

            <div class="kv" style="margin-top:12px">
              <div class="val" id="controlIdVal">
                <div class="label">Kontroll-ID (detta kontrolltillfälle)</div>
                <div class="mono" id="controlIdOut">—</div>
                <div class="small screenOnly" style="margin-top:8px">
                  Beräknas lokalt från kontrollvärde, kontrolltid och utfallet. Kan användas som intern referens. Döljs om miljön inte stödjer beräkning.
                </div>
              </div>

              <div class="val" id="certIdVal">
                <div class="label">Intygs-ID (valfritt)</div>
                <div class="mono" id="certIdOut">Ej angivet</div>
                <div class="small screenOnly" style="margin-top:8px">
                  Om en organisation använder ett internt intygs-ID kan det anges i länken och visas här.
                </div>
              </div>
            </div>

            <div class="val" style="margin-top:12px">
              <div class="label">Intygslänk (denna visning)</div>
              <div class="mono" id="certLinkInline">—</div>
              <div class="small screenOnly" style="margin-top:8px">
                Rekommenderas att sparas i ärendeakten. Vid senare kontroll kan status uppdateras – använd verifieringslänk/QR för ny kontroll.
              </div>
            </div>

            <!-- Notering för ärendeakt (kopiera + valfri nedladdning bakom details) -->
            <div class="noteBox screenOnly" aria-label="Notering för ärendeakt">
              <div class="label">Notering för ärendeakt (rekommenderad)</div>
              <div class="noteText" id="caseNoteText" role="textbox" aria-label="Noteringstext" tabindex="0">—</div>

              <div class="noteActions">
                <button class="copyBtn" id="copyCaseNote" type="button" disabled>Kopiera notering</button>

                <details class="more" id="noteMore" style="margin-top:0;">
                  <summary>Fler alternativ</summary>
                  <div class="moreGrid">
                    <button class="copyBtn" id="downloadCaseNote" type="button" disabled>Ladda ner .txt</button>
                  </div>
                </details>
              </div>

              <div class="noteHint">
                Tips: Klistra in noteringen i ärendeakten tillsammans med eventuell dokumentation om process/åtkomst.
              </div>
            </div>

            <div class="small screenOnly" style="margin-top:10px; opacity:.95;">
              <b>För revision/juridik:</b> Intyget dokumenterar en kontroll som utfördes vid angiven kontrolltid.
              Bevisvärde bedöms i sitt sammanhang (process, åtkomst, versionshantering och övrig dokumentation).
            </div>
          </div>

          <div class="card" id="cardLinks">
            <h3>Verifieringslänk &amp; QR</h3>
            <div class="qrWrap">
              <div>
                <div class="label" style="margin-bottom:8px">QR-kod (snabb kontroll)</div>
                <div id="qrcodeTap" aria-label="QR-kod">
                  <div id="qrcodeSurface">
                    <div id="qrcode" aria-label="QR-kod"></div>
                  </div>
                </div>
                <div class="small" style="margin-top:10px">
                  Skanna med <b>annan enhet</b> för snabb kontroll.
                </div>
              </div>

              <div style="flex:1; min-width:260px;">
                <div class="val" style="margin-bottom:12px">
                  <div class="label">Verifieringslänk</div>
                  <div class="mono" id="verifyLink">—</div>
                </div>

                <div class="val">
                  <div class="label">Kontext (valfritt)</div>
                  <div class="small" id="contextHint" style="margin-top:2px">—</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="small screenOnly" style="margin-top:14px; max-width:96ch;">
          <b>Detta intyg visar:</b> att Proofy vid kontrollen kunde redovisa angiven status för kontrollvärdet.<br/>
          <b>Detta intyg visar inte:</b> dokumentets innehåll, riktighet, giltighet eller äkthet – och ersätter inte juridisk bedömning.
        </div>

        <div class="card screenOnly" id="cardSummary" style="margin-top:14px;">
          <h3>Tydlighet för granskning</h3>

          <div class="fine" style="border-top:0; padding-top:0; margin-top:0;">
            <b>Sammanfattning (självbärande)</b><br/>
            • Intyget redovisar status för kontrollvärdet i Proofys register vid kontrollen.<br/>
            • Tidpunkt redovisas endast om status är <b>Bekräftad</b>.<br/>
            • Tidpunkten avser bekräftelse av kontrollvärdet i Proofys register – inte när dokumentet upprättades eller användes.<br/>
            • Intyget ersätter inte signering, arkivering, behörighetsloggar eller processkontroller.<br/>
            • Bevisvärde bedöms i sitt sammanhang (process, åtkomst, versionshantering och dokumentationskedja).<br/>
            • Utfallet kan ändras vid en senare kontroll om registerstatus uppdateras.
          </div>

          <details class="more" id="moreDetails">
            <summary>Mer information (valfritt)</summary>
            <div class="moreGrid">
              <div class="val" id="internalRefAWrap">
                <div class="label">Intern referens (valfri)</div>
                <div class="mono" id="internalRefA">—</div>
                <div class="small" style="margin-top:6px">
                  Kan underlätta intern uppföljning/support. Behövs normalt inte i ärendet.
                </div>
              </div>
              <div class="val" id="internalRefBWrap">
                <div class="label">Spårningsreferens (valfri)</div>
                <div class="mono" id="internalRefB">—</div>
                <div class="small" style="margin-top:6px">
                  Kan användas vid felsökning. Påverkar inte intygets innebörd.
                </div>
              </div>
            </div>
          </details>

          <div class="footer" id="issuerFooter">
            <div><b>Integritet:</b> Vid kontroll lämnas inte filen ut. Kontroll sker med kontrollvärdet.</div>
            <div style="margin-top:6px"><b>Utfärdare:</b> <span id="issuerName">Proofy AB</span><span id="issuerOrgNr"></span></div>
            <div style="margin-top:6px">Kontakt: <a href="mailto:kontakt@proofy.se">kontakt@proofy.se</a></div>
          </div>
        </div>

        <!-- Print footer (självbärande vid PDF/utskrift) -->
        <div id="printFooter" aria-hidden="true">
          <div><b>Verifieringsintyg – Proofy</b></div>
          <div style="margin-top:4px;">
            Kontrollvärde: <span class="mono" id="pf_id">—</span>
          </div>
          <div id="pf_controlIdRow">
            Kontroll-ID: <span class="mono" id="pf_controlId">—</span>
          </div>
          <div>
            Kontrolltid (UTC): <span class="mono" id="pf_checkedUtc">—</span>
          </div>
          <div>
            Status vid kontrollen: <span class="mono" id="pf_status">—</span>
          </div>
          <div id="pf_confirmedRow" style="display:none;">
            Tidpunkt (UTC, endast om Bekräftad): <span class="mono" id="pf_confirmedUtc">—</span>
          </div>
          <div style="margin-top:4px;">
            Verifieringslänk: <span class="mono" id="pf_verify">—</span>
          </div>
          <div>
            Intygslänk: <span class="mono" id="pf_cert">—</span>
          </div>
          <div style="margin-top:4px;">
            Utfärdare: <span class="mono" id="pf_issuer">Proofy AB</span>
          </div>
        </div>
      </section>
    </main>

    <script>
      /* Intern versionsrad (visas inte för mottagare) */
      const CERT_INTERNAL_VERSION = "certificate.html v2026-01-19a (SE audit/juridik, hardtest)";

      const ISSUER_LEGAL_NAME = "Proofy AB";   // ändra vid behov
      const ISSUER_ORGNR = "";                 // valfritt: t.ex. "org.nr 556XXXX-XXXX"

      const $ = (id) => document.getElementById(id);

      function isValidVerifieringsId(s){
        return typeof s === "string" && /^0x[0-9a-fA-F]{64}$/.test(s.trim());
      }

      function nowSeconds(){ return Math.floor(Date.now()/1000); }
      function pad2(n){ return String(n).padStart(2,"0"); }

      function fmtUtc(sec){
        const n = Number(sec);
        if(!Number.isFinite(n) || n <= 0) return "—";
        const d = new Date(n * 1000);
        return `${d.getUTCFullYear()}-${pad2(d.getUTCMonth()+1)}-${pad2(d.getUTCDate())} ${pad2(d.getUTCHours())}:${pad2(d.getUTCMinutes())}:${pad2(d.getUTCSeconds())} UTC`;
      }

      function fmtSeHtml(sec){
        const n = Number(sec);
        if(!Number.isFinite(n) || n <= 0) return "—";
        try{
          const dt = new Date(n*1000);
          const tz = "Europe/Stockholm";
          const se = new Intl.DateTimeFormat("sv-SE", {
            timeZone: tz,
            year:"numeric", month:"2-digit", day:"2-digit",
            hour:"2-digit", minute:"2-digit", second:"2-digit"
          }).format(dt);
          return `${se} (<span class="tz">${tz}</span>)`;
        }catch{
          return new Date(n*1000).toLocaleString("sv-SE") + " (lokal)";
        }
      }

      function fmtSePlain(sec){
        const n = Number(sec);
        if(!Number.isFinite(n) || n <= 0) return "—";
        try{
          return new Intl.DateTimeFormat("sv-SE", {
            timeZone:"Europe/Stockholm",
            year:"numeric", month:"2-digit", day:"2-digit",
            hour:"2-digit", minute:"2-digit", second:"2-digit"
          }).format(new Date(n*1000)) + " (Europe/Stockholm)";
        }catch{
          return new Date(n*1000).toLocaleString("sv-SE");
        }
      }

      function setStatus(tone, text){
        const badge = $("statusBadge");
        badge.classList.remove("good","bad","warn");
        badge.classList.add(tone);
        $("statusText").textContent = text;
      }

      function showWarn(text){
        const box = $("warnBox");
        box.textContent = String(text || "");
        box.classList.add("show");
      }
      function hideWarn(){
        const box = $("warnBox");
        box.textContent = "";
        box.classList.remove("show");
      }

      async function copyText(text){
        const t = String(text || "").trim();
        if(!t || t === "—") return false;
        try{
          await navigator.clipboard.writeText(t);
          return true;
        }catch{
          try{
            const ta = document.createElement("textarea");
            ta.value = t;
            ta.style.position="fixed";
            ta.style.left="-9999px";
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            document.body.removeChild(ta);
            return true;
          }catch{
            return false;
          }
        }
      }

      function toastCopied(label){
        showWarn(`Kopierat: ${label}`);
        setTimeout(() => hideWarn(), 1200);
      }

      function downloadTextFile(filename, text){
        const blob = new Blob([String(text || "")], { type:"text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(url), 1200);
      }

      function renderQR(text){
        const el = $("qrcode");
        el.innerHTML = "";

        const payload = String(text || "").trim();
        const setFallback = (msg) => {
          el.innerHTML =
            '<div class="small" style="padding:10px;color:#0b1220;text-align:center;line-height:1.35">' +
            msg +
            "</div>";
        };

        if (!payload){
          setFallback("Ingen länk att koda.");
          return;
        }

        const correctLevel =
          (window.QRCodeCorrectLevel && window.QRCodeCorrectLevel.H != null) ? window.QRCodeCorrectLevel.H :
          (window.QRCode && window.QRCode.CorrectLevel && window.QRCode.CorrectLevel.H != null) ? window.QRCode.CorrectLevel.H :
          undefined;

        const runRender = () => {
          if (typeof window.QRCode !== "function"){
            setFallback("QR kunde inte laddas.");
            return;
          }
          try{
            let qr = null;

            try{
              qr = new window.QRCode(el);
              if (qr && qr._htOption){
                qr._htOption.width = 168;
                qr._htOption.height = 168;
                qr._htOption.colorDark = getComputedStyle(document.documentElement).getPropertyValue("--qr-dark").trim() || "#0b1220";
                qr._htOption.colorLight = "#ffffff";
                if (correctLevel != null) qr._htOption.correctLevel = correctLevel;
              }
            }catch{
              qr = null;
            }

            if (!qr || typeof qr.makeCode !== "function"){
              el.innerHTML = "";
              qr = new window.QRCode(el, {
                width:168,
                height:168,
                colorDark:(getComputedStyle(document.documentElement).getPropertyValue("--qr-dark").trim() || "#0b1220"),
                colorLight:"#ffffff",
                correctLevel: correctLevel
              });
            }

            if (!qr || typeof qr.makeCode !== "function"){
              setFallback("QR-koden kunde inte visas.");
              return;
            }

            qr.makeCode(payload);

            const node = el.querySelector("canvas, img, svg, table");
            if (!node){
              setFallback("QR-koden kunde inte visas.");
              return;
            }
            node.style.width = "168px";
            node.style.height = "168px";
            node.style.display = "block";
            node.style.imageRendering = "pixelated";
          }catch(e){
            setFallback("QR-koden kunde inte visas.");
          }
        };

        if (typeof window.QRCode === "function") runRender();
        else setTimeout(runRender, 0);
      }

      function safeText(v, fallback="—"){
        const s = String(v ?? "").trim();
        return s ? s : fallback;
      }

      // Endast fyra tillåtna statusord (UI): Bekräftad / Inskickad – ej bekräftad / Ej bekräftad / Kunde inte kontrolleras
      function canonicalStatus(code, txKnown){
        if (code === "CONFIRMED") return "Bekräftad";
        if (code === "SUBMITTED_UNCONFIRMED"){
          return txKnown ? "Inskickad – ej bekräftad" : "Kunde inte kontrolleras";
        }
        if (code === "NOT_CONFIRMED") return "Ej bekräftad";
        return "Kunde inte kontrolleras";
      }

      function pickStatusPresentation(statusText){
        if (statusText === "Bekräftad") return { tone:"good", badge:"Bekräftad" };
        if (statusText === "Inskickad – ej bekräftad") return { tone:"warn", badge:"Inskickad – ej bekräftad" };
        if (statusText === "Ej bekräftad") return { tone:"bad", badge:"Ej bekräftad" };
        return { tone:"bad", badge:"Kunde inte kontrolleras" };
      }

      function isMeaningful(v){
        const s = String(v ?? "").trim();
        if (!s || s === "—") return false;
        if (/^0+$/.test(s)) return false;
        return true;
      }

      function updateMoreVisibility({ a, b, allow }){
        const more = $("moreDetails");
        if (!more) return;

        const hasA = isMeaningful(a);
        const hasB = isMeaningful(b);

        const aWrap = $("internalRefAWrap");
        const bWrap = $("internalRefBWrap");

        if (!allow || (!hasA && !hasB)){
          more.open = false;
          more.style.display = "none";
          if (aWrap) aWrap.style.display = "none";
          if (bWrap) bWrap.style.display = "none";
          return;
        }

        more.style.display = "block";
        more.open = false;

        if (aWrap) aWrap.style.display = hasA ? "block" : "none";
        if (bWrap) bWrap.style.display = hasB ? "block" : "none";
      }

      function buildCaseNote({
        verifieringsId,
        controlId,
        statusText,
        checkedLocalText,
        checkedUtcText,
        confirmedLocalText,
        confirmedUtcText,
        certLink,
        verifyLink,
        legalLine,
        certId,
        internalA,
        internalB
      }){
        const lines = [];
        lines.push("PROOFY – Notering (ärendeakt/granskningsunderlag)");
        lines.push("");
        lines.push("Kontrolltyp: Intyg (status för kontrollvärde vid kontrolltid).");
        lines.push("Syfte: Dokumentera att en kontroll av registerstatus för kontrollvärdet gjordes hos Proofy vid angiven kontrolltid.");
        lines.push("Avgränsning: Uttalar sig inte om dokumentets innehåll, riktighet, giltighet eller äkthet.");
        lines.push("");

        lines.push(`Kontrollvärde (Verifierings-ID): ${verifieringsId || "—"}`);
        if (controlId && controlId !== "—") lines.push(`Kontroll-ID (detta kontrolltillfälle): ${controlId}`);
        lines.push(`Kontrolltid (denna kontroll): ${checkedLocalText || "—"}`);
        lines.push(`Kontrolltid (UTC): ${checkedUtcText || "—"}`);
        lines.push("Obs: Kontrolltiden kommer från enheten som öppnar intyget och är inte extern tidsstämpling.");
        lines.push("");
        lines.push(`Bevisstatus vid kontrollen (registerstatus): ${statusText || "—"}`);
        if (legalLine) lines.push(`Kommentar: ${legalLine}`);

        if (certId) {
          lines.push("");
          lines.push(`Intygs-ID (valfritt): ${certId}`);
        }

        if (statusText === "Bekräftad" && confirmedLocalText && confirmedLocalText !== "—"){
          lines.push("");
          lines.push(`Tidpunkt (endast om Bekräftad): ${confirmedLocalText}`);
          if (confirmedUtcText && confirmedUtcText !== "—") lines.push(`Tidpunkt (UTC): ${confirmedUtcText}`);
          lines.push("Obs: Tidpunkten avser när Proofy kan redovisa bekräftelse för kontrollvärdet – inte när dokumentet upprättades eller användes.");
        }

        lines.push("");
        lines.push(`Intygslänk: ${certLink || "—"}`);
        lines.push(`Verifieringslänk: ${verifyLink || "—"}`);

        const hasA = internalA && internalA !== "—" && !/^0+$/.test(String(internalA));
        const hasB = internalB && internalB !== "—" && !/^0+$/.test(String(internalB));
        if (hasA || hasB){
          lines.push("");
          lines.push("Interna referenser (valfritt, för support/spårning):");
          if (hasA) lines.push(`- Intern referens: ${internalA}`);
          if (hasB) lines.push(`- Spårningsreferens: ${internalB}`);
        }

        lines.push("");
        lines.push("Slutsats: Noteringen visar utfallet av kontrollen vid kontrolltiden.");
        return lines.join("\n");
      }

      function setIssuer(){
        const nameEl = $("issuerName");
        const orgEl = $("issuerOrgNr");

        if (nameEl) nameEl.textContent = ISSUER_LEGAL_NAME || "Proofy";
        if (orgEl){
          if (String(ISSUER_ORGNR || "").trim()){
            orgEl.textContent = " · " + String(ISSUER_ORGNR).trim();
          } else {
            orgEl.textContent = "";
          }
        }
        const pfIssuer = $("pf_issuer");
        if (pfIssuer) pfIssuer.textContent = (ISSUER_LEGAL_NAME || "Proofy") + (String(ISSUER_ORGNR||"").trim() ? (" · " + String(ISSUER_ORGNR).trim()) : "");
      }

      function toHex(buffer){
        const bytes = new Uint8Array(buffer);
        let hex = "";
        for (let i=0; i<bytes.length; i++){
          hex += bytes[i].toString(16).padStart(2,"0");
        }
        return hex;
      }

      async function sha256Hex(text){
        try{
          if (!window.crypto || !crypto.subtle) return null;
          const enc = new TextEncoder();
          const data = enc.encode(String(text || ""));
          const digest = await crypto.subtle.digest("SHA-256", data);
          return toHex(digest);
        }catch{
          return null;
        }
      }

      // HARDTEST: timeout + retry
      function isRetryableStatus(status){
        return status === 408 || status === 425 || status === 429 || (status >= 500 && status <= 599);
      }

      async function fetchJsonWithTimeout(url, options = {}, timeoutMs = 20000){
        const controller = new AbortController();
        const t = setTimeout(() => controller.abort(), timeoutMs);
        try{
          const sep = url.includes("?") ? "&" : "?";
          const bustUrl = url + sep + "t=" + Date.now();
          const r = await fetch(bustUrl, {
            method: "GET",
            cache: "no-store",
            credentials: "same-origin",
            signal: controller.signal,
            ...options
          });
          const j = await r.json().catch(() => ({}));
          return { ok: r.ok, status: r.status, data: j, aborted:false };
        } catch (e){
          const aborted = (e && e.name === "AbortError");
          return { ok:false, status:0, data:{}, aborted };
        } finally {
          clearTimeout(t);
        }
      }

      async function fetchVerify(hash, tx){
        const base = `/api/verify?hash=${encodeURIComponent(hash)}${tx ? `&tx=${encodeURIComponent(tx)}` : ""}`;
        const attempts = 3;
        const baseDelay = 520;

        for (let i=0; i<attempts; i++){
          const res = await fetchJsonWithTimeout(base, {}, 20000);

          if (res.ok) return { ok:true, data:res.data, status:res.status };

          const retryable = res.aborted || isRetryableStatus(res.status);
          if (i < attempts - 1 && retryable){
            const jitter = Math.floor(Math.random()*180);
            await new Promise(r => setTimeout(r, baseDelay*(i+1) + jitter));
            continue;
          }
          return { ok:false, data:res.data, status:res.status };
        }
        return { ok:false, data:{}, status:0 };
      }

      function setNoteButtonsEnabled(enabled){
        const copyBtn = $("copyCaseNote");
        const dlBtn = $("downloadCaseNote");
        const topCopy = $("btnCopyCaseNoteTop");
        const copyVerify = $("btnCopyVerifyLink");

        if (copyBtn) copyBtn.disabled = !enabled;
        if (dlBtn) dlBtn.disabled = !enabled;
        if (topCopy) topCopy.disabled = !enabled;
        if (copyVerify) copyVerify.disabled = !enabled;
      }

      async function run(){
        hideWarn();
        setIssuer();

        const statusArea = $("statusArea");
        if (statusArea) statusArea.setAttribute("aria-busy","true");

        setNoteButtonsEnabled(false);

        const url = new URL(location.href);
        const debug = (url.searchParams.get("debug") || "").trim() === "1";

        const verifieringsId = (url.searchParams.get("hash") || "").trim();
        const optionalContext = (url.searchParams.get("tx") || "").trim();
        const certId = (url.searchParams.get("cert") || "").trim();

        // Kontrolltid: om "checked" är gammal använder vi ny kontrolltid (för att undvika missvisning).
        const checkedParam = (url.searchParams.get("checked") || "").trim();
        const checkedCandidate = Number(checkedParam);
        const now = nowSeconds();

        let checked = (Number.isFinite(checkedCandidate) && checkedCandidate > 0) ? Math.floor(checkedCandidate) : now;
        const skew = Math.abs(now - checked);
        const STALE_SECONDS = 15 * 60;

        if (skew > STALE_SECONDS){
          checked = now;
          showWarn("Observera: Tiden i länken var äldre. Intyget har därför gjort en ny kontroll nu och visar resultatet från denna kontroll.");
          setTimeout(() => hideWarn(), 4500);
        }

        const certLink =
          `${location.origin}/certificate.html?hash=${encodeURIComponent(verifieringsId)}&checked=${checked}` +
          (optionalContext ? `&tx=${encodeURIComponent(optionalContext)}` : "") +
          (certId ? `&cert=${encodeURIComponent(certId)}` : "");

        const verifyLink =
          `${location.origin}/verify.html?hash=${encodeURIComponent(verifieringsId)}&checked=${checked}` +
          (optionalContext ? `&tx=${encodeURIComponent(optionalContext)}` : "");

        $("certLinkInline").textContent = certLink;
        $("verifyLink").textContent = verifyLink;

        // Öppna verifiering
        $("btnOpenVerify").href = verifyLink;

        // Print footer values
        $("pf_id").textContent = verifieringsId || "—";
        $("pf_checkedUtc").textContent = fmtUtc(checked);
        $("pf_verify").textContent = verifyLink;
        $("pf_cert").textContent = certLink;

        // Reset print-only status rows each run
        $("pf_status").textContent = "—";
        const pfConfirmedRow = $("pf_confirmedRow");
        if (pfConfirmedRow) pfConfirmedRow.style.display = "none";
        const pfConfirmedUtc = $("pf_confirmedUtc");
        if (pfConfirmedUtc) pfConfirmedUtc.textContent = "—";

        $("btnPrint").onclick = () => window.print();
        $("btnRefresh").onclick = () => run();

        // Copy-ID (Verifierings-ID)
        $("copyId").onclick = async () => {
          if (await copyText(verifieringsId)) toastCopied("Kontrollvärde (Verifierings-ID)");
        };

        // Copy verifieringslänk (endast en tydlig plats)
        const btnCopyVerifyLink = $("btnCopyVerifyLink");
        if (btnCopyVerifyLink){
          btnCopyVerifyLink.onclick = async () => {
            if (await copyText(verifyLink)) toastCopied("Verifieringslänk");
          };
        }

        renderQR(verifyLink);

        // Kontrolltid (topp)
        const checkedLocalHtml = fmtSeHtml(checked);
        const checkedUtcText = fmtUtc(checked);
        $("checkedTopLocal").innerHTML = checkedLocalHtml;
        $("checkedTopUtc").textContent = checkedUtcText;

        // CertID: visa text (inga copy-knappar; inga innerHTML)
        if (certId){
          $("certIdOut").textContent = certId;
          $("certIdVal").style.display = "block";
        } else {
          $("certIdOut").textContent = "Ej angivet";
        }

        // Default: dölj tidpunkt-rutan (ska bara visas om Bekräftad)
        const confirmedBox = $("confirmedBox");
        if (confirmedBox) confirmedBox.style.display = "none";
        $("confirmedLocal").textContent = "—";
        $("confirmedUtc").textContent = "—";

        // Reset innan kontroll (statusfält ska inte visa andra ord än de fyra – använd "—" under laddning)
        $("resultText").textContent = "—";
        $("legalLine").textContent = "—";
        setStatus("warn", "—");

        $("internalRefA").textContent = "—";
        $("internalRefB").textContent = "—";
        updateMoreVisibility({ a:"—", b:"—", allow:false });

        // Kontext-hint (textContent för att undvika injection)
        const contextHintEl = $("contextHint");
        if (contextHintEl){
          if (certId){
            contextHintEl.textContent = `Intygs-ID: ${certId}`;
          } else if (optionalContext){
            contextHintEl.textContent = "Kontext: tx angiven i länken (används vid kontroll).";
          } else {
            contextHintEl.textContent = "Spara intygslänken i ärendeakten. Använd verifieringslänk/QR för ny kontroll vid behov.";
          }
        }

        // Notering: byggs först när slutstatus finns (för att undvika mellanlägen i ärendeakt)
        const noteEl = $("caseNoteText");
        const updateCaseNote = (payload) => {
          const note = buildCaseNote(payload);
          if (noteEl) noteEl.textContent = note;
          return note;
        };

        // Kopiera/ladda ner notering
        const copyNoteBtn = $("copyCaseNote");
        const dlNoteBtn = $("downloadCaseNote");
        const topCopy = $("btnCopyCaseNoteTop");

        if (copyNoteBtn){
          copyNoteBtn.onclick = async () => {
            const t = noteEl?.textContent || "";
            if (await copyText(t)) toastCopied("Notering för ärendeakt");
          };
        }
        if (topCopy){
          topCopy.onclick = async () => {
            const t = noteEl?.textContent || "";
            if (await copyText(t)) toastCopied("Notering för ärendeakt");
          };
        }
        if (dlNoteBtn){
          dlNoteBtn.onclick = () => {
            const t = noteEl?.textContent || "";
            downloadTextFile("proofy-notering.txt", t);
            showWarn("Nerladdad: proofy-notering.txt");
            setTimeout(() => hideWarn(), 1200);
          };
        }

        // Kontroll-ID: init (visas först när vi vet utfallet)
        $("controlIdOut").textContent = "—";
        $("pf_controlId").textContent = "—";
        $("controlIdVal").style.display = "block";
        $("pf_controlIdRow").style.display = "block";

        if (!isValidVerifieringsId(verifieringsId)){
          const statusText = "Kunde inte kontrolleras";
          setStatus("bad", statusText);
          $("idText").textContent = "Ogiltigt eller saknas (Verifierings-ID)";
          $("resultText").textContent = statusText;
          const legalLine = "Ingen slutsats kan dras utan giltigt kontrollvärde (Verifierings-ID).";
          $("legalLine").textContent = legalLine;

          $("pf_status").textContent = statusText;

          // Dölj Kontroll-ID (ska inte användas när vi inte ens har giltigt ID)
          $("controlIdVal").style.display = "none";
          $("pf_controlIdRow").style.display = "none";

          updateCaseNote({
            verifieringsId: "—",
            controlId: "—",
            statusText,
            checkedLocalText: fmtSePlain(checked),
            checkedUtcText,
            confirmedLocalText: "—",
            confirmedUtcText: "—",
            certLink,
            verifyLink,
            legalLine,
            certId: certId || "",
            internalA: "—",
            internalB: "—"
          });

          setNoteButtonsEnabled(true);
          if (statusArea) statusArea.setAttribute("aria-busy","false");

          showWarn("Fel: Intyget saknar giltigt kontrollvärde (Verifierings-ID) i länken.");
          return;
        }

        $("idText").textContent = verifieringsId;

        // Meddela att kontroll sker (utan att använda andra statusord i statusfältet)
        showWarn("Kontroll pågår: hämtar registerstatus från Proofy…");

        // Verify med timeout+retry
        const verifyRes = await fetchVerify(verifieringsId, optionalContext || "");
        if (!verifyRes.ok){
          const statusText = "Kunde inte kontrolleras";
          setStatus("bad", statusText);
          $("resultText").textContent = statusText;
          const legalLine = "Tekniskt fel: kunde inte hämta status. Försök igen.";
          $("legalLine").textContent = legalLine;

          $("pf_status").textContent = statusText;

          // Dölj Kontroll-ID helt i fel-läge
          $("controlIdVal").style.display = "none";
          $("pf_controlIdRow").style.display = "none";

          updateCaseNote({
            verifieringsId,
            controlId: "—",
            statusText,
            checkedLocalText: fmtSePlain(checked),
            checkedUtcText,
            confirmedLocalText: "—",
            confirmedUtcText: "—",
            certLink,
            verifyLink,
            legalLine,
            certId: certId || "",
            internalA: "—",
            internalB: "—"
          });

          updateMoreVisibility({ a:"—", b:"—", allow:false });

          setNoteButtonsEnabled(true);
          if (statusArea) statusArea.setAttribute("aria-busy","false");

          showWarn("Tillfälligt fel: kontrollen kunde inte genomföras. Försök igen eller öppna verifieringssidan.");
          return;
        }

        const v = verifyRes.data || {};
        const statusCode = safeText(v?.statusCode, "UNKNOWN");
        const legalText = safeText(v?.legalText, "");
        const confirmedAtUnix = (v?.confirmedAtUnix != null) ? Number(v.confirmedAtUnix) : null;

        // txKnown: krävs för att få visa "Inskickad – ej bekräftad"
        const txFromApi = safeText(v?.submission?.txHash, "");
        const txKnown = !!optionalContext || (txFromApi && txFromApi !== "—");

        // Valfria interna referenser (endast om tx finns eller debug=1)
        const internalA = safeText(v?.evidence?.observedBlockNumber, "—");
        const internalB = safeText(v?.submission?.txHash, "—");
        const allowInternals = !!optionalContext || debug;

        $("internalRefA").textContent = internalA;
        $("internalRefB").textContent = internalB;
        updateMoreVisibility({ a: internalA, b: internalB, allow: allowInternals });

        // Status (fyra ord)
        const statusText = canonicalStatus(statusCode, txKnown);
        const pres = pickStatusPresentation(statusText);
        setStatus(pres.tone, pres.badge);
        $("resultText").textContent = statusText;
        $("pf_status").textContent = statusText;

        // Legal line: tydlig begränsning, utan antaganden
        const finalLegalLine = (() => {
          if (legalText) return legalText;

          if (statusText === "Bekräftad"){
            return "Proofy kan redovisa bekräftelse för kontrollvärdet vid kontrollen.";
          }
          if (statusText === "Inskickad – ej bekräftad"){
            return "En inskickning kan hänföras till känd transaktionsreferens, men bekräftelse kan ännu inte redovisas vid kontrollen.";
          }
          if (statusText === "Ej bekräftad"){
            return "Ingen bekräftelse kunde redovisas vid kontrollen.";
          }
          // Kunde inte kontrolleras
          if (statusCode === "SUBMITTED_UNCONFIRMED" && !txKnown){
            return "Status kunde inte kontrolleras: inskickad-status kräver känd transaktionsreferens (tx) men sådan saknas i denna kontroll.";
          }
          return "Status kunde inte kontrolleras vid kontrollen.";
        })();
        $("legalLine").textContent = finalLegalLine;

        // Kontroll-ID: Beräkna lokalt om möjligt. Döljs annars.
        const controlIdInput = [
          "proofy-cert",
          verifieringsId,
          String(checked),
          String(statusCode),
          (Number.isFinite(confirmedAtUnix) && confirmedAtUnix > 0) ? String(confirmedAtUnix) : "",
          certId || "",
          txKnown ? "tx:1" : "tx:0"
        ].join("|");

        const controlIdHex = await sha256Hex(controlIdInput);
        const controlId = controlIdHex ? ("c_" + controlIdHex) : null;

        $("controlIdOut").textContent = controlId ? controlId : "—";
        $("pf_controlId").textContent = controlId ? controlId : "—";

        const hasControlId = !!controlId;
        if (!hasControlId){
          $("controlIdVal").style.display = "none";
          $("pf_controlIdRow").style.display = "none";
        } else {
          $("controlIdVal").style.display = "block";
          $("pf_controlIdRow").style.display = "block";
        }

        // Tidpunkt: visas endast om Bekräftad och vi faktiskt fått en tid
        let confirmedLocalPlain = "—";
        let confirmedUtcPlain = "—";

        if (statusText === "Bekräftad" && Number.isFinite(confirmedAtUnix) && confirmedAtUnix > 0){
          if (confirmedBox) confirmedBox.style.display = "block";
          $("confirmedLocal").innerHTML = fmtSeHtml(confirmedAtUnix);
          $("confirmedUtc").textContent = fmtUtc(confirmedAtUnix);

          confirmedLocalPlain = fmtSePlain(confirmedAtUnix);
          confirmedUtcPlain = fmtUtc(confirmedAtUnix);

          if (pfConfirmedRow){
            $("pf_confirmedUtc").textContent = confirmedUtcPlain;
            pfConfirmedRow.style.display = "block";
          }
        } else {
          if (confirmedBox) confirmedBox.style.display = "none";
          if (pfConfirmedRow) pfConfirmedRow.style.display = "none";
        }

        // Bygg notering först när vi har slutstatus (fyra ord)
        updateCaseNote({
          verifieringsId,
          controlId: hasControlId ? controlId : "—",
          statusText,
          checkedLocalText: fmtSePlain(checked),
          checkedUtcText,
          confirmedLocalText: (statusText === "Bekräftad") ? confirmedLocalPlain : "—",
          confirmedUtcText: (statusText === "Bekräftad") ? confirmedUtcPlain : "—",
          certLink,
          verifyLink,
          legalLine: finalLegalLine,
          certId: certId || "",
          internalA: allowInternals ? internalA : "—",
          internalB: allowInternals ? internalB : "—"
        });

        // Aktivera kopiera/ladda ner när intyget är revisions-säkert (slutstatus finns)
        setNoteButtonsEnabled(true);
        if (statusArea) statusArea.setAttribute("aria-busy","false");

        // Slutlig UX-hjälptext utan att skapa nya statusord
        if (statusText === "Inskickad – ej bekräftad"){
          showWarn("Notera: Tidpunkt kan inte redovisas innan status är Bekräftad.");
          return;
        }
        if (statusText === "Ej bekräftad"){
          showWarn("Notera: Ingen bekräftelse kunde redovisas vid kontrollen. Kontrollera att rätt filversion/kontrollvärde används.");
          return;
        }
        if (statusText === "Kunde inte kontrolleras"){
          showWarn("Notera: Kontroll kunde inte slutföras med tillräckligt underlag. Försök igen eller öppna verifieringssidan.");
        } else {
          hideWarn();
        }
      }

      // Overlay-safe (robust): reserverar bottenutrymme för fixed widgets/FAB
      (function overlaySafe(){
        const root = document.documentElement;

        const candidates = () => {
          const els = [];
          const byId1 = document.getElementById("chatWidget");
          const byId2 = document.getElementById("chat-widget");
          if (byId1) els.push(byId1);
          if (byId2) els.push(byId2);

          const maybe = Array.from(document.querySelectorAll("button, a, div, iframe"))
            .filter(el => {
              if (!el || !el.getBoundingClientRect) return false;
              const cs = getComputedStyle(el);
              if (cs.position !== "fixed") return false;
              const r = el.getBoundingClientRect();
              if (r.width < 40 || r.height < 40) return false;

              const nearBottom = r.bottom > (window.innerHeight - 40);
              const nearRight = r.right > (window.innerWidth - 120);
              const nearLeft = r.left < 120;
              return nearBottom && (nearRight || nearLeft);
            });

          for (const el of maybe) els.push(el);
          return Array.from(new Set(els));
        };

        const compute = () => {
          const list = candidates();
          let extra = 0;

          for (const el of list){
            try{
              const r = el.getBoundingClientRect();
              if (r.height > extra) extra = r.height;
            } catch {}
          }

          const px = extra > 0 ? Math.ceil(extra + 18) : 0;
          root.style.setProperty("--proofy-fab-space", px + "px");
        };

        compute();
        window.addEventListener("resize", () => compute(), { passive:true });

        const obs = new MutationObserver(() => compute());
        obs.observe(document.body, { childList:true, subtree:true, attributes:true });

        let n = 0;
        const t = setInterval(() => {
          compute();
          n++;
          if (n > 8) clearInterval(t);
        }, 180);
      })();

      run();
    </script>

    <script src="/assets/header-toggle.js?v=2026-01-03a" defer></script>
    <script src="/chat-widget.js?v=2026-01-03a" defer></script>
  </body>
</html>
