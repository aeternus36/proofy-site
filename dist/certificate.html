<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proofy – Verifieringsintyg</title>
  <meta name="description" content="Verifieringsintyg som sammanfattar om ett Verifierings-ID är registrerat och när registreringen skedde." />
  <meta name="theme-color" content="#0b1220" />

  <link rel="stylesheet" href="/assets/proofy.css?v=2025-12-21" />

  <style>
    /* Certifikat: revisionsvänligt, tydligt, bra mobil. */
    .certWrap{ max-width: 920px; margin:0 auto; padding: 0 20px; }

    .certTop{
      margin-top: 14px;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow: 0 18px 60px rgba(0,0,0,.38);
      padding: 18px;
    }

    .certHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .certTitle{
      margin: 0;
      font-size: clamp(26px, 3.2vw, 42px);
      line-height: 1.12;
      letter-spacing: -.4px;
    }

    .certLead{
      margin: 10px 0 0;
      color: rgba(234,240,255,.92);
      max-width: 95ch;
      line-height: 1.55;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      font-weight: 950;
      white-space: nowrap;
    }
    .chip.ok{ color: var(--ok); }
    .chip.err{ color: var(--err); }
    .chip.neutral{ color: rgba(234,240,255,.92); }

    .topMetaGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 920px){
      .topMetaGrid{ grid-template-columns: 1fr; }
    }

    .panel{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(11,18,32,.25);
      border-radius: 16px;
      padding: 16px;
    }

    .label{
      color: rgba(169,183,211,.92);
      font-size: 12.5px;
      font-weight: 900;
      letter-spacing: .2px;
      margin-bottom: 6px;
      text-transform: uppercase;
    }

    .value{
      color: rgba(234,240,255,.92);
      line-height: 1.55;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      word-break: break-all;
    }

    .hr{ height:1px; background: rgba(255,255,255,.12); margin: 14px 0; }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 12px;
    }
    .actions .btn{ min-width: 180px; }
    @media (max-width:560px){
      .actions .btn{ width:100%; min-width: unset; }
    }

    .note{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 14px;
      color: rgba(169,183,211,.95);
      font-size: 13px;
      line-height: 1.55;
    }
    .note b{ color: rgba(234,240,255,.92); }

    .openBox{ display:none; margin-top: 12px; }
    .openRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }
    .openRow input{
      flex:1;
      min-width: 220px;
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(11,18,32,.35);
      color: rgba(234,240,255,.92);
      outline:none;
      font: inherit;
    }
    .openRow .btn{ min-width: 170px; }
    @media (max-width:560px){
      .openRow .btn{ width:100%; }
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 920px){
      .grid{ grid-template-columns: 1fr; }
    }

    .qrRow{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      align-items:flex-start;
      margin-top: 10px;
    }
    .qrBox{
      width: 170px;
      height: 170px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(11,18,32,.25);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .qrBox canvas, .qrBox img{
      width:150px !important;
      height:150px !important;
      image-rendering: pixelated;
    }

    .copyLine{
      display:flex;
      gap:10px;
      align-items:flex-start;
      flex-wrap:wrap;
      margin-top:6px;
    }
    .copyLine .mono{
      flex:1;
      min-width:240px;
    }
    .copyBtn{ min-width: 120px; }

    details{
      border:1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      padding: 14px;
      background: rgba(255,255,255,.04);
    }
    summary{ cursor:pointer; font-weight: 950; list-style:none; }
    summary::-webkit-details-marker{ display:none; }
    details p{ margin: 10px 0 0; color: rgba(169,183,211,.95); line-height:1.6; }

    /* Print/PDF */
    @media print{
      header, footer, .actions, .openBox, #qrWrap, .copyBtn { display:none !important; }
      body{ background:#fff !important; color:#000 !important; }
      .certTop{ box-shadow:none !important; background:#fff !important; border:1px solid #ddd !important; }
      .panel, .note, details{ background:#fff !important; border:1px solid #ddd !important; }
      .chip{ background:#fff !important; border:1px solid #ddd !important; }
      .label{ color:#444 !important; }
      .value{ color:#000 !important; }
      a{ color:#000 !important; text-decoration:none !important; }
    }
  </style>
</head>

<body>
<a class="skip" href="#main">Hoppa till innehåll</a>

<header>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="/" aria-label="Proofy">
        <span class="logo" aria-hidden="true"></span>
        <span>Proofy</span>
      </a>

      <!-- Beslut A: inga ankarlänkar i headern -->

      <div class="navActions">
        <a class="btn soft" href="/pilot.html">Starta pilot</a>
        <a class="btn" href="/verify.html">Verifiera underlag</a>
        <a class="btn" href="/register.html">Skapa Verifierings-ID</a>
        <a class="btn primary" href="/#kontakt">Boka demo</a>
      </div>
    </div>
  </div>
</header>

<main id="main">
  <div class="certWrap">

    <div class="badge" style="margin-top:18px;">Intyg · spårbarhet · byrå &amp; granskning</div>

    <section class="certTop" aria-label="Verifieringsintyg">

      <div class="certHead">
        <div style="flex:1;min-width:260px;">
          <h1 class="certTitle">Verifieringsintyg</h1>
          <p class="certLead">
            Detta intyg sammanfattar resultatet av en kontroll av ett <b>Verifierings-ID</b> (SHA-256-fingeravtryck för en filversion).
            Det visar om ID:t är registrerat och, i så fall, <b>när registreringen skedde</b>.
            <b>Inget dokumentinnehåll lagras</b> i Proofy.
          </p>
        </div>
        <div>
          <div id="statusChip" class="chip neutral">Laddar…</div>
        </div>
      </div>

      <div class="actions" aria-label="Åtgärder">
        <button class="btn primary" id="btnPrint" type="button">Skriv ut / Spara som PDF</button>
        <button class="btn soft" id="btnRefresh" type="button">Uppdatera</button>
        <a class="btn" id="btnVerify" href="/verify.html">Öppna verifiering</a>
      </div>

      <!-- Revisionsvänliga toppfält -->
      <div class="topMetaGrid" aria-label="Intygsmetadata">
        <div class="panel">
          <div class="label">UTFÄRDAD AV</div>
          <div class="value">
            Proofy (proofy.se)
            <div class="meta" style="margin-top:8px;">
              Kontakt: <b>kontakt@proofy.se</b>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="label">INTYG-ID (KONTROLL-ID)</div>
          <div id="certIdOut" class="value mono">—</div>
          <div class="meta" style="margin-top:8px;">
            Unikt ID för detta intyg (genereras lokalt). Bra för hänvisning i ärendeanteckning.
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="note">
        <b>Omfattning (Scope)</b><br />
        Intyget avser endast om en <b>filversion</b> (identiska bytes) kan knytas till en registreringstid via Verifierings-ID.
        Det är <b>inte</b> e-signering, inte arkivering och inte en bedömning av dokumentets innehåll eller riktighet.
      </div>

      <div id="openBox" class="openBox">
        <div class="hr"></div>
        <div class="note">
          <b>Öppna intyget</b><br />
          Klistra in Verifierings-ID eller öppna via länk:
          <span class="mono">/certificate.html?id=0x…</span>
          <span class="meta"> (även <span class="mono">?hash=0x…</span> fungerar)</span>
        </div>
        <div class="openRow">
          <input id="hashInput" type="text" placeholder="Verifierings-ID (0x…)" />
          <button id="btnOpen" class="btn primary" type="button">Öppna intyg</button>
          <button id="btnPaste" class="btn soft" type="button">Klistra in ID</button>
          <a class="btn" href="/verify.html">Gå till verifiering</a>
        </div>
        <div id="openHint" class="meta" style="margin-top:8px;"></div>
      </div>

      <div class="hr"></div>

      <div class="grid">
        <div class="panel">
          <div class="label">VERIFIERINGS-ID</div>
          <div class="copyLine">
            <div id="hashOut" class="value mono">—</div>
            <button class="btn soft copyBtn" id="btnCopyId" type="button" disabled>Kopiera</button>
          </div>
          <div class="meta" style="margin-top:8px;">
            ID:t avser en <b>filversion</b>. Ny export/omskanning/omkomprimering kan ge nytt ID även om dokumentet ser likadant ut.
          </div>
        </div>

        <div class="panel">
          <div class="label">KONTROLL GENOMFÖRD</div>
          <div id="checkedOut" class="value">—</div>
          <div class="meta" style="margin-top:8px;">
            Tidpunkt när denna kontroll kördes (uppdatering av intyget).
          </div>
        </div>
      </div>

      <div class="grid">
        <div class="panel">
          <div class="label">RESULTAT</div>
          <div id="resultOut" class="value">—</div>

          <div class="hr"></div>

          <div class="label">REGISTRERINGSTID (SVERIGE)</div>
          <div id="tsSeOut" class="value">—</div>

          <div class="label" style="margin-top:10px;">REGISTRERINGSTID (UTC)</div>
          <div id="tsUtcOut" class="value">—</div>
        </div>

        <div class="panel">
          <div class="label">LÄNKAR</div>

          <div class="label" style="margin-top:0;">Länk till intyg</div>
          <div class="copyLine">
            <div id="certLinkOut" class="value mono">—</div>
            <button class="btn soft copyBtn" id="btnCopyCert" type="button" disabled>Kopiera</button>
          </div>

          <div class="label" style="margin-top:10px;">Verifieringslänk</div>
          <div class="copyLine">
            <div id="verifyLinkOut" class="value mono">—</div>
            <button class="btn soft copyBtn" id="btnCopyVerify" type="button" disabled>Kopiera</button>
          </div>

          <div id="qrWrap">
            <div class="qrRow">
              <div>
                <div class="label" style="margin-top:12px;">QR-KOD</div>
                <div id="qrBox" class="qrBox" aria-label="QR-kod">—</div>
                <div id="qrStatus" class="meta" style="margin-top:8px;">—</div>
                <div class="meta" style="margin-top:8px;">
                  QR-koden leder till verifieringssidan för ID:t.
                </div>
              </div>
              <div style="flex:1; min-width:240px;">
                <div class="note" style="margin-top:12px;">
                  <b>Tips för byrå:</b> Spara Verifierings-ID + Intyg-ID i ärendet. Dela intygslänken för dokumentation och verifieringslänken/QR för snabb kontroll.
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <div class="panel" style="margin-top:12px;">
        <div class="label">TOLKNING</div>
        <div id="interpretation" class="value">—</div>
      </div>

      <div class="panel" style="margin-top:12px;">
        <div class="label">JURIDISK INFORMATION</div>
        <div class="value" style="color: rgba(169,183,211,.95);">
          Detta intyg är ett tekniskt underlag för dokumentation och spårbarhet. Det ersätter inte juridisk rådgivning,
          och ersätter inte professionell bedömning i granskning/revision. Bevisvärde bedöms alltid i sitt sammanhang.
        </div>

        <details style="margin-top:12px;">
          <summary>Visa fullständig text</summary>

          <p>
            <b>1) Utfärdare och kontakt</b><br/>
            Intyget tillhandahålls via tjänsten <b>proofy.se</b> (Proofy). Kontakt: <b>kontakt@proofy.se</b>.
          </p>

          <p>
            <b>2) Vad intyget visar</b><br/>
            Intyget visar utfallet av en kontroll av ett Verifierings-ID och (om registrerad) registreringstid.
          </p>

          <p>
            <b>3) Vad intyget inte visar</b><br/>
            Intyget visar inte vem som skapat dokumentet, vem som haft tillgång till det, om behörig person godkänt det,
            eller om filen hanterats/ändrats efter registrering. Intyget är inte e-signering, inte arkivering och inte ett avtal i sig.
          </p>

          <p>
            <b>4) Sekretess och personuppgifter</b><br/>
            Proofy lagrar inte dokumentinnehåll i samband med intyget. Intyget kan innehålla Verifierings-ID, tider och delbara länkar.
            Hantering av personuppgifter regleras i tillämplig integritetspolicy och villkor.
          </p>

          <p>
            <b>5) Användning i byrå-/revisionssammanhang</b><br/>
            Intyget är avsett som stöd för spårbarhet och dokumentation. Professionell bedömning, övriga kontrollåtgärder
            och krav på dokumentation kvarstår.
          </p>

          <p>
            <b>6) Drift, fel och tillgänglighet</b><br/>
            Tillfälliga driftstörningar kan påverka möjligheten att genomföra kontrollen vid ett visst tillfälle.
            Vid avvikelse rekommenderas att kontrollen görs om.
          </p>

          <p>
            <b>7) Ansvar</b><br/>
            Intyget lämnas som tekniskt underlag. Eventuellt ansvar och ansvarsbegränsningar regleras i Proofys villkor.
          </p>

          <p>
            <b>8) Tillämplig lag</b><br/>
            Svensk lag ska tillämpas i den mån annat inte följer av tvingande regler. Tvist hanteras enligt Proofys villkor.
          </p>

          <p class="meta">
            Länkar: <a href="/terms.html">Villkor</a> · <a href="/privacy.html">Integritet</a>
          </p>
        </details>
      </div>

      <div id="problemBox" class="note" style="display:none; margin-top:12px;">
        <b style="color: var(--err);">Tillfälligt tekniskt problem</b>
        <div id="problemText" style="margin-top:6px;">—</div>
      </div>

    </section>

    <p class="small" style="margin-top:14px;">
      Behöver ni ett upplägg för rutin/arbetsflöde i byrån? <a href="/#kontakt">Boka demo</a>.
    </p>

  </div>
</main>

<footer>
  <div class="wrap">
    <div class="foot">
      <div>
        <div style="color: rgba(234,240,255,.86); font-weight:800;">Proofy</div>
        <div class="small">© 2025 Proofy. Alla rättigheter förbehållna.</div>
        <div class="small" style="margin-top:8px; max-width:92ch;">
          Proofy tillhandahåller teknisk tidsstämpling och verifiering av filer.
          Tjänsten utgör inte juridisk rådgivning och avgör inte filens rättsliga giltighet.
        </div>
      </div>
      <div class="links">
        <a href="/security.html">Säkerhet</a>
        <a href="/privacy.html">Integritet</a>
        <a href="/terms.html">Villkor</a>
        <a href="/#kontakt">Kontakt</a>
      </div>
    </div>
  </div>
</footer>

<!-- QR-bibliotek -->
<script
  src="/qr.min.js?v=2025-12-20"
  onload="window.__proofyQrLibLoaded = true"
  onerror="window.__proofyQrLibError = true"
></script>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const statusChip = $("statusChip");
  const btnPrint = $("btnPrint");
  const btnRefresh = $("btnRefresh");
  const btnVerify = $("btnVerify");

  const certIdOut = $("certIdOut");

  const openBox = $("openBox");
  const hashInput = $("hashInput");
  const btnOpen = $("btnOpen");
  const btnPaste = $("btnPaste");
  const openHint = $("openHint");

  const hashOut = $("hashOut");
  const checkedOut = $("checkedOut");
  const resultOut = $("resultOut");
  const tsSeOut = $("tsSeOut");
  const tsUtcOut = $("tsUtcOut");

  const certLinkOut = $("certLinkOut");
  const verifyLinkOut = $("verifyLinkOut");

  const btnCopyId = $("btnCopyId");
  const btnCopyCert = $("btnCopyCert");
  const btnCopyVerify = $("btnCopyVerify");

  const qrBox = $("qrBox");
  const qrStatus = $("qrStatus");

  const interpretation = $("interpretation");

  const problemBox = $("problemBox");
  const problemText = $("problemText");

  let busy = false;
  let opId = 0;

  function setBusy(v){
    busy = v;
    btnRefresh.disabled = v;

    const canCopyId = !!hashOut.textContent && hashOut.textContent !== "—";
    const canCopyCert = !!certLinkOut.textContent && certLinkOut.textContent !== "—";
    const canCopyVerify = !!verifyLinkOut.textContent && verifyLinkOut.textContent !== "—";

    btnCopyId.disabled = v || !canCopyId;
    btnCopyCert.disabled = v || !canCopyCert;
    btnCopyVerify.disabled = v || !canCopyVerify;
  }

  function setStatus(text, kind){
    statusChip.textContent = text;
    statusChip.classList.remove("ok","err","neutral");
    statusChip.classList.add(kind || "neutral");
  }

  function showProblem(msg){
    problemBox.style.display = "block";
    problemText.textContent = msg || "Okänt fel.";
  }
  function hideProblem(){
    problemBox.style.display = "none";
    problemText.textContent = "—";
  }

  function isBytes32Hex(h){
    return typeof h === "string" && /^0x[0-9a-fA-F]{64}$/.test(h.trim());
  }

  // ✅ Stöd både ?id= och legacy ?hash=
  function getIdFromUrl(){
    const url = new URL(location.href);
    return (url.searchParams.get("id") || url.searchParams.get("hash") || "").trim();
  }

  // Intyg-ID: stöd ?cert= i URL
  function getCertIdFromUrl(){
    const url = new URL(location.href);
    return (url.searchParams.get("cert") || "").trim();
  }

  function makeCertId(){
    const d = new Date();
    const pad = (n) => String(n).padStart(2,"0");
    const y = d.getFullYear();
    const m = pad(d.getMonth()+1);
    const day = pad(d.getDate());
    const hh = pad(d.getHours());
    const mm = pad(d.getMinutes());
    const ss = pad(d.getSeconds());
    const rnd = Math.random().toString(16).slice(2, 8).toUpperCase();
    return `cert-${y}${m}${day}-${hh}${mm}${ss}-${rnd}`;
  }

  // ✅ Skriv alltid tillbaka som ?id=
  function setIdInUrl(id, certId){
    const url = new URL(location.href);
    if (id) {
      url.searchParams.set("id", id);
      url.searchParams.delete("hash");
    } else {
      url.searchParams.delete("id");
      url.searchParams.delete("hash");
    }
    if (certId) url.searchParams.set("cert", certId);
    history.replaceState({}, "", url.toString());
  }

  function buildCertificateLink(id, certId){
    const base = `${location.origin}/certificate.html?id=${encodeURIComponent(id)}`;
    return certId ? `${base}&cert=${encodeURIComponent(certId)}` : base;
  }
  function buildVerifyLink(id){
    return `${location.origin}/verify.html?id=${encodeURIComponent(id)}`;
  }

  function isoUtcNoMs(d){
    return d.toISOString().replace("T"," ").replace(/\.\d{3}Z$/, " UTC");
  }

  function fmtSe(ts){
    try{
      return new Intl.DateTimeFormat("sv-SE", {
        timeZone:"Europe/Stockholm",
        year:"numeric", month:"2-digit", day:"2-digit",
        hour:"2-digit", minute:"2-digit", second:"2-digit"
      }).format(new Date(Number(ts) * 1000)) + " (Europe/Stockholm)";
    } catch {
      return "—";
    }
  }
  function fmtUtc(ts){
    try{
      return isoUtcNoMs(new Date(Number(ts) * 1000));
    } catch {
      return "—";
    }
  }

  function setCheckedNow(){
    const se = new Date().toLocaleString("sv-SE", { timeZone:"Europe/Stockholm" });
    const utc = isoUtcNoMs(new Date());
    checkedOut.textContent = `${se} (Europe/Stockholm)\n${utc}`;
  }

  function resetView(){
    hashOut.textContent = "—";
    resultOut.textContent = "—";
    tsSeOut.textContent = "—";
    tsUtcOut.textContent = "—";
    certLinkOut.textContent = "—";
    verifyLinkOut.textContent = "—";
    interpretation.textContent = "—";
    if (qrBox) qrBox.innerHTML = "—";
    if (qrStatus) qrStatus.textContent = "—";
    btnVerify.href = "/verify.html";
    setBusy(false);
  }

  function canRenderQr(){
    return typeof window.QRCode === "function";
  }

  function showQrError(){
    const msg = window.__proofyQrLibError
      ? "QR kunde inte laddas. Kontrollera att /qr.min.js finns i deploy."
      : "QR kunde inte laddas.";
    qrBox.innerHTML = `<div class="meta" style="padding:10px;text-align:center;">${msg}</div>`;
    qrStatus.textContent = msg;
  }

  function renderQr(text){
    if (!qrBox) return;

    if(!canRenderQr()){
      if (window.__proofyQrLibError){
        showQrError();
        return;
      }
      qrBox.innerHTML = `<div class="meta" style="padding:10px;text-align:center;">Laddar QR…</div>`;
      qrStatus.textContent = "Laddar QR…";

      let tries = 0;
      const maxTries = 20;
      const t = setInterval(() => {
        tries++;
        if (canRenderQr()){
          clearInterval(t);
          doRender(text);
          qrStatus.textContent = "";
          return;
        }
        if (window.__proofyQrLibError || tries >= maxTries){
          clearInterval(t);
          showQrError();
        }
      }, 50);
      return;
    }

    doRender(text);
    qrStatus.textContent = "";
  }

  function doRender(text){
    qrBox.innerHTML = "";
    const correctLevel =
      window.QRCodeCorrectLevel && window.QRCodeCorrectLevel.M
        ? window.QRCodeCorrectLevel.M
        : undefined;

    new QRCode(qrBox, { text, width:150, height:150, correctLevel });
  }

  async function copyText(btn, text){
    const t = (text || "").trim();
    if(!t || t === "—") return;
    try{
      await navigator.clipboard.writeText(t);
      const old = btn.textContent;
      btn.textContent = "Kopierad";
      setTimeout(() => btn.textContent = old, 1200);
    } catch {
      const old = btn.textContent;
      btn.textContent = "Kunde inte kopiera";
      setTimeout(() => btn.textContent = old, 1400);
    }
  }

  // Robust: prova GET /api/verify?hash=... och fall tillbaka till POST {hash}
  async function fetchVerify(id){
    try{
      const r = await fetch(`/api/verify?hash=${encodeURIComponent(id)}`, { method:"GET" });
      const j = await r.json().catch(() => ({}));
      if (r.ok && typeof j?.exists === "boolean") return { ok:true, data:j };
    } catch { /* ignore */ }

    const r2 = await fetch(`/api/verify`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ hash: id })
    });
    const j2 = await r2.json().catch(() => ({}));
    if (!r2.ok) return { ok:false, error: j2?.error || `HTTP ${r2.status}` };
    return { ok:true, data:j2 };
  }

  function setInterpretationForState(state, hasTs){
    if (state === "registered") {
      return "Resultatet betyder att Verifierings-ID:t har en registrering. Registreringstiden anger när referensen registrerades i Proofy.";
    }
    if (state === "not_registered") {
      return "Resultatet betyder att ingen registrering hittades för detta Verifierings-ID vid kontrolltillfället. Kontrollera att du kopierat hela ID:t.";
    }
    if (state === "invalid") {
      return "Verifierings-ID:t har fel format. Kontrollera att det börjar med 0x och innehåller 64 hex-tecken.";
    }
    if (state === "technical") {
      return "Kontrollen kunde inte genomföras på grund av ett tillfälligt tekniskt problem. Försök igen senare eller kör om kontrollen.";
    }
    return hasTs ? "Registrering hittades." : "Ingen registrering hittades.";
  }

  async function loadCertificate(id, certId){
    const myOp = ++opId;
    hideProblem();
    setBusy(true);
    setCheckedNow();

    certIdOut.textContent = certId || "—";

    if(!id){
      resetView();
      openBox.style.display = "block";
      setStatus("Saknar Verifierings-ID", "err");
      resultOut.textContent = "Kan inte kontrollera (saknar ID)";
      interpretation.textContent = "Ingen kontroll kunde göras eftersom Verifierings-ID saknas.";
      setBusy(false);
      return;
    }

    openBox.style.display = "none";
    hashOut.textContent = id;

    const verifyLink = buildVerifyLink(id);
    const certLink = buildCertificateLink(id, certId);

    certLinkOut.textContent = certLink;
    verifyLinkOut.textContent = verifyLink;

    btnVerify.href = verifyLink;
    renderQr(verifyLink);

    setBusy(busy);

    if(!isBytes32Hex(id)){
      setStatus("OGILTIGT VERIFIERINGS-ID", "err");
      resultOut.textContent = "Ogiltigt format (kan inte kontrollera)";
      tsSeOut.textContent = "—";
      tsUtcOut.textContent = "—";
      interpretation.textContent = setInterpretationForState("invalid", false);
      setBusy(false);
      return;
    }

    setStatus("KONTROLLERAR…", "neutral");

    try{
      const res = await fetchVerify(id);
      if (myOp !== opId) return;

      if(!res.ok){
        setStatus("TEKNISKT FEL", "err");
        resultOut.textContent = "Kontroll kunde inte genomföras";
        tsSeOut.textContent = "—";
        tsUtcOut.textContent = "—";
        interpretation.textContent = setInterpretationForState("technical", false);
        showProblem(res.error || "Okänt fel.");
        setBusy(false);
        return;
      }

      const data = res.data || {};
      const exists = Boolean(data.exists);
      const ts = data.timestamp ? Number(data.timestamp) : null;

      if (exists){
        setStatus("REGISTRERAD", "ok");
        resultOut.textContent = "Registrerad (registrering hittades)";
        tsSeOut.textContent = ts ? fmtSe(ts) : "—";
        tsUtcOut.textContent = ts ? fmtUtc(ts) : "—";
        interpretation.textContent = setInterpretationForState("registered", !!ts);
      } else {
        setStatus("EJ REGISTRERAD", "err");
        resultOut.textContent = "Inte registrerad (ingen registrering hittades)";
        tsSeOut.textContent = "—";
        tsUtcOut.textContent = "—";
        interpretation.textContent = setInterpretationForState("not_registered", false);
      }

      setBusy(false);
    } catch (e){
      if (myOp !== opId) return;
      setStatus("TEKNISKT FEL", "err");
      resultOut.textContent = "Kontroll kunde inte genomföras";
      tsSeOut.textContent = "—";
      tsUtcOut.textContent = "—";
      interpretation.textContent = setInterpretationForState("technical", false);
      showProblem(String(e?.message || e));
      setBusy(false);
    }
  }

  // Actions
  btnPrint.addEventListener("click", () => window.print());
  btnRefresh.addEventListener("click", () => {
    const id = getIdFromUrl();
    const certId = getCertIdFromUrl() || makeCertId();
    setIdInUrl(id, certId);
    certIdOut.textContent = certId;
    loadCertificate(id, certId);
  });

  // Copy buttons
  btnCopyId.addEventListener("click", () => copyText(btnCopyId, hashOut.textContent));
  btnCopyCert.addEventListener("click", () => copyText(btnCopyCert, certLinkOut.textContent));
  btnCopyVerify.addEventListener("click", () => copyText(btnCopyVerify, verifyLinkOut.textContent));

  // Open box
  btnOpen?.addEventListener("click", () => {
    const id = (hashInput.value || "").trim();
    if (!id){
      openHint.textContent = "Klistra in Verifierings-ID för att öppna intyget.";
      return;
    }
    openHint.textContent = "";

    const certId = getCertIdFromUrl() || makeCertId();
    setIdInUrl(id, certId);
    certIdOut.textContent = certId;

    loadCertificate(id, certId);
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  btnPaste?.addEventListener("click", async () => {
    try{
      const t = await navigator.clipboard.readText();
      if (t) hashInput.value = t.trim();
      openHint.textContent = t ? "ID insatt. Klicka “Öppna intyg”." : "Inget att klistra in.";
    } catch {
      openHint.textContent = "Kunde inte läsa urklipp. Klistra in manuellt.";
    }
  });

  // Start
  const initialId = getIdFromUrl();
  const initialCert = getCertIdFromUrl() || makeCertId();

  certIdOut.textContent = initialCert;
  setIdInUrl(initialId, initialCert);

  if (initialId){
    loadCertificate(initialId, initialCert);
  } else {
    resetView();
    setCheckedNow();
    openBox.style.display = "block";
    setStatus("Saknar Verifierings-ID", "err");
    resultOut.textContent = "Kan inte kontrollera (saknar ID)";
    interpretation.textContent = "Ingen kontroll kunde göras eftersom Verifierings-ID saknas.";
    setBusy(false);
  }
})();
</script>

<script src="/chat-widget.js?v=2025-01" defer></script>
</body>
</html>
