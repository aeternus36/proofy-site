<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proofy – Verifieringsintyg</title>
  <meta name="description" content="Verifieringsintyg som sammanfattar om en filversion var registrerad vid en viss tidpunkt. Inget dokumentinnehåll lagras." />
  <meta name="theme-color" content="#0b1220" />

  <!-- Unifierad styling (samma som övriga sidor) -->
  <link rel="stylesheet" href="/assets/proofy.css?v=2025-12-20" />

  <style>
    /* Små, sida-specifika justeringar (behåller Proofy-look) */
    .pageTop{ margin-top: 10px; }
    .kicker{ margin: 14px 0 8px; }
    .heroText{ max-width: 92ch; }

    .certHead{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      flex-wrap:wrap;
      margin-top: 6px;
    }
    .certActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 12px;
    }
    .certActions .btn{ min-width: 190px; }
    @media (max-width: 560px){
      .certActions .btn{ width:100%; min-width: unset; }
    }

    .kvGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 920px){
      .kvGrid{ grid-template-columns: 1fr; }
    }

    .kvCard{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(11,18,32,.25);
      border-radius: 16px;
      padding: 14px;
    }
    .k{ color: var(--muted); font-size: 12.5px; margin-bottom: 6px; font-weight: 900; letter-spacing: .2px; }
    .v{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; word-break: break-all; }

    .summaryBox{
      margin-top: 12px;
      padding: 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }

    .warnBox{
      margin-top: 12px;
      padding: 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,138,161,.30);
      background: rgba(255,138,161,.08);
      display:none;
    }

    .inputRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }
    .inputRow input{ flex:1; min-width: 240px; }
    .inputRow .btn{ min-width: 180px; }
    @media (max-width: 560px){
      .inputRow input{ width: 100%; min-width: unset; }
      .inputRow .btn{ width: 100%; min-width: unset; }
    }

    /* Print */
    @media print{
      header{ position: static !important; backdrop-filter:none !important; }
      .navLinks, .navActions, .certActions, .inputRow, .notePrintHide{ display:none !important; }
      body{ background:#fff !important; color:#000 !important; }
      .card, .kvCard, .summaryBox{ box-shadow:none !important; background:#fff !important; border:1px solid #ddd !important; }
      .badge{ border:1px solid #ddd !important; background:#fff !important; color:#000 !important; }
      .meta, .small{ color:#333 !important; }
      a{ color:#000 !important; text-decoration:none !important; }
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="/" aria-label="Proofy">
        <span class="logo" aria-hidden="true"></span>
        <span>Proofy</span>
      </a>

      <div class="navLinks" aria-label="Navigation">
        <a href="/verify.html">Verifiera</a>
        <a href="/hash.html">Skapa ID</a>
        <a href="/security.html">Säkerhet</a>
      </div>

      <div class="navActions">
        <a class="btn" href="/verify.html">Verifiera</a>
        <a class="btn primary" href="/#kontakt">Boka demo</a>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap pageTop">

    <div class="badge kicker">Intyg · dokumentintegritet · byrå & granskning</div>

    <div class="certHead">
      <div>
        <h1 class="pageTitle" style="margin-top:0;">Verifieringsintyg</h1>
        <p class="lead heroText" style="margin-bottom:0;">
          Intyget sammanfattar resultatet av en kontroll av ett <b>Verifierings-ID</b>.
          Det visar om ID:t finns registrerat och, i så fall, <b>när registreringen skedde</b>.
          <b>Inget dokumentinnehåll lagras</b> i Proofy.
        </p>
      </div>

      <div>
        <div id="statusBadge" class="pill">Laddar…</div>
        <div class="meta" id="statusHint" style="margin-top:8px;">—</div>
      </div>
    </div>

    <div class="card content" style="margin-top:14px;">
      <!-- Om hash saknas: visa enkel inmatning för att öppna intyg -->
      <div id="noHashBox" class="summaryBox" style="display:none;">
        <div style="font-weight:950; font-size:16px;">Öppna intyg</div>
        <p class="meta" style="margin-top:8px;">
          Klistra in ett Verifierings-ID för att visa intyget. Du kan också öppna intyget via länk:
          <span class="mono">/certificate.html?hash=0x…</span>
        </p>

        <div class="inputRow">
          <input id="hashInput" type="text" placeholder="Verifierings-ID (0x…)" autocomplete="off" spellcheck="false" />
          <button class="btn primary" id="openBtn" type="button">Öppna intyg</button>
          <a class="btn" href="/verify.html">Gå till verifiering</a>
        </div>

        <div class="small" style="margin-top:10px;">
          Tips för spårbarhet: spara Verifierings-ID i ärendet tillsammans med datum/tid och vilken filversion det avser.
        </div>
      </div>

      <!-- När hash finns: visa cert -->
      <div id="certBox" style="display:none;">
        <div class="certActions notePrintHide">
          <button class="btn" id="printBtn" type="button">Skriv ut / Spara som PDF</button>
          <button class="btn soft" id="refreshBtn" type="button">Uppdatera</button>
          <a class="btn primary" id="verifyBtn" href="/verify.html">Öppna verifiering</a>
        </div>

        <div class="kvGrid">
          <div class="kvCard">
            <div class="k">Verifierings-ID</div>
            <div class="v" id="hashOut">—</div>
            <div class="small" style="margin-top:10px;">
              Verifierings-ID är en teknisk identifierare för en filversion. Minsta ändring ger ett nytt ID.
            </div>
          </div>

          <div class="kvCard">
            <div class="k">Intyg skapat</div>
            <div class="v" id="issuedOut">—</div>
            <div class="small" style="margin-top:10px;">
              Detta är tidpunkten när intyget visades/genererades i webbläsaren (inte registreringstid).
            </div>
          </div>
        </div>

        <div class="kvGrid">
          <div class="kvCard">
            <div class="k">Kontrollresultat</div>
            <div class="v" id="existsOut">—</div>

            <div class="hr"></div>

            <div class="k">Registreringstid (Sverige)</div>
            <div class="v" id="tsSeOut">—</div>

            <div class="k" style="margin-top:10px;">Registreringstid (UTC)</div>
            <div class="v" id="tsUtcOut">—</div>
          </div>

          <div class="kvCard">
            <div class="k">Verifieringslänk</div>
            <div class="v" id="verifyLinkOut">—</div>

            <div class="qrWrap" style="margin-top:12px;">
              <div>
                <div class="k" style="margin-bottom:8px;">QR-kod</div>
                <div id="qrBox" class="qrBox" aria-label="QR-kod"></div>
                <div class="meta" id="qrStatus" style="margin-top:8px;">—</div>
              </div>
              <div style="min-width:240px; flex:1">
                <div class="k">Registrerad av</div>
                <div class="v" id="submitterOut">—</div>
                <div class="small" style="margin-top:10px;">
                  Detta fält används för spårbarhet i registret och påverkar inte kontrollresultatet.
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="summaryBox" style="margin-top:12px;">
          <div style="font-weight:950; font-size:16px;">Tolkning</div>
          <div class="meta" id="interpretation" style="margin-top:8px;">—</div>

          <div class="small" style="margin-top:10px;">
            <b>Viktigt:</b> Intyget visar endast om en <b>filversion</b> (via Verifierings-ID) var registrerad vid angiven tidpunkt.
            Det säger inget om dokumentets innehåll, riktighet, upphov, behörighet eller parternas avtal – och ersätter inte juridisk rådgivning.
          </div>
        </div>

        <div id="problemBox" class="warnBox">
          <div class="err" style="font-weight:950;">Tillfälligt tekniskt problem</div>
          <div class="meta" id="problemText" style="margin-top:8px;">—</div>
          <div class="small" style="margin-top:10px;">
            Prova <b>Uppdatera</b>. Om problemet kvarstår kan det bero på att API:t inte är publicerat eller att endpoint/metod skiljer sig från verifieringssidan.
          </div>
        </div>

        <details style="margin-top:12px;">
          <summary>Tekniska detaljer (valfritt)</summary>
          <p class="meta" style="margin-top:10px;">
            Den här sektionen är till för felsökning och teknisk dokumentation.
          </p>
          <div class="kvCard" style="margin-top:10px;">
            <div class="k">Teknisk källa</div>
            <div class="v" id="sourceOut">—</div>
          </div>
        </details>

        <div class="meta" style="margin-top:12px;">
          Behöver ni ett upplägg för rutin/arbetsflöde i byrån? <a href="/#kontakt">Boka demo</a>.
        </div>
      </div>
    </div>
  </div>
</main>

<!-- QR-lib (samma som dina andra sidor) -->
<script
  src="/qr.min.js?v=2025-12-20"
  onload="window.__proofyQrLibLoaded = true"
  onerror="window.__proofyQrLibError = true"
></script>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const statusBadge = $("statusBadge");
  const statusHint  = $("statusHint");

  const noHashBox = $("noHashBox");
  const certBox   = $("certBox");

  const hashInput = $("hashInput");
  const openBtn   = $("openBtn");

  const printBtn  = $("printBtn");
  const refreshBtn= $("refreshBtn");
  const verifyBtn = $("verifyBtn");

  const hashOut   = $("hashOut");
  const issuedOut = $("issuedOut");

  const existsOut = $("existsOut");
  const tsSeOut   = $("tsSeOut");
  const tsUtcOut  = $("tsUtcOut");
  const submitterOut = $("submitterOut");

  const verifyLinkOut = $("verifyLinkOut");
  const qrBox = $("qrBox");
  const qrStatus = $("qrStatus");

  const interpretation = $("interpretation");

  const problemBox = $("problemBox");
  const problemText = $("problemText");

  const sourceOut = $("sourceOut");

  // === Tekniska konstanter (kan stå i kod, men visas bara under "Tekniska detaljer") ===
  const NETWORK_LABEL = "Polygon Amoy (testnet)";
  const CHAIN_ID = 80002;
  const CONTRACT = "0x1C14960C4dAD90047ea91d224539311c69EAB261";
  const CONTRACT_EXPLORER = "https://www.oklink.com/amoy/address/" + CONTRACT;

  function setBadge(text, kind){
    statusBadge.textContent = text;
    statusBadge.classList.remove("ok", "err");
    if (kind === "ok") statusBadge.classList.add("ok");
    if (kind === "err") statusBadge.classList.add("err");
  }

  function setHint(text){
    statusHint.textContent = text || "—";
  }

  function showProblem(msg){
    problemBox.style.display = "block";
    problemText.textContent = msg || "—";
  }

  function hideProblem(){
    problemBox.style.display = "none";
    problemText.textContent = "—";
  }

  function isBytes32Hex(h){
    return typeof h === "string" && /^0x[0-9a-fA-F]{64}$/.test(h);
  }

  function getHashFromUrl(){
    const p = new URLSearchParams(location.search);
    return (p.get("hash") || "").trim();
  }

  function buildVerifyLink(hash){
    return `${location.origin}/verify.html?hash=${encodeURIComponent(hash)}`;
  }

  function formatUtc(ts){
    const d = new Date(Number(ts) * 1000);
    // 2025-12-20 16:21:56 UTC
    return d.toISOString().replace("T"," ").replace(".000Z"," UTC");
  }

  function formatSe(ts){
    const d = new Date(Number(ts) * 1000);
    return new Intl.DateTimeFormat("sv-SE", {
      timeZone: "Europe/Stockholm",
      year:"numeric", month:"2-digit", day:"2-digit",
      hour:"2-digit", minute:"2-digit", second:"2-digit"
    }).format(d) + " (Europe/Stockholm)";
  }

  function setQrStatus(msg){
    if (qrStatus) qrStatus.textContent = msg || "";
  }

  function canRenderQr(){
    return typeof window.QRCode === "function";
  }

  function renderQr(text){
    if (!qrBox) return;

    if (!canRenderQr()){
      if (window.__proofyQrLibError){
        qrBox.innerHTML = '<div class="meta" style="padding:10px;text-align:center;">QR-bibliotek kunde inte laddas.<br/>Kontrollera att <span class="mono">/qr.min.js</span> finns i deploy.</div>';
        setQrStatus("QR-bibliotek kunde inte laddas.");
        return;
      }

      qrBox.innerHTML = '<div class="meta" style="padding:10px;text-align:center;">Laddar QR…</div>';
      setQrStatus("Laddar QR…");

      let tries = 0;
      const t = setInterval(() => {
        tries++;
        if (canRenderQr()){
          clearInterval(t);
          doRender(text);
          setQrStatus("");
          return;
        }
        if (window.__proofyQrLibError || tries >= 20){
          clearInterval(t);
          qrBox.innerHTML = '<div class="meta" style="padding:10px;text-align:center;">QR-bibliotek kunde inte laddas.</div>';
          setQrStatus("QR-bibliotek kunde inte laddas.");
        }
      }, 50);
      return;
    }

    doRender(text);
    setQrStatus("");
  }

  function doRender(text){
    qrBox.innerHTML = "";
    const correctLevel =
      window.QRCodeCorrectLevel && window.QRCodeCorrectLevel.M
        ? window.QRCodeCorrectLevel.M
        : undefined;

    new QRCode(qrBox, {
      text,
      width: 150,
      height: 150,
      correctLevel
    });
  }

  // Robust verifieringsanrop:
  // 1) POST /api/verify {hash} (samma som verify.html)
  // 2) fallback GET /api/verify?hash=... (om din backend stödjer GET)
  async function fetchVerify(hash){
    // POST
    try{
      const r = await fetch("/api/verify", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ hash })
      });

      // Om din worker returnerar 405/404 för POST, fall back
      if (r.status === 404 || r.status === 405) throw new Error("POST not supported");

      const j = await r.json().catch(() => ({}));
      if (!r.ok) return { ok:false, error: `HTTP ${r.status}` , raw:j };
      return j;
    } catch {
      // GET fallback
      const r2 = await fetch(`/api/verify?hash=${encodeURIComponent(hash)}`, { method:"GET" });
      const j2 = await r2.json().catch(() => ({}));
      if (!r2.ok) return { ok:false, error:`HTTP ${r2.status}`, raw:j2 };
      return j2;
    }
  }

  function setIssuedNow(){
    const se = new Date().toLocaleString("sv-SE", { timeZone: "Europe/Stockholm" });
    const utc = new Date().toISOString().replace("T"," ").replace(".000Z"," UTC");
    issuedOut.textContent = `${se} (Europe/Stockholm)\n${utc}`;
  }

  function setTechSource(){
    sourceOut.textContent =
      `${NETWORK_LABEL} · ChainId ${CHAIN_ID}\n` +
      `Contract: ${CONTRACT}\n` +
      `Explorer: ${CONTRACT_EXPLORER}`;
  }

  async function load(){
    hideProblem();
    setIssuedNow();
    setTechSource();

    const hash = getHashFromUrl();

    // Om ingen hash: visa inmatning
    if (!hash){
      noHashBox.style.display = "block";
      certBox.style.display = "none";
      setBadge("Klistra in Verifierings-ID", "");
      setHint("Öppna intyget genom att ange ett Verifierings-ID.");
      return;
    }

    // Hash finns: visa cert
    noHashBox.style.display = "none";
    certBox.style.display = "block";

    hashOut.textContent = hash;

    // länk & QR (alltid)
    const vlink = buildVerifyLink(hash);
    verifyBtn.href = vlink;
    verifyLinkOut.textContent = vlink;
    renderQr(vlink);

    // Validering
    if (!isBytes32Hex(hash)){
      setBadge("Ogiltigt format", "err");
      setHint("Verifierings-ID har fel format.");
      existsOut.textContent = "—";
      tsSeOut.textContent = "—";
      tsUtcOut.textContent = "—";
      submitterOut.textContent = "—";
      interpretation.textContent =
        "Verifierings-ID måste vara 0x följt av 64 hex-tecken.";
      return;
    }

    setBadge("Kontrollerar…", "");
    setHint("Hämtar status från registret…");

    try{
      const data = await fetchVerify(hash);

      // Förväntat format: { ok:true, exists:boolean, timestamp:number, submitter:string }
      if (!data || data.ok === false){
        setBadge("Kan inte kontrollera", "err");
        setHint("Tillfälligt fel vid kontroll.");
        showProblem(data?.error || "Kontrollen kunde inte genomföras just nu.");
        existsOut.textContent = "—";
        tsSeOut.textContent = "—";
        tsUtcOut.textContent = "—";
        submitterOut.textContent = "—";
        interpretation.textContent =
          "Kontrollen kunde inte genomföras på grund av ett tillfälligt drift-/nätverksproblem. Prova igen.";
        return;
      }

      // Vissa implementationer kan returnera {exists:..} utan {ok:true}
      const exists = !!data.exists;
      const ts = data.timestamp ? Number(data.timestamp) : null;

      if (exists){
        setBadge("Registrerad", "ok");
        setHint("Verifierings-ID finns i registret.");
        existsOut.textContent = "Registrerad (Verifierings-ID finns i registret)";
        tsSeOut.textContent = ts ? formatSe(ts) : "—";
        tsUtcOut.textContent = ts ? formatUtc(ts) : "—";
        submitterOut.textContent = data.submitter || "—";
        interpretation.textContent =
          "Kontrollen visar att Verifierings-ID:t fanns registrerat vid angiven registreringstid.";
      } else {
        setBadge("Inte registrerad", "err");
        setHint("Verifierings-ID hittades inte i registret.");
        existsOut.textContent = "Inte registrerad (Verifierings-ID saknas)";
        tsSeOut.textContent = "—";
        tsUtcOut.textContent = "—";
        submitterOut.textContent = "—";
        interpretation.textContent =
          "Kontrollen visar att ingen registrering hittades för Verifierings-ID:t vid kontrolltillfället.";
      }
    } catch (e){
      setBadge("Kan inte kontrollera", "err");
      setHint("Tillfälligt fel vid kontroll.");
      showProblem(String(e?.message || e));
      existsOut.textContent = "—";
      tsSeOut.textContent = "—";
      tsUtcOut.textContent = "—";
      submitterOut.textContent = "—";
      interpretation.textContent =
        "Kontrollen kunde inte genomföras på grund av ett tillfälligt drift-/nätverksproblem. Prova igen.";
    }
  }

  // Buttons
  if (printBtn) printBtn.addEventListener("click", () => window.print());
  if (refreshBtn) refreshBtn.addEventListener("click", () => load());

  if (openBtn){
    openBtn.addEventListener("click", () => {
      const h = (hashInput.value || "").trim();
      if (!h){
        setBadge("Klistra in Verifierings-ID", "");
        setHint("Fyll i Verifierings-ID för att öppna intyget.");
        return;
      }
      // Öppna samma sida med param
      location.href = `/certificate.html?hash=${encodeURIComponent(h)}`;
    });
  }

  // Enter i input => öppna
  if (hashInput){
    hashInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") openBtn?.click();
    });
  }

  load();
})();
</script>

<script src="/chat-widget.js?v=2025-01" defer></script>
</body>
</html>
