<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proofy – Verifieringsintyg</title>
  <meta name="description" content="Verifieringsintyg som visar om ett Verifierings-ID är registrerat och när registreringen skedde. Inget dokumentinnehåll lagras." />
  <meta name="theme-color" content="#0b1220" />
  <link rel="stylesheet" href="/assets/proofy.css?v=2025-12-20" />
</head>

<body>
<a class="skip" href="#main">Hoppa till innehåll</a>

<header>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="/" aria-label="Proofy">
        <span class="logo" aria-hidden="true"></span>
        <span>Proofy</span>
      </a>

      <div class="navActions">
        <a class="btn soft" href="/verify.html">Verifiera</a>
        <a class="btn" href="/hash.html">Skapa ID</a>
        <a class="btn primary" href="/#kontakt">Boka demo</a>
      </div>
    </div>
  </div>
</header>

<main id="main">
  <div class="wrap">
    <div class="badge">Intyg · dokumentintegritet · byrå & granskning</div>

    <h1 class="pageTitle">Verifieringsintyg</h1>
    <p class="lead">
      Detta intyg sammanfattar resultatet av en kontroll av ett <b>Verifierings-ID</b>.
      Det visar om ID:t är <b>registrerat</b> och när registreringen skedde.
      <b>Inget dokumentinnehåll lagras</b> i Proofy.
    </p>

    <div class="card content" style="margin-top:14px;">
      <div class="hdr" style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;">
        <div class="meta">
          Öppnas via <span class="mono">/certificate.html?hash=0x…</span>
        </div>
        <div id="statusBadge" class="pill">Kontrollerar…</div>
      </div>

      <div class="actions" style="margin-top:12px;">
        <button class="btn" type="button" id="btnPrint">Skriv ut / Spara som PDF</button>
        <button class="btn soft" type="button" id="btnRefresh">Uppdatera</button>
        <a class="btn primary" id="btnVerify" href="/verify.html">Öppna verifiering</a>
      </div>

      <div class="hr"></div>

      <div class="grid">
        <div>
          <div class="label">Verifierings-ID</div>
          <pre id="hashOut" class="mono">—</pre>
          <p class="small" style="margin-top:10px;margin-bottom:0;">
            Verifierings-ID är filens <b>digitala fingeravtryck</b>. Minsta ändring ger ett nytt ID.
          </p>
        </div>

        <div>
          <div class="label">Intyg genererat</div>
          <pre id="issuedOut" class="mono">—</pre>
          <p class="small" style="margin-top:10px;margin-bottom:0;">
            Detta avser tidpunkten när intygssidan genererades, inte registreringstidpunkten.
          </p>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid">
        <div>
          <div class="label">Kontrollresultat</div>
          <pre id="existsOut" class="mono">—</pre>

          <div class="label" style="margin-top:12px;">Registreringstid (Sverige)</div>
          <pre id="tsSeOut" class="mono">—</pre>

          <div class="label" style="margin-top:12px;">Registreringstid (UTC)</div>
          <pre id="tsUtcOut" class="mono">—</pre>
        </div>

        <div>
          <div class="label">Verifieringslänk</div>
          <pre id="verifyLinkOut" class="mono">—</pre>

          <div class="qrWrap" style="margin-top:12px;">
            <div>
              <div class="label" style="margin-bottom:8px;">QR-kod</div>
              <div id="qrBox" class="qrBox" aria-label="QR-kod"></div>
              <div id="qrStatus" class="small" style="margin-top:8px;">—</div>
            </div>

            <div style="min-width:240px;flex:1;">
              <div class="label">Tolkning</div>
              <p id="interpretation" class="para" style="margin:0;">
                —
              </p>

              <p class="small" style="margin-top:10px;">
                <b>Viktigt:</b> Resultatet visar endast om ett Verifierings-ID fanns registrerat vid angiven tidpunkt.
                Det säger inget om dokumentets innehåll, upphov eller om innehållet är “korrekt” – bara om filversionen är densamma.
              </p>
            </div>
          </div>
        </div>
      </div>

      <div id="problemCard" class="card content" style="display:none;margin-top:14px;background:rgba(255,255,255,.03);">
        <div class="err">Tillfälligt tekniskt problem</div>
        <div id="problemText" class="mono" style="margin-top:8px;">—</div>
        <p class="small" style="margin-top:10px;margin-bottom:0;">
          Prova att klicka <b>Uppdatera</b>. Om problemet kvarstår: kontrollera att API (Workers) är publicerat och svarar korrekt.
        </p>
      </div>

      <details style="margin-top:14px;">
        <summary>Tekniska detaljer (valfritt)</summary>
        <p>
          Proofy jämför en registrerad teknisk referens med Verifierings-ID:t i länken.
          Själva dokumentet skickas inte via intyget och lagras inte i Proofy.
        </p>
      </details>
    </div>

    <p class="meta" style="margin-top:14px;">
      Behöver ni ett upplägg för rutin/arbetsflöde i byrån? <a href="/#kontakt">Boka demo</a>.
    </p>
  </div>
</main>

<!-- ✅ QR lib MUST be reachable at /qr.min.js -->
<script
  src="/qr.min.js?v=2025-12-20"
  onload="window.__proofyQrLibLoaded = true"
  onerror="window.__proofyQrLibError = true"
></script>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const statusBadge = $("statusBadge");
  const hashOut = $("hashOut");
  const issuedOut = $("issuedOut");

  const existsOut = $("existsOut");
  const tsSeOut = $("tsSeOut");
  const tsUtcOut = $("tsUtcOut");

  const verifyLinkOut = $("verifyLinkOut");
  const interpretation = $("interpretation");

  const btnPrint = $("btnPrint");
  const btnRefresh = $("btnRefresh");
  const btnVerify = $("btnVerify");

  const qrBox = $("qrBox");
  const qrStatus = $("qrStatus");

  const problemCard = $("problemCard");
  const problemText = $("problemText");

  function setPill(text, kind){
    statusBadge.textContent = text;
    statusBadge.classList.remove("ok","err");
    if (kind === "ok") statusBadge.classList.add("ok");
    if (kind === "err") statusBadge.classList.add("err");
  }

  function showProblem(msg){
    problemCard.style.display = "block";
    problemText.textContent = msg || "—";
  }
  function hideProblem(){
    problemCard.style.display = "none";
    problemText.textContent = "—";
  }

  function getHashFromQuery(){
    const url = new URL(location.href);
    return (url.searchParams.get("hash") || "").trim();
  }

  function isBytes32Hex(h){
    return typeof h === "string" && /^0x[0-9a-fA-F]{64}$/.test(h);
  }

  function buildVerifyLink(hash){
    return `${location.origin}/verify.html?hash=${encodeURIComponent(hash)}`;
  }

  function formatUtc(ts){
    const d = new Date(Number(ts) * 1000);
    return d.toISOString().replace("T"," ").replace(".000Z"," UTC");
  }

  function formatSe(ts){
    const d = new Date(Number(ts) * 1000);
    return new Intl.DateTimeFormat("sv-SE", {
      timeZone: "Europe/Stockholm",
      year: "numeric", month: "2-digit", day: "2-digit",
      hour: "2-digit", minute: "2-digit", second: "2-digit"
    }).format(d) + " (Europe/Stockholm)";
  }

  function setQrStatus(msg){
    if (qrStatus) qrStatus.textContent = msg || "";
  }

  function canRenderQr(){
    return typeof window.QRCode === "function";
  }

  function showQrError(extra){
    const parts = [];
    parts.push("QR-bibliotek kunde inte laddas.");
    if (window.__proofyQrLibError) parts.push("Kontrollera att /qr.min.js finns i deploy.");
    if (extra) parts.push(extra);
    qrBox.innerHTML = `<div class="meta">${parts.join(" ")}</div>`;
    setQrStatus("QR ej tillgänglig");
  }

  function doRenderQr(text){
    qrBox.innerHTML = "";
    const correctLevel =
      window.QRCodeCorrectLevel && window.QRCodeCorrectLevel.M
        ? window.QRCodeCorrectLevel.M
        : undefined;

    new QRCode(qrBox, {
      text,
      width: 150,
      height: 150,
      colorDark: "#0b1220",
      colorLight: "#eaf0ff",
      correctLevel
    });
  }

  function renderQr(text){
    if (!qrBox) return;

    if (!canRenderQr()){
      if (window.__proofyQrLibError) {
        showQrError();
        return;
      }
      qrBox.innerHTML = `<div class="meta">Laddar QR…</div>`;
      setQrStatus("Laddar…");

      let tries = 0;
      const maxTries = 20; // ~1s
      const t = setInterval(() => {
        tries++;
        if (canRenderQr()){
          clearInterval(t);
          doRenderQr(text);
          setQrStatus("");
          return;
        }
        if (window.__proofyQrLibError || tries >= maxTries){
          clearInterval(t);
          showQrError(tries >= maxTries ? "Tog för lång tid att ladda." : "");
        }
      }, 50);

      return;
    }

    doRenderQr(text);
    setQrStatus("");
  }

  async function load(){
    hideProblem();

    const hash = getHashFromQuery();
    hashOut.textContent = hash || "—";

    const issuedSe = new Date().toLocaleString("sv-SE", { timeZone: "Europe/Stockholm" });
    const issuedUtc = new Date().toISOString().replace("T"," ").replace(".000Z"," UTC");
    issuedOut.textContent = `${issuedSe} (Europe/Stockholm)\n${issuedUtc}`;

    // Förbered verifieringslänk/QR även innan API-svar
    if (hash){
      const vlink = buildVerifyLink(hash);
      btnVerify.href = vlink;
      verifyLinkOut.textContent = vlink;
      renderQr(vlink);
    } else {
      btnVerify.href = "/verify.html";
      verifyLinkOut.textContent = "—";
      qrBox.innerHTML = "—";
      setQrStatus("—");
    }

    // Validering
    if (!hash){
      setPill("Saknar Verifierings-ID", "err");
      existsOut.textContent = "—";
      tsSeOut.textContent = "—";
      tsUtcOut.textContent = "—";
      interpretation.textContent =
        "Ingen Verifierings-ID angavs. Öppna intyget med ?hash=0x… eller gå via verifieringssidan.";
      return;
    }

    if (!isBytes32Hex(hash)){
      setPill("Ogiltigt format", "err");
      existsOut.textContent = "—";
      tsSeOut.textContent = "—";
      tsUtcOut.textContent = "—";
      interpretation.textContent =
        "Verifierings-ID har fel format. Det ska vara: 0x + 64 hex-tecken.";
      return;
    }

    setPill("Kontrollerar…");

    // API: GET /api/verify?hash=...
    try{
      const res = await fetch(`/api/verify?hash=${encodeURIComponent(hash)}`, { method: "GET" });
      const data = await res.json().catch(() => ({}));

      if (!res.ok || data.ok === false){
        setPill("Kan ej kontrollera just nu", "err");
        showProblem(String(data?.error || `HTTP ${res.status}`));
        existsOut.textContent = "—";
        tsSeOut.textContent = "—";
        tsUtcOut.textContent = "—";
        interpretation.textContent =
          "Kontrollen kunde inte genomföras på grund av ett tillfälligt tekniskt problem. Prova igen senare.";
        return;
      }

      if (data.exists){
        setPill("Registrerad", "ok");
        existsOut.textContent = "Registrerad (Verifierings-ID finns i registret)";
        tsSeOut.textContent = data.timestamp ? formatSe(data.timestamp) : "—";
        tsUtcOut.textContent = data.timestamp ? formatUtc(data.timestamp) : "—";
        interpretation.textContent =
          "Kontrollen visar att Verifierings-ID:t var registrerat vid angiven tidpunkt. Du kan använda verifieringslänken/QR för att kontrollera igen vid behov.";
      } else {
        setPill("Inte registrerad", "err");
        existsOut.textContent = "Inte registrerad (Verifierings-ID saknas)";
        tsSeOut.textContent = "—";
        tsUtcOut.textContent = "—";
        interpretation.textContent =
          "Kontrollen hittade ingen registrering för detta Verifierings-ID vid kontrolltillfället.";
      }
    } catch (e){
      setPill("Kan ej kontrollera just nu", "err");
      showProblem(String(e?.message || e));
      existsOut.textContent = "—";
      tsSeOut.textContent = "—";
      tsUtcOut.textContent = "—";
      interpretation.textContent =
        "Kontrollen kunde inte genomföras på grund av ett tillfälligt nätverks-/driftproblem. Prova igen.";
    }
  }

  btnPrint.addEventListener("click", () => window.print());
  btnRefresh.addEventListener("click", () => load());

  load();
})();
</script>

<script src="/chat-widget.js?v=2025-01" defer></script>
</body>
</html>
