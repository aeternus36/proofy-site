<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex" />
  <meta name="theme-color" content="#0b1220" />
  <title>Proofy – Verifieringsintyg</title>

  <!-- Om du vill behålla site-wide header/knappar -->
  <link rel="stylesheet" href="/assets/proofy.css?v=2026-01-03a" />
  <link rel="stylesheet" href="/assets/header.css?v=2026-01-03a" />

  <style>
    :root{
      --bg:#070b14;
      --border:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.72);
      --muted2:rgba(234,240,255,.55);
      --good:#36d399;
      --bad:#ff6b6b;
      --warn:#fbbf24;
      --shadow:0 20px 60px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

      --qr-dark:#0b1220;
      --qr-light:#ffffff;
      --qr-frame: rgba(255,255,255,.12);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 30% 20%, rgba(67,108,255,.20), transparent 60%),
                  radial-gradient(900px 500px at 70% 35%, rgba(54,211,153,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family:var(--sans);
    }
    a{ color:inherit; }

    .skip{
      position:absolute; left:-9999px; top:auto;
      width:1px; height:1px; overflow:hidden;
    }
    .skip:focus{
      left:18px; top:18px; width:auto; height:auto;
      padding:10px 12px; border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.08);
      z-index:999;
    }

    a:focus-visible, button:focus-visible, [role="button"]:focus-visible{
      outline:2px solid rgba(110,168,255,.55);
      outline-offset:3px;
      border-radius:14px;
    }

    main{
      max-width:1100px;
      margin:0 auto;
      padding:10px 18px 48px;
    }

    .pill{
      display:inline-flex; align-items:center; gap:10px;
      padding:8px 12px;
      border:1px solid var(--border);
      border-radius:999px;
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-weight:800;
      font-size:13px;
    }

    .hero{
      margin-top:10px;
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px;
    }

    .heroTop{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    h1{
      margin:10px 0 6px;
      font-size:40px;
      letter-spacing:-.02em;
      line-height:1.05;
    }
    @media (max-width: 900px){
      h1{ font-size:34px; }
    }

    .statusBadge{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px;
      border-radius:999px;
      font-weight:950;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      justify-content:center;
      text-align:center;
      min-width:220px;
    }
    @media (max-width: 360px){
      .statusBadge{ min-width:0; width:100%; }
    }
    .dot{ width:9px;height:9px;border-radius:99px;background:var(--warn) }
    .statusBadge.good .dot{background:var(--good)}
    .statusBadge.bad .dot{background:var(--bad)}
    .statusBadge.warn .dot{background:var(--warn)}

    .actions{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:14px;
    }

    /* Minimera CTA: en primär */
    .actions .btn{ text-decoration:none; display:inline-flex; align-items:center; justify-content:center; }

    .auditTop{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 900px){
      .auditTop{ grid-template-columns:1fr; }
    }

    .card{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:var(--radius);
      padding:16px;
    }
    .card h3{
      margin:2px 0 10px;
      font-size:13px;
      color:var(--muted2);
      letter-spacing:.08em;
      text-transform:uppercase;
      font-weight:900;
    }

    .kv{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width: 700px){
      .kv{ grid-template-columns:1fr; }
    }

    .val{
      background:rgba(0,0,0,.18);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      min-height:54px;
    }

    .label{
      font-size:12px;
      color:var(--muted2);
      margin-bottom:6px;
      font-weight:900;
    }

    .mono{
      font-family:var(--mono);
      font-size:13px;
      color:rgba(234,240,255,.92);
      /* Viktigt för mobil: */
      overflow-wrap:anywhere;
      word-break:break-word;
      min-width:0;
    }

    .row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .row .mono{ flex:1; }
    .copyBtn{
      flex:0 0 auto;
      padding:8px 10px;
      font-weight:950;
      border-radius:12px;
      white-space:nowrap;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
    }
    .copyBtn:hover{ background:rgba(255,255,255,.06); }

    .small{
      font-size:12px; color:var(--muted2); line-height:1.45;
      max-width:560px;
    }

    .lead{
      margin-top:12px;
      color:var(--muted);
      line-height:1.55;
      font-size:15.5px;
      max-width:900px;
    }

    .note{
      margin-top:12px;
      color:var(--muted);
      font-size:14px;
      line-height:1.55;
    }

    /* VARNINGAR/RESERVATIONER – måste tåla print */
    .warnBox{
      margin-top:12px;
      border:1px solid rgba(251,191,36,.40);
      background:rgba(251,191,36,.10);
      border-radius:16px;
      padding:12px;
      color:rgba(255,255,255,.95);
      display:none;
    }
    .warnBox.show{ display:block; }

    .fine{
      margin-top:14px;
      border-top:1px solid var(--border);
      padding-top:14px;
      color:var(--muted2);
      font-size:13px;
      line-height:1.6;
    }

    .qrWrap{
      display:flex;
      align-items:flex-start;
      gap:14px;
      flex-wrap:wrap;
    }

    #qrcodeTap{
      width:184px; height:184px;
      border-radius:18px;
      border:1px solid var(--qr-frame);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      display:grid; place-items:center;
      overflow:hidden;
      user-select:none;
    }
    #qrcodeSurface{
      width:176px; height:176px;
      border-radius:16px;
      background:var(--qr-light);
      border:1px solid rgba(0,0,0,.10);
      display:grid; place-items:center;
    }
    #qrcode{
      width:168px; height:168px;
      display:grid; place-items:center;
    }
    #qrcode canvas, #qrcode img, #qrcode svg{
      width:168px !important;
      height:168px !important;
      display:block;
      image-rendering: pixelated;
    }

    details.tech{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:16px;
      background:rgba(255,255,255,.02);
      padding:10px 12px;
    }
    details.tech > summary{
      cursor:pointer;
      font-weight:950;
      color:rgba(234,240,255,.92);
      list-style:none;
    }
    details.tech > summary::-webkit-details-marker{display:none}

    .techGrid{
      margin-top:10px;
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }

    .tz{ white-space:nowrap; }

    /* PRINT: får aldrig dölja reservationer */
    @media print{
      header, .actions { display:none !important; }
      body{ background:#fff !important; color:#000 !important; }
      .hero, .card { box-shadow:none !important; border-color:#ddd !important; background:#fff !important; }
      .pill, .statusBadge, .val { border-color:#ddd !important; background:#fff !important; }
      .lead, .note, .fine, .small { color:#111 !important; }
      a{ color:#000 !important; text-decoration:none !important; }

      .auditTop{ display:flex !important; flex-direction:column !important; gap:14px !important; }
      .card{ break-inside:avoid; page-break-inside:avoid; }

      /* Visa varningar även i PDF */
      .warnBox{ display:block !important; border-color:#d6b24a !important; background:#fff8dc !important; color:#111 !important; }

      #qrcodeTap{
        border-color:#ddd !important;
        background:#fff !important;
      }
      #qrcodeSurface{
        border-color:#ddd !important;
        background:#fff !important;
      }
      #qrcodeTap, #qrcodeSurface, #qrcode{
        -webkit-print-color-adjust:exact;
        print-color-adjust:exact;
      }
    }
  </style>

  <script src="/assets/qr.min.js?v=2026-01-03a"></script>
</head>

<body>
<a class="skip" href="#main">Hoppa till innehåll</a>

<header>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="/" aria-label="Proofy">
        <span class="logo" aria-hidden="true"></span>
        <span>Proofy</span>
      </a>

      <div class="navActions" id="navActionsDesktop">
        <a class="btn soft" href="/register.html">Skapa Verifierings-ID</a>
        <a class="btn soft" href="/verify.html">Verifiera underlag</a>
        <a class="btn soft" href="/pilot.html">Starta pilot</a>
        <a class="btn primary" href="/#kontakt">Boka kort demo</a>
      </div>

      <details class="mnav" id="mnav">
        <summary class="mnavSummary" aria-label="Öppna meny">
          <span class="mnavIcon" aria-hidden="true"></span>
        </summary>

        <nav class="mnavMenu" aria-label="Meny">
          <a class="mnavLink" href="/register.html">Skapa Verifierings-ID</a>
          <a class="mnavLink" href="/verify.html">Verifiera underlag</a>
          <a class="mnavLink" href="/pilot.html">Starta pilot</a>
          <a class="mnavLink mnavLinkPrimary" href="/#kontakt">Boka kort demo</a>

          <div class="mnavMeta">
            <a class="mnavLink" href="/security.html">Säkerhet</a>
            <a class="mnavLink" href="/privacy.html">Integritet</a>
            <a class="mnavLink" href="/terms.html">Villkor</a>
            <a class="mnavLink" href="/cookies.html">Cookies</a>
            <div class="mnavNote">Verifiering · revision · granskning</div>
            <a class="mnavMail" href="mailto:kontakt@proofy.se">kontakt@proofy.se</a>
          </div>
        </nav>
      </details>
    </div>
  </div>
</header>

<main id="main">
  <div class="pill">Intyg · spårbarhet · revision</div>

  <section class="hero" aria-label="Verifieringsintyg">
    <div class="heroTop">
      <div>
        <h1>Verifieringsintyg</h1>
      </div>

      <div id="statusBadge" class="statusBadge warn" title="Status hos Proofy vid visningstillfället">
        <span class="dot" aria-hidden="true"></span>
        <span id="statusText">Kontrollerar…</span>
      </div>
    </div>

    <!-- Max 1 primär CTA -->
    <div class="actions">
      <button class="btn primary" id="btnPrint" type="button">Skriv ut / Spara som PDF</button>
      <button class="btn" id="btnRefresh" type="button">Uppdatera</button>
    </div>

    <!-- Varningsbox: ska synas och skrivas ut -->
    <div id="warnBox" class="warnBox" role="status" aria-live="polite" aria-atomic="true">
      <b>Not:</b> Uppgifter uppdateras…
    </div>

    <div class="auditTop" aria-label="Snabböversikt (revision/juridik)">
      <div class="card" id="cardEssentials">
        <h3>Nyckeluppgifter</h3>

        <div class="kv">
          <div class="val">
            <div class="label">Verifierings-ID</div>
            <div class="row">
              <div class="mono" id="hashText">—</div>
              <button class="copyBtn" id="copyHash" type="button">Kopiera</button>
            </div>
            <div class="small" style="margin-top:8px">
              Verifierings-ID är kontrollvärdet (SHA-256) för en specifik filversion (0x + 64 hex). Ny export/omskanning/omkomprimering kan ge nytt ID även om underlaget ser likadant ut.
            </div>
          </div>

          <div class="val">
            <div class="label">Visningstid på denna enhet (ej signerad)</div>
            <div class="mono" id="viewSe">—</div>
            <div class="mono" id="viewUtc" style="margin-top:6px;color:rgba(234,240,255,.72);">—</div>
            <div class="small" style="margin-top:8px">
              Detta är <b>enhetens klocka</b> vid visning/utskrift. Det är inte en tidsstämpling och kan inte ensamt användas som bevis för när en händelse inträffade.
            </div>
          </div>

          <div class="val">
            <div class="label">Tidpunkt (om bekräftad)</div>
            <div class="mono" id="regSe">—</div>
            <div class="mono" id="regUtc" style="margin-top:6px;color:rgba(234,240,255,.72);">—</div>
            <div class="small" style="margin-top:8px;color:rgba(234,240,255,.60);">
              Avser när kontrollvärdet först blev bekräftat i Proofys register. Avser inte dokumentets skapande, signering eller godkännande.
            </div>
          </div>

          <div class="val">
            <div class="label">Status hos Proofy vid visningstillfället</div>
            <div class="mono" id="resultText">—</div>
            <div class="small" id="legalLine" style="margin-top:8px">—</div>
          </div>
        </div>

        <div class="note">
          <b>Rekommenderad rutin:</b> Spara Verifierings-ID + verifieringslänk i ärendet när referensen registreras. Använd verifieringslänk/QR vid intern kvalitetskontroll eller efterhandsgranskning.
        </div>
      </div>

      <div class="card" id="cardLinks">
        <h3>Verifieringslänk</h3>

        <div class="qrWrap">
          <div>
            <div class="label" style="margin-bottom:8px">QR-kod (snabb kontroll)</div>
            <div id="qrcodeTap" aria-label="QR-kod för verifieringslänk">
              <div id="qrcodeSurface">
                <div id="qrcode" aria-label="QR-kod"></div>
              </div>
            </div>
            <div class="small" style="margin-top:10px">
              Skanna med <b>annan enhet</b> för snabb kontroll av samma Verifierings-ID.
            </div>
          </div>

          <div style="flex:1; min-width:0;">
            <div class="val">
              <div class="label">Verifieringslänk</div>
              <div class="row">
                <div class="mono" id="verifyLink">—</div>
                <button class="copyBtn" id="copyVerify" type="button">Kopiera</button>
              </div>
              <div class="small" style="margin-top:10px">
                Öppna verifiering: <a id="openVerifyLink" href="/verify.html">/verify.html</a>
              </div>
            </div>

            <div class="val" style="margin-top:12px;">
              <div class="label">Länk till detta intyg</div>
              <div class="row">
                <div class="mono" id="certLink">—</div>
                <button class="copyBtn" id="copyCert" type="button">Kopiera</button>
              </div>
              <div class="small" style="margin-top:10px">
                Intygslänken innehåller endast Verifierings-ID (inga påståenden om kontrolltid via URL).
              </div>
            </div>

            <div class="small" id="techHint" style="margin-top:10px"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="lead">
      Detta intyg är ett <b>tekniskt underlag</b> som sammanfattar utfallet av en kontroll av ett
      <b>Verifierings-ID</b> (kontrollvärde för en specifik filversion) mot Proofys register vid visningstillfället.
      Proofy lagrar <b>inte</b> dokumentinnehåll i registret.
    </div>

    <div class="card" id="cardSummary" style="margin-top:14px;">
      <h3>Revisions-/juridisk tydlighet</h3>

      <div class="fine" style="border-top:0; padding-top:0; margin-top:0;">
        <b>Viktigt:</b><br/>
        • Intyget redovisar status för kontrollvärdet i Proofys register vid visningstillfället.<br/>
        • Tidpunkt redovisas endast när status är <b>bekräftad</b>.<br/>
        • Tidpunkten avser när kontrollvärdet först blev bekräftat i registret – inte när dokumentet skapades, signerades, godkändes eller kommunicerades.<br/>
        • Intyget ersätter inte e-signering, arkivering, behörighetsloggar, processkontroller eller juridisk rådgivning.<br/>
        • Bevisvärde och relevans bedöms i sitt sammanhang (process, åtkomst, versionshantering, dokumentationskedja).<br/>
        • Utfallet kan ändras om registret uppdateras senare.
      </div>

      <details class="tech" id="techDetails">
        <summary>Teknisk information</summary>
        <div class="techGrid">
          <div class="val">
            <div class="label">Kontrollpunkt</div>
            <div class="mono" id="observedPoint">—</div>
            <div class="small" style="margin-top:6px">Spårbar teknisk kontrollpunkt (om tillgänglig).</div>
          </div>
          <div class="val">
            <div class="label">Registreringsreferens</div>
            <div class="mono" id="registrationRef">—</div>
            <div class="small" style="margin-top:6px">Teknisk referens (om tillgänglig). Behövs normalt inte i ärendet.</div>
          </div>
        </div>
      </details>

      <div class="fine">
        <b>Integritet:</b> Vid kontroll skickas endast kontrollvärdet (Verifierings-ID) – inte filen.<br/>
        Kontakt: <a href="mailto:kontakt@proofy.se">kontakt@proofy.se</a>
      </div>
    </div>
  </section>
</main>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  function isValidBytes32Hex(s){
    return typeof s === "string" && /^0x[0-9a-fA-F]{64}$/.test(s.trim());
  }

  function pad2(n){ return String(n).padStart(2,"0"); }

  function fmtUtc(sec){
    const n = Number(sec);
    if(!Number.isFinite(n) || n <= 0) return "—";
    const d = new Date(n * 1000);
    return `${d.getUTCFullYear()}-${pad2(d.getUTCMonth()+1)}-${pad2(d.getUTCDate())} ${pad2(d.getUTCHours())}:${pad2(d.getUTCMinutes())}:${pad2(d.getUTCSeconds())} UTC`;
  }

  function fmtSeText(sec){
    const n = Number(sec);
    if(!Number.isFinite(n) || n <= 0) return "—";
    try{
      const dt = new Date(n * 1000);
      const tz = "Europe/Stockholm";
      const se = new Intl.DateTimeFormat("sv-SE", {
        timeZone: tz,
        year:"numeric", month:"2-digit", day:"2-digit",
        hour:"2-digit", minute:"2-digit", second:"2-digit"
      }).format(dt);
      return `${se} (${tz})`;
    } catch {
      return "—";
    }
  }

  function setStatus(tone, text){
    const badge = $("statusBadge");
    badge.classList.remove("good","bad","warn");
    badge.classList.add(tone);
    $("statusText").textContent = text;
  }

  function showWarn(html){
    const box = $("warnBox");
    box.innerHTML = html;
    box.classList.add("show");
  }
  function hideWarn(){
    const box = $("warnBox");
    box.innerHTML = "";
    box.classList.remove("show");
  }

  async function copyText(text){
    const t = String(text || "").trim();
    if(!t || t === "—") return false;
    try{
      await navigator.clipboard.writeText(t);
      return true;
    }catch{
      try{
        const ta = document.createElement("textarea");
        ta.value = t;
        ta.style.position="fixed";
        ta.style.left="-9999px";
        document.body.appendChild(ta);
        ta.select();
        const ok = document.execCommand("copy");
        document.body.removeChild(ta);
        return !!ok;
      }catch{
        return false;
      }
    }
  }

  function toast(label, ok){
    if(ok) showWarn(`<b>Kopierat:</b> ${label}`);
    else showWarn(`<b>Kunde inte kopiera:</b> ${label}`);
    setTimeout(() => hideWarn(), 1400);
  }

  function pickStatusPresentation(code){
    if (code === "CONFIRMED") return { tone:"good", badge:"Bekräftad" };
    if (code === "SUBMITTED_UNCONFIRMED") return { tone:"warn", badge:"Inskickad – ej bekräftad" };
    if (code === "NOT_CONFIRMED") return { tone:"bad", badge:"Ej bekräftad" };
    return { tone:"bad", badge:"Kunde inte kontrolleras" };
  }

  function safeText(v, fallback="—"){
    const s = String(v ?? "").trim();
    return s ? s : fallback;
  }

  function isMeaningfulTechValue(v){
    const s = String(v ?? "").trim();
    if (!s || s === "—") return false;
    if (/^0+$/.test(s)) return false;
    return true;
  }

  function updateTechBoxVisibility({ observedPoint, registrationRef }){
    const tech = $("techDetails");
    if (!tech) return;

    const hasObserved = isMeaningfulTechValue(observedPoint);
    const hasRef = isMeaningfulTechValue(registrationRef);

    if (!hasObserved && !hasRef){
      tech.open = false;
      tech.style.display = "none";
      return;
    }
    tech.style.display = "block";
    tech.open = true;

    const observedWrap = $("observedPoint")?.closest(".val");
    const refWrap = $("registrationRef")?.closest(".val");
    if (observedWrap) observedWrap.style.display = hasObserved ? "block" : "none";
    if (refWrap) refWrap.style.display = hasRef ? "block" : "none";
  }

  function renderQR(text){
    const el = $("qrcode");
    el.innerHTML = "";
    const payload = String(text || "").trim();

    const fallback = (msg) => {
      el.innerHTML = `<div class="small" style="padding:10px;color:#0b1220;text-align:center;line-height:1.35">${msg}</div>`;
    };

    if (!payload){ fallback("Ingen länk att koda."); return; }
    if (typeof window.QRCode !== "function"){ fallback("QR kunde inte laddas."); return; }

    const correctLevel =
      (window.QRCodeCorrectLevel && window.QRCodeCorrectLevel.H != null) ? window.QRCodeCorrectLevel.H :
      (window.QRCode && window.QRCode.CorrectLevel && window.QRCode.CorrectLevel.H != null) ? window.QRCode.CorrectLevel.H :
      undefined;

    try{
      let qr = null;
      try{
        qr = new window.QRCode(el);
        if (qr && qr._htOption){
          qr._htOption.width = 168;
          qr._htOption.height = 168;
          qr._htOption.colorDark = getComputedStyle(document.documentElement).getPropertyValue("--qr-dark").trim() || "#0b1220";
          qr._htOption.colorLight = "#ffffff";
          if (correctLevel != null) qr._htOption.correctLevel = correctLevel;
        }
      } catch { qr = null; }

      if (!qr || typeof qr.makeCode !== "function"){
        el.innerHTML = "";
        qr = new window.QRCode(el, {
          width:168,
          height:168,
          colorDark:(getComputedStyle(document.documentElement).getPropertyValue("--qr-dark").trim() || "#0b1220"),
          colorLight:"#ffffff",
          correctLevel: correctLevel
        });
      }
      if (!qr || typeof qr.makeCode !== "function"){ fallback("QR-koden kunde inte visas."); return; }

      qr.makeCode(payload);

      const node = el.querySelector("canvas, img, svg, table");
      if (!node){ fallback("QR-koden kunde inte visas."); return; }

      node.style.width = "168px";
      node.style.height = "168px";
      node.style.display = "block";
      node.style.imageRendering = "pixelated";
    } catch {
      fallback("QR-koden kunde inte visas.");
    }
  }

  async function fetchJson(url){
    const sep = url.includes("?") ? "&" : "?";
    const bustUrl = url + sep + "t=" + Date.now();
    const r = await fetch(bustUrl, { cache:"no-store", credentials:"same-origin" });
    const data = await r.json().catch(() => ({}));
    if(!r.ok) throw new Error(data?.error || data?.detail || `HTTP ${r.status}`);
    return data;
  }

  async function run(){
    hideWarn();

    const url = new URL(location.href);
    const hash = (url.searchParams.get("hash") || "").trim();

    // Inga manipulativa tidsparametrar i URL.
    const certLink = `${location.origin}/certificate.html?hash=${encodeURIComponent(hash)}`;
    const verifyLink = `${location.origin}/verify.html?hash=${encodeURIComponent(hash)}`;

    $("certLink").textContent = certLink;
    $("verifyLink").textContent = verifyLink;
    $("openVerifyLink").href = verifyLink;

    $("btnPrint").onclick = () => window.print();
    $("btnRefresh").onclick = () => run();

    $("copyHash").onclick = async () => toast("Verifierings-ID", await copyText(hash));
    $("copyCert").onclick = async () => toast("Länk till intyg", await copyText(certLink));
    $("copyVerify").onclick = async () => toast("Verifieringslänk", await copyText(verifyLink));

    renderQR(verifyLink);

    // Visningstid (enhetens klocka) – tydligt markerad som ej signerad.
    const viewSec = Math.floor(Date.now()/1000);
    $("viewSe").textContent = fmtSeText(viewSec);
    $("viewUtc").textContent = fmtUtc(viewSec);

    // Reset outputs
    $("hashText").textContent = "—";
    $("resultText").textContent = "—";
    $("legalLine").textContent = "—";
    $("regSe").textContent = "—";
    $("regUtc").textContent = "—";
    $("observedPoint").textContent = "—";
    $("registrationRef").textContent = "—";
    updateTechBoxVisibility({ observedPoint:"—", registrationRef:"—" });

    if (!isValidBytes32Hex(hash)){
      setStatus("bad", "Ogiltigt ID");
      $("hashText").textContent = "Ogiltigt eller saknas (hash=...)";
      $("resultText").textContent = "Kunde inte kontrollera: saknat/ogiltigt Verifierings-ID i URL.";
      $("legalLine").textContent = "Ingen slutsats kan dras utan giltigt Verifierings-ID.";
      showWarn(`<b>Fel:</b> Intyget saknar giltigt Verifierings-ID i URL. Exempel: <span class="mono">/certificate.html?hash=0x...</span>`);
      return;
    }

    $("hashText").textContent = hash;
    setStatus("warn", "Kontrollerar…");
    $("resultText").textContent = "Kontrollerar status hos Proofy…";
    showWarn(`<b>Not:</b> Detta intyg visar status vid visningstillfället. Om du sparar som PDF ska varningar/reservationer finnas med.`);

    let v;
    try{
      v = await fetchJson(`/api/verify?hash=${encodeURIComponent(hash)}`);
    } catch {
      setStatus("bad", "Kunde inte kontrolleras");
      $("resultText").textContent = "Kunde inte kontrolleras vid visningstillfället.";
      $("legalLine").textContent = "Tekniskt fel. Ingen slutsats kan dras om bekräftelse.";
      showWarn(`<b>Tillfälligt fel:</b> kontrollen kunde inte genomföras. Försök igen.`);
      return;
    }

    const statusCode = safeText(v?.statusCode, "UNKNOWN");
    const statusText = safeText(v?.statusText, "Kunde inte kontrolleras");
    const legalText = safeText(v?.legalText, "");
    const confirmedAtUnix = (v?.confirmedAtUnix != null) ? Number(v.confirmedAtUnix) : null;

    const observedPoint = safeText(v?.evidence?.observedBlockNumber, "—");
    const registrationRef = safeText(v?.submission?.txHash, "—");

    $("observedPoint").textContent = observedPoint;
    $("registrationRef").textContent = registrationRef;
    updateTechBoxVisibility({ observedPoint, registrationRef });

    const pres = pickStatusPresentation(statusCode);
    setStatus(pres.tone, pres.badge);
    $("resultText").textContent = statusText;

    if (legalText){
      $("legalLine").textContent = legalText;
    } else {
      if (statusCode === "CONFIRMED"){
        $("legalLine").textContent = "Status är bekräftad i Proofys register vid visningstillfället.";
      } else if (statusCode === "SUBMITTED_UNCONFIRMED"){
        $("legalLine").textContent = "En registrering är inskickad men ännu ej bekräftad. Ingen bekräftad tidpunkt kan redovisas.";
      } else if (statusCode === "NOT_CONFIRMED"){
        $("legalLine").textContent = "Ingen bekräftad notering kunde konstateras vid visningstillfället.";
      } else {
        $("legalLine").textContent = "Status kunde inte kontrolleras vid visningstillfället. Ingen slutsats kan dras om bekräftelse.";
      }
    }

    if (statusCode === "CONFIRMED" && Number.isFinite(confirmedAtUnix) && confirmedAtUnix > 0){
      $("regSe").textContent = fmtSeText(confirmedAtUnix);
      $("regUtc").textContent = fmtUtc(confirmedAtUnix);
      hideWarn();
      return;
    }

    $("regSe").textContent = "—";
    $("regUtc").textContent = "—";

    if (statusCode === "SUBMITTED_UNCONFIRMED"){
      showWarn(`<b>Inskickad – ej bekräftad:</b> Intyget kan inte redovisa bekräftelsetid innan status är bekräftad.`);
      return;
    }
    if (statusCode === "NOT_CONFIRMED"){
      showWarn(`<b>Ej bekräftad:</b> Ingen bekräftad notering kunde konstateras vid visningstillfället. Kontrollera att rätt filversion/Verifierings-ID används och uppdatera vid behov.`);
      return;
    }
    showWarn(`<b>Kunde inte kontrolleras:</b> Kontroll kunde inte genomföras vid visningstillfället. Försök igen.`);
  }

  run();
})();
</script>

<script src="/assets/header-toggle.js?v=2026-01-03a" defer></script>
<script src="/chat-widget.js?v=2026-01-03a" defer></script>
</body>
</html>
