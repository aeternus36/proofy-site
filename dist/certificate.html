<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proofy – Verifieringsintyg</title>
  <meta name="description" content="Verifieringsintyg som sammanfattar om en filversion är registrerad och när den registrerades." />
  <meta name="theme-color" content="#0b1220" />
  <link rel="stylesheet" href="/assets/proofy.css?v=2025-12-20" />
</head>

<body>
<a class="skip" href="#main">Hoppa till innehåll</a>

<header>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="/" aria-label="Proofy">
        <span class="logo" aria-hidden="true"></span>
        <span>Proofy</span>
      </a>

      <div class="navLinks" aria-label="Navigation">
        <a href="/">Start</a>
        <a href="/verify.html">Verifiera</a>
        <a href="/hash.html">Skapa ID</a>
        <a href="/terms.html">Villkor</a>
      </div>

      <div class="navActions">
        <a class="btn" id="openVerifyBtn" href="/verify.html">Öppna verifiering</a>
        <button class="btn primary" id="printBtn" type="button">Skriv ut / Spara PDF</button>
      </div>
    </div>
  </div>
</header>

<main id="main">
  <div class="wrap">

    <div class="note meta">
      Intyg öppnas via <span class="mono">/certificate.html?id=…</span>
    </div>

    <div class="paper">
      <div class="hdr">
        <div>
          <h1>Verifieringsintyg</h1>
          <div class="subtitle">
            Sammanfattning för byråärende: visar om ett Verifierings-ID är registrerat och när registreringen gjordes.
            Inget filinnehåll lagras i Proofy.
          </div>
        </div>
        <div id="statusBadge" class="badge">Laddar…</div>
      </div>

      <div class="actions" style="margin-top:14px;">
        <a class="btn" id="copyLinkBtn" href="#" role="button">Kopiera verifieringslänk</a>
        <a class="btn soft" id="refreshBtn" href="#" role="button">Uppdatera</a>
      </div>

      <div class="grid">
        <div class="card content">
          <div class="label">Verifierings-ID</div>
          <pre id="idOut" class="mono">—</pre>
          <div class="para muted">
            Detta ID kan sparas i ärendet och användas för att verifiera filversionen vid behov.
          </div>
        </div>

        <div class="card content">
          <div class="label">Intyg genererat</div>
          <pre id="issuedOut" class="mono">—</pre>
          <div class="para muted">
            Detta är tidpunkten då intyget skapades (inte samma som registreringstid).
          </div>
        </div>
      </div>

      <div class="grid">
        <div class="card content">
          <div class="label">Status</div>
          <pre id="existsOut" class="mono">—</pre>

          <div class="hr"></div>

          <div class="label">Registrerad</div>
          <pre id="tsSeOut" class="mono">—</pre>

          <div class="para muted">
            Om status är “Registrerad” betyder det att referensen fanns registrerad vid angiven tidpunkt.
          </div>
        </div>

        <div class="card content">
          <div class="label">Verifieringslänk</div>
          <pre id="verifyLinkOut" class="mono">—</pre>

          <div class="qrRow">
            <div>
              <div class="label" style="margin-bottom:8px;">QR-kod</div>
              <div id="qrBox" class="qrBox" aria-label="QR-kod"></div>
              <div id="qrStatus" class="meta" style="margin-top:8px;">—</div>
            </div>

            <div style="flex:1; min-width:260px;">
              <div class="para muted" style="margin-top:0;">
                Dela länken eller låt mottagaren scanna QR-koden för att öppna verifieringen.
              </div>
              <details style="margin-top:12px;">
                <summary>Juridik (kort)</summary>
                <p>
                  Intyget visar om en filversion matchar registrerad referens. Det är inte ett intyg om innehållets korrekthet,
                  äkthet, upphov eller att filen är “godkänd”. Proofy ersätter inte juridisk rådgivning eller revision.
                </p>
              </details>
            </div>
          </div>
        </div>
      </div>

      <div class="card content" id="problemCard" style="display:none; margin-top:14px;">
        <div class="label" style="color:var(--err); font-weight:900;">Tillfälligt tekniskt problem</div>
        <div class="para muted" id="problemText">—</div>
        <div class="para muted" style="margin-top:8px;">
          Prova att uppdatera. Om problemet kvarstår: kontrollera drift/anslutning till verifieringstjänsten.
        </div>
      </div>

    </div>
  </div>
</main>

<script
  src="/qr.min.js?v=2025-12-20"
  onload="window.__proofyQrLibLoaded = true"
  onerror="window.__proofyQrLibError = true"
></script>

<script>
(() => {
  const el = (id) => document.getElementById(id);

  const statusBadge = el("statusBadge");
  const idOut = el("idOut");
  const issuedOut = el("issuedOut");
  const existsOut = el("existsOut");
  const tsSeOut = el("tsSeOut");
  const verifyLinkOut = el("verifyLinkOut");
  const qrBox = el("qrBox");
  const qrStatus = el("qrStatus");

  const problemCard = el("problemCard");
  const problemText = el("problemText");

  const openVerifyBtn = el("openVerifyBtn");
  const printBtn = el("printBtn");
  const refreshBtn = el("refreshBtn");
  const copyLinkBtn = el("copyLinkBtn");

  function setBadge(text, kind){
    statusBadge.textContent = text;
    statusBadge.classList.remove("ok", "err");
    if (kind) statusBadge.classList.add(kind);
  }

  function showProblem(msg){
    problemCard.style.display = "block";
    problemText.textContent = msg;
  }

  function hideProblem(){
    problemCard.style.display = "none";
    problemText.textContent = "—";
  }

  function setQrStatus(msg){
    qrStatus.textContent = msg || "";
  }

  function canRenderQr(){
    return typeof window.QRCode === "function";
  }

  function renderQr(text){
    if (!qrBox) return;

    if (!canRenderQr()){
      if (window.__proofyQrLibError){
        qrBox.innerHTML = '<div class="meta" style="padding:10px; text-align:center;">QR-funktionen kunde inte laddas.</div>';
        setQrStatus("QR-funktionen kunde inte laddas.");
        return;
      }

      qrBox.innerHTML = '<div class="meta" style="padding:10px; text-align:center;">Laddar QR…</div>';
      setQrStatus("Laddar QR…");

      let tries = 0;
      const maxTries = 20;
      const t = setInterval(() => {
        tries++;
        if (canRenderQr()){
          clearInterval(t);
          doRender(text);
          setQrStatus("");
          return;
        }
        if (window.__proofyQrLibError || tries >= maxTries){
          clearInterval(t);
          qrBox.innerHTML = '<div class="meta" style="padding:10px; text-align:center;">QR-funktionen kunde inte laddas.</div>';
          setQrStatus("QR-funktionen kunde inte laddas.");
        }
      }, 50);

      return;
    }

    doRender(text);
    setQrStatus("");
  }

  function doRender(text){
    qrBox.innerHTML = "";
    const correctLevel =
      window.QRCodeCorrectLevel && window.QRCodeCorrectLevel.M
        ? window.QRCodeCorrectLevel.M
        : undefined;

    new QRCode(qrBox, { text, width: 150, height: 150, correctLevel });
  }

  function getIdFromQuery(){
    const url = new URL(window.location.href);
    return (url.searchParams.get("id") || url.searchParams.get("hash") || "").trim();
  }

  function isIdFormat(id){
    return /^0x[a-fA-F0-9]{64}$/.test(id);
  }

  function buildVerifyLink(id){
    return `${location.origin}/verify.html?id=${encodeURIComponent(id)}`;
  }

  function formatSe(ts){
    const d = new Date(Number(ts) * 1000);
    return new Intl.DateTimeFormat("sv-SE", {
      timeZone: "Europe/Stockholm",
      year: "numeric", month: "2-digit", day: "2-digit",
      hour: "2-digit", minute: "2-digit", second: "2-digit"
    }).format(d) + " (Europe/Stockholm)";
  }

  async function loadCertificate(){
    hideProblem();

    const id = getIdFromQuery();
    idOut.textContent = id || "—";

    const issuedSe = new Date().toLocaleString("sv-SE", { timeZone: "Europe/Stockholm" });
    const issuedUtc = new Date().toISOString().replace("T"," ").replace(".000Z"," UTC");
    issuedOut.textContent = `${issuedSe} (Europe/Stockholm)\n${issuedUtc}`;

    if (!id){
      setBadge("Saknar Verifierings-ID", "err");
      existsOut.textContent = "—";
      tsSeOut.textContent = "—";
      verifyLinkOut.textContent = "—";
      qrBox.innerHTML = "—";
      setQrStatus("—");
      openVerifyBtn.href = "/verify.html";
      return;
    }

    if (!isIdFormat(id)){
      setBadge("Ogiltigt format", "err");
      existsOut.textContent = "—";
      tsSeOut.textContent = "—";
      const v = buildVerifyLink(id);
      verifyLinkOut.textContent = v;
      openVerifyBtn.href = v;
      renderQr(v);
      return;
    }

    const vlink = buildVerifyLink(id);
    verifyLinkOut.textContent = vlink;
    openVerifyBtn.href = vlink;
    renderQr(vlink);

    setBadge("Kontrollerar…");

    try{
      const res = await fetch(`/api/verify?hash=${encodeURIComponent(id)}`, { method: "GET" });
      const data = await res.json().catch(() => ({}));

      if (!res.ok || data.ok === false){
        setBadge("Kan ej kontrollera just nu", "err");
        showProblem(String(data.error || `HTTP ${res.status}`));
        existsOut.textContent = "—";
        tsSeOut.textContent = "—";
        return;
      }

      if (data.exists){
        setBadge("Registrerad", "ok");
        existsOut.textContent = "Registrerad (referensen finns i registret)";
        tsSeOut.textContent = data.timestamp ? formatSe(data.timestamp) : "—";
      } else {
        setBadge("Inte registrerad", "err");
        existsOut.textContent = "Inte registrerad (ingen registrering hittades)";
        tsSeOut.textContent = "—";
      }
    } catch (e){
      setBadge("Kan ej kontrollera just nu", "err");
      showProblem(String(e?.message || e));
      existsOut.textContent = "—";
      tsSeOut.textContent = "—";
    }
  }

  printBtn.addEventListener("click", () => window.print());
  refreshBtn.addEventListener("click", (e) => { e.preventDefault(); loadCertificate(); });

  copyLinkBtn.addEventListener("click", async (e) => {
    e.preventDefault();
    const id = getIdFromQuery();
    if (!id) return;
    const link = buildVerifyLink(id);
    try{
      await navigator.clipboard.writeText(link);
      setQrStatus("Länk kopierad ✅");
    } catch {
      setQrStatus("Kunde inte kopiera länk");
    }
  });

  loadCertificate();
})();
</script>

</body>
</html>
