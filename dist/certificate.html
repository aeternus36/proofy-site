<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proofy – Verifieringsintyg</title>
  <meta name="description" content="Verifieringsintyg som sammanfattar om ett Verifierings-ID är registrerat och när registreringen skedde." />
  <meta name="theme-color" content="#0b1220" />

  <!-- Om du har gemensam CSS, behåll. Annars går sidan ändå bra med inline-stilen nedan -->
  <link rel="stylesheet" href="/assets/proofy.css?v=2025-12-20" />

  <style>
    /* Målet: en sida, mindre “flik-känsla”, bättre mobilheader, tydlig intygslayout */
    .certWrap{ max-width: 920px; margin:0 auto; padding: 0 20px; }
    .certTop{
      margin-top: 14px;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow: 0 18px 60px rgba(0,0,0,.38);
      padding: 18px;
    }
    .certHead{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
    }
    .certTitle{
      margin: 0;
      font-size: clamp(26px, 3.2vw, 42px);
      line-height: 1.12;
      letter-spacing: -.4px;
    }
    .certLead{
      margin: 10px 0 0;
      color: rgba(234,240,255,.92);
      max-width: 95ch;
      line-height: 1.55;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      font-weight: 950;
      white-space: nowrap;
    }
    .chip.ok{ color: var(--ok); }
    .chip.err{ color: var(--err); }
    .chip.neutral{ color: rgba(234,240,255,.92); }

    .actions{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top: 12px;
    }
    .actions .btn{ min-width: 180px; }
    @media (max-width:560px){
      .actions .btn{ width:100%; min-width: unset; }
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 920px){
      .grid{ grid-template-columns: 1fr; }
    }

    .panel{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(11,18,32,.25);
      border-radius: 16px;
      padding: 16px;
    }
    .label{
      color: rgba(169,183,211,.92);
      font-size: 12.5px;
      font-weight: 900;
      letter-spacing: .2px;
      margin-bottom: 6px;
    }
    .value{
      color: rgba(234,240,255,.92);
      line-height: 1.55;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      word-break: break-all;
    }

    .hr{ height:1px; background: rgba(255,255,255,.12); margin: 14px 0; }

    .note{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 14px;
      color: rgba(169,183,211,.95);
      font-size: 13px;
      line-height: 1.55;
    }
    .note b{ color: rgba(234,240,255,.92); }

    .openBox{
      display:none;
      margin-top: 12px;
    }
    .openRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }
    .openRow input{
      flex:1;
      min-width: 220px;
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(11,18,32,.35);
      color: rgba(234,240,255,.92);
      outline:none;
      font: inherit;
    }
    .openRow .btn{ min-width: 170px; }
    @media (max-width:560px){
      .openRow .btn{ width:100%; }
    }

    .qrRow{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      align-items:flex-start;
      margin-top: 10px;
    }
    .qrBox{
      width: 170px;
      height: 170px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(11,18,32,.25);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .qrBox canvas, .qrBox img{
      width:150px !important; height:150px !important;
      image-rendering: pixelated;
    }

    details{ border:1px solid rgba(255,255,255,.12); border-radius: 16px; padding: 14px; background: rgba(255,255,255,.04); }
    summary{ cursor:pointer; font-weight: 950; list-style:none; }
    summary::-webkit-details-marker{ display:none; }
    details p{ margin: 10px 0 0; color: rgba(169,183,211,.95); line-height:1.6; }

    /* Print/PDF: ren och “intygig” */
    @media print{
      header, .actions, .openBox, #qrWrap, #btnCopyLink { display:none !important; }
      body{ background:#fff !important; color:#000 !important; }
      .certTop{ box-shadow:none !important; background:#fff !important; border:1px solid #ddd !important; }
      .panel, .note, details{ background:#fff !important; border:1px solid #ddd !important; }
      .chip{ background:#fff !important; border:1px solid #ddd !important; }
      .label{ color:#444 !important; }
      .value{ color:#000 !important; }
      a{ color:#000 !important; text-decoration:none !important; }
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="/" aria-label="Proofy">
        <span class="logo" aria-hidden="true"></span>
        <span>Proofy</span>
      </a>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:nowrap;">
        <a class="btn" href="/verify.html">Verifiera</a>
        <a class="btn primary" href="/#kontakt">Boka demo</a>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="certWrap">

    <div class="badge" style="margin-top:18px;">Intyg · spårbarhet · byrå & granskning</div>

    <section class="certTop" aria-label="Verifieringsintyg">

      <div class="certHead">
        <div style="flex:1;min-width:260px;">
          <h1 class="certTitle">Verifieringsintyg</h1>
          <p class="certLead">
            Intyget sammanfattar resultatet av en kontroll av ett <b>Verifierings-ID</b>.
            Det visar om ID:t är registrerat och, i så fall, <b>när registreringen skedde</b>.
            <b>Inget dokumentinnehåll lagras</b> i Proofy.
          </p>
        </div>
        <div>
          <div id="statusChip" class="chip neutral">Laddar…</div>
        </div>
      </div>

      <div class="actions" aria-label="Åtgärder">
        <button class="btn" id="btnPrint" type="button">Skriv ut / Spara som PDF</button>
        <button class="btn soft" id="btnRefresh" type="button">Uppdatera</button>
        <a class="btn primary" id="btnVerify" href="/verify.html">Öppna verifiering</a>
        <button class="btn" id="btnCopyLink" type="button" disabled>Kopiera länk</button>
      </div>

      <div id="openBox" class="openBox">
        <div class="hr"></div>
        <div class="note">
          <b>Öppna intyget</b><br />
          Klistra in Verifierings-ID eller öppna via länk:
          <span class="mono">/certificate.html?hash=0x…</span>
        </div>
        <div class="openRow">
          <input id="hashInput" type="text" placeholder="Verifierings-ID (0x…)" />
          <button id="btnOpen" class="btn primary" type="button">Öppna intyg</button>
          <button id="btnPaste" class="btn soft" type="button">Klistra in ID</button>
          <a class="btn" href="/verify.html">Gå till verifiering</a>
        </div>
        <div id="openHint" class="meta" style="margin-top:8px;"></div>
      </div>

      <div class="hr"></div>

      <!-- Kärninformation: kompakt men komplett -->
      <div class="grid">
        <div class="panel">
          <div class="label">Verifierings-ID</div>
          <div id="hashOut" class="value mono">—</div>
          <div class="meta" style="margin-top:8px;">
            ID:t avser en <b>filversion</b>. Minsta ändring ger ett nytt ID.
          </div>
        </div>

        <div class="panel">
          <div class="label">Kontroll genomförd</div>
          <div id="checkedOut" class="value">—</div>
          <div class="meta" style="margin-top:8px;">
            Tidpunkten då kontrollen gjordes (när intyget uppdaterades).
          </div>
        </div>
      </div>

      <div class="grid">
        <div class="panel">
          <div class="label">Resultat</div>
          <div id="resultOut" class="value">—</div>

          <div class="hr"></div>

          <div class="label">Registreringstid (Sverige)</div>
          <div id="tsSeOut" class="value">—</div>

          <div class="label" style="margin-top:10px;">Registreringstid (UTC)</div>
          <div id="tsUtcOut" class="value">—</div>
        </div>

        <div class="panel">
          <div class="label">Verifieringslänk</div>
          <div id="verifyLinkOut" class="value mono">—</div>

          <div id="qrWrap">
            <div class="qrRow">
              <div>
                <div class="label" style="margin-top:12px;">QR-kod</div>
                <div id="qrBox" class="qrBox" aria-label="QR-kod">—</div>
                <div id="qrStatus" class="meta" style="margin-top:8px;">—</div>
              </div>
              <div style="flex:1; min-width:240px;">
                <div class="note" style="margin-top:12px;">
                  Dela länken eller QR-koden när någon behöver kontrollera ID:t i efterhand.
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <div class="panel" style="margin-top:12px;">
        <div class="label">Tolkning</div>
        <div id="interpretation" class="value">—</div>

        <div class="note" style="margin-top:12px;">
          <b>Viktigt:</b> Intyget visar endast om en filversion (via Verifierings-ID) var registrerad vid angiven tidpunkt.
          Det säger inget om dokumentets innehåll, riktighet, upphov, behörighet, avtal mellan parter eller hur filen hanterats efteråt.
        </div>
      </div>

      <!-- Svensk juridik-/revisionsdel: kort synlig + detaljer i “visa mer” -->
      <div class="panel" style="margin-top:12px;">
        <div class="label">Juridisk information</div>
        <div class="value" style="color: rgba(169,183,211,.95);">
          Detta intyg är ett tekniskt underlag för dokumentation/spårbarhet. Det ersätter inte juridisk rådgivning
          eller professionell bedömning i granskning/revision. Bevisvärde bedöms i sitt sammanhang.
        </div>

        <details style="margin-top:12px;">
          <summary>Visa fullständig text</summary>
          <p>
            <b>1) Utfärdare och kontakt</b><br/>
            Intyget tillhandahålls av Proofy (”tjänsten”). Kontakt: <b>kontakt@proofy.se</b>.
          </p>
          <p>
            <b>2) Vad intyget omfattar</b><br/>
            Intyget beskriver utfallet av en kontroll av ett Verifierings-ID och (om registrerad) registreringstid.
            Intyget tar inte ställning till dokumentets innehåll, tolkning, riktighet eller rättsliga giltighet.
          </p>
          <p>
            <b>3) Vad intyget inte omfattar</b><br/>
            Intyget visar inte vem som skapat dokumentet, vem som haft tillgång till det, om behörig person godkänt det,
            eller om filen hanterats/ändrats efter registrering. Intyget är inte e-signering, inte arkivering och inte ett avtal i sig.
          </p>
          <p>
            <b>4) Integritet och sekretess</b><br/>
            Proofy lagrar inte dokumentinnehåll i samband med intyget. Intyget kan innehålla Verifierings-ID och tider.
            Hantering av personuppgifter och övrig information regleras i tillämplig integritetspolicy och villkor.
          </p>
          <p>
            <b>5) Användning i byrå-/revisionssammanhang</b><br/>
            Intyget är avsett som stöd för spårbarhet och dokumentation. Professionell bedömning, övriga kontrollåtgärder
            och krav på dokumentation kvarstår. Vid tvist eller granskning är intyget en del av helheten.
          </p>
          <p>
            <b>6) Drift, fel och tillgänglighet</b><br/>
            Tillfälliga driftstörningar kan påverka möjligheten att genomföra kontrollen vid ett visst tillfälle.
            Vid avvikelse rekommenderas att kontrollen görs om, samt att underlaget verifieras genom etablerade rutiner.
          </p>
          <p>
            <b>7) Ansvar och ansvarsbegränsning</b><br/>
            Intyget lämnas ”i befintligt skick” som tekniskt underlag. Proofy lämnar inga garantier om att intyget uppfyller
            särskilda branschkrav i varje enskilt fall. Eventuellt ansvar regleras i Proofys villkor.
          </p>
          <p>
            <b>8) Tillämplig lag och tvist</b><br/>
            Svensk lag ska tillämpas i den mån annat inte följer av tvingande regler. Tvist hanteras enligt Proofys villkor.
          </p>
          <p class="meta">
            Länkar: <a href="/terms.html">Villkor</a> · <a href="/privacy.html">Integritet</a>
          </p>
        </details>
      </div>

      <div id="problemBox" class="note" style="display:none; margin-top:12px;">
        <b style="color: var(--err);">Tillfälligt tekniskt problem</b>
        <div id="problemText" style="margin-top:6px;">—</div>
      </div>

    </section>

    <p class="small" style="margin-top:14px;">
      Behöver ni ett upplägg för rutin/arbetsflöde i byrån? <a href="/#kontakt">Boka demo</a>.
    </p>

  </div>
</main>

<!-- QR-bibliotek -->
<script
  src="/qr.min.js?v=2025-12-20"
  onload="window.__proofyQrLibLoaded = true"
  onerror="window.__proofyQrLibError = true"
></script>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const statusChip = $("statusChip");
  const btnPrint = $("btnPrint");
  const btnRefresh = $("btnRefresh");
  const btnVerify = $("btnVerify");
  const btnCopyLink = $("btnCopyLink");

  const openBox = $("openBox");
  const hashInput = $("hashInput");
  const btnOpen = $("btnOpen");
  const btnPaste = $("btnPaste");
  const openHint = $("openHint");

  const hashOut = $("hashOut");
  const checkedOut = $("checkedOut");
  const resultOut = $("resultOut");
  const tsSeOut = $("tsSeOut");
  const tsUtcOut = $("tsUtcOut");
  const verifyLinkOut = $("verifyLinkOut");

  const qrBox = $("qrBox");
  const qrStatus = $("qrStatus");

  const interpretation = $("interpretation");

  const problemBox = $("problemBox");
  const problemText = $("problemText");

  let busy = false;
  let opId = 0;

  function setBusy(v){
    busy = v;
    btnRefresh.disabled = v;
    btnCopyLink.disabled = v || !verifyLinkOut.textContent || verifyLinkOut.textContent === "—";
  }

  function setStatus(text, kind){
    statusChip.textContent = text;
    statusChip.classList.remove("ok","err","neutral");
    statusChip.classList.add(kind || "neutral");
  }

  function showProblem(msg){
    problemBox.style.display = "block";
    problemText.textContent = msg || "Okänt fel.";
  }
  function hideProblem(){
    problemBox.style.display = "none";
    problemText.textContent = "—";
  }

  function isBytes32Hex(h){
    return typeof h === "string" && /^0x[0-9a-fA-F]{64}$/.test(h.trim());
  }

  function getHashFromUrl(){
    const url = new URL(location.href);
    return (url.searchParams.get("hash") || "").trim();
  }

  function setHashInUrl(hash){
    const url = new URL(location.href);
    if (hash) url.searchParams.set("hash", hash);
    else url.searchParams.delete("hash");
    history.replaceState({}, "", url.toString());
  }

  function buildVerifyLink(hash){
    return `${location.origin}/verify.html?hash=${encodeURIComponent(hash)}`;
  }

  function fmtSe(ts){
    try{
      return new Intl.DateTimeFormat("sv-SE", {
        timeZone:"Europe/Stockholm",
        year:"numeric", month:"2-digit", day:"2-digit",
        hour:"2-digit", minute:"2-digit", second:"2-digit"
      }).format(new Date(Number(ts) * 1000)) + " (Europe/Stockholm)";
    } catch {
      return "—";
    }
  }
  function fmtUtc(ts){
    try{
      return new Date(Number(ts) * 1000).toISOString().replace("T"," ").replace(".000Z"," UTC");
    } catch {
      return "—";
    }
  }

  function setCheckedNow(){
    const se = new Date().toLocaleString("sv-SE", { timeZone:"Europe/Stockholm" });
    const utc = new Date().toISOString().replace("T"," ").replace("Z"," UTC");
    checkedOut.textContent = `${se} (Europe/Stockholm)\n${utc}`;
  }

  function resetView(){
    hashOut.textContent = "—";
    resultOut.textContent = "—";
    tsSeOut.textContent = "—";
    tsUtcOut.textContent = "—";
    verifyLinkOut.textContent = "—";
    interpretation.textContent = "—";
    if (qrBox) qrBox.innerHTML = "—";
    if (qrStatus) qrStatus.textContent = "—";
    btnVerify.href = "/verify.html";
    btnCopyLink.disabled = true;
  }

  function canRenderQr(){
    return typeof window.QRCode === "function";
  }

  function showQrError(){
    const msg = window.__proofyQrLibError
      ? "QR kunde inte laddas. Kontrollera att /qr.min.js finns i deploy."
      : "QR kunde inte laddas.";
    qrBox.innerHTML = `<div class="meta" style="padding:10px;text-align:center;">${msg}</div>`;
    qrStatus.textContent = msg;
  }

  function renderQr(text){
    if (!qrBox) return;

    if(!canRenderQr()){
      if (window.__proofyQrLibError){
        showQrError();
        return;
      }
      qrBox.innerHTML = `<div class="meta" style="padding:10px;text-align:center;">Laddar QR…</div>`;
      qrStatus.textContent = "Laddar QR…";

      let tries = 0;
      const maxTries = 20;
      const t = setInterval(() => {
        tries++;
        if (canRenderQr()){
          clearInterval(t);
          doRender(text);
          qrStatus.textContent = "";
          return;
        }
        if (window.__proofyQrLibError || tries >= maxTries){
          clearInterval(t);
          showQrError();
        }
      }, 50);
      return;
    }

    doRender(text);
    qrStatus.textContent = "";
  }

  function doRender(text){
    qrBox.innerHTML = "";
    const correctLevel =
      window.QRCodeCorrectLevel && window.QRCodeCorrectLevel.M
        ? window.QRCodeCorrectLevel.M
        : undefined;

    new QRCode(qrBox, { text, width:150, height:150, correctLevel });
  }

  // Robust: prova GET /api/verify?hash=... och fall tillbaka till POST {hash}
  async function fetchVerify(hash){
    try{
      const r = await fetch(`/api/verify?hash=${encodeURIComponent(hash)}`, { method:"GET" });
      const j = await r.json().catch(() => ({}));
      if (r.ok) return { ok:true, data:j };
    } catch { /* ignore */ }

    const r2 = await fetch(`/api/verify`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ hash })
    });
    const j2 = await r2.json().catch(() => ({}));
    if (!r2.ok) return { ok:false, error: j2?.error || `HTTP ${r2.status}` };
    return { ok:true, data:j2 };
  }

  async function loadCertificate(hash){
    const myOp = ++opId;
    hideProblem();
    setBusy(true);
    setCheckedNow();

    if(!hash){
      resetView();
      openBox.style.display = "block";
      setStatus("Saknar Verifierings-ID", "err");
      interpretation.textContent = "Ingen kontroll kunde göras eftersom Verifierings-ID saknas.";
      setBusy(false);
      return;
    }

    openBox.style.display = "none";
    hashOut.textContent = hash;

    // Länk/QR även om formatet är fel – men tydlig status
    const vlink = buildVerifyLink(hash);
    btnVerify.href = vlink;
    verifyLinkOut.textContent = vlink;
    renderQr(vlink);
    btnCopyLink.disabled = false;

    if(!isBytes32Hex(hash)){
      setStatus("Ogiltigt Verifierings-ID", "err");
      resultOut.textContent = "Kan inte kontrollera (fel format)";
      tsSeOut.textContent = "—";
      tsUtcOut.textContent = "—";
      interpretation.textContent = "Verifierings-ID har fel format. Kontrollera att du kopierat hela ID:t.";
      setBusy(false);
      return;
    }

    setStatus("Kontrollerar…", "neutral");

    try{
      const res = await fetchVerify(hash);
      if (myOp !== opId) return;

      if(!res.ok){
        setStatus("Kan inte kontrollera just nu", "err");
        resultOut.textContent = "Kontroll kunde inte genomföras";
        tsSeOut.textContent = "—";
        tsUtcOut.textContent = "—";
        interpretation.textContent = "Kontrollen kunde inte genomföras på grund av ett tillfälligt tekniskt problem.";
        showProblem(res.error || "Okänt fel.");
        setBusy(false);
        return;
      }

      const data = res.data || {};
      const exists = Boolean(data.exists);
      const ts = data.timestamp ? Number(data.timestamp) : null;

      if (exists){
        setStatus("Registrerad", "ok");
        resultOut.textContent = "Registrerad (Verifierings-ID finns i registret)";
        tsSeOut.textContent = ts ? fmtSe(ts) : "—";
        tsUtcOut.textContent = ts ? fmtUtc(ts) : "—";
        interpretation.textContent = "Kontrollen visar att Verifierings-ID:t fanns registrerat vid angiven registreringstid.";
      } else {
        setStatus("Inte registrerad", "err");
        resultOut.textContent = "Inte registrerad (Verifierings-ID saknas i registret)";
        tsSeOut.textContent = "—";
        tsUtcOut.textContent = "—";
        interpretation.textContent = "Kontrollen visar att ingen registrering hittades för angivet Verifierings-ID vid kontrolltillfället.";
      }

      setBusy(false);
    } catch (e){
      if (myOp !== opId) return;
      setStatus("Kan inte kontrollera just nu", "err");
      resultOut.textContent = "Kontroll kunde inte genomföras";
      tsSeOut.textContent = "—";
      tsUtcOut.textContent = "—";
      interpretation.textContent = "Kontrollen kunde inte genomföras på grund av ett tillfälligt nätverks-/driftproblem.";
      showProblem(String(e?.message || e));
      setBusy(false);
    }
  }

  // Actions
  btnPrint.addEventListener("click", () => window.print());
  btnRefresh.addEventListener("click", () => loadCertificate(getHashFromUrl()));

  btnCopyLink.addEventListener("click", async () => {
    const txt = (verifyLinkOut.textContent || "").trim();
    if (!txt || txt === "—") return;
    try{
      await navigator.clipboard.writeText(txt);
      setStatus("Länk kopierad", "ok");
      setTimeout(() => {
        const h = getHashFromUrl();
        if (h) loadCertificate(h);
        else setStatus("Saknar Verifierings-ID", "err");
      }, 900);
    } catch {
      setStatus("Kunde inte kopiera", "err");
    }
  });

  // Open box
  btnOpen?.addEventListener("click", () => {
    const h = (hashInput.value || "").trim();
    if (!h){
      openHint.textContent = "Klistra in Verifierings-ID för att öppna intyget.";
      return;
    }
    openHint.textContent = "";
    setHashInUrl(h);
    loadCertificate(h);
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  btnPaste?.addEventListener("click", async () => {
    try{
      const t = await navigator.clipboard.readText();
      if (t) hashInput.value = t.trim();
      openHint.textContent = t ? "ID insatt. Klicka “Öppna intyg”." : "Inget att klistra in.";
    } catch {
      openHint.textContent = "Kunde inte läsa urklipp. Klistra in manuellt.";
    }
  });

  // Start
  const initialHash = getHashFromUrl();
  if (initialHash) loadCertificate(initialHash);
  else {
    resetView();
    setCheckedNow();
    openBox.style.display = "block";
    setStatus("Saknar Verifierings-ID", "err");
    interpretation.textContent = "Ingen kontroll kunde göras eftersom Verifierings-ID saknas.";
  }
})();
</script>

<script src="/chat-widget.js?v=2025-01" defer></script>
</body>
</html>
