<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proofy – Verifieringsintyg</title>
  <meta name="description" content="Verifieringsintyg som sammanfattar resultatet av en kontroll av ett Verifierings-ID samt registreringstid." />
  <meta name="theme-color" content="#0b1220" />

  <!-- Gemensam design -->
  <link rel="stylesheet" href="/assets/proofy.css?v=2025-12-20" />

  <!-- Certifikat-specifik styling (liten och robust, även om proofy.css ändras) -->
  <style>
    /* Små förstärkningar för intygssidan (utan att bryta resten) */
    .certHeaderRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .certActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:12px;
    }
    .certActions .btn{ min-width: 180px; }
    @media (max-width: 560px){
      .certActions .btn{ width:100%; min-width: unset; }
    }

    .certTopNote{
      margin-top:12px;
      color: rgba(169,183,211,.92);
      font-size: 12.5px;
    }

    .kv{
      margin-top:12px;
      padding:14px;
      border-radius:16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(11,18,32,.25);
    }
    .kv .k{
      color: var(--muted);
      font-size: 12.8px;
      font-weight: 900;
      letter-spacing:.2px;
      margin-bottom:8px;
    }
    .kv .v{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      word-break: break-all;
      white-space: pre-wrap;
      margin:0;
    }

    .statusRow{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:10px;
      margin-top:10px;
    }
    .statusTag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      font-weight: 900;
    }
    .statusTag.ok{
      border-color: rgba(124,241,198,.35);
      background: rgba(124,241,198,.10);
      color: rgba(234,240,255,.98);
    }
    .statusTag.err{
      border-color: rgba(255,138,161,.35);
      background: rgba(255,138,161,.10);
      color: rgba(234,240,255,.98);
    }

    /* QR-rutan ska alltid se “fylld” ut i mörkt tema */
    .qrBox{
      width: 170px;
      height: 170px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(11,18,32,.25);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .qrBox canvas, .qrBox img{
      width: 150px !important;
      height: 150px !important;
      image-rendering: pixelated;
    }

    details.tech{
      margin-top:12px;
    }

    @media print{
      header, .certActions, .certTopNote, .noPrint{ display:none !important; }
      body{ background:#fff !important; color:#000 !important; }
      .card, .kv{
        box-shadow:none !important;
        background:#fff !important;
        border:1px solid #ddd !important;
      }
      .statusTag{ border:1px solid #ddd !important; background:#fff !important; color:#000 !important; }
      .mono, .kv .v{ color:#000 !important; }
      a{ color:#000 !important; text-decoration:none !important; }
    }
  </style>
</head>

<body>
<a class="skip" href="#main">Hoppa till innehåll</a>

<header>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="/" aria-label="Proofy">
        <span class="logo" aria-hidden="true"></span>
        <span>Proofy</span>
      </a>

      <div class="navLinks" aria-label="Navigation">
        <a href="/verify.html">Verifiera</a>
        <a href="/hash.html">Skapa ID</a>
        <a href="/#kontakt">Kontakt</a>
      </div>

      <div class="navActions">
        <a class="btn soft" href="/verify.html">Verifiera</a>
        <a class="btn primary" href="/#kontakt">Boka demo</a>
      </div>
    </div>
  </div>
</header>

<main id="main">
  <div class="wrap">
    <div class="badge">Intyg · dokumentintegritet · byrå & granskning</div>

    <h1 class="pageTitle">Verifieringsintyg</h1>

    <p class="lead">
      Detta intyg sammanfattar resultatet av en kontroll av ett <b>Verifierings-ID</b>.
      Det visar om ID:t är <b>registrerat</b> och <b>när</b> registreringen skedde.
      <b>Inget dokumentinnehåll lagras</b> i Proofy.
    </p>

    <div class="card content" style="margin-top:14px;">
      <div class="certHeaderRow">
        <div>
          <div class="meta">Öppnas via</div>
          <div class="mono">/certificate.html?hash=0x…</div>
        </div>

        <div class="statusRow">
          <span id="statusTag" class="statusTag">Laddar…</span>
          <span class="pill" id="smallHint">Kontroll av registrering</span>
        </div>
      </div>

      <div class="certActions">
        <button class="btn" type="button" id="btnPrint">Skriv ut / Spara som PDF</button>
        <button class="btn soft" type="button" id="btnRefresh">Uppdatera</button>
        <a class="btn primary" id="btnVerify" href="/verify.html">Öppna verifiering</a>
      </div>

      <div class="certTopNote">
        För bästa spårbarhet: spara Verifierings-ID i ärendet tillsammans med datum/tid och vilken filversion det avser.
      </div>

      <div class="hr"></div>

      <!-- Om hash saknas: gör sidan användbar direkt -->
      <div id="missingBox" class="kv" style="display:none;">
        <div class="k">Saknar Verifierings-ID</div>
        <p class="meta" style="margin:0 0 10px;">
          Klistra in ett Verifierings-ID så öppnar vi intyget för det ID:t.
        </p>
        <div class="formGrid">
          <div>
            <label class="meta" for="inputId">Verifierings-ID</label>
            <input id="inputId" type="text" placeholder="0x…" inputmode="text" autocomplete="off" />
          </div>
        </div>
        <div class="actions" style="margin-top:12px;">
          <button class="btn primary" type="button" id="btnOpen">Öppna intyg</button>
          <a class="btn" href="/verify.html">Gå till verifiering</a>
          <span class="pill" id="inputPill">Klistra in ID</span>
        </div>
      </div>

      <div class="grid2" id="mainGrid" style="margin-top:0;">
        <section aria-label="Sammanfattning">
          <div class="kv">
            <div class="k">Verifierings-ID</div>
            <pre id="outId" class="v">—</pre>
            <p class="small" style="margin:10px 0 0;">
              Verifierings-ID är en unik referens för en filversion. Minsta ändring ger ett nytt ID.
            </p>
          </div>

          <div class="kv">
            <div class="k">Kontrolltid (när denna kontroll gjordes)</div>
            <pre id="outChecked" class="v">—</pre>
          </div>

          <div class="kv">
            <div class="k">Kontrollresultat</div>
            <pre id="outResult" class="v">—</pre>
            <p class="small" id="outResultHelp" style="margin:10px 0 0;">—</p>
          </div>
        </section>

        <section aria-label="Registrering och delning">
          <div class="kv">
            <div class="k">Registreringstid (Sverige)</div>
            <pre id="outRegSe" class="v">—</pre>

            <div class="k" style="margin-top:12px;">Registreringstid (UTC)</div>
            <pre id="outRegUtc" class="v">—</pre>

            <p class="small" style="margin:10px 0 0;">
              Registreringstiden avser när Verifierings-ID registrerades i Proofys register.
            </p>
          </div>

          <div class="kv">
            <div class="k">Verifieringslänk</div>
            <pre id="outLink" class="v">—</pre>

            <div class="qrWrap" style="margin-top:12px;">
              <div>
                <div class="meta" style="margin-bottom:8px;">QR-kod</div>
                <div id="qrBox" class="qrBox" aria-label="QR-kod"></div>
                <div id="qrStatus" class="small" style="margin-top:8px;">—</div>
              </div>
              <div style="min-width:240px; flex:1">
                <p class="small" style="margin:0;">
                  Dela länken eller QR-koden om någon behöver kontrollera senare.
                </p>
                <div class="actions" style="margin-top:10px;">
                  <button class="btn" type="button" id="btnCopyLink" disabled>Kopiera länk</button>
                  <button class="btn soft" type="button" id="btnCopyId" disabled>Kopiera ID</button>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <div class="hr"></div>

      <section aria-label="Juridisk tolkning">
        <h2 style="margin:0 0 8px; font-size:18px;">Tolkning</h2>
        <p class="meta" id="interpretation" style="margin:0;">
          —
        </p>

        <div class="small" style="margin-top:12px;">
          <b>Viktigt:</b> Intyget beskriver endast om en <b>filversion</b> (via Verifierings-ID) var registrerad vid angiven tidpunkt.
          Det säger inget om dokumentets innehåll, riktighet, upphov, behörighet eller parternas avtal – och ersätter inte juridisk rådgivning.
        </div>
      </section>

      <details class="tech noPrint">
        <summary>Tekniska detaljer (valfritt)</summary>
        <p class="small" style="margin:10px 0 0;">
          Detaljerna nedan är för IT/teknisk granskning och påverkar inte tolkningen ovan.
        </p>
        <div class="kv" style="margin-top:12px;">
          <div class="k">Teknisk information</div>
          <pre id="techOut" class="v">—</pre>
        </div>
      </details>

      <div id="problemBox" class="kv" style="display:none; margin-top:12px;">
        <div class="k" style="color: rgba(255,138,161,.95);">Tillfälligt tekniskt problem</div>
        <pre id="problemText" class="v">—</pre>
        <p class="small" style="margin:10px 0 0;">
          Prova <b>Uppdatera</b>. Om problemet kvarstår: kontrollera att API:t är publicerat och att /api/verify svarar korrekt.
        </p>
      </div>
    </div>

    <p class="small" style="margin-top:14px;">
      Behöver ni ett upplägg för rutin/arbetsflöde i byrån? <a href="/#kontakt">Boka demo</a>.
    </p>
  </div>
</main>

<!-- QR-lib (root i deploy) -->
<script
  src="/qr.min.js?v=2025-12-20"
  onload="window.__proofyQrLibLoaded = true"
  onerror="window.__proofyQrLibError = true"
></script>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const statusTag = $("statusTag");
  const smallHint = $("smallHint");

  const outId = $("outId");
  const outChecked = $("outChecked");
  const outResult = $("outResult");
  const outResultHelp = $("outResultHelp");

  const outRegSe = $("outRegSe");
  const outRegUtc = $("outRegUtc");

  const outLink = $("outLink");
  const qrBox = $("qrBox");
  const qrStatus = $("qrStatus");

  const interpretation = $("interpretation");

  const btnPrint = $("btnPrint");
  const btnRefresh = $("btnRefresh");
  const btnVerify = $("btnVerify");

  const btnCopyLink = $("btnCopyLink");
  const btnCopyId = $("btnCopyId");

  const problemBox = $("problemBox");
  const problemText = $("problemText");

  const missingBox = $("missingBox");
  const inputId = $("inputId");
  const btnOpen = $("btnOpen");
  const inputPill = $("inputPill");

  let currentId = null;
  let currentLink = null;

  function setStatus(text, kind){
    statusTag.textContent = text;
    statusTag.classList.remove("ok", "err");
    if (kind === "ok") statusTag.classList.add("ok");
    if (kind === "err") statusTag.classList.add("err");
  }

  function showProblem(msg){
    problemBox.style.display = "block";
    problemText.textContent = String(msg || "Okänt fel");
  }

  function hideProblem(){
    problemBox.style.display = "none";
    problemText.textContent = "—";
  }

  function setQrStatus(msg){
    qrStatus.textContent = msg || "";
  }

  function isBytes32Hex(h){
    return typeof h === "string" && /^0x[0-9a-fA-F]{64}$/.test(h.trim());
  }

  function getHashFromQuery(){
    const url = new URL(location.href);
    const h = (url.searchParams.get("hash") || "").trim();
    return h || "";
  }

  function buildVerifyLink(hash){
    return `${location.origin}/verify.html?hash=${encodeURIComponent(hash)}`;
  }

  function fmtSe(tsSeconds){
    try{
      return new Intl.DateTimeFormat("sv-SE", {
        timeZone: "Europe/Stockholm",
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit"
      }).format(new Date(Number(tsSeconds) * 1000)) + " (Europe/Stockholm)";
    } catch {
      return "—";
    }
  }

  function fmtUtc(tsSeconds){
    try{
      return new Date(Number(tsSeconds) * 1000).toISOString().replace("T"," ").replace(".000Z"," UTC");
    } catch {
      return "—";
    }
  }

  function canRenderQr(){
    return typeof window.QRCode === "function";
  }

  function showQrError(extra){
    const parts = [];
    parts.push("QR kunde inte visas.");
    if (window.__proofyQrLibError) parts.push("Kontrollera att /qr.min.js finns i deploy.");
    if (extra) parts.push(extra);
    qrBox.innerHTML = `<div class="meta" style="padding:10px; text-align:center;">${parts.join(" ")}</div>`;
    setQrStatus(parts.join(" "));
  }

  function doRenderQr(text){
    qrBox.innerHTML = "";
    const correctLevel =
      window.QRCodeCorrectLevel && window.QRCodeCorrectLevel.M
        ? window.QRCodeCorrectLevel.M
        : undefined;

    new QRCode(qrBox, {
      text,
      width: 150,
      height: 150,
      colorDark: "#0b1220",
      colorLight: "#eaf0ff",
      correctLevel
    });
  }

  function renderQr(text){
    if (!qrBox) return;

    if (!canRenderQr()){
      if (window.__proofyQrLibError){
        showQrError();
        return;
      }

      qrBox.innerHTML = `<div class="meta" style="padding:10px; text-align:center;">Laddar QR…</div>`;
      setQrStatus("Laddar…");

      let tries = 0;
      const maxTries = 20; // ~1s
      const t = setInterval(() => {
        tries++;
        if (canRenderQr()){
          clearInterval(t);
          doRenderQr(text);
          setQrStatus("");
          return;
        }
        if (window.__proofyQrLibError || tries >= maxTries){
          clearInterval(t);
          showQrError(tries >= maxTries ? "Tog för lång tid att ladda biblioteket." : "");
        }
      }, 50);

      return;
    }

    doRenderQr(text);
    setQrStatus("");
  }

  async function apiVerify(hash){
    // Primärt: POST (som din verify.html)
    // Fallback: GET ifall du senare stödjer det.
    const payload = { hash };

    // POST
    try{
      const r = await fetch("/api/verify", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(payload)
      });
      const j = await r.json().catch(() => ({}));
      if (r.ok) return { ok: true, data: j };
      // om servern svarar med JSON fel
      return { ok: false, error: j?.error || `HTTP ${r.status}` };
    } catch (e){
      // Fallthrough to GET attempt (kan hjälpa om din edge-route är GET-only)
    }

    // GET fallback
    try{
      const r2 = await fetch(`/api/verify?hash=${encodeURIComponent(hash)}`, { method: "GET" });
      const j2 = await r2.json().catch(() => ({}));
      if (r2.ok) return { ok: true, data: j2 };
      return { ok: false, error: j2?.error || `HTTP ${r2.status}` };
    } catch (e2){
      return { ok: false, error: e2?.message || "Nätverksfel" };
    }
  }

  function resetUi(){
    hideProblem();

    outId.textContent = "—";
    outChecked.textContent = "—";
    outResult.textContent = "—";
    outResultHelp.textContent = "—";
    outRegSe.textContent = "—";
    outRegUtc.textContent = "—";
    outLink.textContent = "—";
    qrBox.innerHTML = `<div class="meta" style="padding:10px; text-align:center;">—</div>`;
    setQrStatus("—");

    interpretation.textContent = "—";

    btnCopyLink.disabled = true;
    btnCopyId.disabled = true;
  }

  function setMissingMode(on){
    missingBox.style.display = on ? "block" : "none";
    $("mainGrid").style.display = on ? "none" : "grid";
    // behåll resten synligt (tolkning osv) även utan ID
  }

  async function load(){
    resetUi();
    setStatus("Kontrollerar…");
    smallHint.textContent = "Kontroll av registrering";

    const hash = getHashFromQuery();

    // Kontrolltid
    try{
      outChecked.textContent = new Date().toLocaleString("sv-SE", { timeZone: "Europe/Stockholm" }) + " (Europe/Stockholm)";
    } catch {
      outChecked.textContent = new Date().toLocaleString("sv-SE");
    }

    if (!hash){
      setStatus("Saknar Verifierings-ID", "err");
      setMissingMode(true);
      interpretation.textContent =
        "Ingen kontroll kunde göras eftersom Verifierings-ID saknas. Klistra in ett Verifierings-ID för att öppna intyget.";
      return;
    }

    setMissingMode(false);

    outId.textContent = hash;
    currentId = hash;

    // Länk/QR till verifiering – även om formatet är fel, så användaren förstår vart man går
    currentLink = buildVerifyLink(hash);
    outLink.textContent = currentLink;
    btnVerify.href = currentLink;

    // QR och kopieringsknappar aktiveras om vi har något att dela
    renderQr(currentLink);
    btnCopyLink.disabled = false;
    btnCopyId.disabled = false;

    if (!isBytes32Hex(hash)){
      setStatus("Ogiltigt format", "err");
      outResult.textContent = "Kan inte kontrollera";
      outResultHelp.textContent = "Verifierings-ID har fel format. Kontrollera att du kopierat hela ID:t.";
      interpretation.textContent =
        "Intyget kan inte visa registreringsstatus eftersom Verifierings-ID:t inte har ett giltigt format.";
      return;
    }

    const res = await apiVerify(hash);

    if (!res.ok){
      setStatus("Kan inte kontrollera just nu", "err");
      outResult.textContent = "Ej genomförd kontroll";
      outResultHelp.textContent = "Kontrollen kunde inte genomföras på grund av ett tillfälligt tekniskt problem.";
      interpretation.textContent =
        "Intyget kunde inte bekräfta registreringsstatus vid denna kontroll. Prova igen senare.";
      showProblem(res.error || "Okänt fel");
      $("techOut").textContent =
        `Verifierings-ID: ${hash}\n` +
        `API: /api/verify\n` +
        `Fel: ${res.error || "Okänt fel"}`;
      return;
    }

    const data = res.data || {};

    // Förväntade fält: ok, exists, timestamp, submitter, txHash (varianter tolereras)
    const ok = (data.ok !== false);
    const exists = Boolean(data.exists);

    if (!ok){
      setStatus("Kan inte kontrollera just nu", "err");
      outResult.textContent = "Ej genomförd kontroll";
      outResultHelp.textContent = "Kontrollen gav ett fel-svar från tjänsten.";
      interpretation.textContent =
        "Intyget kunde inte bekräfta registreringsstatus vid denna kontroll. Prova igen senare.";
      showProblem(data.error || "Fel-svar från API");
    } else if (exists){
      setStatus("Registrerad", "ok");
      outResult.textContent = "Registrerad";
      outResultHelp.textContent = "Verifierings-ID:t finns registrerat i Proofys register.";

      if (data.timestamp){
        outRegSe.textContent = fmtSe(data.timestamp);
        outRegUtc.textContent = fmtUtc(data.timestamp);
      } else {
        outRegSe.textContent = "—";
        outRegUtc.textContent = "—";
      }

      interpretation.textContent =
        "Kontrollen visar att Verifierings-ID:t var registrerat i Proofys register vid angiven registreringstid. " +
        "Om en fil verifieras senare och ger samma Verifierings-ID innebär det att filversionen är oförändrad jämfört med den registrerade referensen.";
    } else {
      setStatus("Inte registrerad", "err");
      outResult.textContent = "Inte registrerad";
      outResultHelp.textContent = "Ingen registrering hittades för detta Verifierings-ID vid kontrolltillfället.";

      outRegSe.textContent = "—";
      outRegUtc.textContent = "—";

      interpretation.textContent =
        "Kontrollen visar att ingen registrering hittades för Verifierings-ID:t vid kontrolltillfället. " +
        "Det kan bero på att ID:t är fel, att registrering inte har gjorts, eller att du kontrollerar fel referens.";
    }

    // Tekniska detaljer – bakom “valfritt”
    const submitter = data.submitter || "—";
    const tx = data.txHash || data.tx || "—";
    $("techOut").textContent =
      `Verifierings-ID: ${hash}\n` +
      `API: /api/verify\n` +
      `Svar: ${JSON.stringify({ ok: data.ok, exists: data.exists, timestamp: data.timestamp, submitter, txHash: tx }, null, 2)}`;
  }

  // Missing flow (öppna intyg)
  function openCertificateForInput(){
    const v = (inputId.value || "").trim();
    if (!v){
      inputPill.textContent = "Klistra in ID";
      return;
    }
    if (!isBytes32Hex(v)){
      inputPill.textContent = "Ogiltigt format";
      return;
    }
    const u = new URL(location.href);
    u.searchParams.set("hash", v);
    location.href = u.toString();
  }

  // Copy
  async function copy(text, onOk){
    try{
      await navigator.clipboard.writeText(text);
      onOk?.();
    } catch {
      // no-op
    }
  }

  btnPrint.addEventListener("click", () => window.print());
  btnRefresh.addEventListener("click", () => load());

  btnCopyLink.addEventListener("click", () => {
    if (!currentLink) return;
    copy(currentLink, () => {
      smallHint.textContent = "Länk kopierad ✅";
      setTimeout(() => (smallHint.textContent = "Kontroll av registrering"), 1200);
    });
  });

  btnCopyId.addEventListener("click", () => {
    if (!currentId) return;
    copy(currentId, () => {
      smallHint.textContent = "ID kopierat ✅";
      setTimeout(() => (smallHint.textContent = "Kontroll av registrering"), 1200);
    });
  });

  btnOpen.addEventListener("click", openCertificateForInput);
  inputId.addEventListener("keydown", (e) => {
    if (e.key === "Enter") openCertificateForInput();
  });
  inputId.addEventListener("input", () => {
    const v = (inputId.value || "").trim();
    inputPill.textContent = !v ? "Klistra in ID" : (isBytes32Hex(v) ? "Redo ✅" : "Ogiltigt format");
  });

  load();
})();
</script>
</body>
</html>
