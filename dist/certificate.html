<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proofy – Verifieringsintyg</title>
  <meta name="description" content="Verifieringsintyg för ett Verifierings-ID (kontroll-ID). Visar status vid kontrolltillfället utan att dokumentinnehåll lagras." />
  <meta name="theme-color" content="#0b1220" />
  <meta name="robots" content="noindex" />

  <link rel="stylesheet" href="/assets/proofy.css?v=2026-01-03a" />
  <link rel="stylesheet" href="/assets/header.css?v=2026-01-03a" />

  <style>
    .sr-only{
      position:absolute !important;
      width:1px !important;
      height:1px !important;
      padding:0 !important;
      margin:-1px !important;
      overflow:hidden !important;
      clip:rect(0,0,0,0) !important;
      white-space:nowrap !important;
      border:0 !important;
    }
    .navActions .btn.isCurrent{
      pointer-events:none;
      opacity:1;
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.05);
    }

    .certHero{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }
    .certPill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      font-weight:800;
      white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;display:inline-block;
      background: rgba(255,255,255,.35);
    }
    .dot.ok{ background: rgba(80,255,180,.85); }
    .dot.warn{ background: rgba(251,191,36,.9); }
    .dot.err{ background: rgba(255,80,80,.85); }

    .btnRow{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:10px; }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (min-width: 980px){
      .grid3{ grid-template-columns: 1.2fr .8fr; }
    }

    .cardTitle{
      font-weight:950;
      font-size:13px;
      letter-spacing:.08em;
      opacity:.8;
      text-transform:uppercase;
      margin-bottom:10px;
    }
    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 720px){
      .kv{ grid-template-columns: 1fr; }
    }

    .monoBox{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
      word-break:break-all;
    }

    .copyWrap{ position:relative; }
    .copyBtn{
      position:absolute;
      top:8px;
      right:8px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      font-weight:800;
    }

    /* ========= QR (matchar verify/register) ========= */
    .proofyQrTap{
      width:184px;
      height:184px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:#ffffff;
      display:grid;
      place-items:center;
      overflow:hidden;
      cursor:pointer;
      padding:0 !important;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .proofyQrBox{
      width:168px;
      height:168px;
      display:grid;
      place-items:center;
    }
    .proofyQrBox canvas,
    .proofyQrBox img,
    .proofyQrBox svg{
      width:168px !important;
      height:168px !important;
      display:block;
      image-rendering: pixelated;
    }

    .pillNote{
      display:none;
      margin-top:10px;
    }
  </style>
</head>

<body>
<a class="skip" href="#main">Hoppa till innehåll</a>

<!-- SAME HEADER AS register.html -->
<header>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="/" aria-label="Proofy">
        <span class="logo" aria-hidden="true"></span>
        <span>Proofy</span>
      </a>

      <div class="navActions" id="navActionsDesktop">
        <a class="btn soft" href="/register.html">Skapa Verifierings-ID</a>
        <a class="btn soft" href="/verify.html">Verifiera underlag</a>
        <a class="btn soft" href="/pilot.html">Starta pilot</a>
        <a class="btn primary" href="/#kontakt">Boka kort demo</a>
      </div>

      <details class="mnav" id="mnav">
        <summary class="mnavSummary" aria-label="Öppna meny">
          <span class="mnavIcon" aria-hidden="true"></span>
        </summary>

        <nav class="mnavMenu" aria-label="Meny">
          <a class="mnavLink" href="/register.html">Skapa Verifierings-ID</a>
          <a class="mnavLink" href="/verify.html">Verifiera underlag</a>
          <a class="mnavLink" href="/pilot.html">Starta pilot</a>
          <a class="mnavLink mnavLinkPrimary" href="/#kontakt">Boka kort demo</a>

          <div class="mnavMeta">
            <a class="mnavLink" href="/security.html">Säkerhet</a>
            <a class="mnavLink" href="/privacy.html">Integritet</a>
            <a class="mnavLink" href="/terms.html">Villkor</a>
            <a class="mnavLink" href="/cookies.html">Cookies</a>

            <div class="mnavNote">Verifiering · revision · granskning</div>
            <a class="mnavMail" href="mailto:kontakt@proofy.se">kontakt@proofy.se</a>
          </div>
        </nav>
      </details>
    </div>
  </div>
</header>

<main id="main">
  <div class="wrap">
    <div class="badge">Intyg · spårbarhet · byrå &amp; granskning</div>

    <div class="certHero" style="margin-top:10px;">
      <div>
        <h1 class="pageTitle" style="margin-bottom:6px;">Verifieringsintyg</h1>
        <p class="lead" style="margin-top:0;">
          Detta intyg sammanfattar utfallet av en kontroll av ett <b>Verifierings-ID</b> (kontrollvärde) vid kontrolltillfället.
          Proofy lagrar inte dokumentinnehåll i registret.
        </p>

        <div class="btnRow">
          <button class="btn primary" id="printBtn" type="button">Skriv ut / Spara som PDF</button>
          <button class="btn" id="refreshBtn" type="button">Uppdatera</button>
          <a class="btn" id="openVerifyBtn" href="/verify.html">Öppna verifiering</a>
        </div>
      </div>

      <div class="certPill" id="statusPill">
        <span class="dot" id="statusDot"></span>
        <span id="statusLabel">Laddar…</span>
      </div>
    </div>

    <div class="card content" style="margin-top:14px;">
      <div class="grid3">

        <!-- LEFT -->
        <section aria-label="Nyckeluppgifter">
          <div class="cardTitle">Nyckeluppgifter</div>

          <div class="kv">
            <div class="card content" style="padding:14px;">
              <div class="meta">Verifierings-ID</div>
              <div class="copyWrap" style="margin-top:8px;">
                <div class="monoBox" id="hashOut">—</div>
                <button class="copyBtn" id="copyHashBtn" type="button">Kopiera</button>
              </div>
              <p class="small" style="margin:10px 0 0; opacity:.9;">
                ID:t avser en specifik filversion. Ny export/omskanning/omkomprimering kan ge nytt ID även om underlaget ser likadant ut.
              </p>
            </div>

            <div class="card content" style="padding:14px;">
              <div class="meta">Kontroll genomförd</div>
              <div class="monoBox" id="checkedOut" style="margin-top:8px;">—</div>
              <div class="small" style="margin-top:8px; opacity:.9;">
                Kontrolltiden avser när detta intyg uppdaterades (snapshot). Uppdatera vid behov.
              </div>
            </div>

            <div class="card content" style="padding:14px;">
              <div class="meta">Tidpunkt (om bekräftad)</div>
              <div class="monoBox" id="confirmedOut" style="margin-top:8px;">—</div>
            </div>

            <div class="card content" style="padding:14px;">
              <div class="meta">Status hos Proofy vid kontrolltillfället</div>
              <div class="monoBox" id="statusTextOut" style="margin-top:8px;">—</div>
              <div class="small" id="legalOut" style="margin-top:8px; opacity:.9;">—</div>
            </div>
          </div>

          <div class="hr" style="margin-top:14px;"></div>

          <div class="cardTitle" style="margin-top:14px;">Revisions-/juridisk tydlighet</div>
          <div class="small" style="opacity:.92; line-height:1.45;">
            • Intyget redovisar status för kontrollvärdet i Proofys register vid kontrolltillfället.<br/>
            • Tidpunkt anges endast när status är <b>bekräftad</b>.<br/>
            • Tidpunkten avser när kontrollvärdet först bekräftades i registret – inte när dokumentet skapades/signerades.<br/>
            • Intyget ersätter inte e-signering, arkivering, behörighetsloggar eller juridisk rådgivning.<br/>
            • Utfallet kan ändras om registret uppdateras senare – uppdatera intyget vid behov.
          </div>

          <details style="margin-top:14px;">
            <summary>Teknisk information (valfritt)</summary>
            <div class="hr"></div>

            <div class="meta">Kontrollpunkt (valfritt)</div>
            <div class="monoBox" id="blockOut" style="margin-top:8px;">—</div>

            <div class="meta" style="margin-top:10px;">Registreringsreferens (valfritt)</div>
            <div class="monoBox" id="txOut" style="margin-top:8px;">—</div>
          </details>
        </section>

        <!-- RIGHT -->
        <section aria-label="Länkar och QR">
          <div class="cardTitle">Länkar &amp; QR</div>

          <div class="card content" style="padding:14px;">
            <div class="meta" style="margin-bottom:8px;">QR-kod (snabb kontroll)</div>

            <div id="qrTap" class="proofyQrTap" role="button" tabindex="0"
                 aria-label="QR-kod (klicka för att kopiera verifieringslänk)"
                 title="Klicka för att kopiera verifieringslänk">
              <div id="qrBox" class="proofyQrBox" aria-label="QR-kod"></div>
            </div>

            <div class="small" style="margin-top:10px; opacity:.9;">
              Skanna med annan enhet för snabb kontroll. Klick på QR kopierar verifieringslänken.
            </div>

            <div class="meta" style="margin-top:14px;">Verifieringslänk</div>
            <div class="copyWrap" style="margin-top:8px;">
              <a class="monoBox" id="verifyLinkOut" href="#" target="_blank" rel="noopener" style="display:block; text-decoration:none;">—</a>
              <button class="copyBtn" id="copyVerifyBtn" type="button">Kopiera</button>
            </div>

            <div class="meta" style="margin-top:14px;">Länk till intyg</div>
            <div class="copyWrap" style="margin-top:8px;">
              <div class="monoBox" id="certLinkOut">—</div>
              <button class="copyBtn" id="copyCertBtn" type="button">Kopiera</button>
            </div>

            <span class="pill pillNote" id="copyPill"></span>
          </div>
        </section>

      </div>
    </div>
  </div>
</main>

<footer>
  <div class="wrap">
    <div class="foot">
      <div>
        <div style="color: rgba(234,240,255,.86); font-weight:800;">Proofy</div>
        <div class="small">© 2026 Proofy. Alla rättigheter förbehållna.</div>
        <div class="small" style="margin-top:8px; max-width:92ch;">
          Proofy tillhandahåller tidsnotering och kontroll av filversioner. Tjänsten utgör inte juridisk rådgivning och avgör inte filens rättsliga giltighet.
        </div>
      </div>
      <div class="links">
        <a href="/security.html">Säkerhet</a>
        <a href="/privacy.html">Integritet</a>
        <a href="/terms.html">Villkor</a>
        <a href="/cookies.html">Cookies</a>
        <a href="/#kontakt">Kontakt</a>
      </div>
    </div>
  </div>
</footer>

<script src="/assets/qr.min.js?v=2026-01-03a"></script>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const statusPill = $("statusPill");
  const statusDot = $("statusDot");
  const statusLabel = $("statusLabel");

  const hashOut = $("hashOut");
  const checkedOut = $("checkedOut");
  const confirmedOut = $("confirmedOut");
  const statusTextOut = $("statusTextOut");
  const legalOut = $("legalOut");
  const blockOut = $("blockOut");
  const txOut = $("txOut");

  const qrTap = $("qrTap");
  const qrBox = $("qrBox");

  const verifyLinkOut = $("verifyLinkOut");
  const certLinkOut = $("certLinkOut");

  const copyHashBtn = $("copyHashBtn");
  const copyVerifyBtn = $("copyVerifyBtn");
  const copyCertBtn = $("copyCertBtn");
  const copyPill = $("copyPill");

  const printBtn = $("printBtn");
  const refreshBtn = $("refreshBtn");
  const openVerifyBtn = $("openVerifyBtn");

  function isIdFormat(v){
    return typeof v === "string" && /^0x[0-9a-fA-F]{64}$/.test(v.trim());
  }

  function formatUnixSe(unixSeconds){
    const n = Number(unixSeconds);
    if (!Number.isFinite(n) || n <= 0) return null;
    try { return new Date(n * 1000).toLocaleString("sv-SE"); } catch { return null; }
  }

  function nowSe(){
    try{
      return new Intl.DateTimeFormat("sv-SE", {
        timeZone:"Europe/Stockholm",
        year:"numeric", month:"2-digit", day:"2-digit",
        hour:"2-digit", minute:"2-digit", second:"2-digit"
      }).format(new Date()) + " (Europe/Stockholm)";
    } catch {
      return new Date().toLocaleString("sv-SE");
    }
  }

  async function copyTextToClipboard(text){
    const t = String(text || "").trim();
    if (!t || t === "—") return false;
    try{
      await navigator.clipboard.writeText(t);
      return true;
    } catch {
      try{
        const ta = document.createElement("textarea");
        ta.value = t;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        ta.style.top = "0";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        const ok = document.execCommand("copy");
        document.body.removeChild(ta);
        return !!ok;
      } catch {
        return false;
      }
    }
  }

  function showPill(text){
    if (!copyPill) return;
    copyPill.style.display = "inline-flex";
    copyPill.textContent = text;
    setTimeout(() => {
      copyPill.style.display = "none";
      copyPill.textContent = "";
    }, 1200);
  }

  // QR helpers (samma som register/verify)
  function getCorrectLevelH(){
    if (window.QRCodeCorrectLevel && window.QRCodeCorrectLevel.H != null) return window.QRCodeCorrectLevel.H;
    if (window.QRCode && window.QRCode.CorrectLevel && window.QRCode.CorrectLevel.H != null) return window.QRCode.CorrectLevel.H;
    return undefined;
  }
  function waitForQRCode(timeoutMs = 2000){
    return new Promise((resolve) => {
      const start = Date.now();
      const tick = () => {
        if (typeof window.QRCode === "function") return resolve(true);
        if (Date.now() - start > timeoutMs) return resolve(false);
        requestAnimationFrame(tick);
      };
      tick();
    });
  }
  function waitForQrNode(targetEl, timeoutMs = 3000){
    return new Promise((resolve) => {
      const start = Date.now();
      const tick = () => {
        const node = targetEl.querySelector("canvas, img, svg, table");
        if (node) return resolve(node);
        if (Date.now() - start > timeoutMs) return resolve(null);
        requestAnimationFrame(tick);
      };
      tick();
    });
  }
  async function renderQr(targetEl, text){
    if (!targetEl) return;
    const payload = String(text || "").trim();
    targetEl.innerHTML = "";
    if (!payload || payload === "—") {
      targetEl.innerHTML = `<div class="meta" style="color:#0b1220;">Ingen länk att koda.</div>`;
      return;
    }
    const ok = await waitForQRCode(2000);
    if (!ok) {
      targetEl.innerHTML = `<div class="meta" style="color:#0b1220;">QR kunde inte laddas.</div>`;
      return;
    }
    const size = 168;
    try{
      const levelH = getCorrectLevelH();
      let qr = null;
      try{
        qr = new window.QRCode(targetEl);
        if (qr && qr._htOption){
          qr._htOption.width = size;
          qr._htOption.height = size;
          qr._htOption.colorDark = "#0b1220";
          qr._htOption.colorLight = "#ffffff";
          if (levelH != null) qr._htOption.correctLevel = levelH;
        }
        if (qr && typeof qr.makeCode === "function") qr.makeCode(payload);
      }catch{ qr = null; }

      if (!qr){
        new window.QRCode(targetEl, {
          text: payload,
          width: size,
          height: size,
          colorDark: "#0b1220",
          colorLight: "#ffffff",
          correctLevel: levelH
        });
      }
    } catch (e){
      console.error("QR render failed:", e);
      targetEl.innerHTML = `<div class="meta" style="color:#0b1220;">QR-koden kunde inte visas.</div>`;
      return;
    }
    const node = await waitForQrNode(targetEl, 3000);
    if (!node) {
      targetEl.innerHTML = `<div class="meta" style="color:#0b1220;">QR kunde inte visas. Testa uppdatera sidan.</div>`;
      return;
    }
    node.style.display = "block";
    node.style.width = size + "px";
    node.style.height = size + "px";
    node.style.imageRendering = "pixelated";
  }

  function setStatus(type, label){
    statusLabel.textContent = label;
    statusDot.className = "dot" + (type ? (" " + type) : "");
  }

  function buildVerifyLink(origin, hash, tx){
    const base = `${origin}/verify.html?hash=${encodeURIComponent(hash)}`;
    return tx ? `${base}&tx=${encodeURIComponent(tx)}` : base;
  }

  async function load(){
    const url = new URL(location.href);
    const hash = (url.searchParams.get("hash") || "").trim();
    const tx = (url.searchParams.get("tx") || "").trim();
    const checked = url.searchParams.get("checked");

    hashOut.textContent = hash || "—";
    checkedOut.textContent = checked
      ? (new Date(Number(checked) * 1000).toLocaleString("sv-SE") + " (från URL)")
      : nowSe();

    const verifyLink = (hash && isIdFormat(hash)) ? buildVerifyLink(location.origin, hash, tx || null) : "/verify.html";
    verifyLinkOut.textContent = verifyLink;
    verifyLinkOut.href = verifyLink;
    openVerifyBtn.href = verifyLink;

    const certLink = hash ? `${location.origin}/certificate.html?hash=${encodeURIComponent(hash)}${checked ? `&checked=${encodeURIComponent(checked)}` : ""}${tx ? `&tx=${encodeURIComponent(tx)}` : ""}` : location.href;
    certLinkOut.textContent = certLink;

    if (!hash || !isIdFormat(hash)){
      setStatus("err", "Ogiltigt ID");
      statusTextOut.textContent = "Kunde inte kontrolleras";
      legalOut.textContent = "Intyget saknar giltigt Verifierings-ID i URL. Exempel: /certificate.html?hash=0x…";
      confirmedOut.textContent = "—";
      blockOut.textContent = "—";
      txOut.textContent = tx || "—";
      qrTap.style.opacity = ".6";
      renderQr(qrBox, "/verify.html");
      return;
    }

    // Fetch verify snapshot
    setStatus("", "Kontrollerar…");
    statusTextOut.textContent = "Kontrollerar…";
    legalOut.textContent = "—";

    const endpoint = `/api/verify?hash=${encodeURIComponent(hash)}${tx ? `&tx=${encodeURIComponent(tx)}` : ""}`;
    try{
      const res = await fetch(endpoint, { method: "GET" });
      const data = await res.json().catch(() => ({}));

      // Mappning (matchar register.html-antikod)
      const sc = String(data?.statusCode || "");
      const st = String(data?.statusText || "");
      const legal = String(data?.legalText || "");
      const confirmedAt = data?.confirmedAtUnix ?? null;

      const txHash = data?.submission?.txHash || tx || null;
      const observedBlockNumber = data?.evidence?.observedBlockNumber || null;

      txOut.textContent = txHash || "—";
      blockOut.textContent = observedBlockNumber ? String(observedBlockNumber) : "—";
      legalOut.textContent = legal || "—";

      const confirmedSe = confirmedAt ? formatUnixSe(confirmedAt) : null;
      confirmedOut.textContent = confirmedSe || "—";

      if (sc === "CONFIRMED"){
        setStatus("ok", "Bekräftad");
        statusTextOut.textContent = st || "Bekräftad";
      } else if (sc === "SUBMITTED_UNCONFIRMED" || sc === "NOT_CONFIRMED"){
        setStatus("warn", sc === "SUBMITTED_UNCONFIRMED" ? "Inskickad – ej bekräftad" : "Ej bekräftad");
        statusTextOut.textContent = st || (sc === "SUBMITTED_UNCONFIRMED" ? "Inskickad – ej bekräftad" : "Ej bekräftad");
      } else {
        setStatus("err", "Kunde inte kontrolleras");
        statusTextOut.textContent = st || "Kunde inte kontrolleras";
      }

      // QR uppdateras alltid till verifieringslänken
      renderQr(qrBox, verifyLink);

      // Klick på QR kopierar verifieringslänk
      const doCopy = async () => {
        const ok = await copyTextToClipboard(verifyLink);
        showPill(ok ? "Länk kopierad ✅" : "Kunde inte kopiera");
      };
      qrTap.onclick = (e) => { e.preventDefault(); doCopy(); };
      qrTap.onkeydown = (e) => {
        if (e.key === "Enter" || e.key === " ") { e.preventDefault(); doCopy(); }
      };

    } catch (e){
      console.error(e);
      setStatus("err", "Kunde inte kontrolleras");
      statusTextOut.textContent = "Kunde inte kontrolleras";
      legalOut.textContent = "Tillfälligt problem vid kontroll. Försök igen senare.";
      confirmedOut.textContent = "—";
      blockOut.textContent = "—";
      txOut.textContent = tx || "—";
      renderQr(qrBox, verifyLink);
    }
  }

  // Buttons
  printBtn.addEventListener("click", () => window.print());
  refreshBtn.addEventListener("click", () => load());

  copyHashBtn.addEventListener("click", async () => {
    const ok = await copyTextToClipboard(hashOut.textContent);
    showPill(ok ? "ID kopierat ✅" : "Kunde inte kopiera");
  });

  copyVerifyBtn.addEventListener("click", async () => {
    const ok = await copyTextToClipboard(verifyLinkOut.textContent);
    showPill(ok ? "Länk kopierad ✅" : "Kunde inte kopiera");
  });

  copyCertBtn.addEventListener("click", async () => {
    const ok = await copyTextToClipboard(certLinkOut.textContent);
    showPill(ok ? "Intygslänk kopierad ✅" : "Kunde inte kopiera");
  });

  load();
})();
</script>

<script src="/assets/header-toggle.js?v=2026-01-03a" defer></script>
<script src="/chat-widget.js?v=2026-01-03a" defer></script>
</body>
</html>
