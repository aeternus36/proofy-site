<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proofy – Fastställ referens</title>
  <meta name="description" content="Fastställ en referensfil och skapa ett verifierings-ID. Filen lämnar aldrig din dator." />
  <meta name="theme-color" content="#0b1220" />
  <link rel="stylesheet" href="/assets/proofy.css?v=2025-12-20" />
</head>

<body>
<a class="skip" href="#main">Hoppa till innehåll</a>

<header>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="/" aria-label="Proofy">
        <span class="logo" aria-hidden="true"></span>
        <span>Proofy</span>
      </a>

      <div class="navActions">
        <a class="btn soft" href="/pilot.html">Starta pilot</a>
        <a class="btn primary" href="/#kontakt">Boka demo</a>
      </div>
    </div>
  </div>
</header>

<main id="main">
  <div class="wrap">
    <div class="badge">För redovisningsbyråer · revision · granskning</div>

    <h1 class="pageTitle">Fastställ referens</h1>

    <p class="lead">
      Välj den <b>filversion</b> som ska vara referens i ärendet.
      Ett verifierings-ID skapas lokalt i webbläsaren. Filen lämnar aldrig din dator.
    </p>

    <section class="card content" style="margin-top:14px; max-width:820px;">
      
      <!-- FILVAL -->
      <div style="font-weight:950; font-size:16px;">Referensfil</div>
      <p class="meta" style="margin-top:6px;">
        Klicka eller dra in filen som ska gälla som referens.
      </p>

      <label id="dropZone" class="drop" for="fileInput" style="margin-top:10px; cursor:pointer;">
        Dra & släpp fil här eller klicka för att välja
      </label>
      <input id="fileInput" type="file" hidden />

      <div id="fileInfo" class="meta" style="margin-top:10px;">Ingen fil vald.</div>

      <!-- ÅTGÄRD -->
      <div class="actions" style="margin-top:16px;">
        <button class="btn primary" id="createBtn" disabled>Fastställ referens</button>
        <span id="statusPill" class="pill">Välj en fil</span>
      </div>

      <!-- RESULTAT -->
      <div id="resultBox" style="display:none; margin-top:20px;">
        <div class="hr"></div>

        <div class="meta">Verifierings-ID</div>
        <pre class="codeblock" id="idOut"></pre>

        <div class="meta" style="margin-top:12px;">Verifieringslänk</div>
        <pre class="codeblock" id="linkOut"></pre>

        <div class="meta" style="margin-top:12px;">QR-kod (för extern kontroll)</div>
        <div id="qrBox" class="qrBox" style="margin-top:8px;"></div>

        <div class="small" style="margin-top:12px;">
          Spara verifierings-ID i ärendet. Länken eller QR-koden kan användas vid senare kontroll.
        </div>
      </div>

      <!-- FEL -->
      <div id="errorBox" style="display:none; margin-top:16px;">
        <div class="err">Tillfälligt tekniskt problem</div>
        <div id="errorMsg" class="mono" style="margin-top:6px;"></div>
      </div>

    </section>

    <p class="meta" style="margin-top:14px; max-width:820px;">
      Proofy lagrar inte dokument. Verifiering sker genom jämförelse av filversioner mot fastställd referens.
    </p>
  </div>
</main>

<script src="/qr.min.js?v=2025-12-20"></script>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const fileInput = $("fileInput");
  const dropZone = $("dropZone");
  const fileInfo = $("fileInfo");
  const createBtn = $("createBtn");
  const statusPill = $("statusPill");

  const resultBox = $("resultBox");
  const idOut = $("idOut");
  const linkOut = $("linkOut");
  const qrBox = $("qrBox");

  const errorBox = $("errorBox");
  const errorMsg = $("errorMsg");

  let file = null;
  let busy = false;

  function setStatus(t){ statusPill.textContent = t; }

  function reset(){
    resultBox.style.display = "none";
    errorBox.style.display = "none";
    idOut.textContent = "";
    linkOut.textContent = "";
    qrBox.innerHTML = "";
  }

  dropZone.addEventListener("dragover", e => { e.preventDefault(); dropZone.classList.add("drag"); });
  dropZone.addEventListener("dragleave", () => dropZone.classList.remove("drag"));
  dropZone.addEventListener("drop", e => {
    e.preventDefault(); dropZone.classList.remove("drag");
    if(e.dataTransfer.files[0]) setFile(e.dataTransfer.files[0]);
  });

  fileInput.addEventListener("change", () => {
    if(fileInput.files[0]) setFile(fileInput.files[0]);
  });

  function setFile(f){
    file = f;
    fileInfo.textContent = `Vald fil: ${f.name}`;
    createBtn.disabled = false;
    setStatus("Redo");
    reset();
  }

  async function sha256(file){
    const buf = await file.arrayBuffer();
    const hash = await crypto.subtle.digest("SHA-256", buf);
    return "0x" + [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  createBtn.addEventListener("click", async () => {
    if(!file || busy) return;
    busy = true;
    setStatus("Fastställer…");
    reset();

    try{
      const id = await sha256(file);
      const res = await fetch("/api/register", {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify({ hash:id })
      });

      if(!res.ok) throw new Error("Registrering misslyckades.");

      const link = `${location.origin}/verify.html?hash=${id}`;

      idOut.textContent = id;
      linkOut.textContent = link;
      resultBox.style.display = "block";

      if(window.QRCode){
        new QRCode(qrBox,{ text:link, width:150, height:150 });
      }

      setStatus("Klar");
    } catch(e){
      errorBox.style.display = "block";
      errorMsg.textContent = e.message;
      setStatus("Fel");
    } finally {
      busy = false;
    }
  });
})();
</script>

<script src="/chat-widget.js?v=2025-01" defer></script>
</body>
</html>
