<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proofy – Skapa Verifierings-ID</title>
  <meta name="description" content="Skapa ett Verifierings-ID för en filversion lokalt i webbläsaren. Filen lämnar aldrig din dator." />
  <meta name="theme-color" content="#0b1220" />

  <link rel="stylesheet" href="/assets/proofy.css?v=2026-01-01a" />
  <link rel="stylesheet" href="/assets/header.css?v=2026-01-01a" />
</head>

<body>
<a class="skip" href="#main">Hoppa till innehåll</a>

<header>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="/" aria-label="Proofy">
        <span class="logo" aria-hidden="true"></span>
        <span>Proofy</span>
      </a>

      <div class="navActions" id="navActionsDesktop">
        <a class="btn soft" href="/pilot.html">Starta pilot</a>
        <a class="btn" href="/verify.html">Verifiera underlag</a>
        <a class="btn" href="/register.html" aria-current="page">Skapa Verifierings-ID</a>
        <a class="btn primary" href="/#kontakt">Boka kort demo</a>
      </div>

      <details class="mnav" id="mnav">
        <summary class="mnavSummary" aria-label="Öppna meny">
          <span class="mnavIcon" aria-hidden="true"></span>
        </summary>

        <nav class="mnavMenu" aria-label="Meny">
          <a class="mnavLink" href="/verify.html">Verifiera underlag</a>
          <a class="mnavLink" href="/register.html" aria-current="page">Skapa Verifierings-ID</a>
          <a class="mnavLink" href="/pilot.html">Starta pilot</a>
          <a class="mnavLink mnavLinkPrimary" href="/#kontakt">Boka kort demo</a>

          <div class="mnavMeta">
            <div class="mnavNote">Verifiering · revision · granskning</div>
            <a class="mnavMail" href="mailto:kontakt@proofy.se">kontakt@proofy.se</a>
          </div>
        </nav>
      </details>
    </div>
  </div>
</header>

<main id="main">
  <div class="wrap">
    <div class="badge">För byråer · revision · granskning</div>

    <h1 class="pageTitle">Skapa Verifierings-ID</h1>

    <p class="lead">
      Skapa ett Verifierings-ID för den filversion som ska vara <b>referens</b> i ärendet.
      <strong>Underlaget lämnar aldrig din dator.</strong>
    </p>

    <div class="card content" style="margin-top:14px;">
      <div class="grid2">

        <!-- LEFT -->
        <section aria-label="Skapa via fil">
          <div style="font-weight:950; font-size:16px;">1. Välj referensunderlag</div>

          <label for="fileInput" class="btn primary" style="display:inline-flex; margin-top:10px; cursor:pointer;">
            Välj referensunderlag (fil)
          </label>
          <input id="fileInput" type="file" style="display:none;" />

          <div id="dropZone" class="drop" style="margin-top:10px">Dra &amp; släpp underlag här</div>

          <div id="fileInfo" class="meta" style="margin-top:10px; padding:10px 12px; border-radius:12px; border:1px dashed rgba(255,255,255,.25); background:rgba(255,255,255,.04);">
            Inget underlag valt.
          </div>

          <div class="hr"></div>

          <div style="font-weight:950; font-size:16px;">2. Skapa &amp; registrera referens</div>

          <div class="actions" style="margin-top:12px; flex-wrap:wrap; gap:10px;">
            <button class="btn soft" id="createBtn" disabled>Skapa &amp; registrera</button>
            <button class="btn" id="copyIdBtn" disabled>Kopiera ID</button>
            <button class="btn" id="copyLinkBtn" disabled>Kopiera länk</button>
            <a class="btn soft" id="receiptBtn" href="#" style="display:none;">Öppna intyg</a>
            <span id="statusPill" class="pill">Välj en fil</span>
          </div>

          <div id="localIdBox" style="display:none;margin-top:12px">
            <div class="meta">Verifierings-ID (för din notering i ärendet):</div>
            <div id="localIdOut"
                 class="mono"
                 style="margin-top:6px; padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.03); overflow-wrap:anywhere; word-break:break-word;">
              —
            </div>
          </div>

          <p class="small" style="margin-top:12px; margin-bottom:0;">
            <b>Obs:</b> Ny export/omskanning/konvertering kan ge annan filversion även om dokumentet “ser likadant ut”.
          </p>
        </section>

        <!-- RIGHT -->
        <section aria-label="Resultat">
          <div style="display:flex; align-items:baseline; justify-content:space-between; gap:12px;">
            <div style="font-weight:950; font-size:16px;">Registreringsrapport</div>
            <div class="meta" id="reportMeta" style="opacity:.85; display:none;">Rapport</div>
          </div>
          <div class="hr"></div>

          <div id="resultBox" style="display:none;">
            <div id="headline"
                 style="font-size:18px; font-weight:950; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.05);">
            </div>

            <div style="margin-top:12px;">
              <div class="meta">Verifierings-ID</div>
              <div id="idOut"
                   class="mono"
                   style="margin-top:6px; padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.03); overflow-wrap:anywhere; word-break:break-word;">
                —
              </div>

              <div class="meta" style="margin-top:12px;">Delbar verifieringslänk</div>
              <a id="linkOut"
                 class="mono"
                 href="#"
                 rel="noopener"
                 style="display:block; margin-top:6px; padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.03); overflow-wrap:anywhere; word-break:break-word; text-decoration:none;">
                —
              </a>

              <div class="hr" style="margin-top:14px;"></div>

              <div class="meta">Registreringsstatus</div>
              <div id="regStatusOut" class="mono" style="margin-top:6px;">—</div>

              <div class="meta" style="margin-top:10px;">Registreringstid</div>
              <div id="timeOut" class="mono" style="margin-top:6px;">—</div>

              <div class="meta" style="margin-top:10px;">QR-kod</div>
              <div id="qrBox" class="qrBox" aria-label="QR-kod" style="margin-top:8px;"></div>

              <div class="small" style="margin-top:10px">
                Tips: Spara ID i ärendet. Dela länken om någon behöver kontrollera senare.
              </div>

              <details style="margin-top:12px;">
                <summary>Tekniska detaljer (valfritt)</summary>
                <p style="margin: 10px 0 0;" class="meta">
                  Dessa uppgifter kan vara användbara vid teknisk felsökning.
                </p>
                <div class="hr"></div>

                <div class="meta">Teknisk referens (txHash)</div>
                <div id="txOut" class="mono" style="margin-top:6px; overflow-wrap:anywhere; word-break:break-word;">—</div>

                <div class="meta" style="margin-top:10px;">Teknisk identitet</div>
                <div id="submitterOut" class="mono" style="margin-top:6px; overflow-wrap:anywhere; word-break:break-word;">—</div>
              </details>
            </div>
          </div>

          <div id="errorBox" style="display:none;">
            <div class="err">Tillfälligt tekniskt problem</div>
            <div id="errorMsg" class="mono" style="margin-top:8px"></div>
          </div>
        </section>

      </div>
    </div>

    <section style="margin-top:14px;">
      <div class="card content">
        <h2 style="margin:0 0 8px; font-size:18px;">Har du redan ett Verifierings-ID?</h2>
        <p class="meta" style="margin:0 0 10px;">
          Klistra in ett Verifierings-ID så skapar vi delbar länk och QR direkt.
        </p>

        <div class="grid2">
          <div>
            <label class="meta" for="manualId">Verifierings-ID</label>
            <input id="manualId" type="text" placeholder="Klistra in Verifierings-ID…" style="margin-top:8px" />
            <div class="actions" style="margin-top:12px; flex-wrap:wrap; gap:10px;">
              <button class="btn" id="manualBuildBtn" type="button">Skapa länk &amp; QR</button>
              <button class="btn" id="manualCopyLinkBtn" type="button" disabled>Kopiera länk</button>
              <a class="btn soft" id="manualVerifyBtn" href="/verify.html" style="pointer-events:none;opacity:.55;">Öppna verifiering</a>
              <span id="manualPill" class="pill">Klistra in ID</span>
            </div>
          </div>

          <div>
            <div class="meta">Delbar verifieringslänk</div>
            <a id="manualLinkOut"
               class="mono"
               href="#"
               style="display:block; margin-top:8px; padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.03); overflow-wrap:anywhere; word-break:break-word; text-decoration:none;">
              —
            </a>

            <div class="meta" style="margin-top:12px;">QR-kod</div>
            <div id="manualQrBox" class="qrBox" aria-label="QR-kod (manuell)" style="margin-top:8px;"></div>
          </div>
        </div>
      </div>
    </section>

    <p class="meta" style="margin-top:14px">
      Proofy lagrar inte dokument. Verifiering bygger på att jämföra filversioner mot en registrerad referens.
    </p>
  </div>
</main>

<footer>
  <div class="wrap">
    <div class="foot">
      <div>
        <div style="color: rgba(234,240,255,.86); font-weight:800;">Proofy</div>
        <div class="small">© 2025 Proofy. Alla rättigheter förbehållna.</div>
        <div class="small" style="margin-top:8px; max-width:92ch;">
          Proofy tillhandahåller teknisk tidsstämpling och verifiering av filer. Tjänsten utgör inte juridisk rådgivning och avgör inte filens rättsliga giltighet.
        </div>
      </div>
      <div class="links">
        <a href="/security.html">Säkerhet</a>
        <a href="/privacy.html">Integritet</a>
        <a href="/terms.html">Villkor</a>
        <a href="/#kontakt">Kontakt</a>
      </div>
    </div>
  </div>
</footer>

<!-- QR-lib -->
<script src="/assets/qr.min.js?v=2026-01-01"></script>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const fileInput = $("fileInput");
  const dropZone = $("dropZone");
  const fileInfo = $("fileInfo");

  const createBtn = $("createBtn");
  const copyIdBtn = $("copyIdBtn");
  const copyLinkBtn = $("copyLinkBtn");
  const receiptBtn = $("receiptBtn");
  const statusPill = $("statusPill");

  const localIdBox = $("localIdBox");
  const localIdOut = $("localIdOut");

  const reportMeta = $("reportMeta");
  const resultBox = $("resultBox");
  const headline = $("headline");
  const idOut = $("idOut");
  const linkOut = $("linkOut");
  const qrBox = $("qrBox");
  const regStatusOut = $("regStatusOut");
  const timeOut = $("timeOut");
  const submitterOut = $("submitterOut");
  const txOut = $("txOut");

  const errorBox = $("errorBox");
  const errorMsg = $("errorMsg");

  // Manual
  const manualId = $("manualId");
  const manualBuildBtn = $("manualBuildBtn");
  const manualCopyLinkBtn = $("manualCopyLinkBtn");
  const manualVerifyBtn = $("manualVerifyBtn");
  const manualPill = $("manualPill");
  const manualLinkOut = $("manualLinkOut");
  const manualQrBox = $("manualQrBox");

  let currentFile = null;
  let currentId = null;
  let currentLink = null;

  let busy = false;
  let opId = 0;

  function setBusy(v){
    busy = v;
    createBtn.disabled = !currentFile || busy;
    copyIdBtn.disabled = !currentId || busy;
    copyLinkBtn.disabled = !currentLink || busy;
    createBtn.classList.remove("primary","soft");
    createBtn.classList.add(createBtn.disabled ? "soft" : "primary");
  }

  function setPill(text){ statusPill.textContent = text; }
  function setManualPill(text){ manualPill.textContent = text; }

  function bytesToHex(bytes){
    return [...bytes].map(b => b.toString(16).padStart(2,"0")).join("");
  }

  async function makeLocalId(file){
    const buf = await file.arrayBuffer();
    const dig = await crypto.subtle.digest("SHA-256", buf);
    return "0x" + bytesToHex(new Uint8Array(dig));
  }

  function isIdFormat(v){
    return typeof v === "string" && /^0x[0-9a-fA-F]{64}$/.test(v);
  }

  function buildVerifyLink(hash){
    return `${location.origin}/verify.html?hash=${encodeURIComponent(hash)}`;
  }

  function showQrError(targetEl){
    targetEl.innerHTML = `<div class="meta">QR-koden kunde inte renderas.</div>`;
  }

  function renderQr(targetEl, text){
    try{
      if (!targetEl) return;
      targetEl.innerHTML = "";

      if (typeof window.QRCode !== "function"){
        showQrError(targetEl);
        return;
      }

      const qr = new window.QRCode(targetEl);
      if (!qr || typeof qr.makeCode !== "function"){
        showQrError(targetEl);
        return;
      }

      if (qr._htOption){
        qr._htOption.width = 170;
        qr._htOption.height = 170;
        qr._htOption.colorDark = "#0b1220";
        qr._htOption.colorLight = "#eaf0ff";
        qr._htOption.typeNumber = 0; // auto-fit
        if (window.QRCodeCorrectLevel && window.QRCodeCorrectLevel.M !== undefined) {
          qr._htOption.correctLevel = window.QRCodeCorrectLevel.M;
        }
      }

      qr.makeCode(text);
      if (!targetEl.querySelector("canvas")) showQrError(targetEl);
    } catch (e){
      console.error("QR render error:", e);
      showQrError(targetEl);
    }
  }

  async function fetchVerify(hash){
    // Stöd både GET /api/verify?hash= och POST /api/verify
    try{
      const r = await fetch(`/api/verify?hash=${encodeURIComponent(hash)}`, { method:"GET" });
      const j = await r.json().catch(() => ({}));
      if (r.ok && typeof j?.exists === "boolean") return { ok:true, data:j };
    } catch {}

    const r2 = await fetch(`/api/verify`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ hash })
    });
    const j2 = await r2.json().catch(() => ({}));
    if (!r2.ok) return { ok:false, error: j2?.error || `HTTP ${r2.status}` };
    return { ok:true, data:j2 };
  }

  function resetRight(){
    errorBox.style.display = "none";
    errorMsg.textContent = "";

    resultBox.style.display = "none";
    if (reportMeta) reportMeta.style.display = "none";

    headline.textContent = "";
    idOut.textContent = "—";
    linkOut.textContent = "—";
    linkOut.href = "#";
    regStatusOut.textContent = "—";
    timeOut.textContent = "—";
    submitterOut.textContent = "—";
    txOut.textContent = "—";
    qrBox.innerHTML = "";
    receiptBtn.style.display = "none";
  }

  function setFile(file){
    currentFile = file || null;
    currentId = null;
    currentLink = null;

    resetRight();

    localIdBox.style.display = "none";
    localIdOut.textContent = "—";
    if (fileInput) fileInput.value = "";

    if(!currentFile){
      fileInfo.textContent = "Inget underlag valt.";
      setPill("Välj en fil");
      setBusy(false);
      return;
    }

    fileInfo.textContent = `Valt underlag: ${currentFile.name} (${(currentFile.size/1024/1024).toFixed(2)} MB)`;
    setPill("Redo att skapa");
    setBusy(false);
  }

  // Input events
  fileInput.addEventListener("change", () => setFile(fileInput.files?.[0] || null));

  dropZone.addEventListener("dragover", (e) => { e.preventDefault(); dropZone.classList.add("drag"); });
  dropZone.addEventListener("dragleave", () => dropZone.classList.remove("drag"));
  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("drag");
    const f = e.dataTransfer?.files?.[0];
    if(f) setFile(f);
  });

  // Poll helper: vänta tills verify säger exists=true
  async function pollUntilRegistered(hash, maxMs = 90_000, intervalMs = 2500){
    const started = Date.now();
    while (Date.now() - started < maxMs){
      const v = await fetchVerify(hash);
      if (v.ok && v.data && v.data.exists === true && v.data.timestamp){
        return v.data;
      }
      await new Promise(r => setTimeout(r, intervalMs));
    }
    return null;
  }

  createBtn.addEventListener("click", async () => {
    if(!currentFile || busy) return;

    const myOp = ++opId;
    setBusy(true);
    resetRight();

    setPill("Skapar ID lokalt…");

    try{
      const id = await makeLocalId(currentFile);
      if(myOp !== opId) return;
      if(!isIdFormat(id)) throw new Error("Det gick inte att skapa ett giltigt Verifierings-ID.");

      currentId = id;
      currentLink = buildVerifyLink(id);

      localIdBox.style.display = "block";
      localIdOut.textContent = id;

      resultBox.style.display = "block";
      if (reportMeta) reportMeta.style.display = "block";

      headline.innerHTML = `<span class="meta">⏳ Förbereder registrering…</span>`;

      idOut.textContent = id;
      linkOut.textContent = currentLink;
      linkOut.href = currentLink;

      receiptBtn.href = `/certificate.html?hash=${encodeURIComponent(id)}`;
      receiptBtn.style.display = "inline-flex";

      renderQr(qrBox, currentLink);

      regStatusOut.textContent = "Registrerar…";
      timeOut.textContent = "—";
      submitterOut.textContent = "—";
      txOut.textContent = "—";

      setPill("Registrerar…");

      // POST register med klient-timeout så mobilen aldrig hänger
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), 25_000);

      let res, data;
      try{
        res = await fetch("/api/register", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ hash: id }),
          signal: controller.signal
        });
        data = await res.json().catch(() => ({}));
      } finally {
        clearTimeout(t);
      }

      if(myOp !== opId) return;

      if(!res.ok && res.status !== 202){
        throw new Error(data?.error || `Registreringen misslyckades (HTTP ${res.status}).`);
      }

      // 200: redan klar / 202: pending
      if (res.status === 200 && data && data.ok){
        if (data.alreadyExists) {
          headline.innerHTML = `<span class="ok">✅ Redan registrerad</span> <span class="meta">(du kan använda samma ID)</span>`;
        } else {
          headline.innerHTML = `<span class="ok">✅ Registrerad</span> <span class="meta">(ny referens skapad)</span>`;
        }
        regStatusOut.textContent = "Registrerad";
        if (data.timestamp) timeOut.textContent = new Date(Number(data.timestamp) * 1000).toLocaleString("sv-SE");
        submitterOut.textContent = data.submitter || "—";
        txOut.textContent = data.txHash || "—";
        setPill("Klart ✅");
        setBusy(false);
        return;
      }

      // Pending (202) eller 200 utan timestamp => poll verify
      headline.innerHTML = `<span class="meta">⏳ Registrering pågår… (kontrollerar status)</span>`;
      regStatusOut.textContent = "Registrering pågår…";
      txOut.textContent = data?.txHash || "—";

      // Poll verify
      const done = await pollUntilRegistered(id, 90_000, 2500);
      if(myOp !== opId) return;

      if (done && done.exists && done.timestamp){
        headline.innerHTML = `<span class="ok">✅ Registrerad</span> <span class="meta">(bekräftad)</span>`;
        regStatusOut.textContent = "Registrerad";
        timeOut.textContent = new Date(Number(done.timestamp) * 1000).toLocaleString("sv-SE");
        setPill("Klart ✅");
        setBusy(false);
        return;
      }

      // Timeout i polling (kedjan seg) – men UI blir inte “fast”.
      headline.innerHTML = `<span class="meta">⏳ Registrering pågår</span> <span class="meta">(kan ta någon minut)</span>`;
      regStatusOut.textContent = "Pågår – kontrollera senare via verifieringslänken.";
      timeOut.textContent = "—";
      setPill("Pågår…");
      setBusy(false);
    } catch (e){
      console.error(e);
      if(myOp !== opId) return;

      errorBox.style.display = "block";
      errorMsg.textContent =
        (e && e.name === "AbortError")
          ? "Registreringen tog för lång tid att svara. Prova igen – eller verifiera senare via länken."
          : (e?.message || "Registreringstjänsten kunde inte nås just nu.");

      setPill("Fel");
      setBusy(false);
    }
  });

  copyIdBtn.addEventListener("click", async () => {
    if(!currentId) return;
    try{
      await navigator.clipboard.writeText(currentId);
      setPill("ID kopierat ✅");
    } catch {
      setPill("Kunde inte kopiera");
    }
  });

  copyLinkBtn.addEventListener("click", async () => {
    if(!currentLink) return;
    try{
      await navigator.clipboard.writeText(currentLink);
      setPill("Länk kopierad ✅");
    } catch {
      setPill("Kunde inte kopiera");
    }
  });

  // Manual section
  function setManualState(id){
    const clean = (id || "").trim();
    if (!isIdFormat(clean)){
      manualLinkOut.textContent = "—";
      manualLinkOut.href = "#";
      manualQrBox.innerHTML = "";
      manualCopyLinkBtn.disabled = true;
      manualVerifyBtn.href = "/verify.html";
      manualVerifyBtn.style.pointerEvents = "none";
      manualVerifyBtn.style.opacity = ".55";
      setManualPill(clean ? "Ogiltigt ID" : "Klistra in ID");
      return null;
    }

    const link = buildVerifyLink(clean);
    manualLinkOut.textContent = link;
    manualLinkOut.href = link;
    renderQr(manualQrBox, link);

    manualCopyLinkBtn.disabled = false;
    manualVerifyBtn.href = link;
    manualVerifyBtn.style.pointerEvents = "auto";
    manualVerifyBtn.style.opacity = "1";
    setManualPill("Redo ✅");
    return link;
  }

  manualBuildBtn.addEventListener("click", () => setManualState(manualId.value));
  manualId.addEventListener("input", () => setManualState(manualId.value));

  manualCopyLinkBtn.addEventListener("click", async () => {
    const link = setManualState(manualId.value);
    if (!link) return;
    try{
      await navigator.clipboard.writeText(link);
      setManualPill("Länk kopierad ✅");
    } catch {
      setManualPill("Kunde inte kopiera");
    }
  });

  // Init
  resetRight();
  setBusy(false);
  setManualState("");
})();
</script>

<script src="/assets/header-toggle.js?v=2026-01-01a" defer></script>
<script src="/chat-widget.js?v=2026-01-01a" defer></script>
</body>
</html>
