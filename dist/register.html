<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proofy – Skapa Verifierings-ID</title>
  <meta name="description" content="Skapa ett Verifierings-ID för en filversion lokalt i webbläsaren. Filen lämnar aldrig din dator." />
  <meta name="theme-color" content="#0b1220" />

  <link rel="stylesheet" href="/assets/proofy.css?v=2025-12-24a" />
  <link rel="stylesheet" href="/assets/header.css?v=2025-12-24a" />
</head>

<body>
<a class="skip" href="#main">Hoppa till innehåll</a>

<header>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="/" aria-label="Proofy">
        <span class="logo" aria-hidden="true"></span>
        <span>Proofy</span>
      </a>

      <div class="navActions">
        <a class="btn soft" href="/pilot.html">Starta pilot</a>
        <a class="btn" href="/verify.html">Verifiera underlag</a>
        <a class="btn" href="/register.html">Skapa Verifierings-ID</a>
        <a class="btn primary" href="/#kontakt">Boka kort demo</a>
      </div>
    </div>
  </div>
</header>

<main id="main">
  <div class="wrap">
    <div class="badge">För redovisningsbyråer · revision · granskning</div>

    <h1 class="pageTitle">Skapa Verifierings-ID</h1>

    <p class="lead">
      Skapa ett Verifierings-ID för den filversion som ska vara <b>referens</b> i ärendet.
      Underlaget lämnar aldrig din dator. Proofy lagrar inte dokument.
    </p>

    <div class="card content" style="margin-top:14px;">
      <div class="grid2">

        <!-- VÄNSTER -->
        <section>
          <div style="font-weight:900">Välj referensunderlag</div>
          <p class="meta" style="margin-top:8px">
            Denna filversion blir referens i ärendet.
          </p>

          <input id="fileInput" type="file" />
          <div id="fileInfo" class="meta" style="margin-top:10px">Inget underlag valt.</div>

          <div class="actions" style="margin-top:12px">
            <button class="btn primary" id="createBtn" disabled>Skapa &amp; registrera</button>
            <span id="statusPill" class="pill">Välj underlag</span>
          </div>
        </section>

        <!-- HÖGER -->
        <section>
          <div style="font-weight:900">Resultat</div>
          <div class="hr"></div>

          <div class="meta">Verifierings-ID</div>
          <pre id="idOut" class="mono">—</pre>

          <div class="meta" style="margin-top:10px">Delbar verifieringslänk</div>
          <pre id="linkOut" class="mono">—</pre>

          <div class="meta" style="margin-top:10px">QR-kod</div>
          <div id="qrBox" class="qrBox" style="margin-top:8px"></div>

          <div class="meta" style="margin-top:10px">Registreringsstatus</div>
          <div id="regStatusOut" class="mono">—</div>

          <div class="meta" style="margin-top:10px">Registreringstid</div>
          <div id="timeOut" class="mono">—</div>
        </section>

      </div>
    </div>
  </div>
</main>

<footer>
  <div class="wrap">
    <div class="foot">
      <div>
        <div style="font-weight:800">Proofy</div>
        <div class="small">© 2025 Proofy. Alla rättigheter förbehållna.</div>
      </div>
    </div>
  </div>
</footer>

<!-- QR-bibliotek (DIN build) -->
<script src="/qr.min.js" defer></script>

<script>
(() => {
  const fileInput = document.getElementById("fileInput");
  const fileInfo = document.getElementById("fileInfo");
  const createBtn = document.getElementById("createBtn");
  const statusPill = document.getElementById("statusPill");

  const idOut = document.getElementById("idOut");
  const linkOut = document.getElementById("linkOut");
  const qrBox = document.getElementById("qrBox");
  const regStatusOut = document.getElementById("regStatusOut");
  const timeOut = document.getElementById("timeOut");

  let currentFile = null;

  fileInput.addEventListener("change", () => {
    currentFile = fileInput.files[0] || null;
    if (!currentFile) {
      fileInfo.textContent = "Inget underlag valt.";
      createBtn.disabled = true;
      statusPill.textContent = "Välj underlag";
      return;
    }
    fileInfo.textContent = `Valt: ${currentFile.name}`;
    createBtn.disabled = false;
    statusPill.textContent = "Redo";
  });

  function bytesToHex(bytes){
    return [...bytes].map(b => b.toString(16).padStart(2,"0")).join("");
  }

  async function sha256(file){
    const buf = await file.arrayBuffer();
    const hash = await crypto.subtle.digest("SHA-256", buf);
    return "0x" + bytesToHex(new Uint8Array(hash));
  }

  function renderQr(el, text){
    el.innerHTML = "";
    if (typeof window.QRCode !== "function") {
      el.textContent = "QR-biblioteket kunde inte laddas.";
      return;
    }
    const qr = new window.QRCode(el);
    qr.makeCode(text);
    const canvas = el.querySelector("canvas");
    if (canvas) {
      canvas.style.width = "150px";
      canvas.style.height = "150px";
      canvas.style.borderRadius = "8px";
      canvas.style.background = "#eaf0ff";
    }
  }

  createBtn.addEventListener("click", async () => {
    if (!currentFile) return;

    statusPill.textContent = "Skapar…";
    const id = await sha256(currentFile);
    const link = `${location.origin}/verify.html?hash=${id}`;

    idOut.textContent = id;
    linkOut.textContent = link;
    renderQr(qrBox, link);

    regStatusOut.textContent = "Registrerar…";

    const r = await fetch("/api/register", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ hash: id })
    });
    const j = await r.json();

    regStatusOut.textContent = "Registrerad";
    timeOut.textContent = j.timestamp
      ? new Date(j.timestamp * 1000).toLocaleString("sv-SE")
      : "—";

    statusPill.textContent = "Klar";
  });
})();
</script>

</body>
</html>
