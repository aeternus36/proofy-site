<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proofy – Skapa Verifierings-ID</title>
  <meta name="description" content="Skapa ett Verifierings-ID lokalt. Filen lämnar aldrig din dator." />
  <meta name="theme-color" content="#0b1220" />

  <link rel="stylesheet" href="/assets/proofy.css" />
  <link rel="stylesheet" href="/assets/header.css" />
</head>

<body>
<a class="skip" href="#main">Hoppa till innehåll</a>

<header>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="/">
        <span class="logo"></span>
        <span>Proofy</span>
      </a>

      <div class="navActions" id="navActionsDesktop">
        <a class="btn" href="/verify.html">Verifiera</a>
        <a class="btn primary" href="/register.html">Skapa ID</a>
      </div>

      <details class="mnav" id="mnav">
        <summary class="mnavSummary">
          <span class="mnavIcon"></span>
        </summary>
        <nav class="mnavMenu">
          <a class="mnavLink" href="/verify.html">Verifiera</a>
          <a class="mnavLink mnavLinkPrimary" href="/register.html">Skapa ID</a>
        </nav>
      </details>
    </div>
  </div>
</header>

<main id="main">
  <div class="wrap">
    <h1 class="pageTitle">Skapa Verifierings-ID</h1>

    <p class="lead">
      Filen hashas lokalt i webbläsaren.
      <strong>Inget laddas upp.</strong>
    </p>

    <div class="card content" style="margin-top:14px;">
      <section>
        <input id="fileInput" type="file" />
        <div id="fileInfo" class="meta" style="margin-top:8px;">Ingen fil vald.</div>

        <div class="actions" style="margin-top:12px;">
          <button class="btn primary" id="createBtn" disabled>Skapa ID</button>
          <span id="statusPill" class="pill">Välj fil</span>
        </div>

        <div id="resultBox" style="display:none; margin-top:14px;">
          <div class="meta">Verifierings-ID</div>
          <div id="idOut" class="mono" style="margin-top:6px;"></div>

          <div class="meta" style="margin-top:10px;">Verifieringslänk</div>
          <a id="linkOut"
             class="mono"
             style="display:block; margin-top:6px; word-break:break-all;"
             target="_blank"
             rel="noopener"></a>

          <div style="margin-top:12px;">
            <div class="meta">QR-kod (tryckbar)</div>
            <a id="qrLink" target="_blank" rel="noopener">
              <div id="qrBox" style="margin-top:8px;"></div>
            </a>
          </div>
        </div>

        <div id="errorBox" style="display:none; margin-top:14px;">
          <div class="err">Fel</div>
          <div id="errorMsg" class="mono" style="margin-top:6px;"></div>
        </div>
      </section>
    </div>
  </div>
</main>

<footer>
  <div class="wrap">
    <div class="foot">
      <div class="small">© Proofy</div>
    </div>
  </div>
</footer>

<!-- QR-lib -->
<script src="/assets/qr.min.js"></script>

<script>
(async () => {
  const $ = (id) => document.getElementById(id);

  const fileInput = $("fileInput");
  const fileInfo = $("fileInfo");
  const createBtn = $("createBtn");
  const statusPill = $("statusPill");

  const resultBox = $("resultBox");
  const idOut = $("idOut");
  const linkOut = $("linkOut");
  const qrBox = $("qrBox");
  const qrLink = $("qrLink");

  const errorBox = $("errorBox");
  const errorMsg = $("errorMsg");

  let file = null;

  function setStatus(t){ statusPill.textContent = t; }

  function bytesToHex(bytes){
    return [...bytes].map(b => b.toString(16).padStart(2,"0")).join("");
  }

  async function sha256(file){
    const buf = await file.arrayBuffer();
    const dig = await crypto.subtle.digest("SHA-256", buf);
    return "0x" + bytesToHex(new Uint8Array(dig));
  }

  function renderQR(link){
    qrBox.innerHTML = "";
    new QRCode(qrBox, {
      text: link,
      width: 150,
      height: 150,
      correctLevel: QRCode.CorrectLevel.M
    });
  }

  fileInput.addEventListener("change", () => {
    file = fileInput.files[0] || null;
    fileInfo.textContent = file
      ? `${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`
      : "Ingen fil vald.";
    createBtn.disabled = !file;
    setStatus(file ? "Redo" : "Välj fil");
  });

  createBtn.addEventListener("click", async () => {
    if (!file) return;

    errorBox.style.display = "none";
    resultBox.style.display = "none";
    setStatus("Skapar ID…");

    try{
      const id = await sha256(file);
      const link = `${location.origin}/verify.html?hash=${id}`;

      idOut.textContent = id;
      linkOut.textContent = link;
      linkOut.href = link;

      qrLink.href = link;
      renderQR(link);

      resultBox.style.display = "block";
      setStatus("Klart ✅");

    } catch(e){
      errorBox.style.display = "block";
      errorMsg.textContent = e.message || "Tekniskt fel";
      setStatus("Fel");
    }
  });
})();
</script>

<script src="/assets/header-toggle.js" defer></script>
</body>
</html>
