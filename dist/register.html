<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Proofy – Skapa kontrollvärde</title>
  <meta name="description" content="Skapa kontrollvärde (Verifierings-ID) för en filversion lokalt i webbläsaren. Underlaget lämnar aldrig din dator." />
  <meta name="theme-color" content="#0b1220" />
  <meta name="robots" content="noindex" />

  <link rel="stylesheet" href="/assets/proofy.css?v=2026-01-03a" />
  <link rel="stylesheet" href="/assets/header.css?v=2026-01-03a" />

  <style>
    .sr-only{
      position:absolute !important;
      width:1px !important;
      height:1px !important;
      padding:0 !important;
      margin:-1px !important;
      overflow:hidden !important;
      clip:rect(0,0,0,0) !important;
      white-space:nowrap !important;
      border:0 !important;
    }

    .actionsRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .actionsMetaRow{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    #statusPill, #manualPill { margin-left:0 !important; }
    .hintline{ margin-top:6px; opacity:.9; }

    .navActions .btn.isCurrent{
      pointer-events:none;
      opacity:1;
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.05);
    }

    /* ✅ “Intyg”-knappen ser ut som en knapp men är en riktig <button> (mobil-säkert) */
    #receiptBtn{
      background: rgba(255,255,255,.04) !important;
      border: 1px solid rgba(255,255,255,.12) !important;
      color: rgba(234,240,255,.85) !important;
    }

    /* ✅ Avbryt ska ha UI (inte bara textlänk) */
    #abortBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius: 12px;
      padding: 8px 12px;
      font-weight: 950;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(234,240,255,.88);
      cursor:pointer;
      text-decoration:none;
      -webkit-tap-highlight-color: transparent;
    }

    .proofyQrTap{
      width:184px;
      height:184px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:#ffffff;
      display:grid;
      place-items:center;
      overflow:hidden;
      cursor:pointer;
      padding:0 !important;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .proofyQrBox{
      width:168px;
      height:168px;
      display:grid;
      place-items:center;
    }
    .proofyQrBox canvas,
    .proofyQrBox img,
    .proofyQrBox svg{
      width:168px !important;
      height:168px !important;
      display:block;
      image-rendering: pixelated;
    }

    .noteBox{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:12px;
    }
    .noteActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:10px;
    }

    .inlineLinkBtn{
      background: transparent;
      border: 0;
      color: rgba(170, 210, 255, .92);
      cursor:pointer;
      padding: 0;
      font: inherit;
      text-decoration: underline;
      text-underline-offset: 3px;
    }

    /* ✅ Hårdtest: extra bottenpadding så “Fråga oss”-widget inte täcker knappar/länkar */
    main{
      padding-bottom: calc(160px + var(--proofy-fab-space, 0px) + env(safe-area-inset-bottom));
    }

    /* ✅ Sticky actions: visas bara när primära knappar inte syns (ingen onödig “följ med”) */
    .proofySticky{
      position: fixed;
      left: 0;
      right: 0;
      bottom: calc(env(safe-area-inset-bottom) + 10px);
      z-index: 60;
      display: none;
      pointer-events: none;
    }
    .proofySticky .inner{
      pointer-events: auto;
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 14px;
    }
    .proofySticky .bar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(11,18,32,.78);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 10px;
      box-shadow: 0 12px 32px rgba(0,0,0,.35);
    }
    .proofySticky .btnPrimary{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 950;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color: rgba(234,240,255,.94);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .proofySticky .btnSecondary{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 950;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(234,240,255,.88);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .proofySticky{
      margin-bottom: calc(var(--proofy-fab-space, 120px));
    }

    @media print{
      header, .actions, #chatWidget, #chat-widget, .mnav, .navActions, .proofySticky { display:none !important; }
      #qrTap, #manualQrTap { display:grid !important; border-color:#ddd !important; }
      #qrTap, #qrBox, #manualQrTap, #manualQrBox{ -webkit-print-color-adjust:exact; print-color-adjust:exact; }
    }
  </style>
</head>

<body>
<a class="skip" href="#main">Hoppa till innehåll</a>

<header>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="/" aria-label="Proofy">
        <span class="logo" aria-hidden="true"></span>
        <span>Proofy</span>
      </a>

      <div class="navActions" id="navActionsDesktop">
        <a class="btn isCurrent" aria-current="page">Skapa kontrollvärde</a>
        <a class="btn soft" href="/verify.html">Verifiera underlag</a>
        <a class="btn soft" href="/pilot.html">Starta pilot</a>
        <a class="btn primary" href="/#kontakt">Boka kort demo</a>
      </div>

      <details class="mnav" id="mnav">
        <summary class="mnavSummary" aria-label="Öppna meny">
          <span class="mnavIcon" aria-hidden="true"></span>
        </summary>

        <nav class="mnavMenu" aria-label="Meny">
          <a class="mnavLink" href="/register.html" aria-current="page">Skapa kontrollvärde</a>
          <a class="mnavLink" href="/verify.html">Verifiera underlag</a>
          <a class="mnavLink" href="/pilot.html">Starta pilot</a>
          <a class="mnavLink mnavLinkPrimary" href="/#kontakt">Boka kort demo</a>

          <div class="mnavMeta">
            <a class="mnavLink" href="/security.html">Säkerhet</a>
            <a class="mnavLink" href="/privacy.html">Integritet</a>
            <a class="mnavLink" href="/terms.html">Villkor</a>
            <a class="mnavLink" href="/cookies.html">Cookies</a>

            <div class="mnavNote">Verifiering · revision · granskning</div>
            <a class="mnavMail" href="mailto:kontakt@proofy.se">kontakt@proofy.se</a>
          </div>
        </nav>
      </details>
    </div>
  </div>
</header>

<main id="main">
  <div class="wrap">
    <div class="badge">Verifiering · revision · granskning</div>

    <h1 class="pageTitle">Skapa kontrollvärde <span class="meta">(Verifierings-ID)</span></h1>

    <p class="lead">
      Välj filversionen som ska vara <b>referens</b> i ärendet. Proofy skapar kontrollvärde lokalt och (om du vill) skickar en registrering för bekräftelse.
      <strong>Underlaget lämnar aldrig din dator.</strong>
    </p>

    <p class="meta" style="margin-top:-6px; opacity:.9; max-width:92ch;">
      Proofy uttalar sig inte om dokumentets innehåll, riktighet, giltighet eller äkthet.
      Kontroll avser endast filversion och registerstatus vid angivet kontrolltillfälle.
    </p>

    <div class="card content" style="margin-top:14px;">
      <div class="grid2">

        <section aria-label="Välj referensunderlag">
          <div style="font-weight:950; font-size:16px;">1. Referensunderlag (filversion)</div>

          <label for="fileInput" class="btn primary" style="display:inline-flex; margin-top:10px; cursor:pointer;">
            Välj / byt underlag
          </label>
          <input id="fileInput" type="file" style="display:none;" />

          <div id="dropZone"
               class="drop"
               role="button"
               tabindex="0"
               aria-label="Dra och släpp underlag här, eller tryck för att välja fil"
               style="margin-top:10px;">
            Dra &amp; släpp underlag här<br />
            <span class="small" style="opacity:.9;">Tryck här för att välja fil</span>
          </div>

          <div id="fileInfo"
               class="meta"
               style="margin-top:10px; padding:10px 12px; border-radius:12px; border:1px dashed rgba(255,255,255,.25); background:rgba(255,255,255,.04);">
            Inget underlag valt.
          </div>

          <div class="actions" style="margin-top:14px;">
            <div class="actionsMetaRow">
              <span id="statusPill" class="pill" role="status" aria-live="polite" aria-atomic="true">Välj underlag</span>
              <button id="abortBtn" type="button" style="display:none;">Avbryt</button>
            </div>
          </div>

          <div id="localIdBox" style="display:none; margin-top:12px;">
            <div class="meta">Kontrollvärde (Verifierings-ID) – för notering i ärendeakt</div>

            <div id="localIdOut"
                 class="mono"
                 tabindex="0"
                 role="button"
                 aria-label="Kontrollvärde (klicka för att kopiera)"
                 title="Klicka för att kopiera"
                 style="
                   margin-top:8px;
                   padding:10px 12px;
                   border-radius:12px;
                   border:1px solid rgba(255,255,255,.14);
                   background:rgba(255,255,255,.03);
                   cursor:pointer;
                   user-select:text;
                 ">—</div>

            <div class="small hintline">Klicka i fältet för att kopiera.</div>
            <span id="copyIdPill" class="pill" style="display:none; margin-top:8px;"></span>
          </div>

          <p class="small" style="margin-top:12px; margin-bottom:0;">
            Vanliga filtyper stöds (t.ex. PDF, Excel, bilder, ZIP).<br />
            <b>Observera:</b> Ny export/omskanning/konvertering kan ge en annan filversion även om innehållet “ser likadant ut”.
          </p>
        </section>

        <section aria-label="Dokumentationsrapport">
          <div style="font-weight:950; font-size:16px;">2. Dokumentation</div>
          <div class="hr"></div>

          <div id="emptyState"
               style="
                 border:1px solid rgba(255,255,255,.10);
                 background: rgba(255,255,255,.03);
                 border-radius: 16px;
                 padding: 12px 14px;
               ">
            <div style="font-weight:950; margin-bottom:6px;">Arbetsflöde (byrå/ärende)</div>
            <div class="small">
              1) Välj filversionen som ska vara <b>referens</b> i ärendet.<br/>
              2) Proofy skapar kontrollvärde lokalt (<b>ingen uppladdning</b>).<br/>
              3) Spara notering i <b>ärendeakt</b> och dela länk/QR vid intern kontroll, klientdialog eller granskning.<br/><br/>
              <b>QR avser skanning med en annan enhet.</b> På samma mobil är det normalt svårt att skanna sin egen skärm.
            </div>
          </div>

          <div id="resultBox" style="display:none; margin-top:12px;">
            <div id="headline"
                 role="status"
                 aria-live="polite"
                 aria-atomic="true"
                 style="font-size:18px; font-weight:950; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.05);">
            </div>

            <div style="margin-top:12px;">
              <div class="meta">Kontrollvärde (Verifierings-ID)</div>
              <div class="small hintline">Klicka i fältet för att kopiera.</div>

              <div style="position:relative; margin-top:6px;">
                <button type="button" id="copyIdIconBtn" aria-label="Kopiera kontrollvärde" title="Kopiera"
                        style="display:none; position:absolute; top:6px; right:6px; width:34px; height:30px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); cursor:pointer;">
                  <span aria-hidden="true" style="display:block; font-size:15px; line-height:28px;">⧉</span>
                </button>

                <div id="idOut"
                     class="mono"
                     tabindex="0"
                     role="button"
                     title="Klicka för att kopiera"
                     aria-label="Kontrollvärde (klicka för att kopiera)"
                     style="
                       padding:10px 12px;
                       border-radius:12px;
                       border:1px solid rgba(255,255,255,.14);
                       background:rgba(255,255,255,.03);
                       cursor:pointer;
                       padding-right:52px;
                       user-select:text;
                     ">—</div>

                <span id="copyIdPill2" class="pill" style="display:none; margin-top:8px;"></span>
              </div>

              <div class="meta" style="margin-top:12px;">Verifieringslänk (delbar)</div>
              <div class="small hintline">Klicka i fältet för att kopiera (eller öppna i ny flik).</div>

              <div style="position:relative; margin-top:6px;">
                <button type="button" id="copyLinkIconBtn" aria-label="Kopiera länk" title="Kopiera"
                        style="display:none; position:absolute; top:6px; right:6px; width:34px; height:30px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); cursor:pointer;">
                  <span aria-hidden="true" style="display:block; font-size:15px; line-height:28px;">⧉</span>
                </button>

                <a id="linkOut"
                   class="mono"
                   href="#"
                   target="_blank"
                   rel="noopener"
                   title="Tryck för att öppna · Långtryck för att kopiera"
                   aria-label="Verifieringslänk (delbar)"
                   style="
                     display:block;
                     padding:10px 12px;
                     border-radius:12px;
                     border:1px solid rgba(255,255,255,.14);
                     background:rgba(255,255,255,.03);
                     cursor:pointer;
                     padding-right:52px;
                     user-select:text;
                     text-decoration:none;
                   ">—</a>

                <span id="copyLinkPill" class="pill" style="display:none; margin-top:8px;"></span>
              </div>

              <p class="small" style="margin:10px 0 0; opacity:.95;">
                <b>Notera:</b> Kontrollvärde och verifieringslänk skapas lokalt. För att kunna redovisa <b>Bekräftad</b> status vid senare kontroll behöver status vara <b>Bekräftad</b>.
              </p>

              <div class="hr" style="margin-top:14px;"></div>

              <!-- ✅ Revisions-/juridik-flöde: tid & status + intyg först, QR därefter -->
              <div class="qrWrap" style="margin-top:12px;">
                <!-- META först -->
                <div style="min-width:240px; flex:1;">
                  <div class="meta">Kontrolltid (detta kontrolltillfälle)</div>
                  <div id="checkedSeOut" class="mono" style="margin-top:8px;">—</div>
                  <div id="checkedUtcOut" class="mono" style="margin-top:8px; opacity:.75;">—</div>
                  <div class="small" style="margin-top:8px; opacity:.9;">
                    Tidpunkten genereras i webbläsaren och kan vara fel om systemklockan är fel. Den utgör inte extern tidsstämpling.
                  </div>

                  <div class="meta" style="margin-top:12px;">Status vid kontrolltillfället</div>
                  <div id="regStatusOut" class="mono" style="margin-top:8px;" aria-live="polite" aria-atomic="true">—</div>

                  <div class="meta" style="margin-top:10px;">Tidpunkt (endast om bekräftad)</div>
                  <div id="timeOut" class="mono" style="margin-top:8px;">—</div>

                  <!-- ✅ Primär åtgärd (synlig på sidan) -->
                  <div class="actions" style="margin-top:12px;">
                    <button class="btn soft" id="receiptBtn" type="button" style="display:none;">Öppna intyg</button>
                  </div>

                  <div class="noteBox" id="noteBox" style="display:none;">
                    <div class="meta">Notering (för ärendeakt)</div>
                    <pre class="mono" id="noteOut" style="white-space:pre-wrap; margin-top:8px;">—</pre>

                    <div class="noteActions">
                      <button class="btn" id="copyNoteBtn" type="button" style="display:none;">Kopiera notering</button>
                      <span id="copyNotePill" class="pill" style="display:none;"></span>
                    </div>

                    <div class="small" style="margin-top:10px; opacity:.9;">
                      Ladda ner som .txt:
                      <button class="inlineLinkBtn" id="downloadNoteLink" type="button">proofy-notering.txt</button>
                    </div>

                    <p class="meta" style="margin:10px 0 0; opacity:.9;">
                      Proofy uttalar sig inte om dokumentets innehåll, riktighet, giltighet eller äkthet.
                      Kontroll avser endast filversion och registerstatus vid angivet kontrolltillfälle.
                    </p>
                  </div>

                  <details style="margin-top:12px;">
                    <summary>Extra uppgifter (valfritt)</summary>
                    <p class="small" style="margin:10px 0 8px; opacity:.95;">
                      Vanligen ej nödvändigt i ärendet, men kan hjälpa vid utredning.
                    </p>

                    <div class="hr"></div>

                    <div class="meta">Registreringsreferens (valfri)</div>
                    <div id="txOut" class="mono" style="margin-top:8px;">—</div>

                    <div class="meta" style="margin-top:10px;">Kontrollpunkt (valfri)</div>
                    <div id="submitterOut" class="mono" style="margin-top:8px;">—</div>

                    <div class="meta" style="margin-top:10px;">Meddelande (om något)</div>
                    <div id="debugOut" class="mono" style="margin-top:8px;">—</div>
                  </details>
                </div>

                <!-- QR därefter -->
                <div>
                  <div class="meta" style="margin-bottom:8px;">QR-kod (för skanning)</div>

                  <div id="qrTap"
                       class="proofyQrTap"
                       role="button"
                       tabindex="0"
                       aria-label="QR-kod (klicka för att kopiera verifieringslänk)"
                       title="Klicka för att kopiera verifieringslänk"
                       style="display:none;">
                    <div id="qrBox" class="proofyQrBox" aria-label="QR-kod"></div>
                  </div>

                  <div class="small" style="margin-top:8px; opacity:.9; max-width:48ch;">
                    Skanna med <b>annan enhet</b> (kollega/klient). Klick på QR kopierar länken.
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="errorBox" style="display:none; margin-top:12px;" role="status" aria-live="polite" aria-atomic="true">
            <div class="err">Tillfälligt problem</div>
            <div id="errorMsg" class="mono" style="margin-top:8px;"></div>
          </div>
        </section>

      </div>
    </div>

    <section style="margin-top:14px;">
      <div class="card content">
        <h2 style="margin:0 0 8px; font-size:18px;">Har du redan ett kontrollvärde?</h2>
        <p class="meta" style="margin:0 0 10px;">
          Klistra in ett kontrollvärde (Verifierings-ID) så skapar vi verifieringslänk och QR direkt.
        </p>

        <div class="grid2">
          <div>
            <label class="meta" for="manualId">Kontrollvärde (Verifierings-ID)</label>
            <input id="manualId" type="text" placeholder="0x…" autocomplete="off" spellcheck="false" style="margin-top:8px" />

            <div class="actions" style="margin-top:12px;">
              <div class="actionsMetaRow">
                <span id="manualPill" class="pill" role="status" aria-live="polite" aria-atomic="true">Klistra in ID</span>
              </div>
            </div>
          </div>

          <div>
            <div class="meta">Verifieringslänk (delbar)</div>

            <a id="manualLinkOut"
               class="mono"
               href="#"
               target="_blank"
               rel="noopener"
               title="Tryck för att öppna · Långtryck för att kopiera"
               style="
                 display:block;
                 margin-top:8px;
                 padding:10px 12px;
                 border-radius:12px;
                 border:1px solid rgba(255,255,255,.14);
                 background:rgba(255,255,255,.03);
                 text-decoration:none;
               ">—</a>

            <div class="small hintline">Klicka i fältet för att kopiera (eller öppna i ny flik).</div>

            <div class="qrWrap" style="margin-top:12px;">
              <div>
                <div class="meta" style="margin-bottom:8px;">QR-kod (för skanning)</div>

                <div id="manualQrTap"
                     class="proofyQrTap"
                     role="button"
                     tabindex="0"
                     aria-label="QR-kod (klicka för att kopiera verifieringslänk)"
                     title="Klicka för att kopiera verifieringslänk"
                     style="display:none;">
                  <div id="manualQrBox" class="proofyQrBox" aria-label="QR-kod (manuell)"></div>
                </div>
              </div>
              <div style="min-width:240px; flex:1;">
                <div class="small" style="margin-top:0;">
                  Bra när kontrollvärdet finns i en notering och du snabbt vill dela verifieringslänk.
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="hr"></div>
        <p class="small" style="margin:0;">
          Proofy lagrar inte dokument. Verifiering bygger på jämförelse av filversioner mot en tidigare fastställd referens (kontrollvärde).
        </p>
      </div>
    </section>

  </div>
</main>

<footer>
  <div class="wrap">
    <div class="foot">
      <div>
        <div style="color: rgba(234,240,255,.86); font-weight:800;">Proofy</div>
        <div class="small">© 2026 Proofy. Alla rättigheter förbehållna.</div>
        <div class="small" style="margin-top:8px; max-width:92ch;">
          Proofy tillhandahåller teknisk kontroll av filversioner (kontrollvärden). Tjänsten utgör inte juridisk rådgivning och avgör inte dokumentets rättsliga giltighet.
        </div>
      </div>
      <div class="links">
        <a href="/security.html">Säkerhet</a>
        <a href="/privacy.html">Integritet</a>
        <a href="/terms.html">Villkor</a>
        <a href="/cookies.html">Cookies</a>
        <a href="/#kontakt">Kontakt</a>
      </div>
    </div>
  </div>
</footer>

<!-- ✅ Sticky åtgärdsrad (visas bara när primära knappar inte syns) -->
<div class="proofySticky" id="stickyBar" aria-hidden="true">
  <div class="inner">
    <div class="bar">
      <button class="btnSecondary" id="stickyAbortBtn" type="button" style="display:none;">Avbryt</button>
      <button class="btnSecondary" id="stickyCopyNoteBtn" type="button" style="display:none;">Kopiera notering</button>
      <button class="btnPrimary" id="stickyReceiptBtn" type="button" style="display:none;">Öppna intyg</button>
    </div>
  </div>
</div>

<script src="/assets/qr.min.js?v=2026-01-03a"></script>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const mainEl = $("main") || document.querySelector("main");

  const fileInput = $("fileInput");
  const dropZone = $("dropZone");
  const fileInfo = $("fileInfo");

  const statusPill = $("statusPill");
  const abortBtn = $("abortBtn");

  const localIdBox = $("localIdBox");
  const localIdOut = $("localIdOut");
  const copyIdPill = $("copyIdPill");

  const emptyState = $("emptyState");
  const resultBox = $("resultBox");
  const headline = $("headline");
  const idOut = $("idOut");
  const linkOut = $("linkOut");
  const qrTap = $("qrTap");
  const qrBox = $("qrBox");

  const receiptBtn = $("receiptBtn");
  let receiptHref = null;

  const regStatusOut = $("regStatusOut");
  const timeOut = $("timeOut");
  const submitterOut = $("submitterOut");
  const txOut = $("txOut");
  const debugOut = $("debugOut");

  const copyIdIconBtn = $("copyIdIconBtn");
  const copyIdPill2 = $("copyIdPill2");
  const copyLinkIconBtn = $("copyLinkIconBtn");
  const copyLinkPill = $("copyLinkPill");

  const checkedSeOut = $("checkedSeOut");
  const checkedUtcOut = $("checkedUtcOut");

  const noteBox = $("noteBox");
  const noteOut = $("noteOut");
  const copyNoteBtn = $("copyNoteBtn");
  const copyNotePill = $("copyNotePill");
  const downloadNoteLink = $("downloadNoteLink");

  const errorBox = $("errorBox");
  const errorMsg = $("errorMsg");

  const manualId = $("manualId");
  const manualPill = $("manualPill");
  const manualLinkOut = $("manualLinkOut");
  const manualQrTap = $("manualQrTap");
  const manualQrBox = $("manualQrBox");

  // ✅ Sticky actions
  const stickyBar = $("stickyBar");
  const stickyAbortBtn = $("stickyAbortBtn");
  const stickyCopyNoteBtn = $("stickyCopyNoteBtn");
  const stickyReceiptBtn = $("stickyReceiptBtn");

  let currentFile = null;
  let currentId = null;
  let currentLink = null;
  let currentCheckedEpoch = null;

  let busy = false;
  let opId = 0;

  let lastRun = null;
  let lastProofyStatusCode = "";
  let manualCurrentLink = null;

  let pollTimer = null;
  let pollStartAt = 0;
  let pollTxHash = null;

  // ✅ Sticky visibility based on whether primary buttons are on-screen
  let receiptInView = false;
  let noteInView = false;
  let ioReady = false;

  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  function setAriaBusy(v){
    try{
      if (mainEl) mainEl.setAttribute("aria-busy", v ? "true" : "false");
    } catch {}
  }

  function setPill(text){ statusPill.textContent = text; }
  function setManualPill(text){ manualPill.textContent = text; }

  function hidePill(p){
    if (!p) return;
    p.style.display = "none";
    p.textContent = "";
  }
  function showPill(p, text){
    if (!p) return;
    p.style.display = "inline-flex";
    p.textContent = text;
  }

  function pad2(n){ return String(n).padStart(2,"0"); }

  function fmtUtcEpochSec(sec){
    const n = Number(sec);
    if (!Number.isFinite(n) || n <= 0) return "—";
    const d = new Date(n * 1000);
    return `${d.getUTCFullYear()}-${pad2(d.getUTCMonth()+1)}-${pad2(d.getUTCDate())} ${pad2(d.getUTCHours())}:${pad2(d.getUTCMinutes())}:${pad2(d.getUTCSeconds())} UTC`;
  }

  function fmtSeEpochSec(sec){
    const n = Number(sec);
    if (!Number.isFinite(n) || n <= 0) return "—";
    try{
      return new Intl.DateTimeFormat("sv-SE", {
        timeZone:"Europe/Stockholm",
        year:"numeric", month:"2-digit", day:"2-digit",
        hour:"2-digit", minute:"2-digit", second:"2-digit"
      }).format(new Date(n * 1000)) + " (Europe/Stockholm)";
    } catch {
      return new Date(n * 1000).toLocaleString("sv-SE") + " (lokal)";
    }
  }

  function bytesToHex(bytes){
    return [...bytes].map(b => b.toString(16).padStart(2,"0")).join("");
  }

  async function sha256Hex(file){
    await sleep(0);
    const buf = await file.arrayBuffer();
    const dig = await crypto.subtle.digest("SHA-256", buf);
    return "0x" + bytesToHex(new Uint8Array(dig));
  }

  function isIdFormat(v){
    return typeof v === "string" && /^0x[0-9a-fA-F]{64}$/.test(v.trim());
  }

  function buildVerifyLink(hash, checkedEpoch, txHash){
    const p = new URL(`${location.origin}/verify.html`);
    p.searchParams.set("hash", hash);
    if (checkedEpoch) p.searchParams.set("checked", String(checkedEpoch));
    if (txHash) p.searchParams.set("tx", txHash);
    return p.toString();
  }

  function buildCertLink(hash, checkedEpoch, txHash){
    const p = new URL(`${location.origin}/certificate.html`);
    p.searchParams.set("hash", hash);
    if (checkedEpoch) p.searchParams.set("checked", String(checkedEpoch));
    if (txHash) p.searchParams.set("tx", txHash);
    return p.toString();
  }

  function isRetryableStatus(status){
    return status === 408 || status === 425 || status === 429 || (status >= 500 && status <= 599);
  }

  async function fetchJsonWithTimeout(url, options = {}, timeoutMs = 25000){
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), timeoutMs);
    try{
      const res = await fetch(url, { ...options, signal: controller.signal });
      const data = await res.json().catch(() => ({}));
      return { res, data, aborted:false };
    } catch (e){
      const aborted = (e && e.name === "AbortError");
      return { res: null, data: {}, aborted };
    } finally {
      clearTimeout(t);
    }
  }

  async function safeRegisterRequest(hash){
    const attempts = 3;
    const baseDelay = 650;

    for (let i = 0; i < attempts; i++){
      const { res, data, aborted } = await fetchJsonWithTimeout(
        "/api/register",
        {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ hash })
        },
        25000
      );

      if (aborted && i < attempts - 1) {
        const jitter = Math.floor(Math.random() * 180);
        await sleep(baseDelay * (i + 1) + jitter);
        continue;
      }

      if (res && res.ok && data && data.ok !== false) {
        return { ok: true, res, data, attempt: i + 1 };
      }

      const status = res?.status || 0;
      const retryable = isRetryableStatus(status);

      if (i < attempts - 1 && retryable) {
        const jitter = Math.floor(Math.random() * 180);
        await sleep(baseDelay * (i + 1) + jitter);
        continue;
      }

      return { ok: false, res, data, attempt: i + 1, aborted };
    }

    return { ok: false, res: null, data: {}, attempt: attempts, aborted:false };
  }

  async function safeGetJson(url){
    const { res, data, aborted } = await fetchJsonWithTimeout(url, { method:"GET" }, 20000);
    if (!res || !res.ok || aborted) return { ok:false, res, data, aborted };
    return { ok:true, res, data, aborted:false };
  }

  async function copyTextToClipboard(text){
    const t = String(text || "").trim();
    if (!t || t === "—") return false;

    try{
      await navigator.clipboard.writeText(t);
      return true;
    } catch {
      try{
        const ta = document.createElement("textarea");
        ta.value = t;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        ta.style.top = "0";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        const ok = document.execCommand("copy");
        document.body.removeChild(ta);
        return !!ok;
      } catch {
        return false;
      }
    }
  }

  async function copyWithFeedback({ text, pillEl, okText = "Kopierad ✓", failText = "Kunde inte kopiera" }){
    showPill(pillEl, "Kopierar…");
    const ok = await copyTextToClipboard(text);
    showPill(pillEl, ok ? okText : failText);
    setTimeout(() => hidePill(pillEl), 1400);
    return ok;
  }

  function applyCopyHover(fieldEl, iconBtnEl, enabled){
    if (!fieldEl) return;

    if (!enabled){
      fieldEl.onmouseenter = null;
      fieldEl.onmouseleave = null;
      fieldEl.onfocus = null;
      fieldEl.onblur = null;
      if (iconBtnEl) iconBtnEl.style.display = "none";
      return;
    }

    const onEnter = () => {
      if (iconBtnEl) iconBtnEl.style.display = "inline-flex";
      fieldEl.style.outline = "1px solid rgba(255,255,255,.14)";
      fieldEl.style.outlineOffset = "2px";
      fieldEl.style.background = "rgba(255,255,255,.05)";
    };

    const onLeave = () => {
      if (iconBtnEl) iconBtnEl.style.display = "none";
      fieldEl.style.outline = "";
      fieldEl.style.outlineOffset = "";
      fieldEl.style.background = "rgba(255,255,255,.03)";
    };

    fieldEl.onmouseenter = onEnter;
    fieldEl.onmouseleave = onLeave;

    fieldEl.onfocus = () => {
      if (iconBtnEl) iconBtnEl.style.display = "inline-flex";
      fieldEl.style.outline = "2px solid rgba(120, 180, 255, .25)";
      fieldEl.style.outlineOffset = "2px";
    };
    fieldEl.onblur = () => onLeave();
  }

  function attachOnce(el, key, fn){
    if (!el) return;
    const k = "proofy_" + key;
    if (el.dataset && el.dataset[k] === "1") return;
    if (el.dataset) el.dataset[k] = "1";
    fn();
  }

  function attachLongPressCopyOnce(el, getText, onCopied){
    if (!el) return;

    attachOnce(el, "longpress", () => {
      let t = null;
      let longPressed = false;

      const start = (e) => {
        longPressed = false;
        t = setTimeout(async () => {
          longPressed = true;
          e.preventDefault();
          const ok = await copyTextToClipboard(getText());
          if (ok && onCopied) onCopied();
        }, 450);
      };

      const end = () => {
        if (t) clearTimeout(t);
        t = null;
      };

      el.addEventListener("touchstart", start, { passive: false });
      el.addEventListener("touchend", end);
      el.addEventListener("touchcancel", end);

      el.addEventListener("mousedown", start);
      el.addEventListener("mouseup", end);
      el.addEventListener("mouseleave", end);

      el.addEventListener("click", (e) => {
        if (longPressed) {
          e.preventDefault();
          e.stopPropagation();
        }
      });
    });
  }

  function attachQrCopyOnce(qrTapEl, getLink, pillEl){
    if (!qrTapEl) return;

    attachOnce(qrTapEl, "qrcopy", () => {
      const doCopy = async () => {
        const link = getLink();
        if (!link || link === "—") return;
        await copyWithFeedback({ text: link, pillEl, okText: "Länk kopierad ✅" });
      };
      qrTapEl.onclick = (e) => { e.preventDefault(); doCopy(); };
      qrTapEl.onkeydown = (e) => {
        if (e.key === "Enter" || e.key === " ") { e.preventDefault(); doCopy(); }
      };
    });
  }

  function getCorrectLevelH(){
    if (window.QRCodeCorrectLevel && window.QRCodeCorrectLevel.H != null) return window.QRCodeCorrectLevel.H;
    if (window.QRCode && window.QRCode.CorrectLevel && window.QRCode.CorrectLevel.H != null) return window.QRCode.CorrectLevel.H;
    return undefined;
  }

  function waitForQRCode(timeoutMs = 2000){
    return new Promise((resolve) => {
      const start = Date.now();
      const tick = () => {
        if (typeof window.QRCode === "function") return resolve(true);
        if (Date.now() - start > timeoutMs) return resolve(false);
        requestAnimationFrame(tick);
      };
      tick();
    });
  }

  function waitForQrNode(targetEl, timeoutMs = 3000){
    return new Promise((resolve) => {
      const start = Date.now();
      const tick = () => {
        const node = targetEl.querySelector("canvas, img, svg, table");
        if (node) return resolve(node);
        if (Date.now() - start > timeoutMs) return resolve(null);
        requestAnimationFrame(tick);
      };
      tick();
    });
  }

  async function renderQr(targetEl, text){
    if (!targetEl) return;

    const payload = String(text || "").trim();
    targetEl.innerHTML = "";

    if (!payload || payload === "—") {
      targetEl.innerHTML = `<div class="meta" style="color:#0b1220;">Ingen länk att koda.</div>`;
      return;
    }

    const ok = await waitForQRCode(2000);
    if (!ok) {
      targetEl.innerHTML = `<div class="meta" style="color:#0b1220;">QR kunde inte laddas.</div>`;
      return;
    }

    const size = 168;

    try {
      const levelH = getCorrectLevelH();
      let qr = null;
      try{
        qr = new window.QRCode(targetEl);
        if (qr && qr._htOption){
          qr._htOption.width = size;
          qr._htOption.height = size;
          qr._htOption.colorDark = "#0b1220";
          qr._htOption.colorLight = "#ffffff";
          if (levelH != null) qr._htOption.correctLevel = levelH;
        }
        if (qr && typeof qr.makeCode === "function") qr.makeCode(payload);
      }catch{
        qr = null;
      }

      if (!qr) {
        new window.QRCode(targetEl, {
          text: payload,
          width: size,
          height: size,
          colorDark: "#0b1220",
          colorLight: "#ffffff",
          correctLevel: levelH
        });
      }
    } catch (e){
      targetEl.innerHTML = `<div class="meta" style="color:#0b1220;">QR-koden kunde inte visas.</div>`;
      return;
    }

    const node = await waitForQrNode(targetEl, 3000);
    if (!node) {
      targetEl.innerHTML = `<div class="meta" style="color:#0b1220;">QR kunde inte visas. Testa uppdatera sidan.</div>`;
      return;
    }

    node.style.display = "block";
    node.style.width = size + "px";
    node.style.height = size + "px";
    node.style.imageRendering = "pixelated";
  }

  function downloadTextFile(filename, text){
    const blob = new Blob([String(text || "")], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(() => URL.revokeObjectURL(url), 1200);
  }

  function canonicalStatusFromCode(code){
    if (code === "CONFIRMED") return "Bekräftad";
    if (code === "SUBMITTED_UNCONFIRMED") return "Inskickad – ej bekräftad";
    if (code === "NOT_CONFIRMED") return "Ej bekräftad";
    return "Kunde inte kontrolleras";
  }

  function buildNote(run){
    if (!run) return "—";
    const lines = [];
    lines.push("PROOFY – Notering (ärendeakt/granskningsunderlag)");
    lines.push("");
    lines.push(`Kontrollvärde (Verifierings-ID): ${run.id || "—"}`);
    if (run.fileName) lines.push(`Referensunderlag: ${run.fileName}`);
    lines.push("");
    lines.push(`Kontrolltid (detta kontrolltillfälle): ${run.checkedSe || "—"}`);
    lines.push(`Kontrolltid (UTC): ${run.checkedUtc || "—"}`);
    lines.push("Tidpunkten genereras i webbläsaren och utgör inte extern tidsstämpling.");
    lines.push("");
    lines.push(`Verifieringslänk: ${run.link || "—"}`);
    lines.push(`Intygslänk: ${run.certLink || "—"}`);
    lines.push("");
    lines.push(`Status vid kontrolltillfället: ${run.statusLine || "—"}`);
    if (run.timeSe) lines.push(`Tidpunkt (endast om bekräftad): ${run.timeSe}`);
    if (run.txHash) lines.push(`Registreringsreferens (valfri): ${run.txHash}`);
    if (run.observedBlockNumber) lines.push(`Kontrollpunkt (valfri): ${run.observedBlockNumber}`);
    lines.push("");
    lines.push("Avgränsning: Proofy uttalar sig inte om dokumentets innehåll, riktighet, giltighet eller äkthet.");
    lines.push("Kontroll avser endast filversion och registerstatus vid angivet kontrolltillfälle.");
    return lines.join("\n");
  }

  function stopPolling(){
    if (pollTimer) clearTimeout(pollTimer);
    pollTimer = null;
    pollStartAt = 0;
    pollTxHash = null;
  }

  function updateReceiptLabel(){
    if (!receiptBtn || !currentId) return;
    receiptBtn.textContent = "Öppna intyg";
    if (lastProofyStatusCode === "UNKNOWN") receiptBtn.textContent = "Öppna intyg (status oklar)";
    if (lastProofyStatusCode === "NOT_CONFIRMED" || lastProofyStatusCode === "SUBMITTED_UNCONFIRMED") receiptBtn.textContent = "Öppna intyg (ej bekräftad)";
  }

  function setStickyVisible(v){
    if (!stickyBar) return;
    stickyBar.style.display = v ? "block" : "none";
    stickyBar.setAttribute("aria-hidden", v ? "false" : "true");
  }

  function shouldShowStickyForActions(){
    // Under pågående arbete: alltid visa Avbryt i sticky
    if (busy) return true;

    const hasResult = !!currentId;
    if (!hasResult) return false;

    const hasReceipt = !!receiptHref && receiptHref !== "—" && (receiptBtn && receiptBtn.style.display !== "none");
    const hasNote = !!lastRun && (copyNoteBtn && copyNoteBtn.style.display !== "none");

    // Om inga actions finns: ingen sticky
    if (!hasReceipt && !hasNote) return false;

    // När vi kan observera: visa bara om respektive primärknapp inte syns
    if (ioReady){
      let need = false;
      if (hasReceipt) need = need || !receiptInView;
      if (hasNote) need = need || !noteInView;
      return need;
    }

    // Fallback utan IO: visa som tidigare
    return true;
  }

  function syncSticky(){
    if (!stickyBar) return;

    const hasResult = !!currentId;
    const isBusy = !!busy;
    const hasReceipt = !!receiptHref && receiptHref !== "—";
    const hasNote = !!lastRun;

    if (stickyAbortBtn) stickyAbortBtn.style.display = "none";
    if (stickyReceiptBtn) stickyReceiptBtn.style.display = "none";
    if (stickyCopyNoteBtn) stickyCopyNoteBtn.style.display = "none";

    if (isBusy){
      if (stickyAbortBtn) stickyAbortBtn.style.display = "inline-flex";
      setStickyVisible(true);
      return;
    }

    if (hasResult){
      let anyAction = false;

      if (hasReceipt){
        if (stickyReceiptBtn){
          stickyReceiptBtn.style.display = "inline-flex";
          stickyReceiptBtn.textContent = receiptBtn?.textContent || "Öppna intyg";
          stickyReceiptBtn.onclick = () => { window.location.href = receiptHref; };
        }
        anyAction = true;
      }

      if (hasNote){
        if (stickyCopyNoteBtn){
          stickyCopyNoteBtn.style.display = "inline-flex";
          stickyCopyNoteBtn.onclick = async () => {
            await copyWithFeedback({ text: buildNote(lastRun), pillEl: copyNotePill, okText:"Notering kopierad ✅" });
          };
        }
        anyAction = true;
      }

      setStickyVisible(anyAction && shouldShowStickyForActions());
      return;
    }

    setStickyVisible(false);
  }

  function setBusy(v){
    busy = v;
    setAriaBusy(v);
    if (abortBtn){
      abortBtn.style.display = busy ? "inline-flex" : "none";
    }
    syncSticky();
  }

  function resetReport(){
    if (resultBox) resultBox.style.display = "none";
    if (errorBox) errorBox.style.display = "none";
    if (errorMsg) errorMsg.textContent = "";
    if (headline) headline.textContent = "";
    if (idOut) idOut.textContent = "—";
    if (linkOut) linkOut.textContent = "—";
    if (linkOut) linkOut.href = "#";
    if (qrBox) qrBox.innerHTML = "";
    if (qrTap) qrTap.style.display = "none";

    if (regStatusOut) regStatusOut.textContent = "—";
    if (timeOut) timeOut.textContent = "—";
    if (submitterOut) submitterOut.textContent = "—";
    if (txOut) txOut.textContent = "—";
    if (debugOut) debugOut.textContent = "—";

    if (checkedSeOut) checkedSeOut.textContent = "—";
    if (checkedUtcOut) checkedUtcOut.textContent = "—";

    if (receiptBtn) receiptBtn.style.display = "none";
    receiptHref = null;

    if (copyIdIconBtn) copyIdIconBtn.style.display = "none";
    if (copyLinkIconBtn) copyLinkIconBtn.style.display = "none";

    hidePill(copyIdPill);
    hidePill(copyIdPill2);
    hidePill(copyLinkPill);
    hidePill(copyNotePill);

    if (noteBox) noteBox.style.display = "none";
    if (noteOut) noteOut.textContent = "—";
    if (copyNoteBtn) copyNoteBtn.style.display = "none";

    lastRun = null;
    lastProofyStatusCode = "";
    stopPolling();

    if (emptyState) emptyState.style.display = "block";
    syncSticky();
  }

  function setFile(file){
    stopPolling();
    currentFile = file || null;
    currentId = null;
    currentLink = null;
    currentCheckedEpoch = null;
    lastProofyStatusCode = "";
    resetReport();

    if (localIdBox) localIdBox.style.display = "none";
    if (localIdOut) localIdOut.textContent = "—";
    hidePill(copyIdPill);

    if (!currentFile){
      fileInfo.textContent = "Inget underlag valt.";
      setPill("Välj underlag");
      setBusy(false);
      return;
    }

    const sizeMb = (currentFile.size/1024/1024);
    const niceSize = (sizeMb < 10) ? sizeMb.toFixed(2) : sizeMb.toFixed(1);
    fileInfo.textContent = `Valt underlag: ${currentFile.name} (${niceSize} MB)`;

    beginAutoFlow();
  }

  function markHeadline(type, text){
    if (!headline) return;
    headline.style.borderColor = "rgba(255,255,255,.14)";
    headline.style.background = "rgba(255,255,255,.05)";
    if (type === "ok"){
      headline.style.borderColor = "rgba(80,255,180,.20)";
      headline.style.background = "rgba(80,255,180,.06)";
      headline.innerHTML = `<span class="ok">✅ ${text}</span> <span class="meta">(kontrolltillfället)</span>`;
      return;
    }
    if (type === "warn"){
      headline.style.borderColor = "rgba(251,191,36,.22)";
      headline.style.background = "rgba(251,191,36,.08)";
      headline.innerHTML = `<span class="meta">⚠️ ${text}</span> <span class="meta">(kontrolltillfället)</span>`;
      return;
    }
    if (type === "err"){
      headline.style.borderColor = "rgba(255,80,80,.20)";
      headline.style.background = "rgba(255,80,80,.06)";
      headline.innerHTML = `<span class="err">⚠️ ${text}</span> <span class="meta">(kontrolltillfället)</span>`;
      return;
    }
    headline.textContent = text;
  }

  function applyStatusToUI({ id, checkedEpoch, data }){
    const sc = String(data?.statusCode || "");
    const legal = String(data?.legalText || "");
    const confirmedAt = data?.confirmedAtUnix ?? null;

    const txHash = data?.submission?.txHash || null;
    const observedBlockNumber = data?.evidence?.observedBlockNumber || null;

    txOut.textContent = txHash || "—";
    submitterOut.textContent = observedBlockNumber != null ? String(observedBlockNumber) : "—";
    debugOut.textContent = legal || "—";

    const confirmedSe = confirmedAt ? fmtSeEpochSec(confirmedAt) : null;
    timeOut.textContent = confirmedSe || "—";

    lastProofyStatusCode = sc || "";
    updateReceiptLabel();

    const canonical = canonicalStatusFromCode(sc);

    if (sc === "CONFIRMED") {
      markHeadline("ok", "Bekräftad");
      regStatusOut.textContent = "Bekräftad";
    } else if (sc === "NOT_CONFIRMED" || sc === "SUBMITTED_UNCONFIRMED") {
      const isSubmitted = (sc === "SUBMITTED_UNCONFIRMED");
      markHeadline("warn", isSubmitted ? "Inskickad – ej bekräftad" : "Ej bekräftad");
      regStatusOut.textContent = isSubmitted ? "Inskickad – ej bekräftad" : "Ej bekräftad";
    } else {
      markHeadline("err", "Kunde inte kontrolleras");
      regStatusOut.textContent = "Kunde inte kontrolleras";
    }

    const verifyLink = currentLink || "—";
    const certLink = buildCertLink(id, checkedEpoch, txHash || "");

    receiptHref = certLink;
    if (receiptBtn){
      receiptBtn.style.display = "inline-flex";
      updateReceiptLabel();
      receiptBtn.onclick = () => {
        if (!receiptHref || receiptHref === "—") return;
        window.location.href = receiptHref;
      };
    }

    lastRun = {
      id,
      link: verifyLink,
      certLink,
      fileName: currentFile?.name || "",
      checkedSe: fmtSeEpochSec(checkedEpoch),
      checkedUtc: fmtUtcEpochSec(checkedEpoch),
      statusLine: canonical,
      timeSe: confirmedSe,
      txHash: txHash,
      observedBlockNumber: observedBlockNumber
    };

    if (noteOut) noteOut.textContent = buildNote(lastRun);
    if (noteBox) noteBox.style.display = "block";
    if (copyNoteBtn) copyNoteBtn.style.display = "inline-flex";

    syncSticky();
  }

  async function pollTxAndVerify(myOp, id, txHash, checkedEpoch){
    stopPolling();
    pollStartAt = Date.now();
    pollTxHash = txHash;

    const maxMs = 120000;
    let attempt = 0;

    const tick = async () => {
      if (myOp !== opId) return;
      if (!pollTxHash || pollTxHash !== txHash) return;

      const elapsed = Date.now() - pollStartAt;
      if (elapsed > maxMs) {
        stopPolling();
        lastProofyStatusCode = "NOT_CONFIRMED";
        updateReceiptLabel();
        debugOut.textContent = "Kontroll kunde inte visa bekräftelse inom tidsgränsen. Du kan verifiera igen senare.";
        markHeadline("warn", "Ej bekräftad");
        regStatusOut.textContent = "Ej bekräftad";
        timeOut.textContent = "—";
        applyStatusToUI({ id, checkedEpoch, data: { statusCode:"NOT_CONFIRMED" } });
        return;
      }

      attempt++;
      regStatusOut.textContent = "Kontroll pågår…";
      txOut.textContent = txHash || "—";

      const txRes = await safeGetJson(`/api/tx?tx=${encodeURIComponent(txHash)}`);
      if (myOp !== opId) return;

      if (!txRes.ok || txRes.data?.ok === false) {
        lastProofyStatusCode = "UNKNOWN";
        updateReceiptLabel();
        debugOut.textContent = "Status kunde inte kontrolleras just nu (tillfälligt fel). Ingen slutsats kan dras.";
        markHeadline("err", "Kunde inte kontrolleras");
        regStatusOut.textContent = "Kunde inte kontrolleras";
        timeOut.textContent = "—";
        applyStatusToUI({ id, checkedEpoch, data: { statusCode:"UNKNOWN" } });
      } else {
        const mined = !!txRes.data?.mined;
        if (!mined) {
          markHeadline("warn", "Inskickad – ej bekräftad");
          regStatusOut.textContent = "Inskickad – ej bekräftad";
        } else {
          const st = String(txRes.data?.status || "");
          const blockNo = txRes.data?.blockNumber || null;

          submitterOut.textContent = blockNo != null ? String(blockNo) : (submitterOut.textContent || "—");

          if (st === "reverted") {
            stopPolling();
            lastProofyStatusCode = "UNKNOWN";
            updateReceiptLabel();
            markHeadline("err", "Kunde inte kontrolleras");
            regStatusOut.textContent = "Kunde inte kontrolleras";
            timeOut.textContent = "—";
            debugOut.textContent = "Inskick misslyckades. Du kan försöka igen eller kontakta Proofy och ange registreringsreferensen.";
            applyStatusToUI({ id, checkedEpoch, data: { statusCode:"UNKNOWN" } });
            return;
          }

          const ver = await safeGetJson(`/api/verify?hash=${encodeURIComponent(id)}&tx=${encodeURIComponent(txHash)}`);
          if (myOp !== opId) return;

          if (!ver.ok || ver.data?.ok === false) {
            lastProofyStatusCode = "UNKNOWN";
            updateReceiptLabel();
            markHeadline("err", "Kunde inte kontrolleras");
            regStatusOut.textContent = "Kunde inte kontrolleras";
            timeOut.textContent = "—";
            debugOut.textContent = "Verifiering misslyckades (tillfälligt fel). Ingen slutsats kan dras.";
            applyStatusToUI({ id, checkedEpoch, data: { statusCode:"UNKNOWN" } });
          } else {
            applyStatusToUI({ id, checkedEpoch, data: ver.data });

            if (String(ver.data?.statusCode || "") === "CONFIRMED") {
              stopPolling();
              return;
            }
          }
        }
      }

      const delay = Math.min(9000, 2200 + attempt * 350);
      pollTimer = setTimeout(tick, delay);
    };

    tick();
  }

  async function beginAutoFlow(){
    if (!currentFile) return;

    const myOp = ++opId;
    stopPolling();
    setBusy(true);
    resetReport();

    setPill("Skapar kontrollvärde…");

    const doAbort = () => {
      opId++;
      stopPolling();
      setBusy(false);
      setPill("Avbruten – välj underlag igen");
      markHeadline("warn", "Avbruten");
      syncSticky();
    };

    if (abortBtn) abortBtn.onclick = doAbort;
    if (stickyAbortBtn) stickyAbortBtn.onclick = doAbort;

    try{
      const checkedEpoch = Math.floor(Date.now() / 1000);
      currentCheckedEpoch = checkedEpoch;

      if (checkedSeOut) checkedSeOut.textContent = fmtSeEpochSec(checkedEpoch);
      if (checkedUtcOut) checkedUtcOut.textContent = fmtUtcEpochSec(checkedEpoch);

      const id = await sha256Hex(currentFile);
      if (myOp !== opId) return;
      if (!isIdFormat(id)) throw new Error("Det gick inte att skapa ett giltigt kontrollvärde.");

      currentId = id;
      currentLink = buildVerifyLink(id, checkedEpoch, null);

      if (emptyState) emptyState.style.display = "none";
      if (resultBox) resultBox.style.display = "block";

      if (localIdBox) localIdBox.style.display = "block";
      if (localIdOut) localIdOut.textContent = id;

      copyTextToClipboard(id).then((ok) => {
        if (ok) {
          showPill(copyIdPill, "Kontrollvärde kopierat");
          setTimeout(() => hidePill(copyIdPill), 1200);
        }
      });

      idOut.textContent = id;
      linkOut.textContent = currentLink;
      linkOut.href = currentLink;

      if (qrTap) qrTap.style.display = "grid";
      requestAnimationFrame(() => renderQr(qrBox, currentLink));

      applyCopyHover(idOut, copyIdIconBtn, true);
      applyCopyHover(linkOut, copyLinkIconBtn, true);

      attachLongPressCopyOnce(linkOut, () => currentLink, async () => {
        await copyWithFeedback({ text: currentLink, pillEl: copyLinkPill, okText: "Länk kopierad ✅" });
      });
      attachQrCopyOnce(qrTap, () => currentLink, copyLinkPill);

      setPill("Skickar registrering…");
      regStatusOut.textContent = "Inskickad – ej bekräftad";
      markHeadline("warn", "Inskickad – ej bekräftad");

      const reg = await safeRegisterRequest(id);
      if (myOp !== opId) return;

      if (!reg.ok){
        throw new Error("Registreringen kunde inte skickas in just nu. Kontrollvärde och länkar är skapade lokalt. Försök igen senare.");
      }

      const data = reg.data || {};
      applyStatusToUI({ id, checkedEpoch, data });

      const txHash = data?.submission?.txHash || null;
      if (txHash) {
        pollTxHash = txHash;
        currentLink = buildVerifyLink(id, checkedEpoch, txHash);

        linkOut.textContent = currentLink;
        linkOut.href = currentLink;

        if (qrTap) qrTap.style.display = "grid";
        requestAnimationFrame(() => renderQr(qrBox, currentLink));

        pollTxAndVerify(myOp, id, txHash, checkedEpoch);
      } else {
        debugOut.textContent = debugOut.textContent || "Registreringsreferens kunde inte visas. Du kan verifiera igen senare.";
      }

      setPill("Klart ✅");
      setBusy(false);
      syncSticky();

    } catch (e){
      if (myOp !== opId) return;

      if (errorBox) errorBox.style.display = "block";
      if (errorMsg) errorMsg.textContent = (e?.message || "Tillfälligt fel. Kontrollvärde/länk kan vara skapade lokalt.");

      if (currentId && currentLink){
        if (resultBox) resultBox.style.display = "block";
        if (emptyState) emptyState.style.display = "none";

        regStatusOut.textContent = "Kunde inte kontrolleras";
        timeOut.textContent = "—";
        markHeadline("err", "Kunde inte kontrolleras");

        lastProofyStatusCode = "UNKNOWN";
        updateReceiptLabel();

        if (qrTap) qrTap.style.display = "grid";
        requestAnimationFrame(() => renderQr(qrBox, currentLink));
        attachQrCopyOnce(qrTap, () => currentLink, copyLinkPill);

        const checkedEpoch = currentCheckedEpoch || Math.floor(Date.now()/1000);
        applyStatusToUI({
          id: currentId,
          checkedEpoch,
          data: { statusCode:"UNKNOWN" }
        });
      }

      setPill("Klart (lokalt) ✅");
      setBusy(false);
      syncSticky();
    }
  }

  // ✅ Setup: observe when primary buttons are visible to decide sticky
  function setupStickyObservers(){
    try{
      if (!("IntersectionObserver" in window)) { ioReady = false; return; }

      const targets = [];
      if (receiptBtn) targets.push({ el: receiptBtn, key: "receipt" });
      if (copyNoteBtn) targets.push({ el: copyNoteBtn, key: "note" });

      if (!targets.length) { ioReady = false; return; }

      const io = new IntersectionObserver((entries) => {
        for (const entry of entries){
          const id = entry.target && entry.target.id;
          const isIn = !!entry.isIntersecting && entry.intersectionRatio >= 0.55;

          if (id === "receiptBtn") receiptInView = isIn;
          if (id === "copyNoteBtn") noteInView = isIn;
        }
        syncSticky();
      }, { threshold: [0, 0.25, 0.55, 0.8] });

      for (const t of targets) io.observe(t.el);

      ioReady = true;
      syncSticky();
    }catch{
      ioReady = false;
    }
  }

  if (localIdOut){
    localIdOut.addEventListener("click", async () => {
      await copyWithFeedback({ text: localIdOut.textContent, pillEl: copyIdPill, okText:"Kopierat ✅" });
    });
    localIdOut.addEventListener("keydown", async (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        await copyWithFeedback({ text: localIdOut.textContent, pillEl: copyIdPill, okText:"Kopierat ✅" });
      }
    });
  }

  if (idOut){
    idOut.addEventListener("click", async () => {
      await copyWithFeedback({ text: idOut.textContent, pillEl: copyIdPill2, okText:"Kopierat ✅" });
    });
    idOut.addEventListener("keydown", async (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        await copyWithFeedback({ text: idOut.textContent, pillEl: copyIdPill2, okText:"Kopierat ✅" });
      }
    });
  }

  if (copyIdIconBtn){
    copyIdIconBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      e.stopPropagation();
      await copyWithFeedback({ text: idOut.textContent, pillEl: copyIdPill2, okText:"Kopierat ✅" });
    });
  }

  if (copyLinkIconBtn){
    copyLinkIconBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      e.stopPropagation();
      await copyWithFeedback({ text: linkOut.textContent, pillEl: copyLinkPill, okText:"Länk kopierad ✅" });
    });
  }

  if (copyNoteBtn){
    copyNoteBtn.addEventListener("click", async () => {
      if (!lastRun) return;
      await copyWithFeedback({ text: buildNote(lastRun), pillEl: copyNotePill, okText:"Notering kopierad ✅" });
      syncSticky();
    });
  }

  if (downloadNoteLink){
    downloadNoteLink.addEventListener("click", () => {
      if (!lastRun) return;
      downloadTextFile("proofy-notering.txt", buildNote(lastRun));
      showPill(copyNotePill, "Nerladdad ✅");
      setTimeout(() => hidePill(copyNotePill), 1200);
      syncSticky();
    });
  }

  fileInput.addEventListener("change", () => {
    setFile(fileInput.files?.[0] || null);
  });

  dropZone.addEventListener("click", () => fileInput.click());
  dropZone.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      fileInput.click();
    }
  });

  dropZone.addEventListener("dragover", (e) => { e.preventDefault(); dropZone.classList.add("drag"); });
  dropZone.addEventListener("dragleave", () => dropZone.classList.remove("drag"));
  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("drag");
    const f = e.dataTransfer?.files?.[0];
    if (f) setFile(f);
  });

  function setManualState(id){
    const clean = (id || "").trim();
    if (!/^0x[0-9a-fA-F]{64}$/.test(clean)){
      manualCurrentLink = null;
      manualLinkOut.textContent = "—";
      manualLinkOut.href = "#";
      manualQrBox.innerHTML = "";
      if (manualQrTap) manualQrTap.style.display = "none";
      setManualPill(clean ? "Ogiltigt ID" : "Klistra in ID");
      return null;
    }

    const checkedEpoch = Math.floor(Date.now() / 1000);
    const link = buildVerifyLink(clean, checkedEpoch, null);
    manualCurrentLink = link;

    manualLinkOut.textContent = link;
    manualLinkOut.href = link;

    if (manualQrTap) manualQrTap.style.display = "grid";
    requestAnimationFrame(() => renderQr(manualQrBox, link));

    setManualPill("Redo ✅");
    return link;
  }

  attachLongPressCopyOnce(manualLinkOut, () => manualCurrentLink, async () => {
    if (!manualCurrentLink) return;
    setManualPill("Länk kopierad ✅");
    setTimeout(() => setManualPill("Redo ✅"), 1200);
  });
  attachQrCopyOnce(manualQrTap, () => manualCurrentLink, manualPill);

  manualId.addEventListener("input", () => setManualState(manualId.value));

  resetReport();
  setFile(null);
  setBusy(false);
  setManualState("");
  setupStickyObservers();
  syncSticky();
})();
</script>

<script src="/assets/header-toggle.js?v=2026-01-03a" defer></script>
<script src="/chat-widget.js?v=2026-01-03a" defer></script>
</body>
</html>
