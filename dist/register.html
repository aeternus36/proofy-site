<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proofy – Skapa Verifierings-ID</title>
  <meta name="description" content="Skapa ett Verifierings-ID för en filversion lokalt i webbläsaren. Filen lämnar aldrig din dator." />
  <meta name="theme-color" content="#0b1220" />

  <link rel="stylesheet" href="/assets/proofy.css?v=2026-01-02a" />
  <link rel="stylesheet" href="/assets/header.css?v=2026-01-02a" />
</head>

<body>
<a class="skip" href="#main">Hoppa till innehåll</a>

<header>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="/" aria-label="Proofy">
        <span class="logo" aria-hidden="true"></span>
        <span>Proofy</span>
      </a>

      <div class="navActions" id="navActionsDesktop">
        <a class="btn" href="/register.html" aria-current="page">Skapa Verifierings-ID</a>
        <a class="btn soft" href="/verify.html">Verifiera underlag</a>
        <a class="btn soft" href="/pilot.html">Starta pilot</a>
        <a class="btn primary" href="/#kontakt">Boka kort demo</a>
      </div>

      <details class="mnav" id="mnav">
        <summary class="mnavSummary" aria-label="Öppna meny">
          <span class="mnavIcon" aria-hidden="true"></span>
        </summary>

        <nav class="mnavMenu" aria-label="Meny">
          <a class="mnavLink" href="/register.html" aria-current="page">Skapa Verifierings-ID</a>
          <a class="mnavLink" href="/verify.html">Verifiera underlag</a>
          <a class="mnavLink" href="/pilot.html">Starta pilot</a>
          <a class="mnavLink mnavLinkPrimary" href="/#kontakt">Boka kort demo</a>

          <div class="mnavMeta">
            <div class="mnavNote">Verifiering · revision · granskning</div>
            <a class="mnavMail" href="mailto:kontakt@proofy.se">kontakt@proofy.se</a>
          </div>
        </nav>
      </details>
    </div>
  </div>
</header>

<main id="main">
  <div class="wrap">
    <div class="badge">Verifiering · revision · granskning</div>

    <h1 class="pageTitle">Skapa Verifierings-ID</h1>

    <p class="lead">
      Skapa ett Verifierings-ID för den filversion som ska vara <b>referens</b> i ärendet.
      <strong>Underlaget lämnar aldrig din dator.</strong>
    </p>

    <div class="card content" style="margin-top:14px;">
      <div class="grid2">

        <!-- LEFT -->
        <section aria-label="Skapa via fil">
          <div style="font-weight:950; font-size:16px;">1. Välj referensunderlag</div>

          <label for="fileInput" class="btn primary" style="display:inline-flex; margin-top:10px; cursor:pointer;">
            Välj referensunderlag (fil)
          </label>
          <input id="fileInput" type="file" style="display:none;" />

          <div id="dropZone" class="drop" style="margin-top:10px;">
            Dra &amp; släpp underlag här
          </div>

          <div id="fileInfo"
               class="meta"
               style="margin-top:10px; padding:10px 12px; border-radius:12px; border:1px dashed rgba(255,255,255,.25); background:rgba(255,255,255,.04);">
            Inget underlag valt.
          </div>

          <div class="actions" style="margin-top:14px;">
            <button class="btn primary" id="createBtn" disabled>Skapa &amp; registrera</button>
            <button class="btn" id="copyIdBtn" disabled>Kopiera ID</button>
            <button class="btn" id="copyLinkBtn" disabled>Kopiera länk</button>
            <a class="btn soft" id="openVerifyBtn" href="/verify.html" style="pointer-events:none; opacity:.55;">Öppna verifiering</a>
            <a class="btn soft" id="receiptBtn" href="#" target="_blank" rel="noopener" style="display:none;">Öppna intyg</a>

            <span id="statusPill" class="pill">Välj underlag</span>
          </div>

          <div id="localIdBox" style="display:none; margin-top:12px;">
            <div class="meta">Verifierings-ID (för din notering i ärendet)</div>

            <div id="localIdOut"
                 class="mono"
                 tabindex="0"
                 role="button"
                 aria-label="Verifierings-ID (klicka för att kopiera)"
                 title="Klicka för att kopiera"
                 style="
                   margin-top:8px;
                   padding:10px 12px;
                   border-radius:12px;
                   border:1px solid rgba(255,255,255,.14);
                   background:rgba(255,255,255,.03);
                   cursor:pointer;
                   user-select:text;
                 ">—</div>

            <span id="copyIdPill" class="pill" style="display:none; margin-top:8px;"></span>
          </div>

          <p class="small" style="margin-top:12px; margin-bottom:0;">
            Alla filtyper stöds (t.ex. PDF, Excel, bilder, ZIP).<br />
            <b>Obs:</b> Ny export/omskanning/konvertering kan ge annan filversion även om dokumentet “ser likadant ut”.
          </p>
        </section>

        <!-- RIGHT -->
        <section aria-label="Registreringsrapport">
          <div style="display:flex; align-items:baseline; justify-content:space-between; gap:12px;">
            <div style="font-weight:950; font-size:16px;">2. Registreringsrapport</div>
            <div class="meta" id="reportMeta" style="opacity:.85; display:none;">Rapport</div>
          </div>

          <div class="hr"></div>

          <!-- Empty state (visas innan ID finns) -->
          <div id="emptyState"
               style="
                 border:1px solid rgba(255,255,255,.10);
                 background: rgba(255,255,255,.03);
                 border-radius: 16px;
                 padding: 12px 14px;
               ">
            <div style="font-weight:950; margin-bottom:6px;">Så fungerar det i en byråprocess</div>
            <div class="small">
              1) Välj filversionen som ska vara <b>referens</b>.<br/>
              2) Proofy skapar ett Verifierings-ID lokalt (ingen uppladdning).<br/>
              3) Du får en delbar länk + QR för att dela till kollega/klient/akt.<br/><br/>
              <b>QR är för att skanna med en annan enhet.</b> På samma mobil är det normalt svårt/omöjligt att “scanna sin egen skärm” med kameran.
            </div>
          </div>

          <div id="resultBox" style="display:none; margin-top:12px;">
            <div id="headline"
                 style="font-size:18px; font-weight:950; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.05);">
            </div>

            <div style="margin-top:12px;">
              <div class="meta">Verifierings-ID</div>
              <div style="position:relative; margin-top:6px;">
                <button type="button" id="copyIdIconBtn" aria-label="Kopiera Verifierings-ID" title="Kopiera"
                        style="display:none; position:absolute; top:6px; right:6px; width:34px; height:30px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); cursor:pointer;">
                  <span aria-hidden="true" style="display:block; font-size:15px; line-height:28px;">⧉</span>
                </button>

                <div id="idOut"
                     class="mono"
                     tabindex="0"
                     role="button"
                     title="Klicka för att kopiera"
                     aria-label="Verifierings-ID (klicka för att kopiera)"
                     style="
                       padding:10px 12px;
                       border-radius:12px;
                       border:1px solid rgba(255,255,255,.14);
                       background:rgba(255,255,255,.03);
                       cursor:pointer;
                       padding-right:52px;
                       user-select:text;
                     ">—</div>

                <span id="copyIdPill2" class="pill" style="display:none; margin-top:8px;"></span>
              </div>

              <div class="meta" style="margin-top:12px;">Delbar verifieringslänk</div>

              <div style="position:relative; margin-top:6px;">
                <button type="button" id="copyLinkIconBtn" aria-label="Kopiera länk" title="Kopiera"
                        style="display:none; position:absolute; top:6px; right:6px; width:34px; height:30px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); cursor:pointer;">
                  <span aria-hidden="true" style="display:block; font-size:15px; line-height:28px;">⧉</span>
                </button>

                <a id="linkOut"
                   class="mono"
                   href="#"
                   target="_blank"
                   rel="noopener"
                   title="Tryck för att öppna · Långtryck för att kopiera"
                   aria-label="Delbar verifieringslänk"
                   style="
                     display:block;
                     padding:10px 12px;
                     border-radius:12px;
                     border:1px solid rgba(255,255,255,.14);
                     background:rgba(255,255,255,.03);
                     cursor:pointer;
                     padding-right:52px;
                     user-select:text;
                     text-decoration:none;
                   ">—</a>

                <span id="copyLinkPill" class="pill" style="display:none; margin-top:8px;"></span>
              </div>

              <div class="hr" style="margin-top:14px;"></div>

              <div class="qrWrap" style="margin-top:12px;">
                <div>
                  <div class="meta" style="margin-bottom:8px;">QR-kod (för skanning)</div>

                  <!-- Klick kopierar länk. Skanning sker med annan enhet -->
                  <div id="qrTap"
                       role="button"
                       tabindex="0"
                       aria-label="QR-kod (klicka för att kopiera verifieringslänk)"
                       title="Klicka för att kopiera verifieringslänk"
                       style="
                         display:inline-block;
                         border-radius:16px;
                         padding:12px;              /* extra luft utanför QR */
                         background:#ffffff;        /* max scannability */
                         border:1px solid rgba(255,255,255,.14);
                         cursor:pointer;
                         max-width: 100%;
                       ">
                    <div id="qrBox" class="qrBox" aria-label="QR-kod"></div>
                  </div>

                  <div class="small" style="margin-top:8px; opacity:.9; max-width:48ch;">
                    Skanna QR med <b>en annan enhet</b> (t.ex. klient/kollega).
                    Klick på QR kopierar länken till urklipp.
                  </div>
                </div>

                <div style="min-width:240px; flex:1;">
                  <div class="meta">Registreringsstatus</div>
                  <div id="regStatusOut" class="mono" style="margin-top:8px;">—</div>

                  <div class="meta" style="margin-top:10px;">Registreringstid</div>
                  <div id="timeOut" class="mono" style="margin-top:8px;">—</div>

                  <div class="actions" style="margin-top:12px;">
                    <button class="btn" id="copyNoteBtn" type="button" style="display:none;">Kopiera registreringsnotering</button>
                    <span id="copyNotePill" class="pill" style="display:none;"></span>
                  </div>

                  <details style="margin-top:12px;">
                    <summary>Tekniska detaljer (valfritt)</summary>
                    <p class="small" style="margin:10px 0 8px; opacity:.95;">
                      Behövs normalt inte i ärendet, men kan hjälpa vid felsökning.
                    </p>

                    <div class="hr"></div>

                    <div class="meta">Teknisk referens (tx)</div>
                    <div id="txOut" class="mono" style="margin-top:8px;">—</div>

                    <div class="meta" style="margin-top:10px;">Teknisk identitet</div>
                    <div id="submitterOut" class="mono" style="margin-top:8px;">—</div>

                    <div class="meta" style="margin-top:10px;">Felsvar (om något)</div>
                    <div id="debugOut" class="mono" style="margin-top:8px;">—</div>
                  </details>
                </div>
              </div>
            </div>
          </div>

          <div id="errorBox" style="display:none; margin-top:12px;">
            <div class="err">Tillfälligt tekniskt problem</div>
            <div id="errorMsg" class="mono" style="margin-top:8px;"></div>
          </div>
        </section>

      </div>
    </div>

    <!-- Manual -->
    <section style="margin-top:14px;">
      <div class="card content">
        <h2 style="margin:0 0 8px; font-size:18px;">Har du redan ett Verifierings-ID?</h2>
        <p class="meta" style="margin:0 0 10px;">
          Klistra in ett Verifierings-ID så skapar vi delbar länk och QR direkt.
        </p>

        <div class="grid2">
          <div>
            <label class="meta" for="manualId">Verifierings-ID</label>
            <input id="manualId" type="text" placeholder="0x…" autocomplete="off" spellcheck="false" style="margin-top:8px" />

            <div class="actions" style="margin-top:12px;">
              <button class="btn" id="manualBuildBtn" type="button">Skapa länk &amp; QR</button>
              <button class="btn" id="manualCopyLinkBtn" type="button" disabled>Kopiera länk</button>
              <a class="btn soft" id="manualVerifyBtn" href="/verify.html" style="pointer-events:none;opacity:.55;">Öppna verifiering</a>
              <span id="manualPill" class="pill">Klistra in ID</span>
            </div>
          </div>

          <div>
            <div class="meta">Delbar verifieringslänk</div>

            <a id="manualLinkOut"
               class="mono"
               href="#"
               target="_blank"
               rel="noopener"
               title="Tryck för att öppna · Långtryck för att kopiera"
               style="
                 display:block;
                 margin-top:8px;
                 padding:10px 12px;
                 border-radius:12px;
                 border:1px solid rgba(255,255,255,.14);
                 background:rgba(255,255,255,.03);
                 text-decoration:none;
               ">—</a>

            <div class="qrWrap" style="margin-top:12px;">
              <div>
                <div class="meta" style="margin-bottom:8px;">QR-kod (för skanning)</div>

                <div id="manualQrTap"
                     role="button"
                     tabindex="0"
                     aria-label="QR-kod manuell (klicka för att kopiera verifieringslänk)"
                     title="Klicka för att kopiera verifieringslänk"
                     style="
                       display:inline-block;
                       border-radius:16px;
                       padding:12px;
                       background:#ffffff;
                       border:1px solid rgba(255,255,255,.14);
                       cursor:pointer;
                       max-width: 100%;
                     ">
                  <div id="manualQrBox" class="qrBox" aria-label="QR-kod (manuell)"></div>
                </div>
              </div>
              <div style="min-width:240px; flex:1;">
                <div class="small" style="margin-top:0;">
                  Bra när du fått ett ID i en notering och vill dela en länk snabbt.
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="hr"></div>
        <p class="small" style="margin:0;">
          Proofy lagrar inte dokument. Verifiering bygger på att jämföra filversioner mot en registrerad referens.
        </p>
      </div>
    </section>

    <p class="meta" style="margin-top:14px">
      Proofy lagrar inte dokument. Verifiering bygger på att jämföra filversioner mot en registrerad referens.
    </p>
  </div>
</main>

<footer>
  <div class="wrap">
    <div class="foot">
      <div>
        <div style="color: rgba(234,240,255,.86); font-weight:800;">Proofy</div>
        <div class="small">© 2026 Proofy. Alla rättigheter förbehållna.</div>
        <div class="small" style="margin-top:8px; max-width:92ch;">
          Proofy tillhandahåller teknisk tidsstämpling och verifiering av filer. Tjänsten utgör inte juridisk rådgivning och avgör inte filens rättsliga giltighet.
        </div>
      </div>
      <div class="links">
        <a href="/security.html">Säkerhet</a>
        <a href="/privacy.html">Integritet</a>
        <a href="/terms.html">Villkor</a>
        <a href="/#kontakt">Kontakt</a>
      </div>
    </div>
  </div>
</footer>

<!-- QR-lib -->
<script src="/assets/qr.min.js?v=2026-01-02a"></script>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const fileInput = $("fileInput");
  const dropZone = $("dropZone");
  const fileInfo = $("fileInfo");

  const createBtn = $("createBtn");
  const copyIdBtn = $("copyIdBtn");
  const copyLinkBtn = $("copyLinkBtn");
  const openVerifyBtn = $("openVerifyBtn");
  const receiptBtn = $("receiptBtn");
  const statusPill = $("statusPill");

  const localIdBox = $("localIdBox");
  const localIdOut = $("localIdOut");
  const copyIdPill = $("copyIdPill");

  const emptyState = $("emptyState");
  const reportMeta = $("reportMeta");
  const resultBox = $("resultBox");
  const headline = $("headline");
  const idOut = $("idOut");
  const linkOut = $("linkOut");
  const qrTap = $("qrTap");
  const qrBox = $("qrBox");
  const regStatusOut = $("regStatusOut");
  const timeOut = $("timeOut");
  const submitterOut = $("submitterOut");
  const txOut = $("txOut");
  const debugOut = $("debugOut");
  const copyIdIconBtn = $("copyIdIconBtn");
  const copyIdPill2 = $("copyIdPill2");
  const copyLinkIconBtn = $("copyLinkIconBtn");
  const copyLinkPill = $("copyLinkPill");
  const copyNoteBtn = $("copyNoteBtn");
  const copyNotePill = $("copyNotePill");

  const errorBox = $("errorBox");
  const errorMsg = $("errorMsg");

  const manualId = $("manualId");
  const manualBuildBtn = $("manualBuildBtn");
  const manualCopyLinkBtn = $("manualCopyLinkBtn");
  const manualVerifyBtn = $("manualVerifyBtn");
  const manualPill = $("manualPill");
  const manualLinkOut = $("manualLinkOut");
  const manualQrTap = $("manualQrTap");
  const manualQrBox = $("manualQrBox");

  let currentFile = null;
  let currentId = null;
  let currentLink = null;
  let busy = false;
  let opId = 0;
  let lastRun = null;

  function setPill(text){ statusPill.textContent = text; }
  function setManualPill(text){ manualPill.textContent = text; }

  function hidePill(p){
    if (!p) return;
    p.style.display = "none";
    p.textContent = "";
  }
  function showPill(p, text){
    if (!p) return;
    p.style.display = "inline-block";
    p.textContent = text;
  }

  function setBusy(v){
    busy = v;
    createBtn.disabled = !currentFile || busy;
    copyIdBtn.disabled = !currentId || busy;
    copyLinkBtn.disabled = !currentLink || busy;

    if (openVerifyBtn){
      if (currentLink && !busy){
        openVerifyBtn.href = currentLink;
        openVerifyBtn.style.pointerEvents = "auto";
        openVerifyBtn.style.opacity = "1";
      } else {
        openVerifyBtn.href = "/verify.html";
        openVerifyBtn.style.pointerEvents = "none";
        openVerifyBtn.style.opacity = ".55";
      }
    }
  }

  function resetReport(){
    if (resultBox) resultBox.style.display = "none";
    if (reportMeta) reportMeta.style.display = "none";
    if (errorBox) errorBox.style.display = "none";
    if (errorMsg) errorMsg.textContent = "";
    if (headline) headline.textContent = "";
    if (idOut) idOut.textContent = "—";
    if (linkOut) linkOut.textContent = "—";
    if (linkOut) linkOut.href = "#";
    if (qrBox) qrBox.innerHTML = "";
    if (regStatusOut) regStatusOut.textContent = "—";
    if (timeOut) timeOut.textContent = "—";
    if (submitterOut) submitterOut.textContent = "—";
    if (txOut) txOut.textContent = "—";
    if (debugOut) debugOut.textContent = "—";
    if (receiptBtn) receiptBtn.style.display = "none";
    if (copyIdIconBtn) copyIdIconBtn.style.display = "none";
    if (copyLinkIconBtn) copyLinkIconBtn.style.display = "none";
    hidePill(copyIdPill);
    hidePill(copyIdPill2);
    hidePill(copyLinkPill);
    hidePill(copyNotePill);
    if (copyNoteBtn) copyNoteBtn.style.display = "none";
    lastRun = null;

    if (emptyState) emptyState.style.display = "block";
  }

  function bytesToHex(bytes){
    return [...bytes].map(b => b.toString(16).padStart(2,"0")).join("");
  }

  async function sha256Hex(file){
    const buf = await file.arrayBuffer();
    const dig = await crypto.subtle.digest("SHA-256", buf);
    return "0x" + bytesToHex(new Uint8Array(dig));
  }

  function isIdFormat(v){
    return typeof v === "string" && /^0x[0-9a-fA-F]{64}$/.test(v.trim());
  }

  function buildVerifyLink(hash){
    return `${location.origin}/verify.html?hash=${encodeURIComponent(hash)}`;
  }

  async function copyTextToClipboard(text){
    const t = String(text || "").trim();
    if (!t || t === "—") return false;

    try{
      await navigator.clipboard.writeText(t);
      return true;
    } catch {
      try{
        const ta = document.createElement("textarea");
        ta.value = t;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        ta.style.top = "0";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        const ok = document.execCommand("copy");
        document.body.removeChild(ta);
        return !!ok;
      } catch {
        return false;
      }
    }
  }

  async function copyWithFeedback({ text, pillEl, okText = "Kopierad ✓", failText = "Kunde inte kopiera" }){
    showPill(pillEl, "Kopierar…");
    const ok = await copyTextToClipboard(text);
    showPill(pillEl, ok ? okText : failText);
    setTimeout(() => hidePill(pillEl), 1400);
    return ok;
  }

  function applyCopyHover(fieldEl, iconBtnEl, enabled){
    if (!fieldEl) return;

    if (!enabled){
      fieldEl.onmouseenter = null;
      fieldEl.onmouseleave = null;
      fieldEl.onfocus = null;
      fieldEl.onblur = null;
      if (iconBtnEl) iconBtnEl.style.display = "none";
      return;
    }

    const onEnter = () => {
      if (iconBtnEl) iconBtnEl.style.display = "inline-flex";
      fieldEl.style.outline = "1px solid rgba(255,255,255,.14)";
      fieldEl.style.outlineOffset = "2px";
      fieldEl.style.background = "rgba(255,255,255,.05)";
    };

    const onLeave = () => {
      if (iconBtnEl) iconBtnEl.style.display = "none";
      fieldEl.style.outline = "";
      fieldEl.style.outlineOffset = "";
      fieldEl.style.background = "rgba(255,255,255,.03)";
    };

    fieldEl.onmouseenter = onEnter;
    fieldEl.onmouseleave = onLeave;

    fieldEl.onfocus = () => {
      if (iconBtnEl) iconBtnEl.style.display = "inline-flex";
      fieldEl.style.outline = "2px solid rgba(120, 180, 255, .25)";
      fieldEl.style.outlineOffset = "2px";
    };
    fieldEl.onblur = () => onLeave();
  }

  function attachLongPressCopy(el, getText, onCopied){
    if (!el) return;

    let t = null;
    let longPressed = false;

    const start = (e) => {
      longPressed = false;
      t = setTimeout(async () => {
        longPressed = true;
        e.preventDefault();
        const ok = await copyTextToClipboard(getText());
        if (ok && onCopied) onCopied();
      }, 450);
    };

    const end = () => {
      if (t) clearTimeout(t);
      t = null;
    };

    el.addEventListener("touchstart", start, { passive: false });
    el.addEventListener("touchend", end);
    el.addEventListener("touchcancel", end);

    el.addEventListener("mousedown", start);
    el.addEventListener("mouseup", end);
    el.addEventListener("mouseleave", end);

    el.addEventListener("click", (e) => {
      if (longPressed) {
        e.preventDefault();
        e.stopPropagation();
      }
    });
  }

  function showQrError(targetEl){
    if (!targetEl) return;
    targetEl.innerHTML = `<div class="meta">QR-koden kunde inte renderas.</div>`;
  }

  /*
    QR FIX (kritisk):
    - Bygg QR med hög felkorrigering (H)
    - Säkerställ 1:1 pixlar (ingen CSS-skalning)
    - Lägg riktig quiet zone (4 moduler) i själva bilden
    - Välj storlek som ger heltals-pixlar per modul => inga moiré/diagonaler
  */
  function renderQr(targetEl, text){
    try{
      if (!targetEl) return;
      targetEl.innerHTML = "";

      if (typeof window.QRCode !== "function"){
        showQrError(targetEl);
        return;
      }

      const container = targetEl.parentElement; // qrTap/manualQrTap
      const containerWidth = container ? container.clientWidth : 320;

      // Vi vill att QR ska få plats utan att behöva CSS-skala canvas.
      // Inre QR (utan quiet zone) ca 200–260 px beroende på utrymme.
      const paddingAround = 24; // ungefär (qrTap har 12px padding på båda sidor)
      const maxInner = Math.max(180, Math.min(260, (containerWidth - paddingAround) || 240));
      const quietModules = 4;

      // Först: rendera QR med innerSize. Libraryn ritar canvas exakt innerSize x innerSize.
      const tmp = document.createElement("div");
      const qr = new window.QRCode(tmp);

      if (qr._htOption){
        qr._htOption.width = maxInner;
        qr._htOption.height = maxInner;
        qr._htOption.colorDark = "#0b1220";
        qr._htOption.colorLight = "#ffffff";
        qr._htOption.typeNumber = 0; // auto
        if (window.QRCodeCorrectLevel && window.QRCodeCorrectLevel.H !== undefined){
          qr._htOption.correctLevel = window.QRCodeCorrectLevel.H;
        }
      }

      qr.makeCode(text);

      const innerCanvas = tmp.querySelector("canvas");
      if (!innerCanvas) {
        showQrError(targetEl);
        return;
      }

      // Läs modulcount från QR-objektet (finns på _oQRCode)
      const moduleCount = qr._oQRCode && typeof qr._oQRCode.getModuleCount === "function"
        ? qr._oQRCode.getModuleCount()
        : null;

      if (!moduleCount) {
        // Fallback: använd innerCanvas direkt men pixel-perfekt
        innerCanvas.style.width = innerCanvas.width + "px";
        innerCanvas.style.height = innerCanvas.height + "px";
        targetEl.appendChild(innerCanvas);
        return;
      }

      // Viktigt: välj cellSize som HELTAL => undvik aliasing/moiré.
      // innerCanvas.width är vad libraryn ritade till (bör vara maxInner men kan bli exakt).
      const rawInner = innerCanvas.width;
      const cellSize = Math.max(3, Math.floor(rawInner / moduleCount)); // min 3 px/modul
      const snappedInner = cellSize * moduleCount;

      // Quiet zone i px
      const quietPx = quietModules * cellSize;
      const outSize = snappedInner + (quietPx * 2);

      // Om outSize riskerar overflow på små skärmar, minska cellSize tills det ryms
      const maxTotal = Math.max(200, Math.min(340, (containerWidth - 2) || outSize));
      let finalCell = cellSize;
      let finalOut = outSize;
      while (finalOut > maxTotal && finalCell > 2){
        finalCell -= 1;
        const si = finalCell * moduleCount;
        const qp = quietModules * finalCell;
        finalOut = si + (qp * 2);
      }

      const finalInner = finalCell * moduleCount;
      const finalQuiet = quietModules * finalCell;

      // Rita om: vit bakgrund + skalad inner QR med nearest-neighbor (ingen smoothing)
      const out = document.createElement("canvas");
      out.width = finalOut;
      out.height = finalOut;

      const ctx = out.getContext("2d", { alpha: false });
      ctx.imageSmoothingEnabled = false;

      // vit bakgrund
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, finalOut, finalOut);

      // Skala innerCanvas till finalInner (integer-multipel) och placera med quiet zone
      ctx.drawImage(innerCanvas, 0, 0, rawInner, rawInner, finalQuiet, finalQuiet, finalInner, finalInner);

      // Viktigt: sätt explicita CSS-dimensioner = pixelperfekt 1:1
      out.style.width = finalOut + "px";
      out.style.height = finalOut + "px";
      out.style.display = "block";

      targetEl.appendChild(out);
    } catch (e){
      console.error("QR render error:", e);
      showQrError(targetEl);
    }
  }

  function buildNote(run){
    if (!run) return "—";
    const lines = [];
    lines.push("PROOFY – Registreringsnotering");
    lines.push("");
    lines.push(`Verifierings-ID: ${run.id || "—"}`);
    lines.push(`Delbar verifieringslänk: ${run.link || "—"}`);
    lines.push(`Status: ${run.statusLine || "—"}`);
    if (run.timeSe) lines.push(`Registreringstid: ${run.timeSe}`);
    if (run.txHash) lines.push(`Tx: ${run.txHash}`);
    lines.push("");
    lines.push(`Tidpunkt: ${new Date().toLocaleString("sv-SE")}`);
    return lines.join("\n");
  }

  function setFile(file){
    currentFile = file || null;
    currentId = null;
    currentLink = null;

    resetReport();

    if (localIdBox) localIdBox.style.display = "none";
    if (localIdOut) localIdOut.textContent = "—";
    hidePill(copyIdPill);

    if (!currentFile){
      fileInfo.textContent = "Inget underlag valt.";
      setPill("Välj underlag");
      setBusy(false);
      return;
    }

    fileInfo.textContent =
      `Valt underlag: ${currentFile.name} (${(currentFile.size/1024/1024).toFixed(2)} MB)`;

    setPill("Redo att skapa");
    setBusy(false);
  }

  fileInput.addEventListener("change", () => setFile(fileInput.files?.[0] || null));

  dropZone.addEventListener("dragover", (e) => { e.preventDefault(); dropZone.classList.add("drag"); });
  dropZone.addEventListener("dragleave", () => dropZone.classList.remove("drag"));
  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("drag");
    const f = e.dataTransfer?.files?.[0];
    if (f) setFile(f);
  });

  if (localIdOut){
    localIdOut.addEventListener("click", async () => {
      await copyWithFeedback({ text: localIdOut.textContent, pillEl: copyIdPill });
    });
    localIdOut.addEventListener("keydown", async (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        await copyWithFeedback({ text: localIdOut.textContent, pillEl: copyIdPill });
      }
    });
  }

  if (idOut){
    idOut.addEventListener("click", async () => {
      await copyWithFeedback({ text: idOut.textContent, pillEl: copyIdPill2 });
    });
    idOut.addEventListener("keydown", async (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        await copyWithFeedback({ text: idOut.textContent, pillEl: copyIdPill2 });
      }
    });
  }

  if (copyIdIconBtn){
    copyIdIconBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      e.stopPropagation();
      await copyWithFeedback({ text: idOut.textContent, pillEl: copyIdPill2 });
    });
  }

  if (copyLinkIconBtn){
    copyLinkIconBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      e.stopPropagation();
      await copyWithFeedback({ text: linkOut.textContent, pillEl: copyLinkPill });
    });
  }

  if (copyNoteBtn){
    copyNoteBtn.addEventListener("click", async () => {
      if (!lastRun) return;
      await copyWithFeedback({ text: buildNote(lastRun), pillEl: copyNotePill });
    });
  }

  copyIdBtn.addEventListener("click", async () => {
    if (!currentId) return;
    setPill("Kopierar…");
    const ok = await copyTextToClipboard(currentId);
    setPill(ok ? "ID kopierat ✅" : "Kunde inte kopiera");
    setTimeout(() => setPill(currentFile ? "Redo att skapa" : "Välj underlag"), 1400);
  });

  copyLinkBtn.addEventListener("click", async () => {
    if (!currentLink) return;
    setPill("Kopierar…");
    const ok = await copyTextToClipboard(currentLink);
    setPill(ok ? "Länk kopierad ✅" : "Kunde inte kopiera");
    setTimeout(() => setPill(currentFile ? "Redo att skapa" : "Välj underlag"), 1400);
  });

  function attachQrCopy(qrTapEl, getLink){
    if (!qrTapEl) return;
    const doCopy = async () => {
      const link = getLink();
      if (!link || link === "—") return;
      await copyWithFeedback({ text: link, pillEl: copyLinkPill, okText: "Länk kopierad ✅" });
    };
    // Viktigt: aldrig navigera vid tap
    qrTapEl.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); doCopy(); });
    qrTapEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); e.stopPropagation(); doCopy(); }
    });
  }

  createBtn.addEventListener("click", async () => {
    if (!currentFile || busy) return;

    const myOp = ++opId;
    setBusy(true);
    resetReport();
    setPill("Skapar ID lokalt…");

    try{
      const id = await sha256Hex(currentFile);
      if (myOp !== opId) return;

      if (!isIdFormat(id)) throw new Error("Det gick inte att skapa ett giltigt Verifierings-ID.");

      currentId = id;
      currentLink = buildVerifyLink(id);

      if (emptyState) emptyState.style.display = "none";

      localIdBox.style.display = "block";
      localIdOut.textContent = id;

      resultBox.style.display = "block";
      reportMeta.style.display = "block";

      idOut.textContent = id;
      linkOut.textContent = currentLink;
      linkOut.href = currentLink;

      openVerifyBtn.href = currentLink;
      openVerifyBtn.style.pointerEvents = "auto";
      openVerifyBtn.style.opacity = "1";

      receiptBtn.href = `/certificate.html?hash=${encodeURIComponent(id)}`;
      receiptBtn.style.display = "inline-flex";

      // Rendera pixelperfekt QR
      renderQr(qrBox, currentLink);

      applyCopyHover(idOut, copyIdIconBtn, true);
      applyCopyHover(linkOut, copyLinkIconBtn, true);

      attachLongPressCopy(linkOut, () => currentLink, async () => {
        await copyWithFeedback({ text: currentLink, pillEl: copyLinkPill, okText: "Länk kopierad ✅" });
      });

      attachQrCopy(qrTap, () => currentLink);

      setPill("Registrerar…");
      regStatusOut.textContent = "Registrerar…";
      timeOut.textContent = "—";
      headline.style.borderColor = "rgba(255,255,255,.14)";
      headline.style.background = "rgba(255,255,255,.05)";
      headline.textContent = "⏳ Registrering pågår…";

      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), 30000);

      let res, data;
      try{
        res = await fetch("/api/register", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ hash: id }),
          signal: controller.signal
        });
        data = await res.json().catch(() => ({}));
      } finally {
        clearTimeout(t);
      }

      if (myOp !== opId) return;

      if (!res.ok || data?.ok === false){
        const detail = data?.detail ? ` | ${data.detail}` : "";
        throw new Error((data?.error || `Registreringen misslyckades (HTTP ${res.status}).`) + detail);
      }

      const already = !!data.alreadyExists;
      headline.style.borderColor = "rgba(80,255,180,.20)";
      headline.style.background = "rgba(80,255,180,.06)";
      headline.innerHTML = already
        ? `<span class="ok">✅ Redan registrerad</span> <span class="meta">(du kan använda samma ID)</span>`
        : `<span class="ok">✅ Registrerad</span> <span class="meta">(ny referens skapad)</span>`;

      regStatusOut.textContent = already ? "Redan registrerad" : "Registrerad";

      if (data.timestamp){
        timeOut.textContent = new Date(Number(data.timestamp) * 1000).toLocaleString("sv-SE");
      } else {
        timeOut.textContent = "—";
      }

      txOut.textContent = data.txHash || "—";
      submitterOut.textContent = data.submitter || "—";
      debugOut.textContent = "—";

      if (copyNoteBtn) copyNoteBtn.style.display = "inline-flex";

      lastRun = {
        id,
        link: currentLink,
        statusLine: already ? "Redan registrerad" : "Registrerad",
        timeSe: data.timestamp ? new Date(Number(data.timestamp) * 1000).toLocaleString("sv-SE") : null,
        txHash: data.txHash || null
      };

      setPill("Klart ✅");
      setBusy(false);
    } catch (e){
      console.error(e);
      if (myOp !== opId) return;

      errorBox.style.display = "block";
      errorMsg.textContent = (e?.name === "AbortError")
        ? "Timeout: registreringen tog för lång tid (30s). Försök igen."
        : (e?.message || "Registreringstjänsten kunde inte nås just nu.");

      if (currentId && currentLink){
        resultBox.style.display = "block";
        reportMeta.style.display = "block";
        if (emptyState) emptyState.style.display = "none";

        regStatusOut.textContent = "Fel";
        timeOut.textContent = "—";
        headline.style.borderColor = "rgba(255,80,80,.20)";
        headline.style.background = "rgba(255,80,80,.06)";
        headline.innerHTML = `<span class="err">⚠️ Registrering misslyckades</span> <span class="meta">(se fel längst ner)</span>`;
        debugOut.textContent = errorMsg.textContent;

        renderQr(qrBox, currentLink);
        attachQrCopy(qrTap, () => currentLink);
      }

      setPill("Fel");
      setBusy(false);
    }
  });

  function setManualState(id){
    const clean = (id || "").trim();
    if (!isIdFormat(clean)){
      manualLinkOut.textContent = "—";
      manualLinkOut.href = "#";
      manualQrBox.innerHTML = "";
      manualCopyLinkBtn.disabled = true;
      manualVerifyBtn.href = "/verify.html";
      manualVerifyBtn.style.pointerEvents = "none";
      manualVerifyBtn.style.opacity = ".55";
      setManualPill(clean ? "Ogiltigt ID" : "Klistra in ID");
      return null;
    }

    const link = buildVerifyLink(clean);
    manualLinkOut.textContent = link;
    manualLinkOut.href = link;

    renderQr(manualQrBox, link);

    manualCopyLinkBtn.disabled = false;
    manualVerifyBtn.href = link;
    manualVerifyBtn.style.pointerEvents = "auto";
    manualVerifyBtn.style.opacity = "1";
    setManualPill("Redo ✅");

    attachLongPressCopy(manualLinkOut, () => link, async () => {
      setManualPill("Länk kopierad ✅");
      setTimeout(() => setManualPill("Redo ✅"), 1200);
    });

    // kopiera vid tap, aldrig nav
    if (manualQrTap){
      manualQrTap.onclick = (e) => { e.preventDefault(); e.stopPropagation(); copyTextToClipboard(link); };
    }
    return link;
  }

  manualBuildBtn.addEventListener("click", () => setManualState(manualId.value));
  manualId.addEventListener("input", () => setManualState(manualId.value));

  manualCopyLinkBtn.addEventListener("click", async () => {
    const link = setManualState(manualId.value);
    if (!link) return;
    const ok = await copyTextToClipboard(link);
    setManualPill(ok ? "Länk kopierad ✅" : "Kunde inte kopiera");
    setTimeout(() => setManualPill("Redo ✅"), 1200);
  });

  resetReport();
  setFile(null);
  setBusy(false);
  setManualState("");

  // Om QR renderas innan layout stabiliserats (mobil), rendera om på resize
  let resizeTimer = null;
  window.addEventListener("resize", () => {
    if (!currentLink) return;
    if (resizeTimer) clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      renderQr(qrBox, currentLink);
      const mid = (manualId && manualId.value) ? manualId.value.trim() : "";
      if (isIdFormat(mid)) renderQr(manualQrBox, buildVerifyLink(mid));
    }, 120);
  });
})();
</script>

<script src="/assets/header-toggle.js?v=2026-01-02a" defer></script>
<script src="/chat-widget.js?v=2026-01-02a" defer></script>
</body>
</html>
