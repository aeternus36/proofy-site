<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proofy ‚Äì Skapa Verifierings-ID</title>
  <meta name="description" content="Skapa ett Verifierings-ID f√∂r en filversion lokalt i webbl√§saren. Filen l√§mnar aldrig din dator." />
  <meta name="theme-color" content="#0b1220" />

  <link rel="stylesheet" href="/assets/proofy.css?v=2025-12-24a" />
  <link rel="stylesheet" href="/assets/header.css?v=2025-12-24a" />
</head>

<body>
<a class="skip" href="#main">Hoppa till inneh√•ll</a>

<header>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="/" aria-label="Proofy">
        <span class="logo" aria-hidden="true"></span>
        <span>Proofy</span>
      </a>

      <div class="navActions" id="navActionsDesktop">
        <a class="btn soft" href="/pilot.html">Starta pilot</a>
        <a class="btn" href="/verify.html">Verifiera underlag</a>
        <a class="btn" href="/register.html">Skapa Verifierings-ID</a>
        <a class="btn primary" href="/#kontakt">Boka kort demo</a>
      </div>

      <details class="mnav" id="mnav">
        <summary class="mnavSummary" aria-label="√ñppna meny">
          <span class="mnavIcon" aria-hidden="true"></span>
        </summary>
        <nav class="mnavMenu" aria-label="Meny">
          <a class="mnavLink" href="/pilot.html">Starta pilot</a>
          <a class="mnavLink" href="/verify.html">Verifiera underlag</a>
          <a class="mnavLink" href="/register.html" aria-current="page">Skapa Verifierings-ID</a>
          <a class="mnavLink mnavLinkPrimary" href="/#kontakt">Boka kort demo</a>

          <div class="mnavMeta">
            <div class="mnavNote">F√∂r byr√•er ¬∑ revision ¬∑ granskning</div>
            <a class="mnavMail" href="mailto:kontakt@proofy.se">kontakt@proofy.se</a>
          </div>
        </nav>
      </details>
    </div>
  </div>
</header>

<main id="main">
  <div class="wrap">
    <div class="badge">F√∂r redovisningsbyr√•er ¬∑ revision ¬∑ granskning</div>

    <h1 class="pageTitle">Skapa Verifierings-ID</h1>

    <p class="lead">
      Skapa ett Verifierings-ID f√∂r den filversion som ska vara <b>referens</b> i √§rendet.
      <strong>Underlaget l√§mnar aldrig din dator.</strong>
    </p>

    <div class="card content" style="margin-top:14px;">
      <div class="grid2">

        <!-- V√§nster: input/√•tg√§rd (matchar verify.html‚Äôs ‚ÄúVerifieringsuppgifter‚Äù) -->
        <section aria-label="Skapa Verifierings-ID">
          <div style="font-weight:950; font-size:16px;">1. V√§lj referensunderlag</div>

          <label for="fileInput" class="btn primary" style="display:inline-flex; margin-top:8px; cursor:pointer;">
            V√§lj referensunderlag (fil)
          </label>
          <input id="fileInput" type="file" style="display:none;" />

          <div id="dropZone" class="drop" style="margin-top:10px">Dra &amp; sl√§pp underlag h√§r</div>

          <div id="fileInfo"
               class="meta"
               style="margin-top:10px; padding:10px 12px; border-radius:12px; border:1px dashed rgba(255,255,255,.25); background:rgba(255,255,255,.04);">
            Inget underlag valt.
          </div>

          <div class="hr"></div>

          <div style="font-weight:950; font-size:16px;">2. Skapa &amp; registrera referens</div>

          <div class="actions" style="margin-top:14px; flex-wrap:wrap; gap:10px;">
            <button class="btn primary" id="createBtn" disabled>Skapa &amp; registrera</button>
            <a class="btn soft" id="receiptBtn" href="#" target="_blank" rel="noopener" style="display:none;">√ñppna intyg</a>
            <span id="statusPill" class="pill">F√∂rbered registrering</span>
          </div>

          <!-- verify-like alert (ist√§llet f√∂r fileHint) -->
          <div id="inputAlert"
               role="status"
               aria-live="polite"
               style="display:none; margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06);">
            <div id="inputAlertText" style="font-weight:800;"></div>
            <div id="inputAlertHelp" class="small" style="margin-top:6px; opacity:.95;"></div>
          </div>

          <p class="small" style="margin-top:12px; margin-bottom:0;">
            <b>Tips:</b> Ny export/omskanning/konvertering kan ge annan filversion √§ven om dokumentet ‚Äúser likadant ut‚Äù.
          </p>

          <!-- Beh√•ll tidigare ‚Äúlokal‚Äù ID-box -->
          <div id="localIdBox" style="display:none;margin-top:12px">
            <div class="meta">Verifierings-ID (f√∂r din notering i √§rendet):</div>
            <div id="localIdOut" class="mono">‚Äî</div>
          </div>
        </section>

        <!-- H√∂ger: rapport (matchar verify.html‚Äôs ‚ÄúVerifieringsresultat‚Äù) -->
        <section aria-label="Registreringsrapport">
          <div style="display:flex; align-items:baseline; justify-content:space-between; gap:12px;">
            <div style="font-weight:950; font-size:16px;">Registreringsrapport</div>
            <div class="meta" id="reportMeta" style="opacity:.85; display:none;">Rapport</div>
          </div>
          <div class="hr"></div>

          <div id="resultBox" style="display:none;">
            <div id="headline"
                 style="font-size:18px; font-weight:950; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.05);">
            </div>

            <div style="margin-top:12px;">
              <div class="meta">Verifierings-ID</div>

              <div style="position:relative; margin-top:6px;">
                <button type="button" id="copyIdIconBtn" aria-label="Kopiera Verifierings-ID" title="Kopiera"
                        style="display:none; position:absolute; top:6px; right:6px; width:34px; height:30px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); cursor:pointer;">
                  <span aria-hidden="true" style="display:block; font-size:15px; line-height:28px;">‚ßâ</span>
                </button>

                <div id="idOut"
                     class="mono"
                     tabindex="0"
                     role="button"
                     title="Klicka f√∂r att kopiera"
                     aria-label="Verifierings-ID (klicka f√∂r att kopiera)"
                     style="
                       padding:8px 10px;
                       border-radius:12px;
                       border:1px solid rgba(255,255,255,.14);
                       background:rgba(255,255,255,.03);
                       cursor:pointer;
                       padding-right:52px;
                       user-select:text;
                       overflow-wrap:anywhere;
                       word-break:break-word;
                       font-size:13px;
                       line-height:1.3;
                     ">‚Äî</div>

                <span id="copyIdPill" class="pill" style="display:none; margin-top:8px;"> </span>
              </div>

              <div class="meta" style="margin-top:12px;">Delbar verifieringsl√§nk</div>

              <div style="position:relative; margin-top:6px;">
                <button type="button" id="copyLinkIconBtn" aria-label="Kopiera verifieringsl√§nk" title="Kopiera"
                        style="display:none; position:absolute; top:6px; right:6px; width:34px; height:30px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); cursor:pointer;">
                  <span aria-hidden="true" style="display:block; font-size:15px; line-height:28px;">‚ßâ</span>
                </button>

                <div id="linkOut"
                     class="mono"
                     tabindex="0"
                     role="button"
                     title="Klicka f√∂r att kopiera"
                     aria-label="Verifieringsl√§nk (klicka f√∂r att kopiera)"
                     style="
                       padding:8px 10px;
                       border-radius:12px;
                       border:1px solid rgba(255,255,255,.14);
                       background:rgba(255,255,255,.03);
                       cursor:pointer;
                       padding-right:52px;
                       user-select:text;
                       overflow-wrap:anywhere;
                       word-break:break-word;
                       font-size:13px;
                       line-height:1.3;
                     ">‚Äî</div>

                <span id="copyLinkPill" class="pill" style="display:none; margin-top:8px;"> </span>
              </div>

              <div class="hr" style="margin-top:14px;"></div>

              <div class="meta">Registreringsstatus</div>
              <div id="regStatusOut" class="mono" style="margin-top:6px">‚Äî</div>

              <div class="meta" style="margin-top:10px;">Registreringstid</div>
              <div id="timeOut" class="mono" style="margin-top:6px">‚Äî</div>

              <div class="qrWrap" style="margin-top:12px">
                <div>
                  <div class="meta" style="margin-bottom:8px">QR-kod</div>
                  <div id="qrBox" class="qrBox" aria-label="QR-kod"></div>
                </div>

                <div style="min-width:240px; flex:1">
                  <div class="small" style="margin-top:0;">
                    Tips: Spara ID i √§rendet. Dela l√§nken om n√•gon beh√∂ver kontrollera senare.
                  </div>
                </div>
              </div>

              <details style="margin-top:12px;">
                <summary>Tekniska detaljer (valfritt)</summary>
                <p style="margin: 10px 0 0;" class="meta">
                  Dessa uppgifter kan vara anv√§ndbara vid teknisk fels√∂kning, men beh√∂vs normalt inte i byr√•processen.
                </p>

                <div class="hr"></div>

                <div class="meta">Teknisk referens</div>
                <div id="txOut" class="mono" style="margin-top:8px">‚Äî</div>

                <div class="meta" style="margin-top:10px;">Teknisk identitet</div>
                <div id="submitterOut" class="mono" style="margin-top:8px">‚Äî</div>
              </details>

              <div class="meta" style="margin-top:12px; opacity:.85;">
                Not: Proofy verifierar filversion (referens), inte dokumentets sakliga riktighet.
              </div>
            </div>
          </div>

          <div id="errorBox" style="display:none;">
            <div class="err">Tillf√§lligt tekniskt problem</div>
            <div id="errorMsg" class="mono" style="margin-top:8px"></div>
          </div>
        </section>

      </div>
    </div>

    <section style="margin-top:14px;">
      <div class="card content">
        <h2 style="margin:0 0 8px; font-size:18px;">Har du redan ett Verifierings-ID?</h2>
        <p class="meta" style="margin:0 0 10px;">
          Klistra in ett Verifierings-ID s√• skapar vi delbar l√§nk och QR direkt.
        </p>

        <div class="grid2">
          <div>
            <label class="meta" for="manualId">Verifierings-ID</label>
            <input id="manualId" type="text" placeholder="Klistra in Verifierings-ID‚Ä¶" style="margin-top:8px" />
            <div class="actions" style="margin-top:12px">
              <button class="btn" id="manualBuildBtn" type="button">Skapa l√§nk &amp; QR</button>
              <button class="btn" id="manualCopyLinkBtn" type="button" disabled>Kopiera l√§nk</button>
              <a class="btn soft" id="manualVerifyBtn" href="/verify.html" style="pointer-events:none;opacity:.55;">√ñppna verifiering</a>
              <span id="manualPill" class="pill">Klistra in ID</span>
            </div>
          </div>

          <div>
            <div class="meta">Delbar verifieringsl√§nk</div>
            <div id="manualLinkOut" class="mono" style="margin-top:8px">‚Äî</div>

            <div class="qrWrap" style="margin-top:12px">
              <div>
                <div class="meta" style="margin-bottom:8px">QR-kod</div>
                <div id="manualQrBox" class="qrBox" aria-label="QR-kod (manuell)"></div>
              </div>
              <div style="min-width:240px; flex:1">
                <div class="small" style="margin-top:0;">
                  Bra n√§r du f√•tt ett ID i en notering och vill dela en l√§nk snabbt.
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="hr"></div>
        <p class="small" style="margin:0;">
          Proofy lagrar inte dokument. Verifiering bygger p√• att j√§mf√∂ra filversioner mot en registrerad referens.
        </p>
      </div>
    </section>

    <p class="meta" style="margin-top:14px">
      Proofy lagrar inte dokument. Verifiering bygger p√• att j√§mf√∂ra filversioner mot en registrerad referens.
    </p>
  </div>
</main>

<footer>
  <div class="wrap">
    <div class="foot">
      <div>
        <div style="color: rgba(234,240,255,.86); font-weight:800;">Proofy</div>
        <div class="small">¬© 2025 Proofy. Alla r√§ttigheter f√∂rbeh√•llna.</div>
        <div class="small" style="margin-top:8px; max-width:92ch;">
          Proofy tillhandah√•ller teknisk tidsst√§mpling och verifiering av filer. Tj√§nsten utg√∂r inte juridisk r√•dgivning och avg√∂r inte filens r√§ttsliga giltighet.
        </div>
      </div>
      <div class="links">
        <a href="/security.html">S√§kerhet</a>
        <a href="/privacy.html">Integritet</a>
        <a href="/terms.html">Villkor</a>
        <a href="/#kontakt">Kontakt</a>
      </div>
    </div>
  </div>
</footer>

<!-- ‚úÖ QR-lib: g√∂r laddning deterministisk -->
<script src="/assets/qr.min.js?v=2025-12-31-qrfix"
  defer
  onload="window.__proofyQrLibLoaded = true"
  onerror="window.__proofyQrLibError = true"></script>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const fileInput = $("fileInput");
  const dropZone = $("dropZone");
  const fileInfo = $("fileInfo");

  const createBtn = $("createBtn");
  const receiptBtn = $("receiptBtn");
  const statusPill = $("statusPill");

  const inputAlert = $("inputAlert");
  const inputAlertText = $("inputAlertText");
  const inputAlertHelp = $("inputAlertHelp");

  const localIdBox = $("localIdBox");
  const localIdOut = $("localIdOut");

  const reportMeta = $("reportMeta");
  const resultBox = $("resultBox");
  const headline = $("headline");

  const idOut = $("idOut");
  const linkOut = $("linkOut");
  const qrBox = $("qrBox");
  const regStatusOut = $("regStatusOut");
  const timeOut = $("timeOut");
  const submitterOut = $("submitterOut");
  const txOut = $("txOut");

  const copyIdIconBtn = $("copyIdIconBtn");
  const copyIdPill = $("copyIdPill");
  const copyLinkIconBtn = $("copyLinkIconBtn");
  const copyLinkPill = $("copyLinkPill");

  const errorBox = $("errorBox");
  const errorMsg = $("errorMsg");

  const manualId = $("manualId");
  const manualBuildBtn = $("manualBuildBtn");
  const manualCopyLinkBtn = $("manualCopyLinkBtn");
  const manualVerifyBtn = $("manualVerifyBtn");
  const manualPill = $("manualPill");
  const manualLinkOut = $("manualLinkOut");
  const manualQrBox = $("manualQrBox");

  let currentFile = null;
  let currentId = null;
  let currentLink = null;

  let busy = false;
  let opId = 0;

  function setPill(text){ statusPill.textContent = text; }
  function setManualPill(text){ manualPill.textContent = text; }

  function showAlert(title, help, tone){
    inputAlert.style.display = "block";
    inputAlertText.textContent = title || "";
    inputAlertHelp.textContent = help || "";

    if (tone === "err") {
      inputAlert.style.borderColor = "rgba(255,80,80,.35)";
      inputAlert.style.background = "rgba(255,80,80,.10)";
      inputAlertText.style.color = "rgba(255,220,220,.95)";
    } else if (tone === "ok") {
      inputAlert.style.borderColor = "rgba(80,255,180,.28)";
      inputAlert.style.background = "rgba(80,255,180,.08)";
      inputAlertText.style.color = "rgba(220,255,245,.95)";
    } else {
      inputAlert.style.borderColor = "rgba(255,255,255,.14)";
      inputAlert.style.background = "rgba(255,255,255,.06)";
      inputAlertText.style.color = "";
    }
  }

  function hideAlert(){
    inputAlert.style.display = "none";
    inputAlertText.textContent = "";
    inputAlertHelp.textContent = "";
  }

  function setCreateBtnTone(isReady){
    if (!createBtn) return;
    createBtn.classList.remove("primary");
    createBtn.classList.add(isReady ? "primary" : "soft");
  }

  function setBusy(v){
    busy = v;
    createBtn.disabled = v || !currentFile;
    setCreateBtnTone(!createBtn.disabled);
  }

  function resetCopyPill(pill){
    if (!pill) return;
    pill.style.display = "none";
    pill.textContent = "";
  }

  async function copyWithPill({ text, pillEl }){
    if (!pillEl) return false;

    const t = String(text || "").trim();
    if (!t || t === "‚Äî") return false;

    pillEl.style.display = "inline-block";
    pillEl.textContent = "Kopierar‚Ä¶";
    try {
      await navigator.clipboard.writeText(t);
      pillEl.textContent = "Kopierad ‚úì";
      setTimeout(() => {
        pillEl.style.display = "none";
        pillEl.textContent = "";
      }, 1400);
      return true;
    } catch {
      pillEl.textContent = "Kunde inte kopiera";
      return false;
    }
  }

  function applyCopyHover(fieldEl, iconBtnEl, enabled){
    if (!fieldEl) return;

    if (!enabled){
      fieldEl.onmouseenter = null;
      fieldEl.onmouseleave = null;
      fieldEl.onfocus = null;
      fieldEl.onblur = null;
      if (iconBtnEl) iconBtnEl.style.display = "none";
      return;
    }

    const onEnter = () => {
      if (iconBtnEl) iconBtnEl.style.display = "inline-flex";
      fieldEl.style.outline = "1px solid rgba(255,255,255,.14)";
      fieldEl.style.outlineOffset = "2px";
      fieldEl.style.background = "rgba(255,255,255,.05)";
    };

    const onLeave = () => {
      if (iconBtnEl) iconBtnEl.style.display = "none";
      fieldEl.style.outline = "";
      fieldEl.style.outlineOffset = "";
      fieldEl.style.background = "rgba(255,255,255,.03)";
    };

    fieldEl.onmouseenter = onEnter;
    fieldEl.onmouseleave = onLeave;

    fieldEl.onfocus = () => {
      if (iconBtnEl) iconBtnEl.style.display = "inline-flex";
      fieldEl.style.outline = "2px solid rgba(120, 180, 255, .25)";
      fieldEl.style.outlineOffset = "2px";
    };
    fieldEl.onblur = () => {
      if (iconBtnEl) iconBtnEl.style.display = "none";
      fieldEl.style.outline = "";
      fieldEl.style.outlineOffset = "";
    };
  }

  function resetReport(){
    if (reportMeta) reportMeta.style.display = "none";
    resultBox.style.display = "none";
    errorBox.style.display = "none";
    errorMsg.textContent = "";

    headline.textContent = "";
    headline.style.borderColor = "rgba(255,255,255,.14)";
    headline.style.background = "rgba(255,255,255,.05)";

    idOut.textContent = "‚Äî";
    linkOut.textContent = "‚Äî";
    regStatusOut.textContent = "‚Äî";
    timeOut.textContent = "‚Äî";
    submitterOut.textContent = "‚Äî";
    txOut.textContent = "‚Äî";
    qrBox.innerHTML = "";

    if (receiptBtn) receiptBtn.style.display = "none";

    if (copyIdIconBtn) copyIdIconBtn.style.display = "none";
    if (copyLinkIconBtn) copyLinkIconBtn.style.display = "none";
    resetCopyPill(copyIdPill);
    resetCopyPill(copyLinkPill);

    if (idOut){
      idOut.style.outline = "";
      idOut.style.outlineOffset = "";
      idOut.style.background = "rgba(255,255,255,.03)";
    }
    if (linkOut){
      linkOut.style.outline = "";
      linkOut.style.outlineOffset = "";
      linkOut.style.background = "rgba(255,255,255,.03)";
    }

    localIdBox.style.display = "none";
    localIdOut.textContent = "‚Äî";
  }

  function bytesToHex(bytes){
    return [...bytes].map(b => b.toString(16).padStart(2,"0")).join("");
  }

  async function makeLocalId(file){
    const buf = await file.arrayBuffer();
    const dig = await crypto.subtle.digest("SHA-256", buf);
    return "0x" + bytesToHex(new Uint8Array(dig));
  }

  function isIdFormat(v){
    return typeof v === "string" && /^0x[0-9a-fA-F]{64}$/.test(v);
  }

  function buildVerifyLink(hash){
    return `${location.origin}/verify.html?hash=${encodeURIComponent(hash)}`;
  }

  function canRenderQr(){
    return typeof window.QRCode === "function";
  }

  function showQrError(targetEl, extra){
    const parts = [];
    parts.push("QR-koden kunde inte renderas.");
    if (window.__proofyQrLibError) parts.push("QR-biblioteket kunde inte laddas.");
    if (extra) parts.push(extra);
    targetEl.innerHTML = `<div class="meta">${parts.join(" ")}</div>`;
  }

  /**
   * ‚úÖ Robust QR-render: st√∂djer b√•de
   * A) new QRCode(el, { text, ... })  (vissa builds)
   * B) const qr = new QRCode(el); qr.makeCode(text)  (din minimal-build)
   */
  function renderQr(targetEl, text){
    if (!targetEl) return;

    // tydlig placeholder
    targetEl.innerHTML = `<div class="meta">Skapar QR‚Ä¶</div>`;

    // üîí S√§kerst√§ll att QR-lib finns √§ven om sidan r√•kar sakna script-import (t.ex. /register/)
    if (!canRenderQr() && !window.__proofyQrLibLoaded && !window.__proofyQrScriptInjected) {
      window.__proofyQrScriptInjected = true;

      const s = document.createElement("script");
      s.src = "/assets/qr.min.js?v=2025-12-31-qrfix";
      s.onload = () => { window.__proofyQrLibLoaded = true; };
      s.onerror = () => { window.__proofyQrLibError = true; };
      document.head.appendChild(s);
    }

    // om script inte laddat √§nnu: v√§nta kort
    if (!canRenderQr()){
      let tries = 0;
      const t = setInterval(() => {
        tries++;
        if (canRenderQr()){
          clearInterval(t);
          renderQr(targetEl, text);
          return;
        }
        if (window.__proofyQrLibError || tries > 40){
          clearInterval(t);
          showQrError(targetEl, "Kontrollera att /assets/qr.min.js finns och inte blockeras.");
        }
      }, 50);
      return;
    }

    // f√∂rs√∂k rendera
    try{
      targetEl.innerHTML = "";

      const opts = {
        text,
        width: 150,
        height: 150,
        colorDark: "#0b1220",
        colorLight: "#eaf0ff",
        correctLevel:
          window.QRCodeCorrectLevel && window.QRCodeCorrectLevel.M
            ? window.QRCodeCorrectLevel.M
            : undefined
      };

      let did = false;

      // 1) F√∂rs√∂k API A (options i constructor)
      try{
        // vissa builds skapar direkt canvas/img
        new window.QRCode(targetEl, opts);
        did = !!(targetEl.querySelector("canvas") || targetEl.querySelector("img"));
      } catch { /* ignore */ }

      // 2) Fallback API B (minimal: makeCode)
      if (!did){
        const qr = new window.QRCode(targetEl);
        if (qr && typeof qr.makeCode === "function"){
          if (qr._htOption){
            qr._htOption.width = 150;
            qr._htOption.height = 150;
            qr._htOption.colorDark = "#0b1220";
            qr._htOption.colorLight = "#eaf0ff";
            if (window.QRCodeCorrectLevel && window.QRCodeCorrectLevel.M) {
              qr._htOption.correctLevel = window.QRCodeCorrectLevel.M;
            }
          }
          qr.makeCode(text);
          did = !!(targetEl.querySelector("canvas") || targetEl.querySelector("img"));
        }
      }

      if (!did){
        showQrError(targetEl, "QR-biblioteket laddades, men API-matchning misslyckades.");
      }
    } catch (e){
      console.error("QR render error:", e);
      showQrError(targetEl, "Ett scriptfel intr√§ffade vid rendering.");
    }
  }

  function updateValidationUI(){
    if (!currentFile){
      hideAlert();
      setPill("F√∂rbered registrering");
      setBusy(false);
      return;
    }
    hideAlert();
    setPill("Redo att registrera");
    setBusy(false);
  }

  function setFile(file){
    currentFile = file || null;
    currentId = null;
    currentLink = null;

    resetReport();

    fileInfo.textContent = currentFile
      ? `Valt underlag: ${currentFile.name} (${(currentFile.size/1024/1024).toFixed(2)} MB)`
      : "Inget underlag valt.";

    updateValidationUI();
  }

  fileInput.addEventListener("change", () => setFile(fileInput.files?.[0] || null));

  dropZone.addEventListener("dragover", (e) => { e.preventDefault(); dropZone.classList.add("drag"); });
  dropZone.addEventListener("dragleave", () => dropZone.classList.remove("drag"));
  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("drag");
    const f = e.dataTransfer?.files?.[0];
    if(f) setFile(f);
  });

  if (idOut) {
    idOut.addEventListener("click", async () => {
      await copyWithPill({ text: idOut.textContent, pillEl: copyIdPill });
    });
    idOut.addEventListener("keydown", async (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        await copyWithPill({ text: idOut.textContent, pillEl: copyIdPill });
      }
    });
  }

  if (copyIdIconBtn) {
    copyIdIconBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      e.stopPropagation();
      await copyWithPill({ text: idOut.textContent, pillEl: copyIdPill });
    });
  }

  if (linkOut) {
    linkOut.addEventListener("click", async () => {
      await copyWithPill({ text: linkOut.textContent, pillEl: copyLinkPill });
    });
    linkOut.addEventListener("keydown", async (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        await copyWithPill({ text: linkOut.textContent, pillEl: copyLinkPill });
      }
    });
  }

  if (copyLinkIconBtn) {
    copyLinkIconBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      e.stopPropagation();
      await copyWithPill({ text: linkOut.textContent, pillEl: copyLinkPill });
    });
  }

  createBtn.addEventListener("click", async () => {
    if (!currentFile) {
      showAlert(
        "‚ö†Ô∏è V√§lj referensunderlag f√∂r att kunna registrera",
        "V√§lj en fil (eller dra & sl√§pp) f√∂r att skapa Verifierings-ID. Underlaget l√§mnar aldrig din dator.",
        "err"
      );
      setPill("V√§lj underlag");
      return;
    }
    if (busy) return;

    const myOp = ++opId;
    setBusy(true);
    setPill("Skapar ID lokalt‚Ä¶");

    try{
      const id = await makeLocalId(currentFile);
      if (myOp !== opId) return;

      if (!isIdFormat(id)) throw new Error("Det gick inte att skapa ett giltigt Verifierings-ID.");

      currentId = id;
      currentLink = buildVerifyLink(id);

      // Visa lokal notering (beh√•ll)
      localIdBox.style.display = "block";
      localIdOut.textContent = id;

      // Visa rapport
      resultBox.style.display = "block";
      if (reportMeta) reportMeta.style.display = "block";

      // Headline neutral direkt (uppdateras efter registrering)
      headline.style.borderColor = "rgba(255,255,255,.14)";
      headline.style.background = "rgba(255,255,255,.05)";
      headline.innerHTML = `<span class="meta">Verifierings-ID skapat</span>`;

      idOut.textContent = id;
      linkOut.textContent = currentLink;

      applyCopyHover(idOut, copyIdIconBtn, true);
      applyCopyHover(linkOut, copyLinkIconBtn, true);

      if (receiptBtn) {
        receiptBtn.href = `/certificate.html?hash=${encodeURIComponent(id)}`;
        receiptBtn.style.display = "inline-flex";
      }

      // ‚úÖ QR render
      renderQr(qrBox, currentLink);

      regStatusOut.textContent = "Registrerar‚Ä¶";
      timeOut.textContent = "‚Äî";

      setPill("Registrerar‚Ä¶");

      const res = await fetch("/api/register", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ hash: id })
      });

      const data = await res.json().catch(() => ({}));
      if (myOp !== opId) return;

      if (!res.ok || data.ok === false) {
        throw new Error(data?.error || `Registreringen misslyckades (HTTP ${res.status}).`);
      }

      // audit-ton (nedtonad gr√∂n)
      headline.style.borderColor = "rgba(80,255,180,.20)";
      headline.style.background = "rgba(80,255,180,.06)";

      if (data.alreadyExists) {
        headline.innerHTML = `<span class="ok">‚úÖ Redan registrerad</span> <span class="meta">(du kan anv√§nda samma ID)</span>`;
      } else {
        headline.innerHTML = `<span class="ok">‚úÖ Registrerad</span> <span class="meta">(referens fastst√§lld)</span>`;
      }

      regStatusOut.textContent = "Registrerad";

      if (data.timestamp) {
        timeOut.textContent = new Date(Number(data.timestamp) * 1000).toLocaleString("sv-SE");
      } else {
        timeOut.textContent = "‚Äî";
      }

      submitterOut.textContent = data.submitter || "‚Äî";
      txOut.textContent = data.txHash || "‚Äî";

      setPill("Registrering klar");
      setBusy(false);
    } catch (e){
      console.error(e);
      if (myOp !== opId) return;

      errorBox.style.display = "block";
      errorMsg.textContent = (e?.message || "Registreringstj√§nsten kunde inte n√•s just nu.");
      setPill("√Ötg√§rd kr√§vs");
      setBusy(false);
    }
  });

  // Manuell del (of√∂r√§ndrad)
  function setManualState(id){
    const clean = (id || "").trim();
    if (!isIdFormat(clean)){
      manualLinkOut.textContent = "‚Äî";
      manualQrBox.innerHTML = "";
      manualCopyLinkBtn.disabled = true;
      manualVerifyBtn.href = "/verify.html";
      manualVerifyBtn.style.pointerEvents = "none";
      manualVerifyBtn.style.opacity = ".55";
      setManualPill(clean ? "Ogiltigt ID" : "Klistra in ID");
      return null;
    }

    const link = buildVerifyLink(clean);
    manualLinkOut.textContent = link;

    // ‚úÖ QR √§ven h√§r
    renderQr(manualQrBox, link);

    manualCopyLinkBtn.disabled = false;
    manualVerifyBtn.href = link;
    manualVerifyBtn.style.pointerEvents = "auto";
    manualVerifyBtn.style.opacity = "1";
    setManualPill("Redo ‚úÖ");
    return link;
  }

  manualBuildBtn.addEventListener("click", () => setManualState(manualId.value));
  manualId.addEventListener("input", () => setManualState(manualId.value));

  manualCopyLinkBtn.addEventListener("click", async () => {
    const link = setManualState(manualId.value);
    if (!link) return;
    try{ await navigator.clipboard.writeText(link); setManualPill("L√§nk kopierad ‚úÖ"); }
    catch { setManualPill("Kunde inte kopiera"); }
  });

  // init
  resetReport();
  updateValidationUI();
  setManualState("");
})();
</script>

<script src="/assets/header-toggle.js?v=2025-12-24a" defer></script>
<script src="/chat-widget.js?v=2025-12-24a" defer></script>
</body>
          </html>
