<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proofy – Skapa verifierings-ID</title>
  <meta name="theme-color" content="#0b1220" />

  <style>
:root{
  --bg:#0b1220;--text:#eaf0ff;--muted:#a9b7d3;
  --border:rgba(255,255,255,.12);--brand:#6ea8ff;--brand2:#7cf1c6;
  --shadow:0 18px 60px rgba(0,0,0,.38);--r:18px;--max:1100px;
  --ok:#7cf1c6; --err:#ff8aa1;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:var(--text);
  background:
    radial-gradient(900px 600px at 15% 10%, rgba(110,168,255,.18), transparent 60%),
    radial-gradient(900px 600px at 80% 20%, rgba(124,241,198,.10), transparent 65%),
    var(--bg);
}
.wrap{max-width:var(--max);margin:0 auto;padding:0 20px}
header{
  border-bottom:1px solid var(--border);
  background:rgba(11,18,32,.75);
  position:sticky;top:0;z-index:10
}
.nav{
  display:flex;justify-content:space-between;align-items:center;
  padding:14px 0;gap:12px
}
.brand{display:flex;gap:10px;font-weight:900;text-decoration:none;align-items:center;color:inherit}
.logo{
  width:34px;height:34px;border-radius:10px;
  background:linear-gradient(135deg,var(--brand),var(--brand2));
  position:relative;
}
.logo:after{
  content:"";
  position:absolute; inset:9px 10px;
  border-radius:7px;
  background: rgba(11,18,32,.65);
  border: 1px solid rgba(255,255,255,.20);
}
.btn{
  display:inline-flex;align-items:center;justify-content:center;
  padding:12px 16px;border-radius:14px;border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);color:inherit;font-weight:900;cursor:pointer;
  text-decoration:none;
  transition: transform .08s ease, background .15s ease;
}
.btn:hover{ background:rgba(255,255,255,.10) }
.btn:active{ transform: translateY(1px) }
.btn.primary{
  border:none;background:linear-gradient(135deg,var(--brand),var(--brand2));
  color:#08101e;
  box-shadow: 0 18px 45px rgba(110,168,255,.22);
}
.btn:disabled{opacity:.45;cursor:not-allowed}
.card{
  border:1px solid var(--border);border-radius:var(--r);
  background:linear-gradient(180deg,rgba(255,255,255,.07),rgba(255,255,255,.03));
  box-shadow:var(--shadow)
}
.content{padding:18px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;word-break:break-all}
.meta{color:var(--muted);font-size:13px}
.ok{color:var(--ok);font-weight:900}
.err{color:var(--err);font-weight:900}
.hr{height:1px;background:rgba(255,255,255,.12);margin:14px 0}
input[type="file"], input[type="text"]{
  width:100%;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
  background:rgba(11,18,32,.35);color:var(--text);outline:none
}
.drop{
  border:2px dashed rgba(255,255,255,.18);
  background:rgba(255,255,255,.03);
  border-radius:16px;
  padding:16px;
  text-align:center;
  user-select:none;
}
.drop.drag{border-color:rgba(255,255,255,.35);background:rgba(255,255,255,.05)}
.small{font-size:12.5px;color:rgba(169,183,211,.92)}
.pill{
  display:inline-flex;align-items:center;gap:8px;
  padding:8px 12px;border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.04);
  font-size:13px;color:var(--muted);font-weight:800;
}
.kv{ margin-top:10px; }
.kv .k{ color: var(--muted); font-size:12.5px; }
.kv .v{ margin-top:6px; }
.qrRow{
  margin-top:12px;
  display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap;
}
.qrBox{
  width:170px;height:170px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  padding:10px;
}
canvas{ display:block; width:150px; height:150px; }
.actions{
  margin-top:12px;
  display:flex;gap:10px;flex-wrap:wrap;align-items:center;
}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="/" aria-label="Proofy">
        <span class="logo" aria-hidden="true"></span>
        <span>Proofy</span>
      </a>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <a class="btn" href="/verify.html">Verifiera fil</a>
        <a class="btn primary" href="/#kontakt">Boka demo</a>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <h1>Skapa verifierings-ID</h1>
    <p class="meta">
      Filen lämnar aldrig din dator. Proofy beräknar ett <b>digitalt fingeravtryck</b> (SHA-256) lokalt i webbläsaren
      och registrerar endast fingeravtrycket. Du får ett <b>Verifierings-ID</b> och en <b>delbar verifieringslänk</b>.
    </p>

    <section class="card content">
      <div class="grid">

        <!-- LEFT -->
        <div>
          <b>Skapa via fil</b>
          <p class="meta" style="margin-top:8px">
            Dra & släpp eller välj en fil. Därefter skapar vi en verifieringspost och visar ID + länk + QR.
          </p>

          <input id="fileInput" type="file" />
          <div id="dropZone" class="drop" style="margin-top:10px">Dra & släpp fil här</div>

          <div id="fileInfo" class="meta" style="margin-top:10px">Ingen fil vald.</div>

          <div class="actions">
            <button class="btn primary" id="createBtn" disabled>Skapa ID</button>
            <button class="btn" id="copyIdBtn" disabled>Kopiera ID</button>
            <button class="btn" id="copyLinkBtn" disabled>Kopiera länk</button>
            <span id="statusPill" class="pill">Välj en fil</span>
          </div>

          <div id="localHashBox" style="display:none;margin-top:12px">
            <div class="meta">Digitalt fingeravtryck (SHA-256 / bytes32):</div>
            <div id="localHashOut" class="mono">—</div>
          </div>

          <div class="small" style="margin-top:10px">
            QR-koden öppnar verifieringslänken på mobilen (smidigt vid kontroll på plats).
          </div>
        </div>

        <!-- RIGHT -->
        <div>
          <b>Resultat</b>
          <div class="hr"></div>

          <div id="status" class="meta"></div>

          <div id="resultBox" style="display:none;margin-top:10px">
            <div id="resultLine" style="font-size:18px;margin-bottom:10px;"></div>

            <div class="kv">
              <div class="k">Verifierings-ID</div>
              <div id="idOut" class="v mono">—</div>
            </div>

            <div class="kv">
              <div class="k">Verifieringslänk</div>
              <div id="linkOut" class="v mono">—</div>
            </div>

            <div class="qrRow">
              <div>
                <div class="k">QR-kod</div>
                <div class="qrBox">
                  <canvas id="qrCanvas" width="150" height="150"></canvas>
                </div>
              </div>

              <div style="flex:1; min-width:240px">
                <div class="kv">
                  <div class="k">Tidsstämpling</div>
                  <div id="timeOut" class="v mono">—</div>
                </div>

                <div class="kv">
                  <div class="k">Registrerad av</div>
                  <div id="submitterOut" class="v mono">—</div>
                </div>

                <div class="small" style="margin-top:10px">
                  Tips: Spara ID i ärendet, och dela länken om någon behöver kontrollera senare.
                </div>
              </div>
            </div>
          </div>

          <div id="errorBox" style="display:none;margin-top:10px">
            <div class="err">Tillfälligt tekniskt problem</div>
            <div id="errorMsg" class="mono" style="margin-top:8px"></div>
          </div>
        </div>

      </div>
    </section>

    <p class="meta" style="margin-top:14px">
      Proofy lagrar inte dokument. Verifiering bygger på jämförelse av filens fingeravtryck.
    </p>
  </div>
</main>

<!-- ✅ Viktigt: den här måste ligga som /dist/qr.min.js så den nås via /qr.min.js -->
<script src="/qr.min.js?v=2025-12-20"></script>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const fileInput = $("fileInput");
  const dropZone = $("dropZone");
  const fileInfo = $("fileInfo");

  const createBtn = $("createBtn");
  const copyIdBtn = $("copyIdBtn");
  const copyLinkBtn = $("copyLinkBtn");
  const statusPill = $("statusPill");

  const localHashBox = $("localHashBox");
  const localHashOut = $("localHashOut");

  const status = $("status");
  const resultBox = $("resultBox");
  const resultLine = $("resultLine");

  const idOut = $("idOut");
  const linkOut = $("linkOut");
  const timeOut = $("timeOut");
  const submitterOut = $("submitterOut");

  const qrCanvas = $("qrCanvas");

  const errorBox = $("errorBox");
  const errorMsg = $("errorMsg");

  let currentFile = null;

  let busy = false;
  let opId = 0;

  let lastHash = null;
  let lastLink = null;

  function setBusy(v){
    busy = v;
    createBtn.disabled = !currentFile || busy;
    copyIdBtn.disabled = !lastHash || busy;
    copyLinkBtn.disabled = !lastLink || busy;
  }

  function setStatus(msg, cls="meta"){
    status.textContent = msg || "";
    status.className = cls;
  }

  function setPill(msg){
    statusPill.textContent = msg || "—";
  }

  function resetUI(){
    errorBox.style.display = "none";
    errorMsg.textContent = "";

    resultBox.style.display = "none";
    resultLine.innerHTML = "";

    idOut.textContent = "—";
    linkOut.textContent = "—";
    timeOut.textContent = "—";
    submitterOut.textContent = "—";

    localHashBox.style.display = "none";
    localHashOut.textContent = "—";

    clearQr();

    setStatus("");
    lastHash = null;
    lastLink = null;
    setBusy(false);
  }

  function bytesToHex(bytes){
    return [...bytes].map(b => b.toString(16).padStart(2,"0")).join("");
  }

  async function sha256Bytes32Hex(file){
    const buf = await file.arrayBuffer();
    const dig = await crypto.subtle.digest("SHA-256", buf);
    return "0x" + bytesToHex(new Uint8Array(dig));
  }

  function isBytes32Hex(h){
    return typeof h === "string" && /^0x[0-9a-fA-F]{64}$/.test(h);
  }

  function shareUrlForHash(h){
    return `${location.origin}/verify.html?hash=${h}`;
  }

  function fmtDateSv(ts){
    try{ return new Date(ts * 1000).toLocaleString("sv-SE"); }
    catch{ return "—"; }
  }

  function clearQr(){
    const ctx = qrCanvas.getContext("2d");
    const size = qrCanvas.width;
    ctx.clearRect(0,0,size,size);
    ctx.fillStyle = "#0b1220";
    ctx.fillRect(0,0,size,size);
    ctx.strokeStyle = "rgba(255,255,255,.14)";
    ctx.lineWidth = 2;
    ctx.strokeRect(1,1,size-2,size-2);
  }

  function renderQr(text){
    // QRCode() comes from qr.min.js
    if(typeof QRCode !== "function"){
      clearQr();
      return;
    }

    const qr = QRCode(text);
    const count = qr.getModuleCount();
    const ctx = qrCanvas.getContext("2d");
    const size = qrCanvas.width;

    const padding = 10; // quiet zone
    const usable = size - padding*2;
    const cell = Math.floor(usable / count);
    const offset = padding + Math.floor((usable - cell*count) / 2);

    // background
    ctx.fillStyle = "#0b1220";
    ctx.fillRect(0,0,size,size);

    // draw modules
    for(let r=0;r<count;r++){
      for(let c=0;c<count;c++){
        if(qr.isDark(r,c)){
          ctx.fillStyle = "#eaf0ff";
          ctx.fillRect(offset + c*cell, offset + r*cell, cell, cell);
        }
      }
    }

    // border
    ctx.strokeStyle = "rgba(255,255,255,.14)";
    ctx.lineWidth = 2;
    ctx.strokeRect(1,1,size-2,size-2);
  }

  function setFile(file){
    currentFile = file || null;
    resetUI();

    if(!currentFile){
      fileInfo.textContent = "Ingen fil vald.";
      setPill("Välj en fil");
      createBtn.disabled = true;
      return;
    }

    fileInfo.textContent = `Vald fil: ${currentFile.name} (${(currentFile.size/1024/1024).toFixed(2)} MB)`;
    setPill("Redo att skapa ID");
    setBusy(false);
  }

  fileInput.addEventListener("change", () => setFile(fileInput.files?.[0] || null));
  dropZone.addEventListener("dragover", (e) => { e.preventDefault(); dropZone.classList.add("drag"); });
  dropZone.addEventListener("dragleave", () => dropZone.classList.remove("drag"));
  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("drag");
    const f = e.dataTransfer?.files?.[0];
    if(f) setFile(f);
  });

  async function postRegister(hash){
    const res = await fetch("/api/register",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ hash })
    });
    const data = await res.json().catch(() => ({}));
    return { res, data };
  }

  createBtn.addEventListener("click", async () => {
    if(!currentFile || busy) return;

    const myOp = ++opId;
    setBusy(true);
    resetUI();
    setPill("Beräknar fingeravtryck…");
    setStatus("Hashar fil lokalt…");

    try{
      const h = await sha256Bytes32Hex(currentFile);
      if(myOp !== opId) return;

      localHashBox.style.display = "block";
      localHashOut.textContent = h;

      if(!isBytes32Hex(h)){
        throw new Error("Fel: hash blev inte bytes32.");
      }

      setPill("Skapar verifieringspost…");
      setStatus("Skapar verifieringspost…");

      const { res, data } = await postRegister(h);
      if(myOp !== opId) return;

      if(!res.ok || data.ok === false){
        const msg = data?.error || `Misslyckades (HTTP ${res.status}).`;
        throw new Error(msg);
      }

      lastHash = data.hash || h;
      lastLink = shareUrlForHash(lastHash);

      resultBox.style.display = "block";
      idOut.textContent = lastHash;
      linkOut.textContent = lastLink;

      // ✅ Om redan registrerad: visa snyggt (inte fel)
      if(data.alreadyExists){
        resultLine.innerHTML = `<span class="ok">✅ Redan registrerad</span> <span class="meta">(du kan använda samma ID)</span>`;
        setStatus("Verifieringspost fanns redan. ID och länk är fortfarande giltiga.", "meta");
      } else {
        resultLine.innerHTML = `<span class="ok">✅ Verifierings-ID skapat</span>`;
        setStatus("Klart. Spara Verifierings-ID i ärendet och dela länken vid behov.", "meta");
      }

      // Dessa finns om din /api/register returnerar dem (i din kod gör den det vid alreadyExists)
      timeOut.textContent = data.timestamp ? fmtDateSv(Number(data.timestamp)) : "—";
      submitterOut.textContent = data.submitter || "—";

      // ✅ QR som går att scanna (riktig QR)
      renderQr(lastLink);

      copyIdBtn.disabled = false;
      copyLinkBtn.disabled = false;

      setPill("Klart ✅");
    } catch (e){
      console.error(e);
      if(myOp !== opId) return;
      errorBox.style.display = "block";
      errorMsg.textContent = (e?.message || "Tjänsten kunde inte nås just nu.");
      setStatus("Fel vid skapande av verifieringspost.", "err");
      setPill("Fel");
    } finally {
      if(myOp === opId) setBusy(false);
    }
  });

  copyIdBtn.addEventListener("click", async () => {
    if(!lastHash) return;
    try{
      await navigator.clipboard.writeText(lastHash);
      setPill("ID kopierat ✅");
    } catch {
      setPill("Kunde inte kopiera");
    }
  });

  copyLinkBtn.addEventListener("click", async () => {
    if(!lastLink) return;
    try{
      await navigator.clipboard.writeText(lastLink);
      setPill("Länk kopierad ✅");
    } catch {
      setPill("Kunde inte kopiera");
    }
  });

  // initial
  clearQr();
  setFile(null);
  setBusy(false);
})();
</script>

<script src="/chat-widget.js?v=2025-01" defer></script>
</body>
</html>
