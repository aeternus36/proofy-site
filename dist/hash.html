<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proofy – Skapa verifierings-ID</title>
  <meta name="theme-color" content="#0b1220" />
  <link rel="stylesheet" href="/assets/proofy.css?v=2025-12-20" />
</head>

<body>
<header>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="/" aria-label="Proofy">
        <span class="logo" aria-hidden="true"></span>
        <span>Proofy</span>
      </a>

      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <a class="btn" href="/verify.html">Verifiera fil</a>
        <a class="btn primary" href="/#kontakt">Boka demo</a>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="badge">För redovisningsbyråer · revision · granskning</div>

    <h1 class="pageTitle">Skapa verifierings-ID</h1>

    <p class="lead">
      Filen lämnar aldrig din dator. Proofy beräknar ett <b>digitalt fingeravtryck</b> (SHA-256) lokalt i webbläsaren
      och registrerar endast fingeravtrycket. Du får ett <b>Verifierings-ID</b> och en <b>delbar verifieringslänk</b>.
    </p>

    <section class="card content">
      <div class="grid2">

        <!-- LEFT -->
        <div>
          <div style="font-weight:950; font-size:16px;">Skapa via fil</div>
          <p class="meta" style="margin-top:8px">
            Dra & släpp eller välj en fil. Därefter skapar vi en verifieringspost och visar ID + länk + QR.
          </p>

          <input id="fileInput" type="file" />
          <div id="dropZone" class="drop" style="margin-top:10px">Dra & släpp fil här</div>

          <div id="fileInfo" class="meta" style="margin-top:10px">Ingen fil vald.</div>

          <div class="actions" style="margin-top:12px">
            <button class="btn primary" id="createBtn" disabled>Skapa ID</button>
            <button class="btn" id="copyIdBtn" disabled>Kopiera ID</button>
            <button class="btn" id="copyLinkBtn" disabled>Kopiera länk</button>
            <a class="btn" id="receiptBtn" href="#" target="_blank" rel="noopener" style="display:none;">Öppna kvitto</a>
            <span id="statusPill" class="pill">Välj en fil</span>
          </div>

          <div id="localHashBox" style="display:none;margin-top:12px">
            <div class="meta">Digitalt fingeravtryck (SHA-256 / bytes32):</div>
            <div id="localHashOut" class="mono">—</div>
          </div>

          <div class="small" style="margin-top:10px">
            Alla filtyper stöds (t.ex. PDF, Excel, bilder, ZIP). Minsta ändring ger ett helt nytt fingeravtryck.
          </div>
        </div>

        <!-- RIGHT -->
        <div>
          <div style="font-weight:950; font-size:16px;">Resultat</div>
          <div class="hr"></div>

          <div class="meta">Verifierings-ID</div>
          <div id="hashOut" class="mono" style="margin-top:8px">—</div>

          <div class="hr"></div>

          <div id="resultBox" style="display:none;">
            <div id="headline" style="font-size:18px; margin-bottom:10px;"></div>

            <div class="meta">Verifieringslänk</div>
            <div id="linkOut" class="mono" style="margin-top:8px">—</div>

            <div class="qrWrap" style="margin-top:12px">
              <div>
                <div class="meta" style="margin-bottom:8px">QR-kod</div>
                <div id="qrBox" class="qrBox" aria-label="QR-kod"></div>
              </div>

              <div style="min-width:240px; flex:1">
                <div class="meta">Tidsstämpling</div>
                <div id="timeOut" class="mono" style="margin-top:8px">—</div>

                <div class="meta" style="margin-top:10px;">Registrerad av</div>
                <div id="submitterOut" class="mono" style="margin-top:8px">—</div>

                <div class="meta" style="margin-top:10px;">Transaktion</div>
                <div id="txOut" class="mono" style="margin-top:8px">—</div>

                <div class="small" style="margin-top:10px">
                  Tips: Spara ID i ärendet, och dela länken om någon behöver kontrollera senare.
                </div>
              </div>
            </div>
          </div>

          <div id="errorBox" style="display:none;">
            <div class="err">Tillfälligt tekniskt problem</div>
            <div id="errorMsg" class="mono" style="margin-top:8px"></div>
          </div>
        </div>

      </div>
    </section>

    <p class="meta" style="margin-top:14px">
      Proofy lagrar inte dokument. Verifiering bygger på jämförelse av filens fingeravtryck.
    </p>
  </div>
</main>

<!-- ✅ QR lib MUST be reachable at /qr.min.js (dist root on deploy) -->
<script src="/qr.min.js?v=2025-12-20"></script>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const fileInput = $("fileInput");
  const dropZone = $("dropZone");
  const fileInfo = $("fileInfo");

  const createBtn = $("createBtn");
  const copyIdBtn = $("copyIdBtn");
  const copyLinkBtn = $("copyLinkBtn");
  const receiptBtn = $("receiptBtn");
  const statusPill = $("statusPill");

  const localHashBox = $("localHashBox");
  const localHashOut = $("localHashOut");

  const hashOut = $("hashOut");

  const resultBox = $("resultBox");
  const headline = $("headline");
  const linkOut = $("linkOut");
  const qrBox = $("qrBox");
  const timeOut = $("timeOut");
  const submitterOut = $("submitterOut");
  const txOut = $("txOut");

  const errorBox = $("errorBox");
  const errorMsg = $("errorMsg");

  let currentFile = null;
  let currentHash = null;
  let currentLink = null;

  let busy = false;
  let opId = 0;

  function setBusy(v){
    busy = v;
    createBtn.disabled = !currentFile || busy;
    copyIdBtn.disabled = !currentHash || busy;
    copyLinkBtn.disabled = !currentLink || busy;
  }

  function setPill(text){
    statusPill.textContent = text;
  }

  function resetRight(){
    resultBox.style.display = "none";
    errorBox.style.display = "none";
    errorMsg.textContent = "";
    headline.textContent = "";
    hashOut.textContent = "—";
    linkOut.textContent = "—";
    timeOut.textContent = "—";
    submitterOut.textContent = "—";
    txOut.textContent = "—";
    qrBox.innerHTML = "";
    receiptBtn.style.display = "none";
  }

  function bytesToHex(bytes){
    return [...bytes].map(b => b.toString(16).padStart(2,"0")).join("");
  }

  async function sha256Bytes32Hex(file){
    const buf = await file.arrayBuffer();
    const dig = await crypto.subtle.digest("SHA-256", buf);
    return "0x" + bytesToHex(new Uint8Array(dig));
  }

  function isBytes32Hex(h){
    return typeof h === "string" && /^0x[0-9a-fA-F]{64}$/.test(h);
  }

  function buildVerifyLink(hash){
    // Always share /verify.html?hash=...
    return `${location.origin}/verify.html?hash=${encodeURIComponent(hash)}`;
  }

  function renderQr(text){
    // Ensure QRCode lib is loaded
    if (typeof window.QRCode !== "function") {
      qrBox.innerHTML = '<div class="meta">QR-bibliotek kunde inte laddas.</div>';
      return;
    }
    qrBox.innerHTML = "";
    new QRCode(qrBox, {
      text,
      width: 150,
      height: 150,
      colorDark: "#0b1220",
      colorLight: "#eaf0ff",
      correctLevel: window.QRCodeCorrectLevel ? window.QRCodeCorrectLevel.M : undefined
    });
  }

  function setFile(file){
    currentFile = file || null;
    currentHash = null;
    currentLink = null;

    resetRight();

    localHashBox.style.display = "none";
    localHashOut.textContent = "—";
    fileInput.value = "";

    if(!currentFile){
      fileInfo.textContent = "Ingen fil vald.";
      setPill("Välj en fil");
      setBusy(false);
      return;
    }

    fileInfo.textContent = `Vald fil: ${currentFile.name} (${(currentFile.size/1024/1024).toFixed(2)} MB)`;
    setPill("Redo att skapa ID");
    setBusy(false);
  }

  // Input
  fileInput.addEventListener("change", () => setFile(fileInput.files?.[0] || null));

  // Drag & drop
  dropZone.addEventListener("dragover", (e) => { e.preventDefault(); dropZone.classList.add("drag"); });
  dropZone.addEventListener("dragleave", () => dropZone.classList.remove("drag"));
  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("drag");
    const f = e.dataTransfer?.files?.[0];
    if(f) setFile(f);
  });

  // Create ID + register
  createBtn.addEventListener("click", async () => {
    if(!currentFile || busy) return;

    const myOp = ++opId;
    setBusy(true);
    resetRight();

    setPill("Hashar lokalt…");

    try{
      const h = await sha256Bytes32Hex(currentFile);
      if(myOp !== opId) return;

      if(!isBytes32Hex(h)) throw new Error("Fel vid hash-format (ej bytes32).");

      currentHash = h;
      currentLink = buildVerifyLink(h);

      localHashBox.style.display = "block";
      localHashOut.textContent = h;

      hashOut.textContent = h;
      linkOut.textContent = currentLink;

      // receipt link (same behavior as you already had)
      receiptBtn.href = `/certificate.html?hash=${encodeURIComponent(h)}`;
      receiptBtn.style.display = "inline-flex";

      // Render QR immediately (even if API fails, QR is still useful)
      renderQr(currentLink);

      setPill("Registrerar…");

      const res = await fetch("/api/register", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ hash: h })
      });

      const data = await res.json().catch(() => ({}));
      if(myOp !== opId) return;

      if(!res.ok || data.ok === false){
        throw new Error(data?.error || `Registrering misslyckades (HTTP ${res.status}).`);
      }

      // Show result
      resultBox.style.display = "block";

      // alreadyExists = true should be treated as OK (not error)
      if (data.alreadyExists) {
        headline.innerHTML = `<span class="ok">✅ Redan registrerad</span> <span class="meta">(du kan använda samma ID)</span>`;
      } else {
        headline.innerHTML = `<span class="ok">✅ Registrerad</span> <span class="meta">(ny verifieringspost skapad)</span>`;
      }

      // Timestamp/submitter if present
      if (data.timestamp) {
        timeOut.textContent = new Date(Number(data.timestamp) * 1000).toLocaleString("sv-SE");
      } else {
        // if API doesn't return timestamp, keep dash
        timeOut.textContent = "—";
      }

      submitterOut.textContent = data.submitter || "—";
      txOut.textContent = data.txHash || "—";

      setPill("Klart ✅");
      setBusy(false);
    } catch (e){
      console.error(e);
      if(myOp !== opId) return;

      errorBox.style.display = "block";
      errorMsg.textContent = (e?.message || "Registreringstjänsten kunde inte nås just nu.");
      setPill("Fel");
      setBusy(false);
    }
  });

  // Copy buttons
  copyIdBtn.addEventListener("click", async () => {
    if(!currentHash) return;
    try{
      await navigator.clipboard.writeText(currentHash);
      setPill("ID kopierat ✅");
    } catch {
      setPill("Kunde inte kopiera");
    }
  });

  copyLinkBtn.addEventListener("click", async () => {
    if(!currentLink) return;
    try{
      await navigator.clipboard.writeText(currentLink);
      setPill("Länk kopierad ✅");
    } catch {
      setPill("Kunde inte kopiera");
    }
  });

  // Initial
  resetRight();
  setBusy(false);
})();
</script>

<script src="/chat-widget.js?v=2025-01" defer></script>
</body>
</html>
