<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proofy – Hasha, registrera & verifiera PDF</title>
  <meta name="theme-color" content="#0b1220" />

  <style>
:root{
  --bg:#0b1220;--panel:rgba(255,255,255,.06);--text:#eaf0ff;--muted:#a9b7d3;
  --border:rgba(255,255,255,.12);--brand:#6ea8ff;--brand2:#7cf1c6;
  --shadow:0 18px 60px rgba(0,0,0,.38);--r:18px;--max:1140px;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:var(--text);
  background:
    radial-gradient(900px 600px at 15% 10%, rgba(110,168,255,.18), transparent 60%),
    radial-gradient(900px 600px at 80% 20%, rgba(124,241,198,.10), transparent 65%),
    var(--bg);
}
.wrap{max-width:var(--max);margin:0 auto;padding:0 20px}
header{position:sticky;top:0;z-index:10;background:rgba(11,18,32,.75);border-bottom:1px solid var(--border)}
.nav{display:flex;justify-content:space-between;align-items:center;padding:14px 0}
.brand{display:flex;gap:10px;font-weight:900;text-decoration:none}
.logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand2))}
.btn{padding:12px 16px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:inherit;font-weight:900;cursor:pointer}
.btn.primary{border:none;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#08101e}
.card{border:1px solid var(--border);border-radius:var(--r);background:linear-gradient(180deg,rgba(255,255,255,.07),rgba(255,255,255,.03));box-shadow:var(--shadow)}
.content{padding:18px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.mono{font-family:ui-monospace,monospace;word-break:break-all}
.meta{color:var(--muted);font-size:13px}
.ok{color:#7cf1c6;font-weight:900}
.err{color:#ff8aa1;font-weight:900}
  </style>
</head>

<body>
<header>
  <div class="wrap nav">
    <a class="brand" href="/"><span class="logo"></span>Proofy</a>
    <a class="btn primary" href="/#kontakt">Boka demo</a>
  </div>
</header>

<main>
  <div class="wrap">
    <h1>Hasha, registrera & verifiera PDF</h1>

    <section class="card content">
      <div class="grid">

        <!-- LEFT -->
        <div>
          <b>1) Välj PDF</b>
          <input id="fileInput" type="file" accept=".pdf" />
          <div class="meta" id="fileInfo">Ingen fil vald.</div>

          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn primary" id="hashBtn" disabled>Hasha</button>
            <button class="btn" id="copyBtn" disabled>Kopiera hash</button>
          </div>

          <div class="meta" id="status"></div>
        </div>

        <!-- RIGHT -->
        <div>
          <b>2) Resultat</b>
          <div class="meta">SHA-256 (bytes32)</div>
          <div id="hashOut" class="mono">—</div>

          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn primary" id="registerBtn" disabled>Registrera</button>
            <button class="btn" id="verifyBtn" disabled>Verifiera</button>
          </div>

          <div class="meta" id="chainStatus"></div>

          <div id="verifyBox" style="display:none;margin-top:10px">
            <div class="meta">Resultat</div>
            <div id="verifyResult"></div>
          </div>
        </div>

      </div>
    </section>
  </div>
</main>

<script>
(() => {
  const fileInput = document.getElementById("fileInput");
  const fileInfo = document.getElementById("fileInfo");
  const hashBtn = document.getElementById("hashBtn");
  const copyBtn = document.getElementById("copyBtn");
  const registerBtn = document.getElementById("registerBtn");
  const verifyBtn = document.getElementById("verifyBtn");
  const status = document.getElementById("status");
  const chainStatus = document.getElementById("chainStatus");
  const hashOut = document.getElementById("hashOut");
  const verifyBox = document.getElementById("verifyBox");
  const verifyResult = document.getElementById("verifyResult");

  let currentFile = null;
  let currentHash = null;

  function set(el, txt, cls){
    el.textContent = txt || "";
    el.className = cls ? cls : "meta";
  }

  function bytesToHex(bytes){
    return [...bytes].map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  async function sha256(file){
    const buf = await file.arrayBuffer();
    const dig = await crypto.subtle.digest("SHA-256", buf);
    return "0x"+bytesToHex(new Uint8Array(dig));
  }

  fileInput.onchange = () => {
    currentFile = fileInput.files[0] || null;
    currentHash = null;
    hashOut.textContent = "—";
    verifyBox.style.display="none";
    registerBtn.disabled = true;
    verifyBtn.disabled = true;
    copyBtn.disabled = true;

    if(!currentFile){
      fileInfo.textContent="Ingen fil vald.";
      hashBtn.disabled=true;
      return;
    }
    fileInfo.textContent=`${currentFile.name} (${(currentFile.size/1024/1024).toFixed(2)} MB)`;
    hashBtn.disabled=false;
  };

  hashBtn.onclick = async () => {
    try{
      set(status,"Hashar…");
      currentHash = await sha256(currentFile);
      hashOut.textContent = currentHash;
      set(status,"Klar ✅","ok");
      registerBtn.disabled=false;
      verifyBtn.disabled=false;
      copyBtn.disabled=false;
    }catch{
      set(status,"Fel vid hashing","err");
    }
  };

  copyBtn.onclick = () => {
    navigator.clipboard.writeText(currentHash);
    set(status,"Hash kopierad ✅","ok");
  };

  registerBtn.onclick = async () => {
    set(chainStatus,"Registrerar…");
    const r = await fetch("/api/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({hash:currentHash})});
    const j = await r.json();
    if(j.ok) set(chainStatus,"Registrerad ✅","ok");
    else set(chainStatus,j.error||"Fel","err");
  };

  verifyBtn.onclick = async () => {
    set(chainStatus,"Verifierar…");
    verifyBox.style.display="none";

    const r = await fetch("/api/verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({hash:currentHash})});
    const j = await r.json();

    if(!j.ok){
      set(chainStatus,j.error||"Fel","err");
      return;
    }

    if(!j.exists){
      verifyResult.innerHTML = "<span class='err'>❌ Hashen finns inte registrerad</span>";
    } else {
      const d = new Date(j.timestamp*1000).toLocaleString("sv-SE");
      verifyResult.innerHTML = `
        <div class="ok">✅ Hashen är registrerad</div>
        <div class="meta">Datum: ${d}</div>
        <div class="meta">Submitter:</div>
        <div class="mono">${j.submitter}</div>
      `;
    }
    verifyBox.style.display="block";
    set(chainStatus,"","meta");
  };
})();
</script>

<script src="/chat-widget.js" defer></script>
</body>
</html>
