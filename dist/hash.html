<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proofy – Hasha, registrera & verifiera</title>
  <meta name="theme-color" content="#0b1220" />

  <style>
:root{
  --bg:#0b1220;--text:#eaf0ff;--muted:#a9b7d3;
  --border:rgba(255,255,255,.12);--brand:#6ea8ff;--brand2:#7cf1c6;
  --shadow:0 18px 60px rgba(0,0,0,.38);--r:18px;--max:1100px;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:var(--text);
  background:
    radial-gradient(900px 600px at 15% 10%, rgba(110,168,255,.18), transparent 60%),
    radial-gradient(900px 600px at 80% 20%, rgba(124,241,198,.10), transparent 65%),
    var(--bg);
}
.wrap{max-width:var(--max);margin:0 auto;padding:0 20px}
header{border-bottom:1px solid var(--border);background:rgba(11,18,32,.75)}
.nav{display:flex;justify-content:space-between;align-items:center;padding:14px 0;gap:12px}
.brand{display:flex;gap:10px;font-weight:900;text-decoration:none;align-items:center}
.logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand2))}
.btn{
  display:inline-flex;align-items:center;justify-content:center;
  padding:12px 16px;border-radius:14px;border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);color:inherit;font-weight:900;cursor:pointer;
}
.btn.primary{border:none;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#08101e}
.btn:disabled{opacity:.45;cursor:not-allowed}
.card{
  border:1px solid var(--border);border-radius:var(--r);
  background:linear-gradient(180deg,rgba(255,255,255,.07),rgba(255,255,255,.03));
  box-shadow:var(--shadow)
}
.content{padding:18px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;word-break:break-all}
.meta{color:var(--muted);font-size:13px}
.ok{color:#7cf1c6;font-weight:900}
.err{color:#ff8aa1;font-weight:900}
.hr{height:1px;background:rgba(255,255,255,.12);margin:14px 0}
input[type="file"]{
  width:100%;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
  background:rgba(11,18,32,.35);color:var(--text)
}
  </style>
</head>

<body>
<header>
  <div class="wrap nav">
    <a class="brand" href="/"><span class="logo"></span>Proofy</a>
    <a class="btn primary" href="/verify.html">Verifiera</a>
  </div>
</header>

<main>
  <div class="wrap">
    <h1>Hasha, registrera & verifiera PDF</h1>
    <p class="meta">Filen hash:as lokalt i webbläsaren. Endast hashvärdet används mot Proofys register.</p>

    <section class="card content">
      <div class="grid">

        <!-- LEFT -->
        <div>
          <b>1) Välj PDF</b>
          <input id="fileInput" type="file" accept=".pdf,application/pdf" />

          <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn primary" id="hashBtn" disabled>Hasha</button>
            <button class="btn" id="copyHashBtn" disabled>Kopiera hash</button>
          </div>

          <div id="localStatus" class="meta" style="margin-top:10px">Ingen fil vald.</div>
        </div>

        <!-- RIGHT -->
        <div>
          <b>2) Resultat</b>
          <div class="meta" style="margin-top:8px">SHA-256 (bytes32)</div>
          <div id="hashOut" class="mono">—</div>

          <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn primary" id="registerBtn" disabled>Registrera</button>
            <button class="btn" id="verifyBtn" disabled>Verifiera</button>
            <button class="btn" id="copyLinkBtn" disabled>Kopiera verifierings-länk</button>
          </div>

          <div class="hr"></div>

          <div id="status" class="meta"></div>
          <div id="verifyBox" style="display:none;margin-top:10px"></div>
        </div>

      </div>
    </section>
  </div>
</main>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const fileInput   = $("fileInput");
  const hashBtn     = $("hashBtn");
  const copyHashBtn = $("copyHashBtn");

  const registerBtn = $("registerBtn");
  const verifyBtn   = $("verifyBtn");
  const copyLinkBtn = $("copyLinkBtn");

  const localStatus = $("localStatus");
  const hashOut     = $("hashOut");
  const status      = $("status");
  const verifyBox   = $("verifyBox");

  let currentFile = null;
  let currentHash = null;

  // Anti-spam / låsning
  let busy = false;
  const setBusy = (v) => {
    busy = v;
    // knappar som beror på hash
    const hasHash = !!currentHash;
    hashBtn.disabled = !currentFile || busy;
    copyHashBtn.disabled = !hasHash || busy;
    registerBtn.disabled = !hasHash || busy;
    verifyBtn.disabled = !hasHash || busy;
    copyLinkBtn.disabled = !hasHash || busy;
  };

  const setLocal = (msg, cls="meta") => { localStatus.textContent = msg || ""; localStatus.className = cls; };
  const setStatus = (msg, cls="meta") => { status.textContent = msg || ""; status.className = cls; };

  const bytesToHex = (b) => [...b].map(x => x.toString(16).padStart(2, "0")).join("");

  async function sha256Bytes32Hex(file) {
    const buf = await file.arrayBuffer();
    const dig = await crypto.subtle.digest("SHA-256", buf);
    return "0x" + bytesToHex(new Uint8Array(dig));
  }

  function resetRightSide() {
    currentHash = null;
    hashOut.textContent = "—";
    setStatus("");
    verifyBox.style.display = "none";
    verifyBox.innerHTML = "";
    setBusy(false);
  }

  // IMPORTANT: alltid reset när fil ändras (förhindrar "gammal grön text")
  fileInput.addEventListener("change", () => {
    const f = fileInput.files?.[0] || null;
    currentFile = f;

    resetRightSide();

    if (!currentFile) {
      setLocal("Ingen fil vald.");
      hashBtn.disabled = true;
      return;
    }

    setLocal(`Vald fil: ${currentFile.name} (${(currentFile.size/1024/1024).toFixed(2)} MB)`);
    setBusy(false);
  });

  hashBtn.addEventListener("click", async () => {
    if (!currentFile || busy) return;

    try {
      setBusy(true);
      setLocal("Hashar fil lokalt…");
      setStatus("");

      const h = await sha256Bytes32Hex(currentFile);
      currentHash = h;
      hashOut.textContent = h;

      setLocal("Klar ✅", "ok");
      setStatus("Redo: du kan registrera eller verifiera.");
    } catch (e) {
      console.error(e);
      setLocal("Fel: kunde inte hasha filen.", "err");
      resetRightSide();
    } finally {
      setBusy(false);
    }
  });

  copyHashBtn.addEventListener("click", async () => {
    if (!currentHash || busy) return;
    try {
      await navigator.clipboard.writeText(currentHash);
      setStatus("Hash kopierad ✅", "ok");
    } catch {
      setStatus("Kunde inte kopiera. Tillåt clipboard i webbläsaren.", "err");
    }
  });

  async function verify() {
    if (!currentHash || busy) return;

    setBusy(true);
    setStatus("Verifierar…");
    verifyBox.style.display = "none";
    verifyBox.innerHTML = "";

    try {
      const r = await fetch("/api/verify", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ hash: currentHash }),
      });

      const j = await r.json().catch(() => ({}));

      if (!r.ok || !j.ok) {
        setStatus("Tekniskt fel vid verifiering.", "err");
        return;
      }

      if (!j.exists) {
        verifyBox.innerHTML = `<div class="err">❌ Hashen är inte registrerad</div>`;
      } else {
        const date = new Date(j.timestamp * 1000).toLocaleString("sv-SE");
        verifyBox.innerHTML = `
          <div class="ok">✅ Hashen är registrerad</div>
          <div class="meta">Datum: ${date}</div>
          <div class="meta">Submitter:</div>
          <div class="mono">${j.submitter}</div>
        `;
      }

      verifyBox.style.display = "block";
      setStatus("");
    } finally {
      setBusy(false);
    }
  }

  verifyBtn.addEventListener("click", verify);

  registerBtn.addEventListener("click", async () => {
    if (!currentHash || busy) return;

    setBusy(true);
    setStatus("Registrerar…");
    // Låt verifyBox ligga kvar om det redan finns, men uppdatera status.

    try {
      const r = await fetch("/api/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ hash: currentHash }),
      });

      const j = await r.json().catch(() => ({}));

      // OK
      if (r.ok && j.ok) {
        setStatus("Registrerad ✅", "ok");
        return;
      }

      const err = String(j.error || j.message || "").toLowerCase();

      // Snygg UX: already registered => behandla som info + auto-verify
      if (err.includes("redan") || err.includes("already")) {
        setStatus("Hashen är redan registrerad. Visar registreringen…", "ok");
        // Kör verify EN gång, men bara om vi inte redan visar resultat för samma hash
        await verify();
        return;
      }

      setStatus("Tekniskt fel vid registrering.", "err");
    } finally {
      setBusy(false);
    }
  });

  copyLinkBtn.addEventListener("click", async () => {
    if (!currentHash || busy) return;
    const url = `${location.origin}/verify.html?hash=${currentHash}`;
    try {
      await navigator.clipboard.writeText(url);
      setStatus("Verifierings-länk kopierad ✅", "ok");
    } catch {
      setStatus("Kunde inte kopiera länk. Tillåt clipboard i webbläsaren.", "err");
    }
  });

  // Initial state
  resetRightSide();
  setBusy(false);
})();
</script>

<script src="/chat-widget.js?v=2025-01" defer></script>
</body>
</html>
