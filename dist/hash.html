
<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proofy – Skapa verifierings-ID</title>
  <meta name="theme-color" content="#0b1220" />
  <link rel="stylesheet" href="/proofy.css?v=2025-12-20">
</head>

<body>
<header>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="/" aria-label="Proofy">
        <span class="logo" aria-hidden="true"></span>
        <span>Proofy</span>
      </a>
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <a class="btn" href="/verify.html">Verifiera underlag</a>
        <a class="btn primary" href="/#kontakt">Boka demo</a>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="badge">För redovisningsbyråer · revision · granskning</div>
    <h1 class="pageTitle">Skapa verifierings-ID</h1>
    <p class="lead">
      Skapa en verifieringspost för ett underlag. Filen lämnar inte din dator — vi beräknar ett <b>digitalt fingeravtryck</b>
      lokalt (SHA-256) och skapar ett <b>Verifierings-ID</b> som kan sparas i ärendet.
    </p>

    <section class="card content">
      <div class="grid">
        <!-- LEFT -->
        <div>
          <b>Skapa via fil</b>
          <p class="meta" style="margin-top:8px">
            Välj fil eller dra & släpp. Du får Verifierings-ID + delbar verifieringslänk.
          </p>

          <input id="fileInput" type="file" />
          <div id="dropZone" class="drop" style="margin-top:10px">Dra & släpp fil här</div>

          <div id="fileInfo" class="meta" style="margin-top:10px">Ingen fil vald.</div>

          <div class="actionsRow" style="margin-top:12px">
            <button class="btn primary" id="registerBtn" disabled>Skapa ID</button>
            <button class="btn" id="copyIdBtn" type="button" disabled>Kopiera ID</button>
            <button class="btn" id="copyLinkBtn" type="button" disabled>Kopiera länk</button>
            <span id="statusPill" class="pill">Välj en fil</span>
          </div>

          <div id="localHashBox" style="display:none;margin-top:12px">
            <div class="meta">Digitalt fingeravtryck (SHA-256 / bytes32):</div>
            <div id="localHashOut" class="mono">—</div>
          </div>

          <div class="small" style="margin-top:10px">
            QR-koden öppnar verifieringslänken (smidigt när du vill kontrollera via mobil).
          </div>
        </div>

        <!-- RIGHT -->
        <div>
          <b>Resultat</b>
          <div class="hr"></div>

          <div id="resultBox" class="resultCard" style="display:none;">
            <div id="resultLine" style="font-size:18px;margin-bottom:10px;"></div>

            <div class="kv">
              <div class="k">Verifierings-ID</div>
              <div id="idOut" class="v mono">—</div>
            </div>

            <div class="kv">
              <div class="k">Verifieringslänk</div>
              <div id="linkOut" class="v mono">—</div>
            </div>

            <div class="qrWrap">
              <div>
                <div class="k">QR-kod (öppnar verifieringslänk)</div>
                <div class="qrBox"><canvas id="qrCanvas" width="136" height="136"></canvas></div>
              </div>

              <div style="flex:1; min-width:220px">
                <div class="k">Info</div>
                <div id="statusText" class="meta">—</div>

                <div class="kv">
                  <div class="k">Registrerad av</div>
                  <div id="submitterOut" class="v mono">—</div>
                </div>

                <div class="kv">
                  <div class="k">Tidsstämpling</div>
                  <div id="timeOut" class="v mono">—</div>
                </div>
              </div>
            </div>
          </div>

          <div id="errorBox" class="resultCard" style="display:none;">
            <div class="err">Tillfälligt tekniskt problem</div>
            <div id="errorMsg" class="mono" style="margin-top:8px"></div>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>

<footer>
  <div class="wrap">
    <div class="foot">
      <div>
        <div style="color: rgba(234,240,255,.86); font-weight:800;">Proofy</div>
        <div class="small">Teknisk verifiering av filer — utan att lagra filinnehåll.</div>
      </div>
      <div class="links">
        <a href="/security.html">Säkerhet</a>
        <a href="/privacy.html">Integritet</a>
        <a href="/terms.html">Villkor</a>
        <a href="/#kontakt">Kontakt</a>
      </div>
    </div>
  </div>
</footer>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const fileInput = $("fileInput");
  const dropZone = $("dropZone");
  const fileInfo = $("fileInfo");

  const registerBtn = $("registerBtn");
  const copyIdBtn = $("copyIdBtn");
  const copyLinkBtn = $("copyLinkBtn");
  const statusPill = $("statusPill");

  const localHashBox = $("localHashBox");
  const localHashOut = $("localHashOut");

  const resultBox = $("resultBox");
  const resultLine = $("resultLine");
  const idOut = $("idOut");
  const linkOut = $("linkOut");
  const statusText = $("statusText");
  const submitterOut = $("submitterOut");
  const timeOut = $("timeOut");

  const qrCanvas = $("qrCanvas");

  const errorBox = $("errorBox");
  const errorMsg = $("errorMsg");

  let currentFile = null;
  let busy = false;
  let opId = 0;

  let lastHash = null;
  let lastLink = null;

  function setBusy(v){
    busy = v;
    registerBtn.disabled = !currentFile || busy;
    copyIdBtn.disabled = !lastHash || busy;
    copyLinkBtn.disabled = !lastLink || busy;
  }

  function setPill(msg){ statusPill.textContent = msg || "—"; }

  function clearCanvas(canvas){
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0,0,canvas.width,canvas.height);
  }

  function resetUI(){
    errorBox.style.display = "none";
    errorMsg.textContent = "";

    resultBox.style.display = "none";
    resultLine.textContent = "";
    idOut.textContent = "—";
    linkOut.textContent = "—";
    statusText.textContent = "—";
    submitterOut.textContent = "—";
    timeOut.textContent = "—";

    localHashBox.style.display = "none";
    localHashOut.textContent = "—";

    clearCanvas(qrCanvas);

    lastHash = null;
    lastLink = null;
    copyIdBtn.disabled = true;
    copyLinkBtn.disabled = true;
  }

  function bytesToHex(bytes){
    return [...bytes].map(b => b.toString(16).padStart(2,"0")).join("");
  }

  async function sha256Bytes32Hex(file){
    const buf = await file.arrayBuffer();
    const dig = await crypto.subtle.digest("SHA-256", buf);
    return "0x" + bytesToHex(new Uint8Array(dig));
  }

  function shareUrlForHash(h){
    return `${location.origin}/verify.html?hash=${h}`;
  }

  function fmtDateSv(tsSeconds){
    try{ return new Date(tsSeconds * 1000).toLocaleString("sv-SE"); } catch { return "—"; }
  }

  // UI-first pseudo-QR (snygg och tydlig). Vill du ha 100% standard QR senare byter vi till liten QR-lib.
  function drawQrToCanvas(canvas, text){
    const ctx = canvas.getContext("2d");
    const size = canvas.width;
    const cells = 29;
    const cell = Math.floor(size / cells);
    const pad = Math.floor((size - cell * cells) / 2);

    ctx.clearRect(0,0,size,size);
    ctx.fillStyle = "rgba(11,18,32,.85)";
    ctx.fillRect(0,0,size,size);

    ctx.strokeStyle = "rgba(255,255,255,.14)";
    ctx.lineWidth = 2;
    ctx.strokeRect(1,1,size-2,size-2);

    const bits = hashBits(text, cells * cells);

    function finder(x,y){
      ctx.fillStyle = "rgba(124,241,198,.95)";
      ctx.fillRect(pad + x*cell, pad + y*cell, cell*7, cell*7);
      ctx.fillStyle = "rgba(11,18,32,.95)";
      ctx.fillRect(pad + (x+1)*cell, pad + (y+1)*cell, cell*5, cell*5);
      ctx.fillStyle = "rgba(110,168,255,.95)";
      ctx.fillRect(pad + (x+2)*cell, pad + (y+2)*cell, cell*3, cell*3);
    }

    finder(1,1);
    finder(cells-8,1);
    finder(1,cells-8);

    for(let i=0;i<cells*cells;i++){
      const x = i % cells;
      const y = Math.floor(i / cells);

      const inFinder =
        (x>=1 && x<8 && y>=1 && y<8) ||
        (x>=cells-8 && x<cells-1 && y>=1 && y<8) ||
        (x>=1 && x<8 && y>=cells-8 && y<cells-1);

      if(inFinder) continue;

      if(bits[i]){
        ctx.fillStyle = "rgba(234,240,255,.92)";
        ctx.fillRect(pad + x*cell, pad + y*cell, cell-1, cell-1);
      }
    }
  }

  function hashBits(str, n){
    let h1 = 0x811c9dc5;
    for(let i=0;i<str.length;i++){
      h1 ^= str.charCodeAt(i);
      h1 = Math.imul(h1, 0x01000193);
    }
    const bits = new Array(n).fill(false);
    let x = h1 >>> 0;
    for(let i=0;i<n;i++){
      x ^= x << 13; x >>>= 0;
      x ^= x >> 17; x >>>= 0;
      x ^= x << 5;  x >>>= 0;
      bits[i] = (x & 1) === 1;
    }
    return bits;
  }

  function setFile(file){
    currentFile = file || null;
    resetUI();

    if(!currentFile){
      fileInfo.textContent = "Ingen fil vald.";
      setPill("Välj en fil");
      registerBtn.disabled = true;
      return;
    }

    fileInfo.textContent = `Vald fil: ${currentFile.name} (${(currentFile.size/1024/1024).toFixed(2)} MB)`;
    setPill("Redo att skapa ID");
    setBusy(false);
  }

  fileInput.addEventListener("change", () => setFile(fileInput.files?.[0] || null));
  dropZone.addEventListener("dragover", (e) => { e.preventDefault(); dropZone.classList.add("drag"); });
  dropZone.addEventListener("dragleave", () => dropZone.classList.remove("drag"));
  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("drag");
    const f = e.dataTransfer?.files?.[0];
    if(f) setFile(f);
  });

  registerBtn.addEventListener("click", async () => {
    if(!currentFile || busy) return;

    const myOp = ++opId;
    setBusy(true);
    resetUI();
    setPill("Beräknar fingeravtryck…");

    try{
      const h = await sha256Bytes32Hex(currentFile);
      if(myOp !== opId) return;

      lastHash = h;
      lastLink = shareUrlForHash(h);

      localHashBox.style.display = "block";
      localHashOut.textContent = h;

      setPill("Skapar verifieringspost…");

      const res = await fetch("/api/register",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ hash: h })
      });

      const data = await res.json().catch(() => ({}));
      if(myOp !== opId) return;

      if(!res.ok || data.ok === false){
        const msg = data?.error || `Misslyckades (HTTP ${res.status}).`;
        throw new Error(msg);
      }

      lastHash = data.hash || h;
      lastLink = shareUrlForHash(lastHash);

      resultBox.style.display = "block";
      idOut.textContent = lastHash;
      linkOut.textContent = lastLink;

      if(data.alreadyExists){
        resultLine.innerHTML = `<span class="ok">✅ Redan registrerad</span> <span class="meta">(befintlig verifieringspost)</span>`;
        statusText.textContent = "Verifieringspost fanns redan. Du kan använda samma ID och länk.";
      } else {
        resultLine.innerHTML = `<span class="ok">✅ Verifierings-ID skapat</span>`;
        statusText.textContent = "Spara ID i ärendet och dela länken vid behov.";
      }

      submitterOut.textContent = (data.submitter || "—");
      timeOut.textContent = data.timestamp ? fmtDateSv(data.timestamp) : "—";

      drawQrToCanvas(qrCanvas, lastLink);

      copyIdBtn.disabled = false;
      copyLinkBtn.disabled = false;
      setPill("Klart ✅");
    } catch (e){
      console.error(e);
      if(myOp !== opId) return;
      errorBox.style.display = "block";
      errorMsg.textContent = (e?.message || "Tjänsten kunde inte nås just nu.");
      setPill("Fel");
    } finally {
      if(myOp === opId) setBusy(false);
    }
  });

  copyIdBtn.addEventListener("click", async () => {
    if(!lastHash) return;
    try{ await navigator.clipboard.writeText(lastHash); setPill("ID kopierat"); }
    catch{ setPill("Kunde inte kopiera"); }
  });

  copyLinkBtn.addEventListener("click", async () => {
    if(!lastLink) return;
    try{ await navigator.clipboard.writeText(lastLink); setPill("Länk kopierad"); }
    catch{ setPill("Kunde inte kopiera"); }
  });

  resetUI();
  setPill("Välj en fil");
  setBusy(false);
})();
</script>

<script src="/chat-widget.js?v=2025-01" defer></script>
</body>
</html>
