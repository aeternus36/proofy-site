import { createPublicClient, http, isHex, zeroAddress } from "viem";
import { polygonAmoy } from "viem/chains";

const CONTRACT_ADDRESS =
  process.env.PROOFY_CONTRACT_ADDRESS ||
  "0x1C14960C4dAD90047ea91d224539311c69EAB261";

const RPC_URL = process.env.AMOY_RPC_URL;

// Minimal ABI för ditt kontrakt (baserat på tidigare svar: timestamp + submitter)
const ABI = [
  {
    type: "function",
    name: "getProof",
    stateMutability: "view",
    inputs: [{ name: "hash", type: "bytes32" }],
    outputs: [
      { name: "timestamp", type: "uint256" },
      { name: "submitter", type: "address" },
    ],
  },
];

function json(statusCode, obj) {
  return new Response(JSON.stringify(obj), {
    status: statusCode,
    headers: {
      "content-type": "application/json; charset=utf-8",
      "cache-control": "no-store",
      "access-control-allow-origin": "*",
      "access-control-allow-headers": "content-type",
      "access-control-allow-methods": "GET,OPTIONS",
    },
  });
}

function isBytes32Hash(h) {
  // exakt 32 bytes: 0x + 64 hex
  return typeof h === "string" && /^0x[a-fA-F0-9]{64}$/.test(h);
}

export default async (request) => {
  try {
    if (request.method === "OPTIONS") return json(204, {});
    if (request.method !== "GET") return json(405, { ok: false, error: "Use GET" });

    const url = new URL(request.url);
    const hash = url.searchParams.get("hash") || "";

    if (!isBytes32Hash(hash)) {
      return json(400, {
        ok: false,
        error: "Invalid hash. Expected bytes32 hex (0x + 64 hex).",
      });
    }

    if (!RPC_URL) {
      return json(500, { ok: false, error: "Missing AMOY_RPC_URL in environment variables." });
    }

    const client = createPublicClient({
      chain: polygonAmoy,
      transport: http(RPC_URL),
    });

    // Default: inte registrerad (vi uppgraderar till exists:true om vi får data)
    let exists = false;
    let timestamp = 0;
    let submitter = null;

    try {
      const res = await client.readContract({
        address: CONTRACT_ADDRESS,
        abi: ABI,
        functionName: "getProof",
        args: [hash],
      });

      // res kan vara array [timestamp, submitter] eller objekt beroende på viem-version
      if (Array.isArray(res)) {
        timestamp = Number(res[0] ?? 0);
        submitter = res[1] ?? null;
      } else {
        timestamp = Number(res?.timestamp ?? 0);
        submitter = res?.submitter ?? null;
      }

      // Om kontraktet returnerar 0/zeroAddress för "saknas"
      if (timestamp > 0 && submitter && submitter !== zeroAddress) {
        exists = true;
      }
    } catch (e) {
      // VIKTIGT: "no data (0x)" eller revert = betyder normalt "saknas"
      const msg = String(e?.shortMessage || e?.message || e);
      const looksLikeMissing =
        msg.includes("returned no data") ||
        msg.includes("0x") ||
        msg.toLowerCase().includes("execution reverted");

      if (!looksLikeMissing) {
        return json(500, { ok: false, error: msg });
      }

      // Saknas → exists=false (ingen error)
      exists = false;
      timestamp = 0;
      submitter = null;
    }

    return json(200, {
      ok: true,
      hashHex: hash,
      exists,
      timestamp: exists ? timestamp : 0,
      submitter: exists ? submitter : null,
    });
  } catch (e) {
    const msg = String(e?.shortMessage || e?.message || e);
    return json(500, { ok: false, error: msg });
  }
};
