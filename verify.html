<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proofy – Verifiera</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; max-width: 860px; margin: 40px auto; padding: 0 16px; }
    h1 { margin: 0 0 8px; }
    p { color: #333; line-height: 1.5; }
    .card { border: 1px solid #e3e3e3; border-radius: 14px; padding: 16px; margin: 14px 0; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #ccc; cursor: pointer; background: #fff; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    code { background: #f6f6f6; border-radius: 10px; padding: 10px; overflow: auto; display: block; }
    .muted { color: #666; font-size: 14px; }
    .ok { color: #0a7a2f; font-weight: 700; }
    .bad { color: #b00020; font-weight: 700; }
    .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; background:#f2f2f2; font-size: 13px; }
    a { color: #0b57d0; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 13px; word-break: break-all; }
  </style>
</head>
<body>

  <h1>Verifiera dokument</h1>
  <p>
    Dokumentet lämnar aldrig din dator. Proofy beräknar en <strong>SHA-256</strong>-hash lokalt och kontrollerar om hash:en är registrerad on-chain.
  </p>

  <div class="card">
    <div class="row">
      <input id="file" type="file" />
      <button id="btnVerify" disabled>Verifiera</button>
      <a id="certLink" href="#" target="_blank" rel="noopener" style="display:none;">Öppna certifikat</a>
      <span id="status" class="pill">Välj en fil</span>
    </div>
    <div class="muted" style="margin-top:10px;">
      Tips: stora filer kan ta några sekunder – hash sker i webbläsaren.
    </div>
  </div>

  <div class="card">
    <div class="muted">SHA-256 (bytes32)</div>
    <code id="hashOut" class="mono">—</code>
  </div>

  <div class="card" id="resultCard" style="display:none;">
    <div id="resultLine" style="font-size:18px; margin-bottom:10px;"></div>

    <div class="muted">Tidsstämpel (UTC)</div>
    <div id="timeOut" class="mono">—</div>

    <div class="muted" style="margin-top:10px;">Övrigt</div>
    <div class="muted" id="metaOut">—</div>
  </div>

  <div class="card" id="errorCard" style="display:none;">
    <div class="bad">Fel</div>
    <div id="errOut" class="mono">—</div>
  </div>

<script>
  const fileInput = document.getElementById("file");
  const btnVerify = document.getElementById("btnVerify");
  const statusEl = document.getElementById("status");
  const hashOut = document.getElementById("hashOut");

  const resultCard = document.getElementById("resultCard");
  const resultLine = document.getElementById("resultLine");
  const timeOut = document.getElementById("timeOut");
  const metaOut = document.getElementById("metaOut");

  const errorCard = document.getElementById("errorCard");
  const errOut = document.getElementById("errOut");

  const certLink = document.getElementById("certLink");

  let lastHash = null;

  fileInput.addEventListener("change", async () => {
    hideError(); hideResult();
    certLink.style.display = "none";
    certLink.href = "#";

    const f = fileInput.files?.[0];
    if (!f) {
      btnVerify.disabled = true;
      statusEl.textContent = "Välj en fil";
      hashOut.textContent = "—";
      lastHash = null;
      return;
    }

    btnVerify.disabled = true;
    statusEl.textContent = "Beräknar SHA-256…";
    hashOut.textContent = "—";

    try {
      const hashHex = await sha256FileToBytes32Hex(f);
      lastHash = hashHex;
      hashOut.textContent = hashHex;

      // gör certifikat-länken direkt
      certLink.href = `/certificate.html?hash=${encodeURIComponent(hashHex)}`;
      certLink.style.display = "inline";

      statusEl.textContent = "Redo att verifiera";
      btnVerify.disabled = false;
    } catch (e) {
      showError(String(e?.message || e));
      statusEl.textContent = "Fel vid hashning";
      btnVerify.disabled = true;
    }
  });

  btnVerify.addEventListener("click", async () => {
    hideError(); hideResult();
    if (!lastHash) return;

    btnVerify.disabled = true;
    statusEl.textContent = "Kontrollerar…";

    try {
      const url = `/.netlify/functions/verify?hash=${encodeURIComponent(lastHash)}`;
      const res = await fetch(url, { method: "GET" });
      const data = await res.json().catch(() => ({}));

      if (!res.ok || data.ok === false) {
        throw new Error(data.error || `Verify failed (HTTP ${res.status})`);
      }

      renderResult(data);
      statusEl.textContent = "Klar";
    } catch (e) {
      showError(String(e?.message || e));
      statusEl.textContent = "Fel";
    } finally {
      btnVerify.disabled = false;
    }
  });

  function renderResult(data) {
    resultCard.style.display = "block";

    const exists = (data.exists === true);

    if (exists) {
      resultLine.innerHTML = `<span class="ok">✅ Registrerad</span> <span class="muted">(hash hittad)</span>`;
      const ts = Number(data.timestamp || 0);
      timeOut.textContent = ts ? toUtc(ts) : "—";
      metaOut.textContent = "Verifiering utförd mot Proofy-kontraktet.";
    } else {
      resultLine.innerHTML = `<span class="bad">❌ Inte registrerad</span> <span class="muted">(hash saknas)</span>`;
      timeOut.textContent = "—";
      metaOut.textContent = "Verifiering utförd mot Proofy-kontraktet.";
    }
  }

  function toUtc(ts) {
    return new Date(ts * 1000).toISOString().replace("T", " ").replace(".000Z", " UTC");
  }

  function showError(msg) {
    errorCard.style.display = "block";
    errOut.textContent = msg;
  }
  function hideError() {
    errorCard.style.display = "none";
    errOut.textContent = "—";
  }
  function hideResult() {
    resultCard.style.display = "none";
  }

  async function sha256FileToBytes32Hex(file) {
    const buf = await file.arrayBuffer();
    const digest = await crypto.subtle.digest("SHA-256", buf);
    return "0x" + [...new Uint8Array(digest)].map(b => b.toString(16).padStart(2, "0")).join("");
  }
</script>

</body>
</html>
